Ext.AwesomeSearchGrid=Ext.extend(Ext.AwesomeGrid,{emptyText:"",searchURI:TDS.env.dataPath+"search",pollThreshold:20,pollCount:0,pollDelay:10000,pollDT:new Ext.util.DelayedTask(),searchFinalised:false,initComponent:function(){Ext.AwesomeSearchGrid.superclass.initComponent.apply(this,arguments);this.on("loadcollection",this.onLoadCollection)},onRender:function(){Ext.AwesomeSearchGrid.superclass.onRender.apply(this,arguments)},submit:function(){Ext.AwesomeSearchGrid.superclass.submit.apply(this,arguments);this.haltPoll()},submitQuery:function(b){this.applyCustomValidationText("Searching...");this.pollCount=0;this.searchFinalised=false;if(this.alwaysUseCollection){b=true}var f,e;this.queryParams={};var d={};for(var a=0;a<this.toolbarFields.length;a++){f=this.toolbarFields[a];if(f.excludeSubmit){continue}if(f.xtype=="datefield"){e=f.getValue();if(typeof e=="object"){e=e.format(TDS.env.dateFormat)}}else{e=f.getValue()}this.queryParams[f.name]=e;if(!f.excludeFromSession){d[f.name]=e}if(f.originalValue==e){continue}if(f.originalValue.length==0){this.isCollectionValid=false}else{if(e.length>f.originalValue.length&&e.substring(0,f.originalValue.length)==f.originalValue){}else{this.isCollectionValid=false}}f.originalValue=e}Ext.apply(this.queryParams,this.appendQueryParams);if(this.enableSession){TDS.session.set(this.getSessionURI(),d)}if(this.pinnable){var c=this.pinnedList.join(",");if(c){this.queryParams.pinned=c}}this.getStore().removeAll();this.applyCustomValidationText("Searching...");Ext.Ajax.request({url:this.searchURI,method:"POST",disableCaching:false,jsonData:{offeringType:this.searchOfferingType,parameters:this.queryParams},callback:this.submitQueryResponse,scope:this})},submitQueryResponse:function(g,a,d){this.fireEvent("queryresponse",this,a);if(a){try{var c=d.getResponseHeader.Location;this.searchID=c.substring(c.lastIndexOf("/")+1);this.collectionIdentifier=this.searchID+"/results/collection";var b=Ext.util.JSON.decode(d.responseText);this.readSearchResponse(b)}catch(f){return}if(!this.isSearchFinalised()){this.doPoll()}}else{if(d.status==409){this.applyValidationText(d.responseText)}}},readSearchResponse:function(a){if(a.finalised){this.searchFinalised=true;this.haltPoll();this.applyCustomValidationText("Loading results...");this.getSearchResults()}else{if(this.pollCount<this.pollThreshold){this.doPoll();if(this.pollCount<2){this.getSearchResults()}this.applyCustomValidationText("Searching...")}else{this.haltPoll();this.applyValidationText("Search halted. No record found.")}}},isSearchFinalised:function(){return this.searchFinalised},doPoll:function(){this.pollCount++;this.pollDT.delay(this.pollDelay,this.pollSearch,this)},haltPoll:function(){this.pollCount=0;this.pollDT.cancel()},pollSearch:function(){Ext.Ajax.request({url:this.searchURI+"/"+this.searchID,method:"GET",disableCaching:false,callback:this.pollSearchResponse,scope:this})},pollSearchResponse:function(f,a,c){if(a){try{var b=Ext.util.JSON.decode(c.responseText);this.readSearchResponse(b)}catch(d){return}}else{}},getSearchResults:function(){Ext.Ajax.request({url:this.searchURI+"/"+this.searchID+"/results/collection",method:"GET",disableCaching:false,callback:this.searchResultsResponse,scope:this})},searchResultsResponse:function(f,a,c){if(a){try{var b=Ext.util.JSON.decode(c.responseText)}catch(d){return}this.loadCollectionDataNew(b)}else{if(c.status==409){this.haltPoll();this.applyValidationText(c.responseText)}else{}}},loadCollectionDataNew:function(b){var c=this.searchOfferingType;b=this.processCollectionData(b);var e;if(c=="AIR"){e=b["air/results/collection"]}else{if(c=="ACCOMMODATION"){e=b["accommodation/results/collection"]}else{if(c=="SIGHTSEEING"){e=b["sightseeings/results/collection"]}}}if(typeof e=="undefined"){return}var d=[];for(var a=0;a<e.length;a++){b[e[a]].dataURI=e[a];if(this.pinnable){if(this.isPinned(e[a])){b[e[a]].pinned="1"}else{b[e[a]].pinned="0"}}d.push(b[e[a]])}this.isCollectionValid=true;if(this.fireEvent("loadcollection",this,d)===false){return}this.getStore().loadData(d)},onLoadCollection:function(a,b){this.getStore().loadData(b,true);return false}});Ext.reg("awesomesearchgrid",Ext.AwesomeSearchGrid);