TDS.heartbeat=Ext.extend(Ext.util.Observable,{constructor:function(){this.addEvents("pulse","afterpulse","sessionsave","aftersessionsave","sessionlogin","sessionexpire")},sessionDelayedTask:new Ext.util.DelayedTask(),sessionStart:function(){this.sessionDelayedTask.delay(5000,this.session,this)},sessionStop:function(){this.sessionDelayedTask.cancel()},session:function(){this.fireEvent("sessionsave",this);var e=TDS.session;var c=e.getModifiedRecords();if(c.length>0){var j={},g,a,f;for(var b=0;b<c.length;b++){g=c[b].data.path;a=c[b].data.session_key;f=c[b].data.value;if(typeof j[g]=="undefined"){j[g]={}}j[g][a]=f}for(var h in j){e.saveSession(h,j[h])}e.commitChanges()}this.fireEvent("aftersessionsave",this);this.sessionStart()},lastHeartbeatTime:0,pulseDelayedTask:new Ext.util.DelayedTask(),pulseStart:function(a){if(a){this.pulseDelayedTask.cancel();this.pulse();return}this.pulseDelayedTask.delay(90000,this.pulse,this)},pulseStop:function(){this.pulseDelayedTask.cancel()},pulse:function(){this.fireEvent("pulse",this);Ext.Ajax.request({url:TDS.env.dataPath+"heartbeat",method:"GET",callback:function(f,a,c){if(a){try{var b=Ext.decode(c.responseText)}catch(d){this.fireEvent("sessionexpire",this);return}this.lastHeartbeatTime=b.lastHeartbeatTime;this.fireEvent("sessionlogin",b);this.pulseStart()}else{this.fireEvent("sessionexpire",this)}this.fireEvent("afterpulse",this)},scope:this})},getLastHeartbeatTime:function(){return this.lastHeartbeatTime},getLastHeartbeatDate:function(){var a=new Date();a.setTime(this.lastHeartbeatTime);return a}});TDS.env.heartbeat=new TDS.heartbeat();