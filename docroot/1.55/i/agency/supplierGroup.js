{xtype:"form",border:false,autoScroll:true,bodyStyle:"padding: 8px;",getDataURI:function(){return this.ownerCt.ownerCt.getDataURI()},getSessionURI:function(){return this.ownerCt.ownerCt.getSessionURI()},getSessionValue:function(a){return this.ownerCt.ownerCt.getSession(a)},reloadData:function(){var a=this.ownerCt.findParentByType("stdpanel");a.getAjaxPanel().reloadData({callback:function(b,c,d){this.getForm().setValues(d)},scope:this});this.getForm().setValues(a.getAjaxPanel().getData())},getHomeCurrency:function(){var a=this.ownerCt.findParentByType("stdpanel");return a.getAjaxPanel().getData("homeCurrency")},listeners:{render:function(){var a=this.ownerCt.findParentByType("stdpanel");this.getForm().setValues(a.getAjaxPanel().getData())}},items:[{xtype:"panel",border:false,hideBorders:true,height:670,layout:"column",items:[{columnWidth:0.56,bodyStyle:"padding-right: 8px;",border:false,height:670,items:[{xtype:"fieldset",title:"Suppliers",collapsible:true,cls:"x-tds-offering",layout:"fit",width:690,height:630,border:false,hideBorders:false,autoHeight:true,defaults:{height:20,isFormField:true,getName:function(){return this.name},setValue:function(c){if(this.renderer&&typeof this.renderer=="function"){c=this.renderer(c)}else{if(this.name.substring(this.name.length-3)=="URI"){var d=TDS.data.getStoreNameByResourceDataURI(c);var a=TDS.data.findRecordBy(d,"dataURI",c);if(a!=-1){c=a.get("name")}}}var b=this.allowHTML?false:true;this.setText(c,b)},getValue:Ext.emptyFn},items:[{xtype:"editorgrid",width:800,getSupplierFilteredData:function(){var h=this.ownerCt.findParentByType("stdpanel");if(!h.getDataURI()){return}var b=h.getDataURI();var g=this.topToolbar.items.itemAt(1).getValue();var c=this.topToolbar.items.itemAt(3).getValue();var f=TDS.env.dataPath+b+"/supplier/collection?&supplierURI="+c+"&countryURI="+g;var e=this.store;Ext.Ajax.request({url:f,method:"GET",callback:function d(p,j,l){var k=Ext.util.JSON.decode(l.responseText);var n=k["agency/suppliers"];if(typeof n=="undefined"){return}var m=[];for(var a=0;a<n.length;a++){k[n[a]].dataURI=n[a];m.push(k[n[a]])}e.loadData(m)}})},bbar:["Markup %",{xtype:"numberfield",width:40}," &nbsp;&nbsp;&nbsp;&nbsp;Add Charge",{xtype:"numberfield",width:50},"&nbsp;&nbsp;&nbsp;&nbsp;",{xtype:"button",text:"Apply to all Suppliers",handler:function(){var a=this.ownerCt.items.itemAt(1).getValue();var c=this.ownerCt.items.itemAt(3).getValue();var b=this.ownerCt.ownerCt;b.store.each(function(d){d.set("percentage",a);d.set("charge",c)})}},"->",{xtype:"button",text:"Save",handler:function(){var g=this.ownerCt.ownerCt.store.getModifiedRecords();var d=this.ownerCt.ownerCt.store;var b=this.ownerCt.findParentByType("stdpanel");if(!b.getDataURI()){return}var j=b.getDataURI();var h=[];for(var f=0;f<g.length;f++){h[f]=g[f].data}g.splice(0,g.length);var k={submitDataAsParams:true,modifiedSupplierData:h};var e=TDS.env.dataPath+j+"/supplierAgencyGroup/Update";Ext.Ajax.request({url:e,method:"POST",jsonData:k,callback:function c(t,l,n){var m=Ext.util.JSON.decode(n.responseText);var q=m["agency/suppliers"];if(typeof q=="undefined"){return}var p=[];for(var a=0;a<q.length;a++){m[q[a]].dataURI=q[a];p.push(m[q[a]])}d.loadData(p)}})}}],tbar:["Country:",{xtype:"combo",allowBlank:false,name:"fromCountryURI",emptyText:"Type a country...",tpl:TDS.util.Templates.ComboNoLabel,minChars:1,enableKeyEvents:true,mode:"local",width:150,typeAhead:true,triggerAction:"all",forceSelection:true,selectOnFocus:true,displayField:"name",valueField:"isoCode",store:TDS.data.getStore({dataURI:TDS.env.dataPath+"countries/collection",identifier:"countries",fields:["name","isoCode"]}),appendData:[{name:"",dataURI:""}],listeners:{select:function(){this.ownerCt.ownerCt.getSupplierFilteredData()}}}," &nbsp;&nbsp;&nbsp;&nbsp; supplier",{xtype:"combo",name:"suppliers",mode:"local",fieldLabel:"Supplier",width:200,triggerAction:"all",editable:false,displayField:"name",valueField:"supplierDataURI",appendData:[{name:"",dataURI:""}],store:new Ext.data.JsonStore({fields:["supplierDataURI","name"]}),listeners:{select:function(){this.ownerCt.ownerCt.getSupplierFilteredData()}}}],height:620,enableRowExpander:false,clicksToEdit:1,store:new Ext.data.JsonStore({url:"",id:"dataURI",fields:["dataURI","name","countryURI","percentage","charge","rateOverride"]}),sm:new Ext.grid.RowSelectionModel(),cm:new Ext.grid.ColumnModel([{header:"Country",dataIndex:"countryURI",sortable:true,renderer:TDS.util.Format.displayResourceNameRenderer()},{header:"Supplier",dataIndex:"name",sortable:true},{header:"Markup %",dataIndex:"percentage",align:"right",sortable:true,editor:new Ext.form.TextField({vtype:"numeric"}),renderer:function(b,c,a){if(b){return a.get("percentage").toFixed(2)}else{return""}}},{header:"Charge",dataIndex:"charge",align:"right",sortable:true,editor:new Ext.form.TextField({vtype:"numeric"}),renderer:function(b,c,a){if(b){return a.get("charge").toFixed(2)}else{return""}}},{header:"Rate Override",dataIndex:"rateOverride",align:"right",sortable:true,width:110,fixed:true,editor:new Ext.form.Checkbox({xtype:"checkbox"})}]),viewConfig:{forceFit:true},listeners:{render:function(){var e=this.store;var h=this.ownerCt.ownerCt.ownerCt.items.itemAt(1).items.itemAt(0).items.itemAt(0).items.itemAt(0);h=h.topToolbar[1].store;var d=this.topToolbar.items.itemAt(3).store;var g=this.ownerCt.findParentByType("stdpanel");if(!g.getDataURI()){return}var b=g.getDataURI();var f=TDS.env.dataPath+b+"/supplier/collection";Ext.Ajax.request({url:f,method:"GET",callback:function c(p,j,l){var k=Ext.util.JSON.decode(l.responseText);var n=k["agency/suppliers"];if(typeof n=="undefined"){return}var m=[];for(var a=0;a<n.length;a++){k[n[a]].dataURI=n[a];m.push(k[n[a]])}e.loadData(m);d.loadData(m);h.loadData(m)}})}}}]}]},{columnWidth:0.44,height:820,items:{xtype:"panel",border:false,layout:"fit",width:535,height:820,hideBorders:true,items:{xtype:"fieldset",title:"Exchange rates",border:false,collapsible:true,autoHeight:true,height:650,items:{xtype:"editorgrid",height:620,storeExchangeRates:undefined,store:new Ext.data.JsonStore({fields:["dataURI","fromCurrency","toCurrency","modifier","active","modifierToday","sortOrderNumber","modifierDifference","maxCutOff","minCutOff"]}),tbar:["Supplier: ",{xtype:"combo",name:"suppliers",mode:"local",fieldLabel:"Supplier",width:200,triggerAction:"all",editable:false,displayField:"name",valueField:"supplierDataURI",store:new Ext.data.JsonStore({fields:["supplierDataURI","name"]}),listeners:{select:function(){var d=this.ownerCt.findParentByType("form");var c=this.ownerCt.ownerCt.storeExchangeRates;c=new Ext.data.CollectionStore({autoLoad:true,url:TDS.env.dataPath+"exchangeRates/collection?currency="+d.getHomeCurrency(),identifier:"exchangeRates?currency="+d.getHomeCurrency(),id:"counterCurrency",fields:["dataURI","convertedBaseCurrency","convertedModifier","counterCurrency"]});var b=this.getValue();var i=this.ownerCt.ownerCt.store;var h=this.ownerCt.findParentByType("stdpanel");if(!h.getDataURI()){return}var f=h.getDataURI();var g=TDS.env.dataPath+f+"/"+b+"/exchangeRates/collection";Ext.Ajax.request({url:g,method:"GET",callback:function e(p,j,l){var k=Ext.util.JSON.decode(l.responseText);var n=k[f+"/"+b+"/exchangeRates"];if(typeof n=="undefined"){return}var m=[];for(var a=0;a<n.length;a++){k[n[a]].dataURI=n[a];m.push(k[n[a]])}i.loadData(m)}});c.on("load",this.ownerCt.ownerCt.loadExchangeRates,this.ownerCt.ownerCt);i.on("load",this.ownerCt.ownerCt.loadSupplierExchangeRates,this.ownerCt.ownerCt)}}},{xtype:"tbfill"},{xtype:"button",text:"Save",handler:function(){var f=this.ownerCt.ownerCt;var j=this.ownerCt.findParentByType("form");var m=this.ownerCt.ownerCt.storeExchangeRates;m=new Ext.data.CollectionStore({autoLoad:true,url:TDS.env.dataPath+"exchangeRates/collection?currency="+j.getHomeCurrency(),identifier:"exchangeRates?currency="+j.getHomeCurrency(),id:"counterCurrency",fields:["dataURI","convertedBaseCurrency","convertedModifier","counterCurrency"]});var o=this.ownerCt.ownerCt.store;var c=this.ownerCt.items.itemAt(1).getValue();var n=j.getDataURI()+"/"+c+"/exchangeRates";var b=f.getStore().getModifiedRecords();var h=[];var l={};for(var d=0;d<b.length;d++){var e=b[d];var k=e.get("dataURI");l[k]={fromCurrency:e.get("fromCurrency"),toCurrency:e.get("toCurrency"),modifier:e.get("modifier"),active:e.get("active"),maxCutOff:e.get("maxCutOff"),minCutOff:e.get("minCutOff")};h.push(k)}l[n]=h;b.length=0;Ext.Ajax.request({url:TDS.env.dataPath+j.getDataURI()+"/"+c+"/exchangeRates/collection",method:"PUT",headers:{"Content-Type":"application/json"},callback:function(v,g,q){if(g){var p=Ext.util.JSON.decode(q.responseText);var u=p[j.getDataURI()+"/"+c+"/exchangeRates"];if(typeof u=="undefined"){return}var t=[];for(var a=0;a<u.length;a++){p[u[a]].dataURI=u[a];t.push(p[u[a]])}o.loadData(t)}},jsonData:l,scope:this});o.on("load",this.ownerCt.ownerCt.loadSupplierExchangeRates,this.ownerCt.ownerCt)}}],sm:new Ext.grid.CheckboxSelectionModel({listeners:{rowselect:function(c,b,a){a.set("active",true)},rowdeselect:function(c,b,a){a.set("active",false)}}}),cm:new Ext.grid.ColumnModel([new Ext.grid.CheckboxSelectionModel(),{header:"Currency",dataIndex:"toCurrency",sortable:true,renderer:function(b){var a=TDS.data.currencies.getById(b);var c;if(typeof a!="undefined"){c='<div title="'+a.get("text")+'">'+b+"</div>"}else{c=b}return c}},{header:"Current",dataIndex:"modifier",sortable:true,width:80,fixed:true,editor:new Ext.form.TextField({vtype:"numeric"})},{header:"Difference (%)",dataIndex:"modifierDifference",sortable:true,editor:new Ext.form.TextField()},{header:"Today",dataIndex:"modifierToday",sortable:true},{header:"Max. Cut Off",dataIndex:"maxCutOff",sortable:true,width:75,fixed:true,editor:new Ext.form.TextField({vtype:"numeric"})},{header:"Min. Cut Off",dataIndex:"minCutOff",sortable:true,width:70,fixed:true,editor:new Ext.form.TextField({vtype:"numeric"})}]),viewConfig:{forceFit:true},selectRecords:function(){var a=[];this.getStore().each(function(b){if(b.get("active")==true){a.push(b)}});if(a.length>0){this.selModel.selectRecords(a,true)}},exchangeRatesLoaded:false,supplierExchangeRatesLoaded:false,isReady:function(){if(this.exchangeRatesLoaded&&this.supplierExchangeRatesLoaded){return true}return false},loadExchangeRates:function(){this.getView().refresh();this.exchangeRatesLoaded=true;if(this.isReady()){this.initExchangeRates()}},CalculatePercentageDifference:function(){var b;var a;var c;this.store.each(function(e){if((e.get("modifier")!="undefined"&&e.get("modifier")!=null&&e.get("modifier")!="")&&(e.get("modifierToday")!="undefined"&&e.get("modifierToday")!=null&&e.get("modifierToday")!="")){a=(parseFloat(e.get("modifierToday"))-parseFloat(e.get("modifier")));if(parseFloat(e.get("modifierToday"))>0){b=Math.round(100*(parseFloat(a)/parseFloat(e.get("modifierToday"))));var d=b.toFixed(8);e.set("modifierDifference",d)}}else{e.set("modifier",e.get("modifierToday"));e.set("modifierDifference",b)}e.commit()},this)},loadSupplierExchangeRates:function(){var b=0;this.store.each(function(c){if(parseInt(b)>8){return false}if(c.get("toCurrency")=="USD"){b=parseInt(b)+1;c.set("sortOrderNumber",1)}else{if(c.get("toCurrency")=="AUD"){b=parseInt(b)+1;c.set("sortOrderNumber",2)}else{if(c.get("toCurrency")=="GBP"){b=parseInt(b)+1;c.set("sortOrderNumber",3)}else{if(c.get("toCurrency")=="EUR"){b=parseInt(b)+1;c.set("sortOrderNumber",4)}else{if(c.get("toCurrency")=="CAD"){b=parseInt(b)+1;c.set("sortOrderNumber",5)}else{if(c.get("toCurrency")=="CYN"){b=parseInt(b)+1;c.set("sortOrderNumber",6)}else{if(c.get("toCurrency")=="INR"){b=parseInt(b)+1;c.set("sortOrderNumber",7)}else{if(c.get("toCurrency")=="JPY"){b=parseInt(b)+1;c.set("sortOrderNumber",8)}}}}}}}}},this);this.store.sort("toCurrency","ASC");var a=8;this.store.each(function(c){;if(c.get("sortOrderNumber")==""||c.get("sortOrderNumber")=="undefined"||c.get("sortOrderNumber")==null){a=parseInt(a)+1;c.set("sortOrderNumber",a)}else{}},this);this.store.sort("sortOrderNumber","ASC");this.supplierExchangeRatesLoaded=true;if(this.isReady()){this.initExchangeRates()}},initExchangeRates:function(){this.getStore().each(function(b){var a=this.storeExchangeRates.find("counterCurrency",b.get("toCurrency"));if(a!=-1){var c=this.storeExchangeRates.getAt(a);b.set("modifierToday",c.get("convertedModifier"));c.commit();b.commit()}},this);this.CalculatePercentageDifference();this.selectRecords()},listeners:{render:function(){var a=this.ownerCt.findParentByType("stdpanel");var b=a.getAjaxPanel().getData();var e=b.homeCurrency;this.colModel.setColumnHeader(2,"Current/"+e)},validateedit:function(n,h,k,j){var g=n.record;if(n.field=="modifier"){var f=n.value;var b=g.get("modifierToday");var d;var l;var p;if((f!="undefined"&&f!=null&&f!="")&&(b!="undefined"&&b!=null&&b!="")){l=(parseFloat(b)-parseFloat(f));if(parseFloat(b)>0){d=Math.round(100*(parseFloat(l)/parseFloat(b)));var a=d.toFixed(8);g.set("modifierDifference",a)}}}else{if(n.field=="modifierDifference"){var f=g.get("modifier");var b=g.get("modifierToday");var l=n.value;if((f!="undefined"&&f!=null&&f!="")&&(b!="undefined"&&b!=null&&b!="")){var c=(parseFloat(parseFloat(b)*parseFloat(l)))/100;var o=parseFloat(b)-parseFloat(c);var i=o.toFixed(8);g.set("modifier",i)}}}},beforerender:function(){var a=this.ownerCt.findParentByType("form");this.storeExchangeRates=new Ext.data.CollectionStore({autoLoad:true,url:TDS.env.dataPath+"exchangeRates/collection?currency="+a.getHomeCurrency(),identifier:"exchangeRates?currency="+a.getHomeCurrency(),id:"counterCurrency",fields:["dataURI","convertedBaseCurrency","convertedModifier","counterCurrency"]});this.storeExchangeRates.on("load",this.loadExchangeRates,this)}}}}}}]}]}