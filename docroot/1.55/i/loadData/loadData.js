{xtype:"form",border:false,bodyStyle:"padding: 8px;",autoScroll:true,fileStorePath:"",items:[{xtype:"panel",layout:"form",height:250,border:false,items:[{xtype:"panel",layout:"table",border:false,width:700,style:"padding-bottom:4px",layoutConfig:{columns:4},items:[{html:"Supplier:",border:false,width:105},{xtype:"combo",name:"supplierURI",fieldLabel:"Supplier",mode:"local",width:200,triggerAction:"all",editable:true,displayField:"name",valueField:"dataURI",store:TDS.data.getStore({dataURI:TDS.env.dataPath+"suppliers/collection/conciseLoadData",identifier:"suppliers",fields:["name","dataURI"]}),toggleButtons:function(){var d=this.ownerCt.findParentByType("form");this.ownerCt.items.itemAt(3).enable(true);d.el.mask("","x-mask-loading");document.getElementById("dataFileUpLoad").value="";d.fileStorePath="";d.items.itemAt(0).items.itemAt(5).disable(true);document.getElementById("dataFileUpLoad").value="";d.items.itemAt(0).items.itemAt(1).setValue("");d.items.itemAt(0).items.itemAt(2).setValue("");d.items.itemAt(0).items.itemAt(3).setValue("");d.items.itemAt(0).items.itemAt(4).setValue("");var e=d.items.itemAt(1);e.getStore().loadData([]);var b=this.getValue();var c=this.ownerCt.ownerCt.items.itemAt(1);var a=this.ownerCt.ownerCt.items.itemAt(1).getStore();var f=new Ext.data.SimpleStore({fields:["name","dataURI"],data:[[TDS.data.componentType.TYPE_ACCOMMODATION,TDS.data.componentType.TYPE_ACCOMMODATION],[TDS.data.componentType.TYPE_HOSTEL,TDS.data.componentType.TYPE_HOSTEL],[TDS.data.componentType.TYPE_TOUR,TDS.data.componentType.TYPE_TOUR],[TDS.data.componentType.TYPE_CAR,TDS.data.componentType.TYPE_CAR],[TDS.data.componentType.TYPE_RAIL,TDS.data.componentType.TYPE_RAIL],[TDS.data.componentType.TYPE_AIR,TDS.data.componentType.TYPE_AIR],[TDS.data.componentType.TYPE_CRUISE,TDS.data.componentType.TYPE_CRUISE],[TDS.data.componentType.TYPE_ATTRACTION_NEW,TDS.data.componentType.TYPE_ATTRACTION],[TDS.data.componentType.TYPE_TRANSFER,TDS.data.componentType.TYPE_TRANSFER],[TDS.data.componentType.TYPE_SIGHTSEEING_NEW,TDS.data.componentType.TYPE_SIGHTSEEING]]});a.removeAll();Ext.Ajax.request({url:TDS.env.dataPath+b,method:"GET",callback:function(j,g,h){if(g){var i=Ext.util.JSON.decode(h.responseText);f.each(function(k){if(!i.permittedComponentAccommodation&&k.data.dataURI=="ACCOMMODATION"){f.remove(k)}if(!i.permittedComponentAttraction&&k.data.dataURI=="ATTRACTION"){f.remove(k)}if(!i.permittedComponentCar&&k.data.dataURI=="CAR"){f.remove(k)}if(!i.permittedComponentCruise&&k.data.dataURI=="CRUISE"){f.remove(k)}if(!i.permittedComponentFlight&&k.data.dataURI=="AIR"){f.remove(k)}if(!i.permittedComponentHostel&&k.data.dataURI=="HOSTEL"){f.remove(k)}if(!i.permittedComponentRail&&k.data.dataURI=="RAIL"){f.remove(k)}if(!i.permittedComponentSightseeing&&k.data.dataURI=="SIGHTSEEING"){f.remove(k)}if(!i.permittedComponentTour&&k.data.dataURI=="TOUR"){f.remove(k)}if(!i.permittedComponentTransfer&&k.data.dataURI=="TRANSFER"){f.remove(k)}});f.each(function(k){a.add(k)});d.el.unmask()}}})},listeners:{select:function(){this.toggleButtons()}}},{html:" ",border:false,width:50},{xtype:"checkbox",disabled:true,boxLabel:"Load Common extras only.",listeners:{check:function(){var b=this.ownerCt.findParentByType("form");var a=b.items.itemAt(0).items.itemAt(1);var d=b.items.itemAt(0).items.itemAt(2);var e=b.items.itemAt(0).items.itemAt(3);var c=b.items.itemAt(0).items.itemAt(4);if(this.getValue()){a.setValue("");a.disable(true);d.setValue("");d.disable(true);e.setValue("");e.disable(true);c.setValue("");c.disable(true);b.items.itemAt(0).items.itemAt(5).enable(true)}else{a.enable(true);d.enable(true);b.items.itemAt(0).items.itemAt(5).disable(true)}}}}]},{xtype:"combo",name:"componentURI",fieldLabel:"Component",mode:"local",width:200,triggerAction:"all",editable:false,displayField:"name",valueField:"dataURI",store:new Ext.data.Store(),listeners:{select:function(){var c=this.ownerCt.findParentByType("form");c.el.mask("","x-mask-loading");document.getElementById("dataFileUpLoad").value="";c.fileStorePath="";c.items.itemAt(0).items.itemAt(5).disable(true);document.getElementById("dataFileUpLoad").value="";c.items.itemAt(0).items.itemAt(2).setValue("");c.items.itemAt(0).items.itemAt(3).setValue("");c.items.itemAt(0).items.itemAt(4).setValue("");var e=c.items.itemAt(1);e.getStore().loadData([]);var b=this.getValue();var d=this.ownerCt.items.itemAt(2);var f=this.ownerCt.items.itemAt(2).getStore();f.removeAll();if(b=="TOUR"){TDS.data.componentsTourDataLoadFor.each(function(a){f.add(a)})}else{if(b=="SIGHTSEEING"){TDS.data.componentsSightseeingDataLoadFor.each(function(a){f.add(a)})}else{if(b=="ACCOMMODATION"){TDS.data.componentsAccommodationDataLoadFor.each(function(a){f.add(a)})}else{if(b=="TRANSFER"){TDS.data.componentsTransferDataLoadFor.each(function(a){f.add(a)})}}}}c.el.unmask()}}},{xtype:"combo",name:"dataLoadFor",fieldLabel:"Loading data for",mode:"local",width:200,triggerAction:"all",editable:false,displayField:"name",valueField:"dataURI",store:new Ext.data.Store(),listeners:{select:function(){var d=this.ownerCt.findParentByType("form");d.el.mask("","x-mask-loading");var b=this.getValue();document.getElementById("dataFileUpLoad").value="";d.fileStorePath="";d.items.itemAt(0).items.itemAt(5).disable(true);document.getElementById("dataFileUpLoad").value="";d.items.itemAt(0).items.itemAt(3).setValue("");d.items.itemAt(0).items.itemAt(4).setValue("");var e=d.items.itemAt(1);e.getStore().loadData([]);TDS.data.commonStore.removeAll();var e=d.items.itemAt(1);e.getStore().loadData([]);var c=b.split("_");if(c[1]=="offering"){d.items.itemAt(0).items.itemAt(3).disable(true);d.items.itemAt(0).items.itemAt(4).disable(true);d.items.itemAt(0).items.itemAt(5).enable(true);if(b=="tour_offering"){TDS.data.commonStore.data.addAll(TDS.data.tourOfferingTableMaping.data.items)}else{if(b=="sightseeing_offering"){TDS.data.commonStore.data.addAll(TDS.data.sightseeingOfferingTableMaping.data.items)}else{if(b=="accommodation_offering"){TDS.data.commonStore.data.addAll(TDS.data.accommodationOfferingTableMaping.data.items)}else{if(b=="transfer_offering"){TDS.data.commonStore.data.addAll(TDS.data.transferOfferingTableMaping.data.items)}}}}d.el.unmask()}else{if(c[1]=="rate"){d.items.itemAt(0).items.itemAt(5).enable(true);d.items.itemAt(0).items.itemAt(4).disable(true);if(b=="tour_rate"){TDS.data.commonStore.data.addAll(TDS.data.tourRateTableMaping.data.items)}else{if(b=="sightseeing_rate"){TDS.data.commonStore.data.addAll(TDS.data.sightseeingRateTableMaping.data.items)}else{if(b=="accommodation_rate"){TDS.data.commonStore.data.addAll(TDS.data.accommodationRateTableMaping.data.items)}else{if(b=="transfer_rate"){TDS.data.commonStore.data.addAll(TDS.data.transferRateTableMaping.data.items)}}}}d.el.unmask()}else{if(c[1]=="extra"){d.items.itemAt(0).items.itemAt(5).disable(true);d.items.itemAt(0).items.itemAt(3).enable(true);d.items.itemAt(0).items.itemAt(4).disable(true);var f=d.items.itemAt(0).items.itemAt(3).getStore();f.removeAll();if(!d.items.itemAt(0).items.itemAt(0).items.itemAt(1).getValue()){d.el.unmask();return}Ext.Ajax.request({url:TDS.env.dataPath+c[0]+"/offerings/collection?supplierURI="+d.items.itemAt(0).items.itemAt(0).items.itemAt(1).getValue(),method:"GET",disableCaching:false,callback:function(n,g,j){if(g){var h=Ext.util.JSON.decode(j.responseText);var m=h[c[0]+"/offerings?supplierURI="+d.items.itemAt(0).items.itemAt(0).items.itemAt(1).getValue()];if(typeof m=="undefined"){return}var k=[];for(var a=0;a<m.length;a++){h[m[a]].dataURI=m[a];var l=new Ext.data.Record(h[m[a]]);k.push(l)}f.add(k);d.el.unmask();TDS.data.commonStore.removeAll()}}});if(b=="tour_extra"){TDS.data.commonStore.data.addAll(TDS.data.tourOfferingTableMaping.data.items)}else{if(b=="sightseeing_extra"){TDS.data.commonStore.data.addAll(TDS.data.sightseeingOfferingTableMaping.data.items)}else{if(b=="accommodation_extra"){TDS.data.commonStore.data.addAll(TDS.data.accommodationOfferingTableMaping.data.items)}else{if(b=="transfer_extra"){TDS.data.commonStore.data.addAll(TDS.data.transferOfferingTableMaping.data.items)}}}}}}}}}},{xtype:"combo",name:"offerings",fieldLabel:"Offerings",mode:"local",width:200,triggerAction:"all",editable:false,disabled:true,displayField:"name",valueField:"dataURI",store:new Ext.data.Store(),listeners:{select:function(){var f=this.ownerCt.findParentByType("form");f.el.mask("","x-mask-loading");document.getElementById("dataFileUpLoad").value="";f.fileStorePath="";f.items.itemAt(0).items.itemAt(5).disable(true);document.getElementById("dataFileUpLoad").value="";f.items.itemAt(0).items.itemAt(4).setValue("");var h=f.items.itemAt(1);h.getStore().loadData([]);var d=this.getValue();var c=f.items.itemAt(0).items.itemAt(2).getValue();TDS.data.commonStore.removeAll();var e=c.split("_");if(e[1]=="rate"){f.items.itemAt(0).items.itemAt(5).enable(true);f.items.itemAt(0).items.itemAt(4).disable(true)}else{if(e[1]=="extra"){f.items.itemAt(0).items.itemAt(4).enable(true);f.items.itemAt(0).items.itemAt(5).disable(true);var i=f.items.itemAt(0).items.itemAt(4).getStore();i.removeAll();if(!f.items.itemAt(0).items.itemAt(3).getValue()){f.el.unmask();return}Ext.Ajax.request({url:TDS.env.dataPath+f.items.itemAt(0).items.itemAt(3).getValue()+"/rates/collection?nameLike=",method:"GET",disableCaching:false,callback:function(n,b,j){if(b){var g=Ext.util.JSON.decode(j.responseText);var m=g[f.items.itemAt(0).items.itemAt(3).getValue()+"/rates?nameLike="];if(typeof m=="undefined"){return}var k=[];for(var a=0;a<m.length;a++){g[m[a]].dataURI=m[a];var l=new Ext.data.Record(g[m[a]]);k.push(l)}i.add(k);f.el.unmask();TDS.data.commonStore.removeAll()}}})}}f.el.unmask()}}},{xtype:"combo",name:"rates",fieldLabel:"Rates",mode:"local",width:200,triggerAction:"all",editable:false,disabled:true,displayField:"name",valueField:"dataURI",store:new Ext.data.Store(),listeners:{select:function(){var a=this.ownerCt.findParentByType("form");a.items.itemAt(0).items.itemAt(5).enable(true);document.getElementById("dataFileUpLoad").value="";a.fileStorePath="";var b=a.items.itemAt(1);b.getStore().loadData([])}}},{xtype:"panel",layout:"table",border:false,width:400,disabled:true,layoutConfig:{columns:4},items:[{bodyStyle:"padding-right: 20px;",border:false,html:'<form action="dataFileUpLoad" enctype="multipart/form-data" method="post"><td width= "300"><input width= "290" name="dataFileUpLoad" id="dataFileUpLoad"type="file"  /></td></form>',width:300},{border:false,html:" &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"},{xtype:"button",text:"Upload",style:"padding: 6px 0px 0px 0px;",handler:function(c){var f=document.getElementById("dataFileUpLoad").files[0];var a="dataFile";var l=this.ownerCt.findParentByType("form");var h=l.items.itemAt(0).items.itemAt(0).items.itemAt(1).getValue();var j=this.ownerCt.ownerCt.ownerCt.items.itemAt(1);var b=this.ownerCt.items.itemAt(3);if(f){b.show();var d=new FormData();d.append("image",f);var n=new XMLHttpRequest();n.upload.addEventListener("progress",i,false);n.addEventListener("load",k,false);n.addEventListener("error",e,false);n.addEventListener("abort",m,false);n.open("POST",TDS.env.dataPath+"uploadDataFile?&fileName=dataFile.xls");n.send(d);n.onreadystatechange=function(){if(n.readyState==4){var p=n.getAllResponseHeaders();var q=n.responseText;l.fileStorePath=q;var g={};g.absoluteDataFilePath=q;g.componentType=l.items.itemAt(0).items.itemAt(1).getValue();g.offeringDataURI=l.items.itemAt(0).items.itemAt(3).getValue();g.rateDataURI=l.items.itemAt(0).items.itemAt(4).getValue();var o=l.items.itemAt(0).items.itemAt(0).items.itemAt(3).getValue();if(o||g.rateDataURI){Ext.Ajax.request({url:TDS.env.dataPath+h+"/uploadExcelData/extrasOnly",method:"PUT",disableCaching:false,jsonData:g,callback:function(v,t,u){if(t){Ext.Msg.alert("",u.responseText,function(){b.hide(true)});l.items.itemAt(0).items.itemAt(5).disable(true);document.getElementById("dataFileUpLoad").value="";l.items.itemAt(0).items.itemAt(0).items.itemAt(1).setValue("");l.items.itemAt(0).items.itemAt(0).items.itemAt(3).disable(true);l.items.itemAt(0).items.itemAt(0).items.itemAt(3).setValue(false);l.items.itemAt(0).items.itemAt(1).setValue("");l.items.itemAt(0).items.itemAt(2).setValue("");l.items.itemAt(0).items.itemAt(3).setValue("");l.items.itemAt(0).items.itemAt(4).setValue("");l.items.itemAt(0).items.itemAt(1).getStore().removeAll();l.items.itemAt(0).items.itemAt(2).getStore().removeAll();l.items.itemAt(0).items.itemAt(3).getStore().removeAll();l.items.itemAt(0).items.itemAt(4).getStore().removeAll()}}})}else{Ext.Ajax.request({url:TDS.env.dataPath+h+"/uploadDataFile",method:"PUT",disableCaching:false,jsonData:g,callback:function(z,u,w){if(u){var v=Ext.util.JSON.decode(w.responseText);var y=v.columnDetails;if(typeof y=="undefined"){return}var x=[];for(var t=0;t<y.length;t++){x.push(v[y[t]])}j.getStore().loadData(x);b.hide(true)}}})}}else{l.fileStorePath=""}}}function i(g){}function k(g){}function e(g){Ext.Msg.alert("","There was an error attempting to upload the file.")}function m(g){Ext.Msg.alert("","The upload has been canceled by the user or the browser dropped the connection.")}}},{border:false,hidden:true,html:'<input type="image" src="images/shared/blue-loading.gif" height="25px"> '}]},{xtype:"button",text:"Clear",style:"padding: 6px 0px 0px 0px;",handler:function(b){var a=this.ownerCt.findParentByType("form");a.items.itemAt(0).items.itemAt(5).disable(true);document.getElementById("dataFileUpLoad").value="";a.items.itemAt(0).items.itemAt(0).items.itemAt(1).setValue("");a.items.itemAt(0).items.itemAt(0).items.itemAt(3).disable(true);a.items.itemAt(0).items.itemAt(0).items.itemAt(3).setValue(false);a.items.itemAt(0).items.itemAt(1).setValue("");a.items.itemAt(0).items.itemAt(2).setValue("");a.items.itemAt(0).items.itemAt(3).setValue("");a.items.itemAt(0).items.itemAt(4).setValue("");a.items.itemAt(0).items.itemAt(1).getStore().removeAll();a.items.itemAt(0).items.itemAt(2).getStore().removeAll();a.items.itemAt(0).items.itemAt(3).getStore().removeAll();a.items.itemAt(0).items.itemAt(4).getStore().removeAll();var c=a.items.itemAt(1);c.getStore().loadData([])}},{border:false,html:' <table  height="50px" width=100%><tr><td><u><b>Note</b></u>: when uploading the extras please maintain the column order as bellow </br><b>Component name, Extra name, Category, Min. inventory rewquired, Required, Available for all rates, Price is nett or gross, Price, Commission, Notes.</b></br>* No mapping require for Extras the data will be loaded on upload.</td></tr></table>'}]},{xtype:"editorgrid",width:570,height:250,border:false,enableColumndisable:false,enableColumnMove:false,enableColumnResize:false,enableHdMenu:false,tbar:[{xtype:"redbutton",text:"Start loading..",style:"padding: 0px 0px 0px 0px;",handler:function(d){var i=this.ownerCt.findParentByType("form");var b=this.ownerCt.items.itemAt(1);if(!i.fileStorePath){return}b.show();var h=this.ownerCt.ownerCt;var e=this.ownerCt.ownerCt.ownerCt.items.itemAt(0).items.itemAt(0).items.itemAt(1).getValue();if(!e){return}var m=h.getStore();var c={};for(var f=0;f<m.data.length;f++){var l={};l.columns=m.data.items[f].data.columns;l.exactName=m.data.items[f].data.exactName;c[f]=l}var k={};k.columnMaping=c;k.tableName=i.items.itemAt(0).items.itemAt(2).getValue();k.absoluteDataFilePath=i.fileStorePath;Ext.Ajax.request({url:TDS.env.dataPath+e+"/uploadExcelData",method:"PUT",disableCaching:false,jsonData:k,callback:function(p,a,n){if(a){Ext.Msg.alert(" ",n.responseText,function(){b.hide(true)});document.getElementById("dataFileUpLoad").value="";i.fileStorePath="";i.items.itemAt(0).items.itemAt(5).disable(true);document.getElementById("dataFileUpLoad").value="";i.items.itemAt(0).items.itemAt(0).items.itemAt(1).setValue("");i.items.itemAt(0).items.itemAt(0).items.itemAt(3).disable(true);i.items.itemAt(0).items.itemAt(0).items.itemAt(3).setValue(false);i.items.itemAt(0).items.itemAt(1).setValue("");i.items.itemAt(0).items.itemAt(2).setValue("");i.items.itemAt(0).items.itemAt(3).setValue("");i.items.itemAt(0).items.itemAt(4).setValue("");i.items.itemAt(0).items.itemAt(1).getStore().removeAll();i.items.itemAt(0).items.itemAt(2).getStore().removeAll();i.items.itemAt(0).items.itemAt(3).getStore().removeAll();i.items.itemAt(0).items.itemAt(4).getStore().removeAll();var j=i.items.itemAt(1);j.getStore().loadData([])}}})}},'<input type="image" src="images/shared/blue-loading.gif" height="20px">'],viewConfig:{forceFit:true},store:new Ext.data.JsonStore({url:"",id:"dataURI",fields:["columns","exactName"]}),sm:new Ext.grid.RowSelectionModel(),columns:[{header:"Column name in given File",dataIndex:"columns"},{header:"Exact name with respect to ARENA",dataIndex:"exactName",editor:new Ext.form.ComboBox({store:TDS.data.commonStore,editable:false,forceSelection:true,mode:"local",triggerAction:"all",displayField:"name",valueField:"dataURI",listeners:{expand:function(){this.bindStore(TDS.data.commonStore)}}})}],listeners:{render:function(){this.topToolbar.items.itemAt(1).hide(true)}}}]}