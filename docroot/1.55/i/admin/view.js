{xtype:"form",id:"form",border:false,autoScroll:true,bodyStyle:"padding: 8px;",getDataURI:function(){return this.ownerCt.ownerCt.getDataURI()},getSessionURI:function(){return this.ownerCt.ownerCt.getSessionURI()},getSessionValue:function(a){return this.ownerCt.ownerCt.getSession(a)},getFormData:function(){var a=this.ownerCt.findParentByType("stdpanel");return a.getAjaxPanel().getData()},reloadData:function(){var a=this.ownerCt.findParentByType("stdpanel");a.getAjaxPanel().reloadData({callback:function(b,c,d){this.getForm().setValues(d)},scope:this});this.getForm().setValues(a.getAjaxPanel().getData())},listeners:{render:function(){var a=this.ownerCt.findParentByType("stdpanel")}},items:[{xtype:"panel",border:false,hideBorders:true,height:500,layout:"column",items:[{columnWidth:0.6,bodyStyle:"padding-right: 8px;",items:{xtype:"panel",border:false,layout:"fit",width:775,height:450,hideBorders:true,items:{xtype:"fieldset",title:"Exchange rates",border:false,collapsible:true,autoHeight:true,height:350,items:{xtype:"editorgrid",height:400,storeExchangeRates:undefined,store:new Ext.data.JsonStore({fields:["dataURI","fromCurrency","toCurrency","modifier","active","modifierToday","sortOrderNumber","modifierDifference","maxCutOff","minCutOff"]}),tbar:["Currency: ",{xtype:"combo",id:"yy",store:TDS.data.currencies,fieldLabel:"Home currency",width:180,editable:false,forceSelection:true,mode:"local",triggerAction:"all",displayField:"text",valueField:"value",tpl:'<tpl for="."><div class="x-combo-list-item">{text}, <span style="font-style: italic; font-size: 10px; color: #999;">{value}</span></div></tpl>',value:"...",listeners:{select:function(){var a=this.getValue();var b=Ext.getCmp("yy").findParentByType("editorgrid");Ext.getCmp("yy").findParentByType("editorgrid").getStore().removeAll();Ext.getCmp("yy").findParentByType("editorgrid").getView().refresh();b.storeExchangeRates=new Ext.data.CollectionStore({autoLoad:true,url:TDS.env.dataPath+"admin/base/exchangeRates/collection?currency="+a,identifier:"exchangeRates?currency="+a,id:"counterCurrency",fields:["dataURI","convertedBaseCurrency","convertedModifier","counterCurrency"]});b.store=new Ext.data.CollectionStore({autoLoad:true,url:TDS.env.dataPath+"admin/exchangeRates/collection",identifier:"admin/exchangeRates",id:"dataURI",fields:["dataURI","fromCurrency","toCurrency","modifier","active","modifierToday","sortOrderNumber","modifierDifference"]});b.storeExchangeRates.on("load",b.loadExchangeRates,b);b.store.on("load",b.loadSupplierExchangeRates,b)}}},{xtype:"tbfill"},{xtype:"button",text:"Save",handler:function(){var h=this.ownerCt.ownerCt;var k=this.ownerCt.findParentByType("form");var n="admin/exchangeRates";var c=h.getStore().getModifiedRecords();var d=h.getSelections();var j=[];var m={};var a={};for(var e=0;e<c.length;e++){var f=c[e];var l=f.get("dataURI");var b=f.get("modifierDifference");m[l]={modifier:f.get("modifier"),active:f.get("active"),maxCutOff:f.get("maxCutOff"),minCutOff:f.get("minCutOff"),modified:b};j.push(l)}m[n]=j;TDS.env.user.getSupplierURI();console.log(TDS.env.user.getSupplierURI());Ext.Ajax.request({url:TDS.env.dataPath+"admin/exchangeRates/collection",method:"PUT",headers:{"Content-Type":"application/json"},callback:function(p,g,i){if(g){h.getStore().reload()}},jsonData:m,scope:this})}}],sm:new Ext.grid.CheckboxSelectionModel({listeners:{rowselect:function(f,d,e){e.set("active",true)},rowdeselect:function(f,d,e){e.set("active",false)}}}),cm:new Ext.grid.ColumnModel([new Ext.grid.CheckboxSelectionModel(),{header:"Currency",dataIndex:"toCurrency",sortable:true,width:80,renderer:function(d){var e=TDS.data.currencies.getById(d);var f;if(typeof e!="undefined"){f='<div title="'+e.get("text")+'">'+d+"</div>"}else{f=d}return f}},{header:"Current",dataIndex:"modifier",sortable:true,fixed:true,editor:new Ext.form.TextField({vtype:"numeric"})},{header:"Difference (%)",dataIndex:"modifierDifference",sortable:true,editor:new Ext.form.TextField()},{header:"Today",dataIndex:"modifierToday",sortable:true},{header:"Max. Cut Off",dataIndex:"maxCutOff",sortable:true,fixed:true,editor:new Ext.form.TextField({vtype:"numeric"})},{header:"Min. Cut Off",dataIndex:"minCutOff",sortable:true,fixed:true,editor:new Ext.form.TextField({vtype:"numeric"})}]),viewConfig:{forceFit:true},selectRecords:function(){var b=[];this.getStore().each(function(a){if(a.get("active")==true){b.push(a)}});if(b.length>0){this.selModel.selectRecords(b,true)}},exchangeRatesLoaded:false,supplierExchangeRatesLoaded:false,isReady:function(){if(this.exchangeRatesLoaded){return true}return false},loadExchangeRates:function(){this.exchangeRatesLoaded=true;if(this.isReady()){this.initExchangeRates()}},CalculatePercentageDifference:function(){var d;var e;var f;this.store.each(function(a){if((a.get("modifier")!="undefined"&&a.get("modifier")!=null&&a.get("modifier")!="")&&(a.get("modifierToday")!="undefined"&&a.get("modifierToday")!=null&&a.get("modifierToday")!="")){e=(parseFloat(a.get("modifierToday"))-parseFloat(a.get("modifier")));if(parseFloat(a.get("modifierToday"))>0){d=Math.round(100*(parseFloat(e)/parseFloat(a.get("modifierToday"))));var b=d.toFixed(8);a.set("modifierDifference",b)}}else{a.set("modifier",a.get("modifierToday"));a.set("modifierDifference",d)}a.commit()},this)},loadSupplierExchangeRates:function(){var c=0;this.store.each(function(a){if(parseInt(c)>8){return false}if(a.get("toCurrency")=="USD"){c=parseInt(c)+1;a.set("sortOrderNumber",1)}else{if(a.get("toCurrency")=="AUD"){c=parseInt(c)+1;a.set("sortOrderNumber",2)}else{if(a.get("toCurrency")=="GBP"){c=parseInt(c)+1;a.set("sortOrderNumber",3)}else{if(a.get("toCurrency")=="EUR"){c=parseInt(c)+1;a.set("sortOrderNumber",4)}else{if(a.get("toCurrency")=="CAD"){c=parseInt(c)+1;a.set("sortOrderNumber",5)}else{if(a.get("toCurrency")=="CYN"){c=parseInt(c)+1;a.set("sortOrderNumber",6)}else{if(a.get("toCurrency")=="INR"){c=parseInt(c)+1;a.set("sortOrderNumber",7)}else{if(a.get("toCurrency")=="JPY"){c=parseInt(c)+1;a.set("sortOrderNumber",8)}}}}}}}}},this);this.store.sort("toCurrency","ASC");var d=8;this.store.each(function(a){if(a.get("sortOrderNumber")==""||a.get("sortOrderNumber")=="undefined"||a.get("sortOrderNumber")==null){d=parseInt(d)+1;a.set("sortOrderNumber",d)}else{}},this);this.store.sort("sortOrderNumber","ASC");this.supplierExchangeRatesLoaded=true;if(this.isReady()){console.log("SSSSSSSSSS                SSSSSS");this.initExchangeRates();Ext.getCmp("yy").findParentByType("editorgrid").getView().refresh()}},initExchangeRates:function(){this.getStore().each(function(d){var e=this.storeExchangeRates.find("counterCurrency",d.get("toCurrency"));if(e!=-1){var f=this.storeExchangeRates.getAt(e);d.set("modifierToday",f.get("convertedModifier"));f.commit();d.commit()}},this);this.CalculatePercentageDifference()},listeners:{validateedit:function(q,v,s,t){var w=q.record;if(q.field=="modifier"){var x=q.value;var A=w.get("modifierToday");var y;var r;var e;if((x!="undefined"&&x!=null&&x!="")&&(A!="undefined"&&A!=null&&A!="")){r=(parseFloat(A)-parseFloat(x));if(parseFloat(A)>0){y=Math.round(100*(parseFloat(r)/parseFloat(A)));var B=y.toFixed(8);w.set("modifierDifference",B)}}}else{if(q.field=="modifierDifference"){var x=w.get("modifier");var A=w.get("modifierToday");var r=q.value;if((x!="undefined"&&x!=null&&x!="")&&(A!="undefined"&&A!=null&&A!="")){var z=(parseFloat(parseFloat(A)*parseFloat(r)))/100;var m=parseFloat(A)-parseFloat(z);var u=m.toFixed(8);w.set("modifier",u)}}}},beforerender:function(){var a=this.ownerCt.findParentByType("form");this.storeExchangeRates=new Ext.data.CollectionStore({autoLoad:true,url:TDS.env.dataPath+"exchangeRates/collection?currency=AUD",identifier:"exchangeRates?currency=AUD",id:"counterCurrency",fields:["dataURI","convertedBaseCurrency","convertedModifier","counterCurrency"]});this.store=new Ext.data.CollectionStore({autoLoad:true,url:TDS.env.dataPath+"admin/exchangeRates/collection",identifier:"admin/exchangeRates",id:"dataURI",fields:["dataURI","fromCurrency","toCurrency","modifier","active","modifierToday","sortOrderNumber","modifierDifference"]});this.storeExchangeRates.on("load",this.loadExchangeRates,this);this.store.on("load",this.loadSupplierExchangeRates,this)}}}}}},{columnWidth:0.4,layout:"fit",bodyStyle:"padding-right: 6px;",items:{xtype:"panel",border:false,width:500,height:450,hideBorders:true,items:[{xtype:"fieldset",title:"Booking Fee ",collapsible:true,height:200,items:[{xtype:"panel",layout:"form",height:80,border:false,defaults:{style:"padding: 2px 5px 2px 5px;"},items:[{xtype:"numberfield",decimalPrecision:2,forceDecimals:true,name:"financialContactName",fieldLabel:"Booking Fees per pax USD",labelStyle:"width:150px;",listeners:{blur:function(a,b){a.setRawValue(a.getValue().toFixed(2))}}},{xtype:"numberfield",decimalPrecision:2,forceDecimals:true,name:"financialContactName",labelStyle:"width:150px;",fieldLabel:"Capped At USD",listeners:{blur:function(a,b){a.setRawValue(a.getValue().toFixed(2))}}}]},{xtype:"button",style:"padding-top:25px;",name:"financialContactName",text:"Submit"}]},{xtype:"fieldset",title:"Title",collapsible:true,height:220}]}}]}]}