{xtype:"panel",border:false,layout:"column",items:[{requireStores:[{dataURI:TDS.env.dataPath+"tour/types/collection",identifier:"tour/types",fields:["name","dataURI"]},{dataURI:TDS.env.dataPath+"tour/classes/collection",identifier:"tour/classes",fields:["name","dataURI"]},{dataURI:TDS.env.dataPath+"tour/extracategories/collection",identifier:"tour/extracategories",fields:["name","dataURI"]},{dataURI:TDS.env.dataPath+"rate/classes/collection",identifier:"rate/classes",fields:["name","dataURI"]},{dataURI:TDS.env.dataPath+"rate/pers/collection",identifier:"rate/pers",fields:["name","dataURI"]},{dataURI:TDS.env.dataPath+"rate/occupancies/collection",identifier:"rate/occupancies",fields:["name","dataURI"]}],xtype:"panel",height:200,border:false,frame:false,layout:"column",columnWidth:0.95,getAgencyPanel:function(){return this.items.itemAt(0)},getDetailsPanel:function(){return this.items.itemAt(1)},getPassengersPanel:function(){return this.items.itemAt(2)},hasDetailsInventory:false,hasDetailsOffering:false,isDetailsReady:function(){if(this.hasDetailsInventory&&this.hasDetailsOffering){return true}return false},items:[{xtype:"panel",layout:"column",columnWidth:0.12,hideBorders:true,height:200,items:[{tpl:new Ext.XTemplate(['<div style="height:125px;  overflow-y: scroll;">',"<p><b>Agent:</b> {agencyName}</p>","<p><b>Consultant:</b> {consultantName}</p>","<p><b>Tel:</b> {telephoneNo}</p>","<p><b>Email:</b> {email}</p>","<p><b>Location:</b> {agentLocation}</p>","<p><b>Country:</b> {country}</p>","<p><b>Date / Time:</b> {bookingDateTime}</p>","</div>"]),listeners:{render:function(){var d=this.ownerCt.findParentByType("tabpanel");var c=d.getComponentDetail("agencyURI");Ext.Ajax.request({url:TDS.env.dataPath+c+"?forceGet=true",method:"GET",callback:function(a,i,e){if(i){try{var j=Ext.util.JSON.decode(e.responseText);this.tpl.overwrite(this.body,{agencyName:TDS.util.Format.displayResourceName(c),consultantName:d.getComponentDetail("createdByUserFullNameString"),telephoneNo:j.phoneNumber,email:j.email,agentLocation:j.locality,country:TDS.util.Format.displayResourceName(j.countryURI),bookingDateTime:TDS.util.Format.dateSpecial(d.getComponentDetail("createdDate"),TDS.env.dateTimeFormatDisplay)})}catch(b){}}},scope:this,disableCaching:true})}}}]},{columnWidth:0.5,xtype:"panel",height:200,border:true,tpl:new Ext.XTemplate('<div style="height:125px;overflow-y: scroll; ">','<table class="x-tds-dataview" style="width: 100%;" border=1 cellpadding = 1 cellspacing=0  >','<tr style="background-color: #d0def0;" >','<th style="padding: 2px; width: 28%;">Tour Name</th>','<th style="padding: 2px; width: 16%;">Type</th>','<th style="padding: 2px; width: 18%;">From City.</th>','<th style="padding: 2px; width: 12%;">Dep Date</th>','<th style="padding: 2px; width: 18%;">To City</th>','<th style="padding: 2px; width: 12%;">Duration</th>',"</tr>","<tr>","<td>{name}</td>","<td>{tourType}</td>","<td>{fromLocationString}</td>","<td>{dateFrom}</td>","<td>{toLocationString}</td>","<td>{duration}</td>","</tr>","</table>",'<table class="x-tds-dataview" style="width: 100%;" border=1 cellpadding = 1 cellspacing=0  >','<tr style="background-color: #d0def0;" >','<th style="padding: 2px; width: 25%;">Rate</th>','<th style="padding: 2px; width: 25%;">Room Type</th>','<th style="padding: 2px; width: 10%;">Pax Type</th>','<th style="padding: 2px; width: 5%;">No.</th>','<th style="padding: 2px; width: 15%;">Price</th>','<th style="padding: 2px; width: 15%;">Status</th>',"</tr>","{rateBody}","</table>",'<table class="x-tds-dataview" style="width: 100%;" border=1 cellpadding = 1 cellspacing=0  >','<tr style="background-color: #C0D9D9;">','<th style="padding: 2px; width: 14%;">Tour Price</th>','<th style="padding: 2px; width: 13%;">Gross/Net</th>','<th style="padding: 2px; width: 14%;">Extras</th>','<th style="padding: 2px; width: 20%;">Total Price ({grossOrNet})</th>','<th style="padding: 2px; width: 7%;">Comm%</th>',"</tr>","<tr>","<td>{tourPrice}</td>","<td>{grossOrNet}</td>","<td>{extras}</td>","<td>{totalPrice}</td>","<td>{comm}</td>","</tr>","</table>","</div>")},{xtype:"panel",height:150,columnWidth:0.38,layout:"fit",typeStatusMap:{},items:[{xtype:"grid",enableRowExpander:false,sessionExpandedRows:false,height:110,autoScroll:true,border:false,enableColumnHide:false,enableColumnMove:false,enableColumnResize:false,enableHdMenu:false,store:new Ext.data.JsonStore({url:"",id:"dataURI",fields:["dataURI","displayName","code","roomType","dateOfBirth","addressString","phoneNumber1","emailAddress","gender","status","abstractRateId"]}),columns:[{header:"Passenger",dataIndex:"displayName",width:120,fixed:true,sortable:true,renderer:function(j,k,h,i,l,g){return j}},{header:"Type",dataIndex:"code",width:40,fixed:true},{header:"Gender",dataIndex:"gender",renderer:TDS.util.Format.gender,width:50,fixed:true},{header:"DOB",dataIndex:"dateOfBirth",width:70,fixed:true,renderer:TDS.util.Format.dateSpecialRenderer(TDS.env.dateBirthdayFormatDisplay)},{header:"Age",dataIndex:"dateOfBirth",renderer:TDS.util.Format.age,width:40,fixed:true},{header:"Room Type",dataIndex:"roomType",width:70,fixed:true},{header:"Price",dataIndex:"price",width:40,fixed:true},{header:"Status",dataIndex:"status",width:50,fixed:true}],viewConfig:{forceFit:true},listeners:{render:function(){this.getEl().swallowEvent(["columnmove","columnresize","headerclick","click","mouseout","rowclick","rowmousedown","rowdbclick","cellblclick","sortchange","mouseup","mousedown"]);var c=this.ownerCt.findParentByType("tabpanel");var d=c.getComponentDetail("dataURI");Ext.Ajax.request({url:TDS.env.dataPath+d+"/passengers/collection/concise",method:"GET",callback:function(o,a,q){if(a){var i=Ext.util.JSON.decode(q.responseText);var m=i[d+"/passengers"];if(typeof m=="undefined"){return}var b=[];for(var n=0;n<m.length;n++){i[m[n]].dataURI=m[n];b.push(i[m[n]])}var p=this;var r=p.store;r.loadData(b);p.getView().refresh()}},scope:this})}}}]}],listeners:{render:function(){var b=this;setTimeout(function(){b.initInventory();b.initOffering()},500)}},initInventory:function(){var h=this.ownerCt.findParentByType("tabpanel");var g=h.getComponentDetail("dataURI");var i=g;var j=new Array();var f=0;Ext.Ajax.request({url:TDS.env.dataPath+g+"/inventories/collection",method:"GET",callback:function(ab,af,ad){var ap=this.getPassengersPanel();var c=this.ownerCt.findParentByType("tabpanel");if(af){try{var aj=Ext.decode(ad.responseText)}catch(e){}if(aj){var ar=0,ai,aa=[];var ak=0;var r=aj["component/inventory/collection"];var aA=r[g+"/inventories"];var ac=aj["component/rate/collection/"];var aC=ac["component/rate/collection/list"];var au=ac.TOUR_TYPR_STRING;c.setDetail("rateList",aC);var ae=new Array();var aq="";this.rateData=[];var a=aA.length/aC.length;var Z=[];var ao="";var o=[];var at=0;if(aA.length>0){for(var s=0;s<aA.length;s++){var d=r[aA[s]];aa[aa.length]=TDS.util.Format.dateSpecial(d.componentPaybyDate,TDS.env.dateFormatDisplay);ao=d.pricingPriceCurrency;if(o.indexOf(d.rateId)==-1){o[s]=d.rateId;Z[at]=TDS.util.Price.calculateFixedGrossNettPrice({pricingPriceCurrency:d.pricingPriceCurrency,pricingPriceSell:d.pricingPriceSell,pricingPriceCommission:d.pricingPriceCommission,pricingPriceIsNett:d.pricingPriceIsNett});Z[at].rateId=d.rateId;Z[at].quantity=d.quantity;at++}}var ag="";var ax=false;var am=0;var M=0;if(aC.length>0){for(var s=0;s<aC.length;s++){var an=ac[aC[s]];M=an.extraTotal;aq=ac[aC[s]].tempBookedDate;var ah=[];var az="";var aw="";var b=[];var av=null;for(var X=0;X<Z.length;X++){if(Z[X].rateId==aC[s].substring(aC[s].lastIndexOf("/")+1,aC[s].length)){av=Z[X]}}ax=av.priceIsNett;if(!av.priceIsNett){az=av.priceCommissionPercentage;if(typeof az=="undefined"){az="0%"}}else{aw=av.priceCommission;ak+=(av.quantity*av.priceCommission)}am+=(av.quantity*av.priceSell);ag+="<tr>";ag+="<td>"+an.nameString+"</td>",ag+="<td>"+ah[1]+"</td>",ag+="<td>"+b[0]+"</td>",ag+="<td>"+av.quantity+"</td>",ag+="<td>"+TDS.util.Price.formatPrice(av.priceSell,av.priceCurrency)+"</td>",ag+="<td>"+c.getComponentDetail("status")+"</td>",ag+="</tr>"}}var aB="";var al=am;am+=ak;am+=M;if(aa.length>0){var ay=aa[0]}else{var ay=aa}c.setComponentDetail("pricingPriceCurrency",ao);this.inventoryData={name:c.getComponentDetail("name"),fromLocationString:c.getComponentDetail("locationFromString"),toLocationString:c.getComponentDetail("locationToString"),dateFrom:TDS.util.Format.dateSpecial(c.getComponentDetail("dateFrom"),TDS.env.dateFormatDisplay),duration:c.getComponentDetail("duration"),divDataUri:i,rateBody:ag,numberOfNights:a,dates:ay,markup:ak.toFixed(2),pnrCode:ae[1],bookeddateDis:aq,total:am.toFixed(2),extraTotal:M.toFixed(2),tourType:au,priceCurrency:ao,tourPrice:TDS.util.Price.formatPrice(al,ao),grossOrNet:(ax?"Nett":"Gross"),extras:TDS.util.Price.formatPrice(M,ao),markUp:ak,totalPrice:TDS.util.Price.formatPrice(am,ao),comm:aB};this.hasDetailsInventory=true;if(this.isDetailsReady()){this.displayDetails()}}}}},scope:this})},initOffering:function(){var f=this.ownerCt.findParentByType("tabpanel");var d=f.getComponentDetail("offeringURI");var e;Ext.Ajax.request({url:TDS.env.dataPath+d,method:"GET",callback:function(a,k,c){if(k){try{var j=Ext.decode(c.responseText)}catch(b){}if(j){this.offeringData={locationFromString:j.locationFromString,locationsString:j.locationsString,website:j.primaryHref,addressString:j.addressString,notes:j.notes,tourClass:TDS.util.Format.displayResourceName(j.tourClassURI)};this.hasDetailsOffering=true;if(this.isDetailsReady()){this.displayDetails()}}}},scope:this})},displayDetails:function(){var k=this.ownerCt.findParentByType("tabpanel");var i=Date.parseDate(k.getComponentDetail("createdDate"),TDS.env.dateFormat);var o=Date.parseDate(k.getComponentDetail("updatedDate"),TDS.env.dateFormat);var j="Created on "+i.format(TDS.env.dateTimeFormatDisplay)+" by "+k.getComponentDetail("createdByUserFullNameString")+", modified on "+o.format(TDS.env.dateTimeFormatDisplay)+(k.getComponentDetail("createdByUserFullNameString")==k.getComponentDetail("updatedByUserFullNameString")?"":" by "+k.getComponentDetail("updatedByUserFullNameString"))+".";var p=TDS.util.Price.calculateFixedGrossNettPrice({pricingPriceCurrency:k.getComponentDetail("pricingPriceCurrency"),pricingPriceSell:k.getComponentDetail("pricingPriceSell"),pricingPriceCommission:k.getComponentDetail("pricingPriceCommission"),pricingPriceIsNett:k.getComponentDetail("pricingPriceIsNett")});var l=(p.priceSell+p.priceCommission);var m=this.inventoryData.Ggrosstemp;if(p.priceSell==""||p.priceSell==null||p.priceSell=="undefined"){p.priceSell=0}var n=p.priceSell*parseInt(this.inventoryData.quantity);this.getDetailsPanel().tpl.overwrite(this.getDetailsPanel().body,Ext.apply({price:p.priceSell.toFixed(2),createdString:j,pricenet:p.priceIsNett,flag:p.flag,priceCommissionPercentage:p.priceCommissionPercentage,extragross:p.extragross,quaPrice:n.toFixed(2)},this.inventoryData,this.offeringData))}},{xtype:"panel",autoHeight:true,border:false,bodyStyle:"padding: 2px;",width:60,columnWidth:0.05,defaults:{minWidth:60},invokeWindow:function(l,k){if(!k){k={}}var m=this.ownerCt.items.itemAt(0).items.itemAt(2);var o=m.selModel.selections;var a=this.ownerCt.findParentByType("tabpanel");var b=a.ownerCt;var n=a.getComponentDetail("dataURI");var q=a.getComponentDetail("pricingPriceCurrency");if(!n){return}var p=this;Ext.apply(k,{title:"Edit",information:"You may edit the details of this component below.",interfaceURI:"fulfillment/tour/edit.js",destinationDataURI:n,sourceDataURI:"tour/rate/"+o.items[0].data.abstractRateId,scope:p,dataURI:{component:n,passenger:o.items[0].id,offering:a.getComponentDetail("offeringURI")},params:{status:l,componentName:a.getComponentDetail("name"),priceCurrency:a.getComponentDetail("pricingPriceCurrency")},callback:{fn:function(c){if(c){b.refreshGrid()}},scope:this}});TDS.window.setWindow(k)},invokeAltOffWindow:function(k,j){if(!j){j={}}var l=this.ownerCt.items.itemAt(0).items.itemAt(2);var n=l.selModel.selections;var a=this.ownerCt.findParentByType("tabpanel");var b=a.ownerCt;var m=a.getComponentDetail("dataURI");if(!m){return}Ext.apply(j,{title:"Alternative offer",information:"You may offer with new offering below.",interfaceURI:"fulfillment/tour/alternative.js",destinationDataURI:m+"/altOffering",dataURI:{component:m,offering:a.getComponentDetail("offeringURI")},params:{status:k,priceCurrency:a.getComponentDetail("pricingPriceCurrency")},callback:{fn:function(c){if(c){b.refreshGrid()}},scope:this}});TDS.window.setWindow(j)},items:[{xtype:"button",text:"Edit",handler:function(){var g=this.ownerCt.findParentByType("tabpanel");var h=g.ownerCt;var e="TOUR";var f=g.getComponentDetail("dataURI");TDS.window.setWindow({title:"Tour Edit Fulfillment",information:"Please enter your required details.",interfaceURI:"fulfillment/tour/edit.js",destinationDataURI:f+"/fulfillment/editPassStatus",buttonOK:"Save",data:{type:e,pnrDataURI:f,status:g.getComponentDetail("status")},callback:{fn:function(a){if(a){h.refreshGrid()}},scope:this.ownerCt.ownerCt}})}},{xtype:"button",text:"Note",handler:function(){var c=this.ownerCt.findParentByType("tabpanel");var d=c.getComponentDetail("dataURI");TDS.window.setWindow({title:"Send a note",information:"Please enter your note below.",interfaceURI:"note.js",postDataURI:d+"/note",callback:{fn:function(a){},scope:this}})}}]}]}