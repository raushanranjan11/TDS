{requireStores:[{dataURI:TDS.env.dataPath+"accommodation/ratings/collection",identifier:"accommodation/ratings",fields:["name","dataURI"]},{dataURI:TDS.env.dataPath+"accommodation/propertyclasstypes/collection",identifier:"accommodation/propertyclasstypes",fields:["name","displayName","dataURI"]},{dataURI:TDS.env.dataPath+"accommodation/groups/collection",identifier:"accommodation/groups",fields:["name","dataURI"]},{dataURI:TDS.env.dataPath+"accommodation/inventorytypes/collection",identifier:"accommodation/inventorytypes",storeId:"inventorytypes",fields:["name","displayName","dataURI"]},{dataURI:TDS.env.dataPath+"accommodation/roomviews/collection",identifier:"accommodation/roomviews",fields:["name","displayName","dataURI"]},{dataURI:TDS.env.dataPath+"accommodation/extracategories/collection",identifier:"accommodation/extracategories",fields:["name","dataURI"]}],xtype:"panel",border:false,layout:"column",bodyStyle:"padding: 2px;",items:[{requireStores:[{dataURI:TDS.env.dataPath+"rate/classes/collection",identifier:"rate/classes",fields:["name","dataURI"]},{dataURI:TDS.env.dataPath+"rate/pers/collection",identifier:"rate/pers",fields:["name","dataURI"]},{dataURI:TDS.env.dataPath+"rate/occupancies/collection",identifier:"rate/occupancies",fields:["name","dataURI"]}],xtype:"panel",height:200,border:false,frame:false,layout:"column",columnWidth:0.95,getAgencyPanel:function(){return this.items.itemAt(0)},getDetailsPanel:function(){return this.items.itemAt(1)},getPassengersPanel:function(){return this.items.itemAt(2)},hasDetailsInventory:false,hasDetailsOffering:false,isDetailsReady:function(){if(this.hasDetailsInventory&&this.hasDetailsOffering){return true}else{return false}},items:[{xtype:"panel",layout:"column",bodyStyle:"padding: 2px;",columnWidth:0.12,hideBorders:true,height:200,items:[{tpl:new Ext.XTemplate(['<div style="height:125px;  overflow-y: scroll;">',"<p><b>Agent:</b> {agencyName}</p>","<p><b>Consultant:</b> {consultantName}</p>","<p><b>Tel:</b> {telephoneNo}</p>","<p><b>Email:</b> {email}</p>","<p><b>Location:</b> {agentLocation}</p>","<p><b>Country:</b> {country}</p>","<p><b>Date / Time:</b> {bookingDateTime}</p>","</div>"]),listeners:{render:function(){var d=this.ownerCt.findParentByType("tabpanel");var c=d.getComponentDetail("agencyURI");Ext.Ajax.request({url:TDS.env.dataPath+c+"?forceGet=true",method:"GET",callback:function(a,i,e){if(i){try{var j=Ext.util.JSON.decode(e.responseText);this.tpl.overwrite(this.body,{agencyName:TDS.util.Format.displayResourceName(c),consultantName:d.getComponentDetail("createdByUserFullNameString"),telephoneNo:j.phoneNumber,email:j.email,agentLocation:j.locality,country:TDS.util.Format.displayResourceName(j.countryURI),bookingDateTime:TDS.util.Format.dateSpecial(d.getComponentDetail("createdDate"),TDS.env.dateTimeFormatDisplay)})}catch(b){}}},scope:this,disableCaching:true})}}}]},{columnWidth:0.5,xtype:"panel",height:200,border:true,tpl:new Ext.XTemplate('<div style="height:125px;  overflow-y: scroll; ">','<table class="x-tds-dataview" style="width: 100%;" border=1 cellpadding = 1 cellspacing=0  >','<tr style="background-color: #d0def0;" >','<th style="padding: 2px; width: 28%;">Property Name</th>','<th style="padding: 2px; width: 16%;">Rating</th>','<th style="padding: 2px; width: 18%;">In</th>','<th style="padding: 2px; width: 12%;">Out</th>','<th style="padding: 2px; width: 18%;">Nights</th>',"</tr>","<tr>","<td>{name}</td>","<td>{rating}</td>","<td>{dateFrom}</td>","<td>{dateTo}</td>","<td>{nights}</td>","</tr>","</table>",'<table class="x-tds-dataview" style="width: 100%;" border=1 cellpadding = 1 cellspacing=0  >','<tr style="background-color: #d0def0;" >','<th style="padding: 2px; width: 25%;">Rate</th>','<th style="padding: 2px; width: 25%;">Room Type</th>','<th style="padding: 2px; width: 10%;">Basis</th>','<th style="padding: 2px; width: 5%;">Rooms</th>','<th style="padding: 2px; width: 15%;">Price P/N</th>','<th style="padding: 2px; width: 15%;">Status</th>',"</tr>","{rateBody}","</table>",'<table class="x-tds-dataview" style="width: 100%;" border=1 cellpadding = 1 cellspacing=0  >','<tr style="background-color: #C0D9D9;">','<th style="padding: 2px; width: 14%;">Tour Price</th>','<th style="padding: 2px; width: 13%;">Gross/Net</th>','<th style="padding: 2px; width: 14%;">Extras</th>','<th style="padding: 2px; width: 20%;">Total Price ({grossOrNet})</th>','<th style="padding: 2px; width: 7%;">Comm%</th>',"</tr>","<tr>","<td>{tourPrice}</td>","<td>{grossOrNet}</td>","<td>{extras}</td>","<td>{totalPrice}</td>","<td>{comm}</td>","</tr>","</table>","</div>")},{xtype:"panel",height:155,columnWidth:0.38,layout:"fit",xtype:"panel",items:[{xtype:"grid",enableRowExpander:false,sessionExpandedRows:false,height:110,autoScroll:true,border:false,enableColumnHide:false,enableColumnMove:false,enableColumnResize:false,enableHdMenu:false,store:new Ext.data.JsonStore({url:"",id:"dataURI",fields:["dataURI","displayName","code","roomType","dateOfBirth","addressString","phoneNumber1","emailAddress","gender","status","abstractRateId","roomTypeName"]}),columns:[{header:"Passenger",dataIndex:"displayName",width:220,sortable:true,renderer:function(j,k,h,i,l,g){return j}},{header:"Type",dataIndex:"code",width:40,fixed:true},{header:"Gender",dataIndex:"gender",renderer:TDS.util.Format.gender,width:50,fixed:true},{header:"DOB",dataIndex:"dateOfBirth",width:70,fixed:true,renderer:TDS.util.Format.dateSpecialRenderer(TDS.env.dateBirthdayFormatDisplay)},{header:"Age",dataIndex:"dateOfBirth",renderer:TDS.util.Format.age,width:40,fixed:true},{header:"Room Type",dataIndex:"roomTypeName",width:80,fixed:true},{header:"Price",dataIndex:"price",width:40,fixed:true},{header:"Status",dataIndex:"status",width:50,fixed:true}],viewConfig:{forceFit:true},listeners:{render:function(){this.getEl().swallowEvent(["columnmove","columnresize","headerclick","click","mouseout","rowclick","rowmousedown","rowdbclick","cellblclick","sortchange","mouseup","mousedown"]);var c=this.ownerCt.findParentByType("tabpanel");var d=c.getComponentDetail("dataURI");Ext.Ajax.request({url:TDS.env.dataPath+d+"/passengers/collection/concise",method:"GET",callback:function(o,a,q){if(a){var i=Ext.util.JSON.decode(q.responseText);var m=i[d+"/passengers"];if(typeof m=="undefined"){return}var b=[];for(var n=0;n<m.length;n++){i[m[n]].dataURI=m[n];b.push(i[m[n]])}var p=this;var r=p.store;r.loadData(b);p.getView().refresh()}},scope:this})}}}]}],listeners:{render:function(){this.initInventory();this.initOffering()}},initInventory:function(){var f=this.ownerCt.findParentByType("tabpanel");var e=f.getComponentDetail("dataURI");var d=e;Ext.Ajax.request({url:TDS.env.dataPath+e+"/inventories/collection",method:"GET",callback:function(W,aa,Y){if(aa){try{var ae=Ext.decode(Y.responseText)}catch(i){}if(ae){var b=this.ownerCt.findParentByType("tabpanel");var ak=0,ad,V=[];var af=0;var ab=0;var o=ae["component/inventory/collection"];var at=o[e+"/inventories"];var X=ae["component/rate/collection/"];var av=X["component/rate/collection/list"];b.setDetail("rateList",av);var Z=new Array();Z=e.split("/");var aj="";this.rateData=[];var a=at.length/av.length;var U=[];var ai="";var j=[];var al=0;if(at.length>0){for(var r=0;r<at.length;r++){var c=o[at[r]];V[V.length]=TDS.util.Format.dateSpecial(c.componentPaybyDate,TDS.env.dateFormatDisplay);ai=c.pricingPriceCurrency;if(j.indexOf(c.rateId)==-1){j[r]=c.rateId;U[al]=TDS.util.Price.calculateFixedGrossNettPrice({pricingPriceCurrency:c.pricingPriceCurrency,pricingPriceSell:c.pricingPriceSell,pricingPriceCommission:c.pricingPriceCommission,pricingPriceIsNett:c.pricingPriceIsNett});U[al].rateId=c.rateId;U[al].quantity=c.quantity;al++}}var ac="";var au="";var ao=false;var ap=0;var ag=0;var s=0;if(av.length>0){for(var r=0;r<av.length;r++){var ah=X[av[r]];s=ah.extraTotal*at.length;aj=X[av[r]].tempBookedDate;var an="";var am=null;var ar="";for(var T=0;T<U.length;T++){if(U[T].rateId==av[r].substring(av[r].lastIndexOf("/")+1,av[r].length)){am=U[T]}}ao=am.priceIsNett;if(!am.priceIsNett){ar=am.priceCommissionPercentage;if(typeof ar=="undefined"){ar="0%"}}else{an=am.priceCommission;af+=(at.length*am.quantity*am.priceCommission)}ag+=(at.length*am.quantity*am.priceSell);ap+=(at.length*am.quantity*am.priceSell);ac+="<tr>";ac+="<td>"+ah.nameString+"</td>",ac+="<td>"+TDS.util.Format.displayResourceName(ah.inventoryTypeURI)+"</td>",ac+="<td>"+am.flag+"</td>",ac+="<td>"+am.quantity+"</td>",ac+="<td>"+TDS.util.Price.formatPrice(am.priceSell,am.priceCurrency)+"</td>",ac+="<td>"+b.getComponentDetail("status")+"</td>",ac+="</tr>"}ag+=af;ag+=s}if(V.length>0){var aq=V[0]}else{var aq=V}b.setComponentDetail("pricingPriceCurrency",ai);b.setComponentDetail("noOfNights",a);b.setComponentDetail("bookedDate",aj);this.inventoryData={name:b.getComponentDetail("name"),fromLocationString:b.getComponentDetail("locationFromString"),toLocationString:b.getComponentDetail("locationToString"),dateFrom:TDS.util.Format.dateSpecial(b.getComponentDetail("dateFrom"),TDS.env.dateFormatDisplay),dateTo:TDS.util.Format.dateSpecial(b.getComponentDetail("dateTo"),TDS.env.dateFormatDisplay),duration:b.getComponentDetail("duration"),nights:at.length,rateBody:ac,dataURI:e,divDataUri:d,numberOfNights:a,dates:aq,markup:af.toFixed(2),pnrCode:Z[1],bookeddateDis:aj,total:ag.toFixed(2),extraTotal:s.toFixed(2),priceCurrency:ai,tourPrice:TDS.util.Price.formatPrice(ap,ai),grossOrNet:(ao?"Nett":"Gross"),extras:TDS.util.Price.formatPrice(s,ai),markUp:af,totalPrice:TDS.util.Price.formatPrice(ag,ai),comm:au};this.hasDetailsInventory=true;if(this.isDetailsReady()){this.displayDetails()}}}}},scope:this})},initOffering:function(){var c=this.ownerCt.findParentByType("tabpanel");var d=c.getComponentDetail("offeringURI");Ext.Ajax.request({url:TDS.env.dataPath+d,method:"GET",callback:function(a,j,e){if(j){try{var i=Ext.decode(e.responseText)}catch(b){}if(i){this.offeringData={rating:TDS.util.Format.displayResourceName(i.accommodationRatingURI),addressString:i.addressString,propertyType:TDS.util.Format.displayResourceName(i.accommodationPropertyClassTypeURI),accommodationGroup:TDS.util.Format.displayResourceName(i.accommodationGroupURI)};this.hasDetailsOffering=true;if(this.isDetailsReady()){this.displayDetails()}}}},scope:this})},displayDetails:function(){var k=this.ownerCt.findParentByType("tabpanel");var i=Date.parseDate(k.getComponentDetail("createdDate"),TDS.env.dateFormat);var o=Date.parseDate(k.getComponentDetail("updatedDate"),TDS.env.dateFormat);var j="Created on "+i.format(TDS.env.dateTimeFormatDisplay)+" by "+k.getComponentDetail("createdByUserFullNameString")+", modified on "+o.format(TDS.env.dateTimeFormatDisplay)+(k.getComponentDetail("createdByUserFullNameString")==k.getComponentDetail("updatedByUserFullNameString")?"":" by "+k.getComponentDetail("updatedByUserFullNameString"))+".";var p=TDS.util.Price.calculateFixedGrossNettPrice({pricingPriceCurrency:k.getComponentDetail("pricingPriceCurrency"),pricingPriceSell:k.getComponentDetail("pricingPriceSell"),pricingPriceCommission:k.getComponentDetail("pricingPriceCommission"),pricingPriceIsNett:k.getComponentDetail("pricingPriceIsNett")});var l=(p.priceSell+p.priceCommission);var m=this.inventoryData.Ggrosstemp;if(p.priceSell==""||p.priceSell==null||p.priceSell=="undefined"){p.priceSell=0}var n=p.priceSell*parseInt(this.inventoryData.quantity);this.getDetailsPanel().tpl.overwrite(this.getDetailsPanel().body,Ext.apply({price:p.priceSell.toFixed(2),createdString:j,pricenet:p.priceIsNett,flag:p.flag,priceCommissionPercentage:p.priceCommissionPercentage,extragross:p.extragross,quaPrice:n.toFixed(2)},this.inventoryData,this.offeringData))}},{type:"panel",autoHeight:true,border:false,bodyStyle:"padding: 2px;",width:60,columnWidth:0.05,defaults:{minWidth:60},invokeWindow:function(p,s){if(!s){s={}}var b=this.ownerCt.items.itemAt(0).items.itemAt(2).items.itemAt(0);var n=b.selModel.selections;var m=this.ownerCt.findParentByType("tabpanel");var t=m.ownerCt;var o=m.getComponentDetail("noOfNights");var q=m.getComponentDetail("bookedDate");var a="accommodation/rate/"+n.items[0].data.abstractRateId;var r=m.getComponentDetail("dataURI");if(!r){return}Ext.apply(s,{title:"Edit",information:"You may edit the details of this component below.",interfaceURI:"fulfillment/accommodation/edit.js",destinationDataURI:r,sourceDataURI:"accommodation/rate/"+n.items[0].data.abstractRateId,dataURI:{component:r,offering:m.getComponentDetail("offeringURI"),componentName:m.getComponentDetail("name")},params:{status:p,noOfNights:o,bookedDate:q,componentName:m.getComponentDetail("name"),priceCurrency:m.getComponentDetail("pricingPriceCurrency")},callback:{fn:function(c){if(c){t.refreshGrid()}},scope:this}});TDS.window.setWindow(s)},invokeAltOffWindow:function(k,j){if(!j){j={}}var l=this.ownerCt.items.itemAt(0).items.itemAt(2).items.itemAt(0);var n=l.selModel.selections;var a=this.ownerCt.findParentByType("tabpanel");var b=a.ownerCt;var m=a.getComponentDetail("dataURI");if(!m){return}Ext.apply(j,{title:"Alternative offer",information:"You may offer with new offering below.",interfaceURI:"fulfillment/accommodation/alternative.js",destinationDataURI:m+"/altOffering",dataURI:{component:m,offering:a.getComponentDetail("offeringURI")},params:{status:k,priceCurrency:a.getComponentDetail("pricingPriceCurrency")},callback:{fn:function(c){if(c){b.refreshGrid()}},scope:this}});TDS.window.setWindow(j)},items:[{xtype:"button",text:"Edit",handler:function(){var g=this.ownerCt.findParentByType("tabpanel");var h=g.ownerCt;var e="ACCOMMODATION";var f=g.getComponentDetail("dataURI");TDS.window.setWindow({title:"Accommodation Edit Fulfillment",information:"Please enter your required details.",interfaceURI:"fulfillment/accommodation/edit.js",destinationDataURI:f+"/fulfillment/editPassStatus",buttonOK:"Save",data:{type:e,pnrDataURI:f,MQ:true,componentName:g.getComponentDetail("name")},callback:{fn:function(a){if(a){h.refreshGrid()}},scope:this.ownerCt.ownerCt}})}},{xtype:"button",text:"Note",handler:function(){var c=this.ownerCt.findParentByType("tabpanel");var d=c.getComponentDetail("dataURI");TDS.window.setWindow({title:"Send a note",information:"Please enter your note below.",interfaceURI:"note.js",postDataURI:d+"/note",callback:{fn:function(a){},scope:this}})}}]}]}