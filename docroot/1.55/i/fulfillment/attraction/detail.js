{xtype:"panel",border:false,layout:"column",items:[{requireStores:[{dataURI:TDS.env.dataPath+"rate/classes/collection",identifier:"rate/classes",fields:["name","dataURI"]},{dataURI:TDS.env.dataPath+"rate/pers/collection",identifier:"rate/pers",fields:["name","dataURI"]},{dataURI:TDS.env.dataPath+"rate/occupancies/collection",identifier:"rate/occupancies",fields:["name","dataURI"]}],xtype:"panel",height:150,border:false,frame:false,layout:"column",columnWidth:0.95,getAgencyPanel:function(){return this.items.itemAt(0)},getDetailsPanel:function(){return this.items.itemAt(1)},getPassengersPanel:function(){return this.items.itemAt(2)},hasDetailsInventory:false,hasDetailsOffering:false,isDetailsReady:function(){if(this.hasDetailsInventory&&this.hasDetailsOffering){return true}return false},items:[{xtype:"panel",layout:"column",bodyStyle:"padding: 2px;",columnWidth:0.12,hideBorders:true,height:150,items:[{tpl:new Ext.XTemplate(['<div style="height:120px;  overflow-y: scroll;">',"<p><b>Agent:</b> {agencyName}</p>","<p><b>Consultant:</b> {consultantName}</p>","<p><b>Tel:</b> {telephoneNo}</p>","<p><b>Email:</b> {email}</p>","<p><b>Location:</b> {agentLocation}</p>","<p><b>Country:</b> {country}</p>","<p><b>Date / Time:</b> {bookingDateTime}</p>","</div>"]),listeners:{render:function(){var a=this.ownerCt.findParentByType("tabpanel");var b=a.getComponentDetail("agencyURI");Ext.Ajax.request({url:TDS.env.dataPath+b+"?forceGet=true",method:"GET",callback:function(h,d,f){if(d){try{var c=Ext.util.JSON.decode(f.responseText);this.tpl.overwrite(this.body,{agencyName:TDS.util.Format.displayResourceName(b),consultantName:a.getComponentDetail("createdByUserFullNameString"),telephoneNo:c.phoneNumber,email:c.email,agentLocation:c.locality,country:TDS.util.Format.displayResourceName(c.countryURI),bookingDateTime:TDS.util.Format.dateSpecial(a.getComponentDetail("createdDate"),TDS.env.dateTimeFormatDisplay)})}catch(g){}}},scope:this,disableCaching:true})}}}]},{columnWidth:0.5,xtype:"panel",height:150,border:true,tpl:new Ext.XTemplate('<div style="height:120px; overflow-y: scroll;">','<table class="x-tds-dataview" style="width: 100%;" border=1 cellpadding = 1 cellspacing=0  >','<tr style="background-color: #d0def0;" >','<th style="padding: 2px; width: 35%;">Service</th>','<th style="padding: 2px; width: 25%;">City</th>','<th style="padding: 2px; width: 25%;">Date</th>','<th style="padding: 2px; width: 15%;">Time</th>','<th style="padding: 2px; width: 15%;">Duration</th>',"</tr>","<tr>","<td>{name}</td>","<td>{toLocationString}</td>","<td>{dateFrom}</td>","<td>{time}</td>","<td>{duration}</td>","</tr>","</table>",'<table class="x-tds-dataview" style="width: 100%;" border=1 cellpadding = 1 cellspacing=0  >','<tr style="background-color: #d0def0;" >','<th style="padding: 2px; width: 25%;">Rate</th>','<th style="padding: 2px; width: 15%;">Passenger Type</th>','<th style="padding: 2px; width: 5%;">No.</th>','<th style="padding: 2px; width: 20%;">Price Per Person</th>','<th style="padding: 2px; width: 10%;">Status</th>',"</tr>","{rateBody}","</table>",'<table class="x-tds-dataview" style="width: 100%;" border=1 cellpadding = 1 cellspacing=0  >','<tr style="background-color: #C0D9D9;">','<th style="padding: 2px; width: 14%;">Tour Price</th>','<th style="padding: 2px; width: 13%;">Gross/Net</th>','<th style="padding: 2px; width: 14%;">Extras</th>','<th style="padding: 2px; width: 20%;">Total Price ({grossOrNet})</th>','<th style="padding: 2px; width: 7%;">Comm%</th>',"</tr>","<tr>","<td>{tourPrice}</td>","<td>{grossOrNet}</td>","<td>{extras}</td>","<td>{totalPrice}</td>","<td>{comm}</td>","</tr>","</table>","</div>")},{xtype:"panel",height:150,columnWidth:0.4,layout:"fit",items:[{xtype:"grid",enableRowExpander:false,sessionExpandedRows:false,height:110,autoScroll:true,border:false,enableColumnHide:false,enableColumnMove:false,enableColumnResize:false,enableHdMenu:false,store:new Ext.data.JsonStore({url:"",id:"dataURI",fields:["dataURI","displayName","code","dateOfBirth","addressString","phoneNumber1","emailAddress","gender","status","abstractRateId"]}),columns:[{header:"Passenger",dataIndex:"displayName",width:220,fixed:true,sortable:true,renderer:function(e,d,a,f,c,b){return e}},{header:"Type",dataIndex:"code",width:40,fixed:true},{header:"Gender",dataIndex:"gender",renderer:TDS.util.Format.gender,width:50,fixed:true},{header:"DOB",dataIndex:"dateOfBirth",width:70,fixed:true,renderer:TDS.util.Format.dateSpecialRenderer(TDS.env.dateBirthdayFormatDisplay)},{header:"Age",dataIndex:"dateOfBirth",renderer:TDS.util.Format.age,width:40,fixed:true},{header:"Price",dataIndex:"price",width:40,fixed:true},{header:"Status",dataIndex:"status",width:50,fixed:true}],viewConfig:{forceFit:true},listeners:{render:function(){this.getEl().swallowEvent(["columnmove","columnresize","headerclick","click","mouseout","rowclick","rowmousedown","rowdbclick","cellblclick","sortchange","mouseup","mousedown"]);var b=this.ownerCt.findParentByType("tabpanel");var a=b.getComponentDetail("dataURI");Ext.Ajax.request({url:TDS.env.dataPath+a+"/passengers/collection/concise",method:"GET",callback:function(f,l,d){if(l){var j=Ext.util.JSON.decode(d.responseText);var h=j[a+"/passengers"];if(typeof h=="undefined"){return}var k=[];for(var g=0;g<h.length;g++){j[h[g]].dataURI=h[g];k.push(j[h[g]])}var e=this;var c=e.store;c.loadData(k);e.getView().refresh()}},scope:this})}}}]}],listeners:{render:function(){this.initInventory();this.initOffering()}},initInventory:function(){var e=this.ownerCt.findParentByType("tabpanel");var a=e.getComponentDetail("dataURI");var d=a;var c=new Array();var b=0;c=a.split("/");Ext.Ajax.request({url:TDS.env.dataPath+a+"/inventories/collection",method:"GET",callback:function(J,F,H){var U=this.ownerCt.findParentByType("tabpanel");if(F){try{var B=Ext.decode(H.responseText)}catch(S){}if(B){var v=0,C,K=[];var A=0;var Q=B["component/inventory/collection"];var h=Q[a+"/inventories"];var I=B["component/rate/collection/"];var f=I["component/rate/collection/list"];var t=I.TOUR_TYPR_STRING;U.setDetail("rateList",f);var G=new Array();G=a.split("/");var w="";this.rateData=[];var X=h.length/f.length;var M=[];var x="";var R=[];var u=0;if(h.length>0){for(var P=0;P<h.length;P++){var T=Q[h[P]];K[K.length]=TDS.util.Format.dateSpecial(T.componentPaybyDate,TDS.env.dateFormatDisplay);x=T.pricingPriceCurrency;if(R.indexOf(T.rateId)==-1){R[P]=T.rateId;M[u]=TDS.util.Price.calculateFixedGrossNettPrice({pricingPriceCurrency:T.pricingPriceCurrency,pricingPriceSell:T.pricingPriceSell,pricingPriceCommission:T.pricingPriceCommission,pricingPriceIsNett:T.pricingPriceIsNett});M[u].rateId=T.rateId;M[u].quantity=T.quantity;u++}}var E="";var g="";var n=false;var z=0;var m=0;var O=0;if(f.length>0){for(var P=0;P<f.length;P++){var y=I[f[P]];O=y.extraTotal;w=I[f[P]].tempBookedDate;var D=[];var W=y.groupName;var k="";var p="";D=W.split(",");var V=[];var L=D[0];V=L.split(" ");var q=null;for(var N=0;N<M.length;N++){if(M[N].rateId==f[P].substring(f[P].lastIndexOf("/")+1,f[P].length)){q=M[N]}}n=q.priceIsNett;if(!q.priceIsNett){k=q.priceCommissionPercentage;if(typeof k=="undefined"){k="0%"}}else{p=q.priceCommission;A+=(q.quantity*q.priceCommission)}z+=(q.quantity*q.priceSell);m+=(q.quantity*q.priceSell);E+="<tr>";E+="<td> "+y.nameString+"</td>",E+="<td> "+V[0]+" </td>",E+="<td>"+q.quantity+"</td>",E+="<td>"+TDS.util.Price.formatPrice(q.priceSell,q.priceCurrency)+"</td>",E+="<td>"+U.getComponentDetail("status")+"</td>",E+="</tr>"}z+=A;z+=O}if(K.length>0){var l=K[0]}else{var l=K}U.setDetail("pricingPriceCurrency",x);this.inventoryData={name:U.getComponentDetail("name"),fromLocationString:U.getComponentDetail("locationFromString"),toLocationString:U.getComponentDetail("locationToString"),dateFrom:TDS.util.Format.dateSpecial(U.getComponentDetail("dateFrom"),TDS.env.dateFormatDisplay),duration:U.getComponentDetail("duration"),status:U.getComponentDetail("status"),rateBody:E,dataURI:a,divDataUri:d,numberOfNights:X,dates:l,markup:A.toFixed(2),pnrCode:G[1],bookeddateDis:w,total:z.toFixed(2),extraTotal:O.toFixed(2),priceCurrency:x,tourPrice:TDS.util.Price.formatPrice(m,x),grossOrNet:(n?"Nett":"Gross"),extras:TDS.util.Price.formatPrice(O,x),markUp:A,totalPrice:TDS.util.Price.formatPrice(z,x),comm:g};this.hasDetailsInventory=true;if(this.isDetailsReady()){this.displayDetails()}}}}},scope:this})},initOffering:function(){var c=this.ownerCt.findParentByType("tabpanel");var b=c.getComponentDetail("offeringURI");var a;Ext.Ajax.request({url:TDS.env.dataPath+b,method:"GET",callback:function(i,d,g){if(d){try{var f=Ext.decode(g.responseText)}catch(h){}if(f){this.offeringData={locationsString:f.locationsString,website:f.primaryHref,addressString:f.addressString,locationPickup:f.locationPickup,locationDropoff:f.locationDropoff,departureTime:f.departureTime,duration:f.duration,sightseeingType:TDS.util.Format.displayResourceName(f.sightseeingTypeURI)};this.hasDetailsOffering=true;if(this.isDetailsReady()){this.displayDetails()}}}},scope:this})},displayDetails:function(){var h=this.ownerCt.findParentByType("tabpanel");var b=Date.parseDate(h.getComponentDetail("createdDate"),TDS.env.dateFormat);var d=Date.parseDate(h.getComponentDetail("updatedDate"),TDS.env.dateFormat);var a="Created on "+b.format(TDS.env.dateTimeFormatDisplay)+" by "+h.getComponentDetail("createdByUserFullNameString")+", modified on "+d.format(TDS.env.dateTimeFormatDisplay)+(h.getComponentDetail("createdByUserFullNameString")==h.getComponentDetail("updatedByUserFullNameString")?"":" by "+h.getComponentDetail("updatedByUserFullNameString"))+".";var c=TDS.util.Price.calculateFixedGrossNettPrice({pricingPriceCurrency:h.getComponentDetail("pricingPriceCurrency"),pricingPriceSell:h.getComponentDetail("pricingPriceSell"),pricingPriceCommission:h.getComponentDetail("pricingPriceCommission"),pricingPriceIsNett:h.getComponentDetail("pricingPriceIsNett")});var g=(c.priceSell+c.priceCommission);var f=this.inventoryData.Ggrosstemp;if(c.priceSell==""||c.priceSell==null||c.priceSell=="undefined"){c.priceSell=0}var e=c.priceSell*parseInt(this.inventoryData.quantity);this.getDetailsPanel().tpl.overwrite(this.getDetailsPanel().body,Ext.apply({price:c.priceSell.toFixed(2),createdString:a,pricenet:c.priceIsNett,flag:c.flag,priceCommissionPercentage:c.priceCommissionPercentage,extragross:c.extragross,quaPrice:e.toFixed(2)},this.inventoryData,this.offeringData))}},{type:"panel",autoHeight:true,border:false,bodyStyle:"padding: 2px;",width:60,columnWidth:0.05,defaults:{minWidth:60},invokeWindow:function(b,c){if(!c){c={}}var e=this.ownerCt.findParentByType("tabpanel");var d=e.ownerCt;var a=e.getComponentDetail("dataURI");if(!a){return}Ext.apply(c,{title:"Edit",information:"You may edit the details of this component below.",interfaceURI:"fulfillment/attraction/edit.js",destinationDataURI:a,sourceDataURI:a,dataURI:{component:a,offering:e.getComponentDetail("offeringURI")},params:{status:b,priceCurrency:e.getComponentDetail("pricingPriceCurrency")},callback:{fn:function(f){if(f){d.refreshGrid()}},scope:this}});TDS.window.setWindow(c)},listeners:{render:function(){var b=this.items.itemAt(0);var c=this.ownerCt.findParentByType("tabpanel");var a=c.getComponentDetail("status");if(a.toLowerCase()==TDS.data.componentStatus.STATUS_HELD.toLowerCase()){}else{if(a.toLowerCase()==TDS.data.componentStatus.STATUS_REQUESTED.toLowerCase()){}else{if(a.toLowerCase()==TDS.data.componentStatus.STATUS_REJECTED.toLowerCase()){b.disable()}else{if(a.toLowerCase()==TDS.data.componentStatus.STATUS_CONFIRMED.toLowerCase()){}else{if(a.toLowerCase()==TDS.data.componentStatus.STATUS_CANCEL_REQUESTED.toLowerCase()){}else{if(a.toLowerCase()==TDS.data.componentStatus.STATUS_CANCELLED.toLowerCase()){b.disable()}}}}}}}},items:[{xtype:"button",text:"Edit",handler:function(){var d=this.ownerCt.findParentByType("tabpanel");var c=d.ownerCt;var b=TDS.data.componentType.TYPE_ATTRACTION_NEW;var a=d.getComponentDetail("dataURI");TDS.window.setWindow({title:"Services Edit Fulfillment",information:"Please enter your required details.",interfaceURI:"fulfillment/attraction/edit.js",destinationDataURI:a+"/fulfillment/editPassStatus",buttonOK:"Save",data:{type:b,pnrDataURI:a,MQ:true},callback:{fn:function(e){if(e){c.refreshGrid()}},scope:this.ownerCt.ownerCt}})}},{xtype:"button",text:"Confirm",hidden:true,handler:function(){var a=this.ownerCt;a.invokeWindow(TDS.data.componentStatus.STATUS_CONFIRMED)}},{xtype:"button",text:"Cancel",hidden:true,handler:function(){var a=this.ownerCt;a.invokeWindow(TDS.data.componentStatus.STATUS_CANCELLED)}},{xtype:"button",text:"Accept",hidden:true,handler:function(){var a=this.ownerCt;a.invokeWindow(TDS.data.componentStatus.STATUS_HELD)}},{xtype:"button",text:"Reject",hidden:true,handler:function(){var a=this.ownerCt;a.invokeWindow(TDS.data.componentStatus.STATUS_REJECTED)}},{xtype:"button",text:"Note",handler:function(){var b=this.ownerCt.findParentByType("tabpanel");var a=b.getComponentDetail("dataURI");TDS.window.setWindow({title:"Send a note",information:"Please enter your note below.",interfaceURI:"note.js",postDataURI:a+"/note",callback:{fn:function(c){},scope:this}})}}]}]}