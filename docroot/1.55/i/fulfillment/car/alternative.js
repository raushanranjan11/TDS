{xtype:"form",border:false,markDataDirtyOnLoad:true,beforeSubmit:function(a){return a},afterDataLoad:function(a){this.initRadioSelection(a.status);this.initInventory()},getDetailTab:function(){return this.items.itemAt(0).items.itemAt(0)},items:[{xtype:"tabpanel",border:false,defaults:{border:false},activeTab:0,layoutOnTabChange:true,height:330,defaults:{bodyStyle:"padding: 8px;"},items:[{title:"Details",border:false,bodyStyle:"padding: 8px;",items:{xtype:"panel",labelWidth:110,border:false,items:[{xtype:"panel",labelWidth:70,layout:"form",style:"padding: 2px 4px 2px 4px;",border:false,items:[{xtype:"combo",name:"inventoryTypeURI",mode:"local",fieldLabel:"Vehicle",width:190,triggerAction:"all",editable:false,displayField:"name",valueField:"dataURI",store:TDS.data.getStore({dataURI:TDS.env.dataPath+"rate/occupancies/collection1",identifier:"rate1/occupancies",fields:["name","dataURI"]})},{xtype:"combo",name:"inventoryTypeURI",mode:"local",fieldLabel:"Vehicle type",width:190,triggerAction:"all",editable:false,displayField:"name",valueField:"dataURI",store:TDS.data.getStore({dataURI:TDS.env.dataPath+"rate/occupancies/collection1",identifier:"rate1/occupancies",fields:["name","dataURI"]})},{xtype:"textfield",fieldLabel:"Daily rate",width:60,name:"dailyRate"},{xtype:"textfield",fieldLabel:"Days",width:60,name:"days"},{xtype:"datefield",fieldLabel:"Expiry date",width:80,format:"dMy",name:"expiryDate"}]},{xtype:"fieldset",layout:"table",layoutConfig:{columns:1},autoHeight:true,defaults:{xtype:"radio",name:"status",forceSubmit:true,hideLabel:true},items:[{boxLabel:"Leave as-is.",checked:true,inputValue:"doNothing"},{boxLabel:"Confirm component",disabled:true,inputValue:TDS.data.componentStatus.STATUS_CONFIRMED},{boxLabel:"Confirm a passenger",disabled:true,inputValue:TDS.data.componentStatus.STATUS_CONFIRMED_PASSENGER},{boxLabel:"Confirm passenger of waitlist",disabled:true,inputValue:TDS.data.componentStatus.STATUS_PART_CONFIRMED,handler:function(a,b){var c=this.ownerCt.ownerCt.ownerCt}},{boxLabel:"Cancel a passenger",disabled:true,inputValue:TDS.data.componentStatus.STATUS_CANCEL_PASSENGER},{boxLabel:"Cancel a component",disabled:true,inputValue:TDS.data.componentStatus.STATUS_CANCELLED}]}]}},{title:"Extras",items:[{xtype:"editorgrid",height:160,width:380,extraTpl:new Ext.XTemplate(["Name: {nameString}<br/>","Category: {[TDS.util.Format.displayResourceName(values.extraCategoryURI)]}<br/>","Required: {[TDS.util.Format.booleanRenderer(values.required)]}<br/>","Min. required: {minimumInventoryRequired}<br/>"]),enableHdMenu:false,stores:{},store:new Ext.data.JsonStore({url:"",fields:["dataURI","selectedDataURI","name","nameString","extraCategoryURI","minimumInventoryRequired","required","pricingPriceCurrency","pricingPriceCommission","pricingPriceIsNett","pricingPriceSell","quantity","pricingPriceMarkup"]}),getData:function(){var b=this.ownerCt.findParentByType("awesomewindow");var f=this.getStore().getModifiedRecords();for(var e=0,g=[];e<f.length;e++){var a=f[e].get("selectedDataURI");var c={extraURI:f[e].get("dataURI"),quantity:f[e].get("quantity")};if(f[e].get("pricingPriceMarkup")){c.pricingPriceMarkup=f[e].get("pricingPriceMarkup")}g.push({method:a?"PUT":"POST",destinationDataURI:a?TDS.env.dataPath+a+"?currency="+b.getParam("priceCurrency"):TDS.env.dataPath+this.baseDataURI+"/extras?currency="+b.getParam("priceCurrency"),data:c})}return{data:g}},columns:[{header:"Name",dataIndex:"nameString",width:150},{header:"Price",dataIndex:"convertedPricingPriceSell",width:100,fixed:true,renderer:TDS.util.Price.conversionGrossNettPriceRenderer},{header:"Markup ($)",dataIndex:"pricingPriceMarkup",width:70,fixed:true,editor:new Ext.form.TextField()},{header:"Quantity",width:60,fixed:true,dataIndex:"quantity",editor:new Ext.form.OmnicrementerField()}],sm:new Ext.grid.RowSelectionModel(),viewConfig:{forceFit:true,getRowClass:function(a,d,c,b){if(a.get("required")==true){return"x-tds-disabled-row"}}},initSelectionStore:function(){var b=this.getStore();var a=[];this.stores.rateExtras.each(function(e){var g={};Ext.apply(g,e.data);var c=this.stores.selectedRateExtras.find("extraURI",e.get("dataURI"));if(c!==-1){var f=this.stores.selectedRateExtras.getAt(c);Ext.apply(g,{selectedDataURI:f.get("dataURI"),quantity:f.get("quantity"),pricingPriceMarkup:f.get("pricingPriceIsNett")?f.get("pricingPriceCommission"):""})}else{Ext.apply(g,{selectedDataURI:"",quantity:"",pricingPriceMarkup:""})}var e=new b.recordType(g);a[a.length]=e},this);b.add(a);b.sort("required","DESC");this.lm.hide()},listeners:{beforeedit:function(a){if(a.field=="pricingPriceMarkup"){if(!a.record.get("convertedPricingPriceIsNett")){a.cancel=true}}},render:function(){var d=this.getSelectionModel();d.on("beforerowselect",function(i,h,f,e){var g=this.ownerCt.items.itemAt(1);this.extraTpl.overwrite(g.body,e.data);if(e.get("required")==true){return false}},this);var c=this.ownerCt.findParentByType("form");var a=this.ownerCt.findParentByType("awesomewindow");a.registerItem(this.id);this.baseDataURI=a.getConfigValue("sourceDataURI");this.lm=new Ext.LoadMask(this.el,{msg:""});var b=0;this.lm.show();this.stores.rateExtras=new Ext.data.CollectionStore({autoLoad:true,identifier:a.getDataURI("offering")+"/searchExtras?rateURI="+a.getParam("rateList")+"&currency="+a.getParam("priceCurrency"),url:TDS.env.dataPath+a.getDataURI("offering")+"/searchExtras?rateURI="+a.getParam("rateList")+"&currency="+a.getParam("priceCurrency"),fields:["dataURI","name","extraCategoryURI","minimumInventoryRequired","required","conversionCurrency","convertedPricingPriceCommission","convertedPricingPriceIsNett","convertedPricingPriceSell"],listeners:{load:{fn:function(){b++;if(b==2){this.initSelectionStore()}this.lm.hide()},scope:this}}});this.stores.selectedRateExtras=new Ext.data.CollectionStore({autoLoad:true,identifier:this.baseDataURI+"/extras",url:TDS.env.dataPath+this.baseDataURI+"/extras/collection",fields:["extraURI","quantity","pricingPriceCurrency","pricingPriceCommission","pricingPriceIsNett","pricingPriceSell"],listeners:{load:{fn:function(){b++;if(b==2){this.initSelectionStore()}this.lm.hide()},scope:this}}})}}},{xtype:"panel",style:"margin-top: 4px;",bodyStyle:{background:"#ffffff",padding:"8px"},html:"Please select an extra to see additional details."}]}]}],initInventory:function(){var a=this.ownerCt;a.el.mask("","x-mask-loading");Ext.Ajax.request({url:TDS.env.dataPath+a.getConfigValue("sourceDataURI")+"/inventories/collection",method:"GET",callback:function(g,v,b){if(v){try{var l=Ext.decode(b.responseText)}catch(p){}if(l){var j=a.getConfigValue("sourceDataURI");var h=0,u,c=[];var q=l["component/inventory/collection"];var d=q[j+"/inventories"];for(var k=0;k<d.length;k++){var f=q[d[k]];if(!u){u=f.rateURI}h+=f.quantity;c[c.length]=f.date}var t=l["component/rate/collection/"];var m=t["component/rate/collection/list"];var n=t[m[0]];this.inventoryData={quantity:h,rateURI:u,rateName:n.name,groupName:n.groupName,dates:c,rateConditions:n.restrictions};this.initDetails()}}a.el.unmask()},scope:this})},initDetails:function(){var w=this.ownerCt;with(this.getDetailTab()){}},initRadioSelection:function(d){d=this.ownerCt.initialConfig.params.status;var h=this.items.itemAt(0).items.itemAt(0).items.itemAt(0).findByType("fieldset")[0];var e=h.items.itemAt(0);var f=h.items.itemAt(1);var b=h.items.itemAt(2);var c=h.items.itemAt(3);var g=h.items.itemAt(4);var i=h.items.itemAt(5);var j=this.ownerCt;var a=j.getParam("status");if(d.toLowerCase()==TDS.data.componentStatus.STATUS_HELD.toLowerCase()){}else{if(d.toLowerCase()==TDS.data.componentStatus.STATUS_PART_CONFIRMED.toLowerCase()){f.enable(true);c.enable(true);g.enable(true);i.enable(true)}else{if(d.toLowerCase()==TDS.data.componentStatus.STATUS_CONFIRMED.toLowerCase()){g.enable(true);i.enable(true)}else{if(d.toLowerCase()==TDS.data.componentStatus.STATUS_CANCEL_REQUESTED.toLowerCase()){i.enable(true)}else{if(d.toLowerCase()==TDS.data.componentStatus.STATUS_REJECTED.toLowerCase()){i.enable(true)}else{if(d.toLowerCase()==TDS.data.componentStatus.STATUS_REQUESTED.toLowerCase()){f.enable(true);g.enable(true);i.enable(true)}}}}}}f.setValue(false);b.setValue(false);c.setValue(false);g.setValue(false);i.setValue(false);e.setValue(true)}}