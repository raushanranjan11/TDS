{xtype:"form",border:false,markDataDirtyOnLoad:true,beforeSubmit:function(a){var b=this.items.itemAt(0).items.itemAt(2).items.itemAt(1);if(b.rendered){a.passengerURIs=b.getData()}return a},afterDataLoad:function(a){this.initRadioSelection(a.status);this.initInventory()},getDetailTab:function(){return this.items.itemAt(0).items.itemAt(0)},items:[{xtype:"tabpanel",border:false,defaults:{border:false},activeTab:0,layoutOnTabChange:true,height:300,defaults:{bodyStyle:"padding: 8px;"},items:[{title:"Details",getLabelOffering:function(){return this.items.itemAt(0).items.itemAt(0).items.itemAt(0).items.itemAt(1)},getLabelRate:function(){return this.items.itemAt(0).items.itemAt(0).items.itemAt(0).items.itemAt(3)},getFieldNumberRoom:function(){return this.items.itemAt(0).items.itemAt(0).items.itemAt(1).items.itemAt(1)},getFieldExpiryDate:function(){return this.items.itemAt(0).items.itemAt(0).items.itemAt(3).items.itemAt(1)},items:{xtype:"panel",labelWidth:110,border:false,items:[{xtype:"panel",border:false,layout:"form",items:[{xtype:"panel",style:"padding: 0; margin-top: 4px;",border:false,layout:"table",layoutConfig:{columns:2},defaults:{border:false,style:"padding-bottom: 4px;"},items:[{html:"Offering:",width:Ext.isIE?128:125},{xtype:"labelpanel",html:"NA"},{html:"Rate:",width:Ext.isIE?128:125},{xtype:"labelpanel",html:"NA"}]},{xtype:"panel",style:"padding: 0; margin-top: 4px;",border:false,layout:"table",layoutConfig:{columns:2},defaults:{border:false},items:[{html:"Number of PAX:",width:Ext.isIE?128:125},{xtype:"omnicrementer",name:"rateAmount"}]},{xtype:"panel",style:"padding: 0; margin-top: 4px;",border:false,layout:"table",layoutConfig:{columns:3},defaults:{border:false},items:[{html:"Total price:",width:Ext.isIE?128:125},{xtype:"fieldlabel",name:"pricingPriceCurrency",style:"padding-right: 4px;",setValue:function(a){this.setText(TDS.util.Price.formatCurrency(a))}},{xtype:"textfield",name:"pricingPriceSell",width:60}]},{xtype:"panel",style:"padding: 0; margin-top: 4px; margin-bottom: 8px;",border:false,layout:"table",layoutConfig:{columns:2},defaults:{border:false},items:[{html:"Expiry date:",width:Ext.isIE?128:125},{xtype:"datefield",name:"expireDate",disabled:true,showToday:false,width:80,format:TDS.env.dateFormatDisplay,minValue:Ext.TimerMgr.getServerCalculatedDate().clearTime()}]}]},{xtype:"fieldset",layout:"table",layoutConfig:{columns:1},autoHeight:true,defaults:{xtype:"radio",name:"status",forceSubmit:true,hideLabel:true},items:[{boxLabel:"Leave as-is.",checked:true,inputValue:"doNothing"},{boxLabel:"Confirm",hidden:true,inputValue:TDS.data.componentStatus.STATUS_CONFIRMED},{boxLabel:"Cancel",hidden:true,inputValue:TDS.data.componentStatus.STATUS_CANCELLED},{boxLabel:"Accept",hidden:true,inputValue:TDS.data.componentStatus.STATUS_HELD,handler:function(a,b){var c=this.ownerCt.ownerCt.ownerCt;if(b){c.getFieldExpiryDate().enable()}else{c.getFieldExpiryDate().disable()}}},{boxLabel:"Reject",hidden:true,inputValue:TDS.data.componentStatus.STATUS_REJECTED}]}]}},{title:"Extras",items:[{xtype:"editorgrid",height:160,enableHdMenu:false,stores:{},store:new Ext.data.JsonStore({url:"",fields:["dataURI","selectedDataURI","name","extraCategoryURI","minimumInventoryRequired","required","quantity"]}),getData:function(){var b=this.ownerCt.findParentByType("awesomewindow");var e=this.getStore().getModifiedRecords();for(var c=0,f=[];c<e.length;c++){var a=e[c].get("selectedDataURI");f.push({method:a?"PUT":"POST",destinationDataURI:a?TDS.env.dataPath+a+"?currency="+b.getParam("priceCurrency"):TDS.env.dataPath+this.baseDataURI+"/extras?currency="+b.getParam("priceCurrency"),data:{extraURI:e[c].get("dataURI"),quantity:e[c].get("quantity")}})}return{data:f}},columns:[{header:"Name",dataIndex:"name"},{header:"Price",dataIndex:"convertedPricingPriceSell",width:100,fixed:true,renderer:TDS.util.Price.conversionGrossNettPriceRenderer},{header:"Quantity",width:70,fixed:true,dataIndex:"quantity",editor:new Ext.form.OmnicrementerField()}],sm:new Ext.grid.RowSelectionModel(),viewConfig:{forceFit:true,getRowClass:function(a,d,c,b){if(a.get("required")==true){return"x-tds-disabled-row"}}},initSelectionStore:function(){var b=this.getStore();var a=[];this.stores.rateExtras.each(function(e){var g={};Ext.apply(g,e.data);var c=this.stores.selectedRateExtras.find("extraURI",e.get("dataURI"));if(c!==-1){var f=this.stores.selectedRateExtras.getAt(c);Ext.apply(g,{selectedDataURI:f.get("dataURI"),quantity:f.get("quantity")})}else{Ext.apply(g,{selectedDataURI:"",quantity:""})}var e=new b.recordType(g);a[a.length]=e},this);b.add(a);b.sort("required","DESC");this.lm.hide()},listeners:{render:function(){var d=this.getSelectionModel();var c=this.ownerCt.findParentByType("form");var a=this.ownerCt.findParentByType("awesomewindow");a.registerItem(this.id);this.baseDataURI=a.getConfigValue("sourceDataURI");this.lm=new Ext.LoadMask(this.el,{msg:""});var b=0;this.lm.show();this.stores.rateExtras=new Ext.data.CollectionStore({autoLoad:true,identifier:a.getDataURI("offering")+"/searchExtras?rateURI="+c.inventoryData.rateURI+"&currency="+a.getParam("priceCurrency"),url:TDS.env.dataPath+a.getDataURI("offering")+"/searchExtras/collection?rateURI="+c.inventoryData.rateURI+"&currency="+a.getParam("priceCurrency"),fields:["dataURI","name","extraCategoryURI","minimumInventoryRequired","required","conversionCurrency","convertedPricingPriceSell"],listeners:{load:{fn:function(){b++;if(b==2){this.initSelectionStore()}},scope:this}}});this.stores.selectedRateExtras=new Ext.data.CollectionStore({autoLoad:true,identifier:this.baseDataURI+"/extras",url:TDS.env.dataPath+this.baseDataURI+"/extras/collection",fields:["extraURI","quantity"],listeners:{load:{fn:function(){b++;if(b==2){this.initSelectionStore()}},scope:this}}})}}}]},{title:"Passengers",items:[{xtype:"panel",border:false,html:["<p>To remove a passenger from this booking, uncheck the the passenger you wish to remove.</p>","<p>Note: Do this carefully, removal of a passenger cannot be undone.</p>"]},{xtype:"grid",height:150,store:new Ext.data.CollectionStore({url:"",identifier:"",fields:["type","code","nameFirst","nameLast","salutation","displayName","dateOfBirth"]}),viewConfig:{forceFit:true},getData:function(){var b=this.selModel.getSelections();var c=[];for(var a=0;a<b.length;a++){c[a]=b[a].get("dataURI")}return c},sm:new Ext.grid.CheckboxSelectionModel(),columns:[new Ext.grid.CheckboxSelectionModel(),{header:"Code",dataIndex:"code",width:70,fixed:true},{header:"Name",dataIndex:"displayName"},{header:"DOB",dataIndex:"dateOfBirth",renderer:TDS.util.Format.dateSpecialRenderer(TDS.env.dateBirthdayFormatDisplay)},{header:"Age",dataIndex:"dateOfBirth",renderer:TDS.util.Format.age}],listeners:{render:function(){var w=this.ownerCt.findParentByType("awesomewindow");with(this.store){reader.meta.identifier=w.getConfigValue("sourceDataURI")+"/passengers";proxy.conn.url=TDS.env.dataPath+w.getConfigValue("sourceDataURI")+"/passengers/collection/concise";on("load",function(){this.getSelectionModel().selectAll()},this);load()}}}}]}]}],initInventory:function(){var a=this.ownerCt;a.el.mask("","x-mask-loading");Ext.Ajax.request({url:TDS.env.dataPath+a.getConfigValue("sourceDataURI")+"/inventories/collection",method:"GET",callback:function(g,q,b){if(q){try{var l=Ext.decode(b.responseText)}catch(n){}if(l){var j=a.getConfigValue("sourceDataURI");var h=0,p,c=[];var d=l[j+"/inventories"];for(var k=0;k<d.length;k++){var f=l[d[k]];if(!p){p=f.rateURI}h+=f.quantity;c[c.length]=f.date}var m=l[p];this.inventoryData={quantity:h,rateURI:p,rateName:m.name,groupName:m.groupName,dates:c,rateConditions:m.restrictions};this.initDetails()}}a.el.unmask()},scope:this})},initDetails:function(){var w=this.ownerCt;with(this.getDetailTab()){getLabelOffering().setText(w.getData("name"));getLabelRate().setText(this.inventoryData.rateName);getFieldNumberRoom().setValue(this.inventoryData.quantity)}},initRadioSelection:function(c){var e=this.items.itemAt(0).items.itemAt(0).items.itemAt(0).findByType("fieldset")[0];var d=e.items.itemAt(0);var h=e.items.itemAt(1);var f=e.items.itemAt(2);var a=e.items.itemAt(3);var g=e.items.itemAt(4);var i=this.ownerCt;var b=i.getParam("status");e.items.each(function(j){(j.inputValue==b)?j.setValue(true):j.setValue(false)});if(c.toLowerCase()==TDS.data.componentStatus.STATUS_HELD.toLowerCase()){h.show();f.show()}else{if(c.toLowerCase()==TDS.data.componentStatus.STATUS_REQUESTED.toLowerCase()){a.show();g.show()}else{if(c.toLowerCase()==TDS.data.componentStatus.STATUS_CONFIRMED.toLowerCase()){f.show()}else{if(c.toLowerCase()==TDS.data.componentStatus.STATUS_CANCEL_REQUESTED.toLowerCase()){f.show()}}}}}}