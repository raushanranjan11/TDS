{xtype:"panel",border:false,layout:"column",bodyStyle:"padding: 2px;",requireStores:[{dataURI:TDS.env.dataPath+"transfer/modetypes/collection",identifier:"transfer/modetypes",fields:["name","dataURI"]},{dataURI:TDS.env.dataPath+"transfer/placetypes/collection",identifier:"transfer/placetypes",fields:["name","dataURI"]},{dataURI:TDS.env.dataPath+"transfer/extracategories/collection",identifier:"transfer/extracategories",fields:["name","dataURI"]},{dataURI:TDS.env.dataPath+"rate/classes/collection",identifier:"rate/classes",fields:["name","dataURI"]},{dataURI:TDS.env.dataPath+"rate/pers/collection",identifier:"rate/pers",fields:["name","dataURI"]},{dataURI:TDS.env.dataPath+"rate/occupancies/collection",identifier:"rate/occupancies",fields:["name","dataURI"]}],items:[{xtype:"panel",height:300,border:false,frame:false,layout:"column",columnWidth:0.95,getAgencyPanel:function(){return this.items.itemAt(0)},getDetailsPanel:function(){return this.items.itemAt(1)},getPassengersPanel:function(){return this.items.itemAt(2)},hasDetailsInventory:false,hasDetailsOffering:false,isDetailsReady:function(){if(this.hasDetailsInventory&&this.hasDetailsOffering){return true}return false},items:[{xtype:"panel",layout:"column",columnWidth:0.1,hideBorders:true,height:300,items:[{tpl:new Ext.XTemplate(["<p><b>Agent:</b> {agencyName}</p>","<p><b>Consultant:</b> {consultantName}</p>","<p><b>Tel:</b> {telephoneNo}</p>","<p><b>Email:</b> {email}</p>","<p><b>Location:</b> {agentLocation}</p>","<p><b>Country:</b> {country}</p>","<p><b>Date / Time:</b> {bookingDateTime}</p>"]),listeners:{render:function(){var a=this.ownerCt.findParentByType("tabpanel");var b=a.getComponentDetail("agencyURI");Ext.Ajax.request({url:TDS.env.dataPath+b+"?forceGet=true",method:"GET",callback:function(h,d,f){if(d){try{var c=Ext.util.JSON.decode(f.responseText);this.tpl.overwrite(this.body,{agencyName:TDS.util.Format.displayResourceName(b),consultantName:a.getComponentDetail("createdByUserFullNameString"),telephoneNo:c.phoneNumber,email:c.email,agentLocation:c.locality,country:TDS.util.Format.displayResourceName(c.countryURI),bookingDateTime:TDS.util.Format.dateSpecial(a.getComponentDetail("createdDate"),TDS.env.dateTimeFormatDisplay)})}catch(g){}}},scope:this,disableCaching:true})}}}]},{columnWidth:0.5,xtype:"panel",height:300,border:true,tpl:new Ext.XTemplate('<div style="height:270px; overflow-y: scroll;">','<table class="x-tds-dataview" style="width: 100%;" border=1 cellpadding = 1 cellspacing=0  >','<tr style="background-color: #d0def0;" >','<th style="padding: 2px; width: 35%;">Service</th>','<th style="padding: 2px; width: 25%;">Departs</th>','<th style="padding: 2px; width: 25%;">Date</th>','<th style="padding: 2px; width: 15%;">Time</th>','<th style="padding: 2px; width: 15%;">Arrive</th>','<th style="padding: 2px; width: 15%;">Time</th>','<th style="padding: 2px; width: 15%;">Trip Time</th>',"</tr>","<tr>","<td>{name}</td>","<td>{fromLocationString}</td>","<td>{dateFrom}</td>","<td>{depTime}</td>","<td>{toLocationString}</td>","<td>{arrTime}</td>","<td>{duration}</td>","</tr>","</table>",'<table class="x-tds-dataview" style="width: 100%;" border=1 cellpadding = 1 cellspacing=0  >','<tr style="background-color: #d0def0;" >','<th style="padding: 2px; width: 15%;">Rate</th>','<th style="padding: 2px; width: 15%;">Cabin/Seat</th>','<th style="padding: 2px; width: 10%;">Car No</th>','<th style="padding: 2px; width: 10%;">Class</th>','<th style="padding: 2px; width: 10%;">Pax Type</th>','<th style="padding: 2px; width: 5%;">No</th>','<th style="padding: 2px; width: 10%;">Price P/P</th>','<th style="padding: 2px; width: 10%;">Status</th>',"</tr>","{rateBody}","</table>",'<table class="x-tds-dataview" style="width: 100%;" border=1 cellpadding = 1 cellspacing=0  >','<tr style="background-color: #C0D9D9;">','<th style="padding: 2px; width: 14%;">Price</th>','<th style="padding: 2px; width: 13%;">Gross/Net</th>','<th style="padding: 2px; width: 14%;">Extras</th>','<th style="padding: 2px; width: 20%;">Total Price ({grossOrNet})</th>','<th style="padding: 2px; width: 7%;">Comm%</th>',"</tr>","<tr>","<td>{tourPrice}</td>","<td>{grossOrNet}</td>","<td>{extras}</td>","<td>{totalPrice}</td>","<td>{comm}</td>","</tr>","</table>",'<table style="width: 100%;" border=0 cellpadding = 1 cellspacing=0  >',"<tr>",'<td style="padding: 2px; width: 50%;"><div  style="height:150px; width:100%; border: solid 1px;  float:left; overflow-y: scroll; overflow-x: hidden;"><b><u>Notes:</u> <br>{notes}</b></div></th>','<td style="padding: 2px; width: 50%;"><div  style="height:150px; width:100%; border: solid 1px;  float:left; overflow-y: scroll; overflow-x: hidden;"><b><u>Notes:</u> <br>{notes}</b></div></th>',"</tr>","</table>","</div>")},{xtype:"panel",height:270,columnWidth:0.4,layout:"fit",items:[{xtype:"grid",enableRowExpander:false,sessionExpandedRows:false,height:110,autoScroll:true,border:false,enableColumnHide:false,enableColumnMove:false,enableColumnResize:false,enableHdMenu:false,store:new Ext.data.JsonStore({url:"",id:"dataURI",fields:["dataURI","displayName","code","roomType","dateOfBirth","addressString","phoneNumber1","emailAddress","gender","status","abstractRateId"]}),columns:[{header:"Passenger",dataIndex:"displayName",width:220,fixed:true,sortable:true,renderer:function(e,d,a,f,c,b){return e}},{header:"Type",dataIndex:"code",width:40,fixed:true},{header:"Gender",dataIndex:"gender",renderer:TDS.util.Format.gender,width:50,fixed:true},{header:"DOB",dataIndex:"dateOfBirth",width:70,fixed:true,renderer:TDS.util.Format.dateSpecialRenderer(TDS.env.dateBirthdayFormatDisplay)},{header:"Age",dataIndex:"dateOfBirth",renderer:TDS.util.Format.age,width:40,fixed:true},{header:"Seat/Cabin",dataIndex:"seatCabin",width:70,fixed:true},{header:"Price",dataIndex:"price",width:40,fixed:true},{header:"Status",dataIndex:"status",width:50,fixed:true}],viewConfig:{forceFit:true},listeners:{render:function(){this.getEl().swallowEvent(["columnmove","columnresize","headerclick","click","mouseout","rowclick","rowmousedown","rowdbclick","cellblclick","sortchange","mouseup","mousedown"]);var b=this.ownerCt.findParentByType("tabpanel");var a=b.getComponentDetail("dataURI");Ext.Ajax.request({url:TDS.env.dataPath+a+"/passengers/collection/concise",method:"GET",callback:function(f,l,d){if(l){var j=Ext.util.JSON.decode(d.responseText);var h=j[a+"/passengers"];if(typeof h=="undefined"){return}var k=[];for(var g=0;g<h.length;g++){j[h[g]].dataURI=h[g];k.push(j[h[g]])}var e=this;var c=e.store;c.loadData(k);e.getView().refresh()}},scope:this})}}}]}],listeners:{render:function(){this.initInventory();this.initOffering()}},initInventory:function(){var d=this.ownerCt.findParentByType("tabpanel");var a=d.getComponentDetail("dataURI");var c=a;var b=new Array();b=a.split("/");Ext.Ajax.request({url:TDS.env.dataPath+a+"/inventories/collection",method:"GET",callback:function(I,E,G){if(E){try{var A=Ext.decode(G.responseText)}catch(R){}if(A){var u=0,B,J=[];var z=0;var P=A["component/inventory/collection"];var h=P[a+"/inventories"];var H=A["component/rate/collection/"];var f=H["component/rate/collection/list"];d.setDetail("rateList",f);var F=new Array();F=a.split("/");var v="";this.rateData=[];var V=h.length/f.length;var L=[];var w="";var Q=[];var t=0;if(h.length>0){for(var O=0;O<h.length;O++){var S=P[h[O]];J[J.length]=TDS.util.Format.dateSpecial(S.componentPaybyDate,TDS.env.dateFormatDisplay);w=S.pricingPriceCurrency;if(Q.indexOf(S.rateId)==-1){Q[O]=S.rateId;L[t]=TDS.util.Price.calculateFixedGrossNettPrice({pricingPriceCurrency:S.pricingPriceCurrency,pricingPriceSell:S.pricingPriceSell,pricingPriceCommission:S.pricingPriceCommission,pricingPriceIsNett:S.pricingPriceIsNett});L[t].rateId=S.rateId;L[t].quantity=S.quantity;t++}}var D="";var g="";var n=false;var y=0;var m=0;var N=0;if(f.length>0){for(var O=0;O<f.length;O++){var x=H[f[O]];N=x.extraTotal;v=H[f[O]].tempBookedDate;var C=[];var U=x.groupName;var k="";var p="";C=U.split(",");var T=[];var K=C[0];T=K.split(" ");var q=null;for(var M=0;M<L.length;M++){if(L[M].rateId==f[O].substring(f[O].lastIndexOf("/")+1,f[O].length)){q=L[M]}}n=q.priceIsNett;if(!q.priceIsNett){k=q.priceCommissionPercentage}else{p=q.priceCommission;z+=(q.quantity*q.priceCommission)}y+=(q.quantity*q.priceSell);m+=(q.quantity*q.priceSell);D+="<tr>";D+="<td>"+x.nameString+"</td>",D+="<td>"+(f[O].railSeat?"Cabin Type("+f[O].railSeat+")":"Seat")+"</td>",D+="<td> </td>",D+="<td>"+(f[O].railClass?f[O].railClass:"")+"</td>",D+="<td>"+T[0]+"</td>",D+="<td>"+q.quantity+"</td>",D+="<td>"+TDS.util.Price.formatPrice(q.priceSell,q.priceCurrency)+"</td>",D+="<td>"+d.getComponentDetail("status")+"</td>",D+="</tr>"}y+=z;y+=N}if(J.length>0){var l=J[0]}else{var l=J}d.setDetail("pricingPriceCurrency",w);this.inventoryData={name:d.getComponentDetail("name"),fromLocationString:d.getComponentDetail("locationFromString"),toLocationString:d.getComponentDetail("locationToString"),dateFrom:TDS.util.Format.dateSpecial(d.getComponentDetail("dateFrom"),TDS.env.dateFormatDisplay),status:d.getComponentDetail("status"),rateBody:D,dataURI:a,divDataUri:c,numberOfNights:V,dates:l,markup:z.toFixed(2),pnrCode:F[1],bookeddateDis:v,total:y.toFixed(2),extraTotal:N.toFixed(2),priceCurrency:w,tourPrice:TDS.util.Price.formatPrice(m,w),grossOrNet:(n?"Nett":"Gross"),extras:TDS.util.Price.formatPrice(N,w),markUp:z,totalPrice:TDS.util.Price.formatPrice(y,w),comm:g};this.hasDetailsInventory=true;if(this.isDetailsReady()){this.displayDetails()}}}}},scope:this})},initOffering:function(){var b=this.ownerCt.findParentByType("tabpanel");var a=b.getComponentDetail("offeringURI");Ext.Ajax.request({url:TDS.env.dataPath+a,method:"GET",callback:function(h,c,f){if(c){try{var d=Ext.decode(f.responseText)}catch(g){}if(d){this.offeringData={arrTime:d.arrivalTime,depTime:d.departureTime,duration:d.duration,website:d.primaryHref,addressString:d.addressString,city:d.locationToString,transferModeType:TDS.util.Format.displayResourceName(d.transferModeTypeURI),transferPlaceTypeFrom:TDS.util.Format.displayResourceName(d.transferPlaceTypeFromURI),transferPlaceTypeTo:TDS.util.Format.displayResourceName(d.transferPlaceTypeToURI)};this.hasDetailsOffering=true;if(this.isDetailsReady()){this.displayDetails()}}}},scope:this})},displayDetails:function(){var g=this.ownerCt.findParentByType("tabpanel");var b=Date.parseDate(g.getComponentDetail("createdDate"),TDS.env.dateFormat);var d=Date.parseDate(g.getComponentDetail("updatedDate"),TDS.env.dateFormat);var a="Created on "+b.format(TDS.env.dateTimeFormatDisplay)+" by "+g.getComponentDetail("createdByUserFullNameString")+", modified on "+d.format(TDS.env.dateTimeFormatDisplay)+(g.getComponentDetail("createdByUserFullNameString")==g.getComponentDetail("updatedByUserFullNameString")?"":" by "+g.getComponentDetail("updatedByUserFullNameString"))+".";var c=TDS.util.Price.calculateFixedGrossNettPrice({pricingPriceCurrency:g.getComponentDetail("pricingPriceCurrency"),pricingPriceSell:g.getComponentDetail("pricingPriceSell"),pricingPriceCommission:g.getComponentDetail("pricingPriceCommission"),pricingPriceIsNett:g.getComponentDetail("pricingPriceIsNett")});var f=this.inventoryData.Ggrosstemp;if(c.priceSell==""||c.priceSell==null||c.priceSell=="undefined"){c.priceSell=0}var e=c.priceSell*parseInt(this.inventoryData.quantity);this.getDetailsPanel().tpl.overwrite(this.getDetailsPanel().body,Ext.apply({createdString:a},this.inventoryData,this.offeringData))}},{type:"panel",autoHeight:true,border:false,bodyStyle:"padding: 2px;",width:60,columnWidth:0.05,defaults:{minWidth:60},invokeWindow:function(g,e){if(!e){e={}}var k=this.ownerCt.items.itemAt(0).items.itemAt(2).items.itemAt(0);var h=k.selModel.selections;var j=this.ownerCt.findParentByType("tabpanel");var c=j.ownerCt;var f=j.getComponentDetail("dataURI");var d=j.getComponentDetail("offeringURI");var i=j.getComponentDetail("pricingPriceCurrency");if(!f){return}Ext.apply(e,{title:"Edit",information:"You may edit the details of this component below.",interfaceURI:"fulfillment/rail/edit.js",destinationDataURI:f,sourceDataURI:"rail/rate/"+h.items[0].data.abstractRateId,dataURI:{component:f,offeringDataURI:d,passenger:h.items[0].id,offering:j.getComponentDetail("offeringURI")},params:{status:g,componentName:j.getComponentDetail("name"),priceCurrency:j.getComponentDetail("pricingPriceCurrency")},callback:{fn:function(a){if(a){c.refreshGrid()}},scope:this}});TDS.window.setWindow(e)},invokeAltOffWindow:function(f,g){if(!g){g={}}var e=this.ownerCt.items.itemAt(0).items.itemAt(2).items.itemAt(0);var c=e.selModel.selections;var i=this.ownerCt.findParentByType("tabpanel");var h=i.ownerCt;var d=i.getComponentDetail("dataURI");if(!d){return}Ext.apply(g,{title:"Alternative offer",information:"You may offer with new offering below.",interfaceURI:"fulfillment/rail/alternative.js",destinationDataURI:d+"/altOffering",dataURI:{component:d,offering:i.getComponentDetail("offeringURI")},params:{status:f,priceCurrency:i.getComponentDetail("pricingPriceCurrency")},callback:{fn:function(a){if(a){h.refreshGrid()}},scope:this}});TDS.window.setWindow(g)},listeners:{render:function(){var b=this.items.itemAt(0);var c=this.ownerCt.findParentByType("tabpanel");var a=c.getComponentDetail("status");if(a.toLowerCase()==TDS.data.componentStatus.STATUS_HELD.toLowerCase()){}else{if(a.toLowerCase()==TDS.data.componentStatus.STATUS_REQUESTED.toLowerCase()){}else{if(a.toLowerCase()==TDS.data.componentStatus.STATUS_REJECTED.toLowerCase()){b.disable()}else{if(a.toLowerCase()==TDS.data.componentStatus.STATUS_CONFIRMED.toLowerCase()||a.toLowerCase()==TDS.data.componentStatus.STATUS_PART_CONFIRMED.toLowerCase()){}else{if(a.toLowerCase()==TDS.data.componentStatus.STATUS_CANCEL_REQUESTED.toLowerCase()){}else{if(a.toLowerCase()==TDS.data.componentStatus.STATUS_CANCELLED.toLowerCase()){b.disable()}}}}}}}},items:[{xtype:"button",text:"Edit",handler:function(){var d=this.ownerCt.findParentByType("tabpanel");var c=d.ownerCt;var b="RAIL";var a=d.getComponentDetail("dataURI");TDS.window.setWindow({title:"Rail Edit Fulfillment",information:"Please enter your required details.",interfaceURI:"fulfillment/rail/edit.js",destinationDataURI:a+"/fulfillment/editPassStatus",buttonOK:"Save",data:{type:b,pnrDataURI:a,MQ:true},callback:{fn:function(e){if(e){c.refreshGrid()}},scope:this.ownerCt.ownerCt}})}},{xtype:"button",text:"Note",handler:function(){var b=this.ownerCt.findParentByType("tabpanel");var a=b.getComponentDetail("dataURI");TDS.window.setWindow({title:"Send a note",information:"Please enter your note below.",interfaceURI:"note.js",postDataURI:a+"/note",callback:{fn:function(c){},scope:this}})}}]}]}