{xtype:"panel",border:false,layout:"column",bodyStyle:"padding: 2px;",requireStores:[{dataURI:TDS.env.dataPath+"transfer/modetypes/collection",identifier:"transfer/modetypes",fields:["name","dataURI"]},{dataURI:TDS.env.dataPath+"transfer/placetypes/collection",identifier:"transfer/placetypes",fields:["name","dataURI"]},{dataURI:TDS.env.dataPath+"transfer/extracategories/collection",identifier:"transfer/extracategories",fields:["name","dataURI"]},{dataURI:TDS.env.dataPath+"rate/classes/collection",identifier:"rate/classes",fields:["name","dataURI"]},{dataURI:TDS.env.dataPath+"rate/pers/collection",identifier:"rate/pers",fields:["name","dataURI"]},{dataURI:TDS.env.dataPath+"rate/occupancies/collection",identifier:"rate/occupancies",fields:["name","dataURI"]}],items:[{xtype:"panel",height:150,border:false,frame:false,layout:"column",columnWidth:0.95,getAgencyPanel:function(){return this.items.itemAt(0)},getDetailsPanel:function(){return this.items.itemAt(1)},getPassengersPanel:function(){return this.items.itemAt(2)},hasDetailsInventory:false,hasDetailsOffering:false,isDetailsReady:function(){if(this.hasDetailsInventory&&this.hasDetailsOffering){return true}return false},items:[{xtype:"panel",layout:"column",columnWidth:0.1,hideBorders:true,height:150,items:[{tpl:new Ext.XTemplate(['<div style="height:120px;  overflow-y: scroll;">',"<p><b>Agent:</b> {agencyName}</p>","<p><b>Consultant:</b> {consultantName}</p>","<p><b>Tel:</b> {telephoneNo}</p>","<p><b>Email:</b> {email}</p>","<p><b>Location:</b> {agentLocation}</p>","<p><b>Country:</b> {country}</p>","<p><b>Date / Time:</b> {bookingDateTime}</p>","</div>"]),listeners:{render:function(){var d=this.ownerCt.findParentByType("tabpanel");var c=d.getComponentDetail("agencyURI");Ext.Ajax.request({url:TDS.env.dataPath+c+"?forceGet=true",method:"GET",callback:function(a,i,e){if(i){try{var j=Ext.util.JSON.decode(e.responseText);this.tpl.overwrite(this.body,{agencyName:TDS.util.Format.displayResourceName(c),consultantName:d.getComponentDetail("createdByUserFullNameString"),telephoneNo:j.phoneNumber,email:j.email,agentLocation:j.locality,country:TDS.util.Format.displayResourceName(j.countryURI),bookingDateTime:TDS.util.Format.dateSpecial(d.getComponentDetail("createdDate"),TDS.env.dateTimeFormatDisplay)})}catch(b){}}},scope:this,disableCaching:true})}}}]},{columnWidth:0.5,xtype:"panel",height:150,border:true,tpl:new Ext.XTemplate('<div style="height:120px; overflow-y: scroll;">','<table class="x-tds-dataview" style="width: 100%;" border=1 cellpadding = 1 cellspacing=0  >','<tr style="background-color: #d0def0;" >','<th style="padding: 2px; width: 35%;">Mode</th>','<th style="padding: 2px; width: 25%;">From</th>','<th style="padding: 2px; width: 25%;">To</th>','<th style="padding: 2px; width: 15%;">Date</th>',"</tr>","<tr>","<td>{transferModeType}</td>","<td>{fromLocationString}</td>","<td>{toLocationString}</td>","<td>{dateFrom}</td>","</tr>","</table>",'<table class="x-tds-dataview" style="width: 100%;" border=1 cellpadding = 1 cellspacing=0  >','<tr style="background-color: #d0def0;" >','<th style="padding: 2px; width: 25%;">Rate</th>','<th style="padding: 2px; width: 15%;">Passenger Type</th>','<th style="padding: 2px; width: 5%;">No.</th>','<th style="padding: 2px; width: 20%;">Price Per Person</th>','<th style="padding: 2px; width: 10%;">Status</th>',"</tr>","{rateBody}","</table>",'<table class="x-tds-dataview" style="width: 100%;" border=1 cellpadding = 1 cellspacing=0  >','<tr style="background-color: #C0D9D9;">','<th style="padding: 2px; width: 14%;">Price</th>','<th style="padding: 2px; width: 13%;">Gross/Net</th>','<th style="padding: 2px; width: 14%;">Extras</th>','<th style="padding: 2px; width: 20%;">Total Price ({grossOrNet})</th>','<th style="padding: 2px; width: 7%;">Comm%</th>',"</tr>","<tr>","<td>{tourPrice}</td>","<td>{grossOrNet}</td>","<td>{extras}</td>","<td>{totalPrice}</td>","<td>{comm}</td>","</tr>","</table>","</div>")},{xtype:"panel",height:150,columnWidth:0.4,layout:"fit",items:[{xtype:"grid",enableRowExpander:false,sessionExpandedRows:false,height:110,autoScroll:true,border:false,enableColumnHide:false,enableColumnMove:false,enableColumnResize:false,enableHdMenu:false,store:new Ext.data.JsonStore({url:"",id:"dataURI",fields:["dataURI","displayName","code","dateOfBirth","addressString","phoneNumber1","emailAddress","gender","status","abstractRateId","priceSell"]}),columns:[{header:"Passenger",dataIndex:"displayName",width:220,fixed:true,sortable:true,renderer:function(j,k,h,i,l,g){return j}},{header:"Type",dataIndex:"code",width:40,fixed:true},{header:"Gender",dataIndex:"gender",renderer:TDS.util.Format.gender,width:50,fixed:true},{header:"DOB",dataIndex:"dateOfBirth",width:70,fixed:true,renderer:TDS.util.Format.dateSpecialRenderer(TDS.env.dateBirthdayFormatDisplay)},{header:"Age",dataIndex:"dateOfBirth",renderer:TDS.util.Format.age,width:40,fixed:true},{header:"Price",dataIndex:"priceSell",width:40,fixed:true},{header:"Status",dataIndex:"status",width:50,fixed:true}],viewConfig:{forceFit:true},listeners:{render:function(){this.getEl().swallowEvent(["columnmove","columnresize","headerclick","click","mouseout","rowclick","rowmousedown","rowdbclick","cellblclick","sortchange","mouseup","mousedown"]);var c=this.ownerCt.findParentByType("tabpanel");var d=c.getComponentDetail("dataURI");Ext.Ajax.request({url:TDS.env.dataPath+d+"/passengers/collection/concise",method:"GET",callback:function(o,a,q){if(a){var i=Ext.util.JSON.decode(q.responseText);var m=i[d+"/passengers"];if(typeof m=="undefined"){return}var b=[];for(var n=0;n<m.length;n++){i[m[n]].dataURI=m[n];b.push(i[m[n]])}var p=this;var r=p.store;r.loadData(b);p.getView().refresh()}},scope:this})}}}]}],listeners:{render:function(){this.initInventory();this.initOffering()}},initInventory:function(){var g=this.ownerCt.findParentByType("tabpanel");var f=g.getComponentDetail("dataURI");var h=f;var e=new Array();e=f.split("/");Ext.Ajax.request({url:TDS.env.dataPath+f+"/inventories/collection",method:"GET",callback:function(ab,af,ad){if(af){try{var aj=Ext.decode(ad.responseText)}catch(i){}if(aj){var aq=0,ai,aa=[];var al=0;var o=aj["component/inventory/collection"];var az=o[f+"/inventories"];var ac=aj["component/rate/collection/"];var aB=ac["component/rate/collection/list"];g.setDetail("rateList",aB);var ae=new Array();ae=f.split("/");var ap="";this.rateData=[];var a=az.length/aB.length;var Y=[];var ao="";var j=[];var ar=0;if(az.length>0){for(var r=0;r<az.length;r++){var d=o[az[r]];aa[aa.length]=TDS.util.Format.dateSpecial(d.componentPaybyDate,TDS.env.dateFormatDisplay);ao=d.pricingPriceCurrency;if(j.indexOf(d.rateId)==-1){j[r]=d.rateId;Y[ar]=TDS.util.Price.calculateFixedGrossNettPrice({pricingPriceCurrency:d.pricingPriceCurrency,pricingPriceSell:d.pricingPriceSell,pricingPriceCommission:d.pricingPriceCommission,pricingPriceIsNett:d.pricingPriceIsNett});Y[ar].rateId=d.rateId;Y[ar].quantity=d.quantity;ar++}}var ag="";var aA="";var av=false;var am=0;var aw=0;var s=0;if(aB.length>0){for(var r=0;r<aB.length;r++){var an=ac[aB[r]];s=an.extraTotal;ap=ac[aB[r]].tempBookedDate;var ah=[];var b=an.groupName;var c=[];if(typeof(b)!="undefined"){ah=W.split(",");var Z=ag[0];c=Z.split(" ")}var ay="";var au="";var c=[];var at=null;for(var X=0;X<Y.length;X++){if(Y[X].rateId==aB[r].substring(aB[r].lastIndexOf("/")+1,aB[r].length)){at=Y[X]}}av=at.priceIsNett;if(!at.priceIsNett){ay=at.priceCommissionPercentage}else{au=at.priceCommission;al+=(at.quantity*at.priceCommission)}am+=(at.quantity*at.priceSell);aw+=(at.quantity*at.priceSell);ag+="<tr>";ag+="<td>"+an.nameString+"</td>",ag+="<td>"+c[0]+"</td>",ag+="<td>"+at.quantity+"</td>",ag+="<td>"+TDS.util.Price.formatPrice(at.priceSell,at.priceCurrency)+"</td>",ag+="<td>"+g.getComponentDetail("status")+"</td>",ag+="</tr>"}am+=al;am+=s}if(aa.length>0){var ax=aa[0]}else{var ax=aa}var ak=this.findParentByType("tabpanel").items.items[0].findByType("button")[0];g.setDetail("pricingPriceCurrency",ao);this.inventoryData={fromLocationString:g.getComponentDetail("locationFromString"),toLocationString:g.getComponentDetail("locationToString"),dateFrom:TDS.util.Format.dateSpecial(g.getComponentDetail("dateFrom"),TDS.env.dateFormatDisplay),duration:g.getComponentDetail("duration"),status:g.getComponentDetail("status"),rateBody:ag,dataURI:f,divDataUri:h,numberOfNights:a,dates:ax,markup:al.toFixed(2),pnrCode:ae[1],bookeddateDis:ap,total:am.toFixed(2),extraTotal:s.toFixed(2),priceCurrency:ao,tourPrice:TDS.util.Price.formatPrice(aw,ao),grossOrNet:(av?"Nett":"Gross"),extras:TDS.util.Price.formatPrice(s,ao),markUp:al,totalPrice:TDS.util.Price.formatPrice(am,ao),comm:aA};this.hasDetailsInventory=true;if(this.isDetailsReady()){this.displayDetails()}}}}},scope:this})},initOffering:function(){var c=this.ownerCt.findParentByType("tabpanel");var d=c.getComponentDetail("offeringURI");Ext.Ajax.request({url:TDS.env.dataPath+d,method:"GET",callback:function(a,k,i){if(k){try{var j=Ext.decode(i.responseText)}catch(e){}if(j){this.offeringData={website:j.primaryHref,addressString:j.addressString,city:j.locationToString,transferModeType:TDS.util.Format.displayResourceName(j.transferModeTypeURI),transferPlaceTypeFrom:TDS.util.Format.displayResourceName(j.transferPlaceTypeFromURI),transferPlaceTypeTo:TDS.util.Format.displayResourceName(j.transferPlaceTypeToURI)};this.hasDetailsOffering=true;if(this.isDetailsReady()){this.displayDetails()}var b=this.findParentByType("tabpanel").items.items[0].findByType("button")[0];b.config.modetypes=TDS.util.Format.displayResourceName(j.transferModeTypeURI)}}},scope:this})},displayDetails:function(){var j=this.ownerCt.findParentByType("tabpanel");var h=Date.parseDate(j.getComponentDetail("createdDate"),TDS.env.dateFormat);var m=Date.parseDate(j.getComponentDetail("updatedDate"),TDS.env.dateFormat);var i="Created on "+h.format(TDS.env.dateTimeFormatDisplay)+" by "+j.getComponentDetail("createdByUserFullNameString")+", modified on "+m.format(TDS.env.dateTimeFormatDisplay)+(j.getComponentDetail("createdByUserFullNameString")==j.getComponentDetail("updatedByUserFullNameString")?"":" by "+j.getComponentDetail("updatedByUserFullNameString"))+".";var n=TDS.util.Price.calculateFixedGrossNettPrice({pricingPriceCurrency:j.getComponentDetail("pricingPriceCurrency"),pricingPriceSell:j.getComponentDetail("pricingPriceSell"),pricingPriceCommission:j.getComponentDetail("pricingPriceCommission"),pricingPriceIsNett:j.getComponentDetail("pricingPriceIsNett")});var k=this.inventoryData.Ggrosstemp;if(n.priceSell==""||n.priceSell==null||n.priceSell=="undefined"){n.priceSell=0}var l=n.priceSell*parseInt(this.inventoryData.quantity);this.getDetailsPanel().tpl.overwrite(this.getDetailsPanel().body,Ext.apply({createdString:i},this.inventoryData,this.offeringData))}},{type:"panel",autoHeight:true,border:false,bodyStyle:"padding: 2px;",width:60,columnWidth:0.05,defaults:{minWidth:60},invokeWindow:function(n,p){if(!p){p={}}var a=this.ownerCt.items.itemAt(0).items.itemAt(2).items.itemAt(0);var m=a.selModel.selections;var b=this.ownerCt.findParentByType("tabpanel");var r=b.ownerCt;var o=b.getComponentDetail("dataURI");var q=b.getComponentDetail("offeringURI");var l=b.getComponentDetail("pricingPriceCurrency");if(!o){return}Ext.apply(p,{title:"Edit",information:"You may edit the details of this component below.",interfaceURI:"fulfillment/transfer/edit.js",destinationDataURI:o,sourceDataURI:"transfer/rate/"+m.items[0].data.abstractRateId,dataURI:{component:o,offeringDataURI:q,passenger:m.items[0].id,offering:b.getComponentDetail("offeringURI")},params:{status:n,componentName:b.getComponentDetail("name"),priceCurrency:b.getComponentDetail("pricingPriceCurrency")},callback:{fn:function(c){if(c){r.refreshGrid()}},scope:this}});TDS.window.setWindow(p)},invokeAltOffWindow:function(k,j){if(!j){j={}}var l=this.ownerCt.items.itemAt(0).items.itemAt(2).items.itemAt(0);var n=l.selModel.selections;var a=this.ownerCt.findParentByType("tabpanel");var b=a.ownerCt;var m=a.getComponentDetail("dataURI");if(!m){return}Ext.apply(j,{title:"Alternative offer",information:"You may offer with new offering below.",interfaceURI:"fulfillment/transfer/alternative.js",destinationDataURI:m+"/altOffering",dataURI:{component:m,offering:a.getComponentDetail("offeringURI")},params:{status:k,priceCurrency:a.getComponentDetail("pricingPriceCurrency")},callback:{fn:function(c){if(c){b.refreshGrid()}},scope:this}});TDS.window.setWindow(j)},listeners:{render:function(){var d=this.items.itemAt(0);var f=this.ownerCt.findParentByType("tabpanel");var e=f.getComponentDetail("status");if(e.toLowerCase()==TDS.data.componentStatus.STATUS_HELD.toLowerCase()){}else{if(e.toLowerCase()==TDS.data.componentStatus.STATUS_REQUESTED.toLowerCase()){}else{if(e.toLowerCase()==TDS.data.componentStatus.STATUS_REJECTED.toLowerCase()){d.disable()}else{if(e.toLowerCase()==TDS.data.componentStatus.STATUS_CONFIRMED.toLowerCase()||e.toLowerCase()==TDS.data.componentStatus.STATUS_PART_CONFIRMED.toLowerCase()){}else{if(e.toLowerCase()==TDS.data.componentStatus.STATUS_CANCEL_REQUESTED.toLowerCase()){}else{if(e.toLowerCase()==TDS.data.componentStatus.STATUS_CANCELLED.toLowerCase()){}}}}}}}},items:[{xtype:"button",text:"Edit",config:{rateList:"",status:"",offeringURI:"",priceperperson:"",deptDate:"",modetypes:""},handler:function(){var h=this.ownerCt.findParentByType("tabpanel");var i=h.ownerCt;var e="TRANSFER";var f=h.getComponentDetail("dataURI");var g=this;TDS.window.setWindow({title:"Transfer Edit Fulfillment",information:"Please enter your required details.",interfaceURI:"fulfillment/transfer/edit.js",destinationDataURI:f+"/fulfillment/editPassStatus",buttonOK:"Save",scope:g,dataURI:{dataURI:f},data:{type:e,pnrDataURI:f,MQ:true,componentName:h.getComponentDetail("name")},callback:{fn:function(a){if(a){i.refreshGrid()}},scope:this.ownerCt.ownerCt}})}},{xtype:"button",text:"Note",handler:function(){var c=this.ownerCt.findParentByType("tabpanel");var d=c.getComponentDetail("dataURI");TDS.window.setWindow({title:"Send a note",information:"Please enter your note below.",interfaceURI:"note.js",postDataURI:d+"/note",callback:{fn:function(a){},scope:this}})}}]}]}