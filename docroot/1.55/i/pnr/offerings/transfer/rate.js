{xtype:"panel",border:false,requireStores:[{dataURI:TDS.env.dataPath+"rate/classes/collection",identifier:"rate/classes",fields:["name","dataURI"]},{dataURI:TDS.env.dataPath+"rate/occupancies/collection",identifier:"rate/occupancies",fields:["name","dataURI"]},{dataURI:TDS.env.dataPath+"rate/pers/collection",identifier:"rate/pers",fields:["name","dataURI"]}],findField:function(c){var d=false;this.getRateToolbar().items.each(function(a){if(a.name==c){d=a;return true}});return d},getMultipleSelectedRateURI:function(){var p=this.findParentByType("tabpanel");var A=this.getRateGrid();var t=p.shared.stores.rates;var y=t.data.length;var z=[];var r=0;var B=0;for(var x=0;x<y;x++){var v=t.getAt(x);var q=v.data.shareAvailabilitywith;var w=v.data.dataURI;var i=document.getElementById("no"+w).value;if(q==""){if(document.getElementById("rd"+w)!=null&&document.getElementById("rd"+w).checked&&i!=0&&i!=""){z[r]=v;r++;B+=parseInt(i)}}else{if(document.getElementById("ch"+w)!=null&&document.getElementById("ch"+w).checked){z[r]=v;r++;B+=parseInt(i)}}}var p=this.findParentByType("tabpanel");var s=p.getTabField("Book","numberToReserve");var u=this.findField("minimumAvailable");if(s&&u){s.setValue(B)}return z},getRateGrid:function(){return this.items.itemAt(0).items.itemAt(0).items.itemAt(0).items.itemAt(0)},getRateToolbar:function(){return this.items.itemAt(0).items.itemAt(0).items.itemAt(0).getTopToolbar()},getSelectedRateURI:function(){var b=this.getRateGrid().getSelectionModel().getSelected();if(typeof b!="undefined"){return b.get("dataURI")}return false},focusBookTab:function(){var k=this.findParentByType("tabpanel");var o=k.getTabField("Book","datePointer");var l=k.getTabField("Book","dateDays");var i=this.findField("datePointer");var p=this.findField("dateDays");if(o&&i){o.setValue(i.getValue())}if(l&&p){l.setValue(p.getValue())}var n=k.getTabField("Book","rateURI");var j=this.getSelectedRateURI();if(n&&j){n.setValue(j)}this.getMultipleSelectedRateURI();var m=k.getTab("Book");if(m){m.setNumberOfRatePerFieldByRateURI(j);m.submit()}k.setActiveTab(2)},items:{xtype:"panel",layout:"column",bodyStyle:"padding: 8px;",border:false,items:[{xtype:"panel",border:false,height:150,width:700,items:[{xtype:"awesomepanel",height:136,layout:"fit",searchURI:"",store:new Ext.data.JsonStore({url:"",id:"dataURI",fields:["dataURI","nameString","agencyURI","maximumOccupancy","groupName","inventoryAvailable","queueRequestable","special","available","conversionCurrency","convertedPricingPriceSell","convertedPricingPriceIsNett","convertedPricingPriceCommission","rateClassURI","ratePerURI","rateOccupancyURI","agencyGroupId","shareAvailabilitywith","flagCount","offeringURI","childChbox","noOfPersons","mode","defaultFee","suppierPricing","homeCurrency"]}),tbar:["Price from ",{xtype:"textfield",name:"amountLower",enableKeyEvents:true,width:60}," ","No of Pax",{xtype:"omnicrementer",name:"minimumAvailable",width:60,value:1,minValue:1,maxValue:8}," ","Available"," ",{xtype:"datefield",name:"datePointer",enableKeyEvents:true,showToday:false,width:80,format:"dMy",minValue:Ext.TimerMgr.getServerCalculatedDate().clearTime()},{xtype:"omnicrementer",name:"dateDays",width:60,hidden:true,editable:false}],items:[{xtype:"grid",width:500,border:false,enableColumnHide:false,enableColumnMove:false,enableColumnResize:false,enableHdMenu:false,viewConfig:{forceFit:true},sm:new Ext.grid.CheckboxSelectionModel(),columns:[{header:"",width:35,id:"chk",dataIndex:"chk",editable:false,renderer:function(k,n,h,l,j,m){var i=h.get("dataURI");if(h.get("shareAvailabilitywith")==""){return'<input type="radio" id = "rd'+i+'" name="parentRate" /><input type="hidden" name="existingParentId" id="existingParentId" value="">'}else{return'&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<input type="checkbox" id="ch'+i+'" name="rateChk[]" disabled/>'}}},{header:"Rate",editable:false,dataIndex:"nameString",width:105,renderer:function(f,d,e){if(e.get("special")){d.attr='style="color: red;"'}else{if(e.get("agencyURI")!=""){d.attr='style="color: blue;"'}}if(e.get("agencyGroupId")!=""){d.attr='style="color: green;"'}return f}},{header:"Mode",editable:false,dataIndex:"mode",width:75,renderer:function(d,f,e){return d}},{header:"Basis",editable:false,dataIndex:"groupName",width:125},{header:"Gross Price",editable:false,dataIndex:"convertedPricingPriceSell",renderer:TDS.util.Price.conversionGrossNettPriceRenderer,width:125},{header:"No of Pax.",dataIndex:"",width:95,renderer:function(l,p,i,n,k,o){var j=i.get("dataURI");var m="no"+j;return'<input type="text" size="3" id="'+m+'" name="noOfPersons" value="1"  disabled> &nbsp;<button type="button"> + </button> '}},{header:"Status",editable:false,dataIndex:"available",fixed:true,width:75,renderer:function(d,f,e){return d}},{header:"",editable:false,dataIndex:"",width:35,renderer:function(f,d,e){if(e.get("shareAvailabilitywith")==""){return'<input type="password" name="" style="border:#FFFFFF; display:compact; font:Verdana; font-weight: bold; background: none; div {text-align: lert; }; color:#ff0000" disabled value = "a">'}}}],listeners:{beforerender:function(){this.store=this.ownerCt.store},render:function(){this.getEl().swallowEvent(["columnmove","columnresize","headerclick","click","mouseout","mouseover","rowclick","rowmousedown","sortchange","mouseup","mousedown"])},rowclick:function(J,E,I){I.stopPropagation();var R=this.getStore().getAt(E);var T=R.get("offeringURI");var N=R.get("dataURI");R.set("noOfPersons",document.getElementById("no"+N).value);var L=R.get("noOfPersons");if(document.getElementById("rd"+N)!=null){document.getElementById("no"+N).disabled=false;var k=this.getStore();var S="";var e=0;var V=R.store.data.length;for(var K=0;K<V;K++){var P=k.getAt(K);S=P.get("dataURI");if(document.getElementById("rd"+S)!=null&&document.getElementById("rd"+S).checked&&(P.get("shareAvailabilitywith")==null||P.get("shareAvailabilitywith")=="")){for(var i=0;i<P.get("flagCount");i++){document.getElementById("ch"+P.get("childChbox")[i]).disabled=false}}else{if((P.get("shareAvailabilitywith")==null||P.get("shareAvailabilitywith")=="")){for(var j=0;j<P.get("flagCount");j++){document.getElementById("ch"+P.get("childChbox")[j]).disabled=true;document.getElementById("ch"+P.get("childChbox")[j]).checked=false}}}}}if(R==-1){return}var F={rate:R.data};var p=this.ownerCt.findParentByType("ajaxpanel");var U=this.ownerCt.findParentByType("tabpanel");var H=U.getPNRCurrency();var t=this.ownerCt.ownerCt.ownerCt.items.itemAt(1);t.el.mask("","x-mask-loading");var O=new Ext.data.CollectionStore({autoLoad:true,url:TDS.env.dataPath+p.baseDataURI+"/searchExtras/collection?rateURI="+R.get("dataURI")+"&currency="+H,identifier:p.baseDataURI+"/searchExtras?rateURI="+R.get("dataURI")+"&currency="+H,fields:["dataURI","nameString","termsAndConditions","extraCategoryURI","required","minimumInventoryRequired","conversionCurrency","convertedPricingPriceSell","convertedPricingPriceIsNett","convertedPricingPriceCommission","rateClassURI","ratePerURI","rateOccupancyURI","shareAvailabilitywith","flagCount","offeringURI","childChbox","defaultFee"]});O.on("load",function(f,o){F.extras=[];TDS.data[R.get("dataURI")]=[];var g=R.get("dataURI");for(var m=0;m<o.length;m++){o[m].data.rateURI=g;o[m].data.doWork="if(this.checked){TDS.data['"+g+"'].push(this.value);}else{TDS.data['"+g+"'].pop(this.value);}";F.extras[m]=o[m].data;Ext.apply(F.extras[m],TDS.util.Price.calculateGrossNettPrice(F.extras[m]))}var h=t.items.itemAt(0);var n=t.items.itemAt(1);var l=t.items.itemAt(2);var d=l.items.itemAt(1);var a=l.items.itemAt(0);var b=l.items.itemAt(2);var c=t.items.itemAt(3);h.hide();n.tpl.overwrite(n.body,F.rate);if(F.extras.length>0){c.tpl.overwrite(c.body,F.extras)}if(document.getElementById("ch"+N)==null){if(document.getElementById("rd"+N)!=null){if(document.getElementById("rd"+N).checked){d.extras=F.extras;d.show();a.show();if(F.rate.restrictions&&F.rate.restrictions.length>6){b.show()}else{b.hide()}}else{if(d.hidden){d.hide();a.hide();b.hide()}}}}t.el.unmask()},this);var M=this.getSelectionModel().selections.items[0].data;var Q=this.ownerCt.ownerCt.ownerCt.items.itemAt(1).items.itemAt(0);var G={};G=M;Q.tpl.overwrite(Q.body,Ext.apply({convertedPricingPriceSells:TDS.util.Price.formatPrice((G.convertedPricingPriceSell*G.noOfPersons),G.conversionCurrency),defaultFees:TDS.util.Price.formatPrice(G.defaultFee,G.conversionCurrency),totals:TDS.util.Price.formatPrice((G.convertedPricingPriceSell*G.noOfPersons)+G.defaultFee,G.conversionCurrency)},G))}}}],listeners:{toolbarinit:function(){var m=this.ownerCt.findParentByType("awesomegrid");var n=this.ownerCt.findParentByType("tabpanel");var l=m.findField("datePointer");var o=m.findField("dateDays");var k=m.findField("maximumOccupancy");var j=this.getTopToolbar().items.itemAt(4);var q=this.getTopToolbar().items.itemAt(8);var r=this.getTopToolbar().items.itemAt(9);if(l){q.setValue(l.getValue())}if(o){r.setValue(o.getValue())}if(k){j.setValue(k.getValue())}this.searchURI=TDS.env.dataPath+n.getDetail("offeringURI")+"/searchRates";this.appendQueryParams.currency=n.getPNRCurrency();var p=n.shared.stores.rates;this.getStore().on("load",function(a,b){p.removeAll();p.add(b)})}}},{border:false,html:'<p style="font-size: 9px; padding-top: 3px;">* Rates that appear highlighted red are <b style="color: red;">special</b> rates And  Rates that appear highlighted green are <b style="color: green;">special agency</b> rates.</p>'}]},{xtype:"panel",cls:"x-tds-rate-table",columnWidth:1,layout:"table",layoutConfig:{columns:2},height:150,bodyStyle:"padding-left: 8px;",hideBorders:true,border:false,items:[{html:"<p>Select a rate to view more details and available extras.</p>",colspan:2},{colspan:2,hidden:true,tpl:new Ext.XTemplate(["<p>{groupName}</p>"])},{xtype:"panel",layout:"table",colspan:2,width:160,layoutConfig:{columns:2},defaults:{style:"padding-left: 2px;",minWidth:80},items:[{xtype:"formredbutton",text:"Select",hidden:true,handler:function(){var b=this.ownerCt.ownerCt.ownerCt.ownerCt;b.focusBookTab()}},{xtype:"button",text:"Notes",extras:[],hidden:true,handler:function(){var h=this.ownerCt.ownerCt.ownerCt.ownerCt;var f=h.getSelectedRateURI();if(!f){return}var g=this.ownerCt.ownerCt.findParentByType("tabpanel");var e=g.getTabField("Rate","datePointer");TDS.window.setWindow({title:"Notes",interfaceURI:"popup/terms.js",sourceDataURI:f,extras:this.extras,data:{offeringData:g.ownerCt.ownerCt.rowRecordData,departureDate:e.getRawValue()},buttonOK:false,buttonCancel:"Close"})}},{colspan:2,border:false,hidden:true,html:'<font size="4" color="#cc0033">*</font><font color="#0000ff">Notes available for this rate.</font>'}]},{colspan:2,tpl:new Ext.XTemplate(['<div style="height: 100px; overflow-x:hidden; margin-top: 8px;">','<table class="x-tds-dataview" style="width: 100%;">',"<thead>","<tr>",'<th style="width: 20px; padding-bottom: 2px;"></th>','<th style="padding-bottom: 2px;">Extra</th>','<th style="width: 90px; padding-bottom: 2px;">No.</th>','<th style="width: 120px; padding-bottom: 2px;">Pricing</th>',"</tr>","</thead>",'<tpl for=".">','<tr class="x-tds-dataview-extras-item">','<td ><input type="checkbox" id = "{rateURI}{dataURI}" value="{dataURI}" {[values.required ?  "disabled checked" : "" ]} onclick={doWork}></td>','<td style="width: 140px;{[values.required ? " color: gray;" : "" ]}">{nameString}</td>',"<td>{minimumInventoryRequired}</td>",'<td style="width: 140px;{[values.priceIsCredit ? " color: green;" : "" ]}">{priceFormatted}{[values.priceIsCredit ? " CR" : "" ]}</td>',"</tr>","</tpl>","</table>","</div>",'<hr style="height: 1px; border: none; border-top: 1px solid #eee;"/>','<p style="font-size: 9px;">* Extras that appear greyed out are <b>mandatory</b> extras on this rate.</p>'])}]}]}}