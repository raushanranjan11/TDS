{xtype:"panel",cls:"x-tds-availability",width:750,height:170,dt:new Ext.util.DelayedTask(),delay:400,border:false,hideBorders:true,findField:function(b){var a=false;this.getTopToolbar().items.each(function(c){if(c.name==b){a=c;return true}});return a},getDataURI:function(){return this.ownerCt.baseDataURI},getPNRDataURI:function(){return this.ownerCt.pnrDataURI},getDataBox:function(){return this.items.itemAt(0)},getTimerLabel:function(){return this.getTopToolbar().items.itemAt(17)},getRecheckButton:function(){return this.getTopToolbar().items.itemAt(18)},getQueryData:function(){var c={};var a=this.getTopToolbar();var b=this.getDataBox();a.items.each(function(e){if(e.xtype==="textfield"||e.xtype==="combo"||e.xtype==="omnicrementer"){c[e.name]=e.getValue()}else{if(e.xtype==="datefield"){var d=e.getValue();if(d){c[e.name]=d.format(TDS.env.dateFormat)}}}},this);if(c.rateURI&&c.datePointer&&c.dateDays>=0){return c}return false},getPnrPanel:function(){return this.ownerCt.findParentByType("pnrpanel")},setNumberOfRatePerFieldByRateURI:function(e){var f=this.ownerCt.findParentByType("tabpanel");var a=f.shared.stores.rates;var c=a.getById(e);var b=this.findField("numberOfRatePerType");if(c!=-1&&b){var d=TDS.data.findRecordByResourceDataURI(c.get("ratePerURI"));b.setValue("# of "+d.get("name"))}},expireInterface:function(){this.getTimerLabel().hide();this.getRecheckButton().show();var a=this.getDataBox();a.store.removeAll();a.updateCalendarStatus()},submit:function(){this.dt.cancel();this.dt.delay(this.delay,this.submitQuery,this)},submitQuery:function(){var b=this.getDataBox();var a=this.getQueryData();if(!a){this.dt.cancel();return}b.lm.show();b.store.removeAll();b.updateCalendarStatus();Ext.Ajax.request({method:"GET",url:TDS.env.dataPath+this.getDataURI()+"/reservation",params:a,callback:this.submitResponse,scope:this})},submitResponse:function(g,c,e){if(c){var f=Ext.decode(e.responseText);var b=this.getDataBox();b.store.loadData(f);b.updateCalendarStatus();b.lm.hide();var a=new Date().add(Date.SECOND,240).format(TDS.env.dateFormat);this.getTimerLabel().activate(a)}},tbar:["Rate",{xtype:"combo",name:"rateURI",mode:"local",width:140,triggerAction:"all",editable:false,displayField:"nameString",valueField:"dataURI",listeners:{select:function(){var a=this.ownerCt.ownerCt;a.setNumberOfRatePerFieldByRateURI(this.getValue());a.submit()}}}," ",{xtype:"fieldlabel",name:"numberOfRatePerType",text:"# of"}," ",{xtype:"omnicrementer",name:"numberToReserve",width:60,value:1,minValue:1,maxValue:7,listeners:{trigger:function(){var b=this.ownerCt.ownerCt;var c=this.findParentByType("tabpanel");var a=c.getTabField("Rate","minimumAvailable");if(a){a.setValue(this.getValue())}b.submit()}}}," ","Available"," ",{xtype:"datefield",name:"datePointer",enableKeyEvents:true,showToday:false,width:80,format:"dMy",minValue:Ext.TimerMgr.getServerCalculatedDate().clearTime(),menuListeners:{select:function(g,d){var e=this.ownerCt.ownerCt;this.setValue(d);var f=this.findParentByType("tabpanel");var b=f.getTabField("Rate","datePointer");if(b){b.setValue(this.getValue())}var a=e.getDataBox();a.setDate(this.getValue());e.submit()}}},"+",{xtype:"omnicrementer",name:"dateDays",width:60,editable:false,listeners:{trigger:function(){var b=this.ownerCt.ownerCt;var c=this.findParentByType("tabpanel");var a=c.getTabField("Rate","dateDays");if(a){a.setValue(this.getValue())}b.submit()}}}," ","days"," ","-"," ",{xtype:"timerlabel",text:"",activate:function(b){var c=this.ownerCt.ownerCt;var a=Ext.TimerMgr.start(new Ext.Timer({id:c.getDataURI()+"/availability",useServerTime:false,expireTime:b,interval:1000}));this.setTimer(a)},reset:function(){var a=this.ownerCt.ownerCt;this.cancelTimer();this.setText('<b>Availability:  <font color="#cc0000">Checking...</font></b>',false)},listeners:{timerexpire:function(a){var b=this.ownerCt.ownerCt;b.expireInterface()},timerrefresh:function(a,b){this.setText('<b>Availability: <font color="#cc0000">Valid for '+b+"</font></b>",false)}}},{xtype:"redbutton",text:"Availability: Expired, click to re-check.",hidden:true,handler:function(){var a=this.ownerCt.ownerCt;a.submitQuery();this.hide();a.getTimerLabel().show()}}],items:[{xtype:"databox",listeners:{go:function(m,j,c){;var g=this.getRecordByDate(c);var k=this.getDaysFromDate(c);var b=this.ownerCt;var i=b.findParentByType("tabpanel");var f=b.findField("numberToReserve");var h=i.shared.stores.rates;var e=b.findField("rateURI");var a=b.findField("railClass");var l=e.getValue();var d=h.getById(l);if(d==-1){return}TDS.window.setWindow({title:"Booking",interfaceURI:"pnr/offerings/rail/go.js",postDataURI:b.getPNRDataURI()+"/component",mergeData:true,dataURI:{pnr:b.getPNRDataURI(),offering:b.getDataURI()},data:{dateFrom:c.format(TDS.env.dateFormat),offeringURI:i.getDetail("offeringURI"),rateURI:l,priceCurrency:d.get("conversionCurrency")},params:{rateName:e.getRawValue(),rateId:e.getValue(),rateBasis:d.get("groupName"),railClass:d.get("railClass"),railSeat:d.get("railSeat"),offeringName:i.getDetail("offeringName"),numberToReserveRequested:f.getValue(),priceCurrency:d.get("conversionCurrency"),priceSell:d.get("convertedPricingPriceSell"),rateClassURI:d.get("rateClassURI"),ratePerURI:d.get("ratePerURI"),rateOccupancyURI:d.get("rateOccupancyURI"),daysAvailable:k.availableDays,daysRequestable:k.requestableDays},callback:{fn:function(o,r,n){if(o){var t=this.ownerCt.getPnrPanel();var q=t.getViewByName("pnr");if(q){var p=q.findByType("awesomegrid")[0];p.submitQuery(true)}if(!r.makeAnotherBooking){t.focusView("pnrView","pnr")}b.expireInterface()}},scope:this}})}}}],listeners:{render:function(){var i=this.ownerCt.findParentByType("tabpanel");this.lm=new Ext.LoadMask(this.bwrap,{msg:""});var f=this.getTopToolbar().items.itemAt(1);f.store=i.shared.stores.rates;var b=i.getTabField("Rate","datePointer");var c=i.getTabField("Rate","dateDays");var j=i.getTabField("Rate","minimumAvailable");var k=this.findField("datePointer");var h=this.findField("dateDays");var g=this.findField("numberToReserve");if(b&&k){k.setValue(b.getValue());this.getDataBox().firstDate=b.getValue()}if(c&&h){h.setValue(c.getValue())}if(j&&g){g.setValue(j.getValue())}var d=i.getTab("Rate");if(d){var e=this.findField("rateURI");var a=d.getSelectedRateURI();if(e&&a){e.setValue(a);this.setNumberOfRatePerFieldByRateURI(a)}}this.submit()}}}