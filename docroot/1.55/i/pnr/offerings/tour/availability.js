{xtype:"panel",cls:"x-tds-availability",width:750,height:170,dt:new Ext.util.DelayedTask(),delay:400,border:false,hideBorders:true,findField:function(c){var d=false;this.getTopToolbar().items.each(function(a){if(a.name==c){d=a;return true}});return d},getDataURI:function(){return this.ownerCt.baseDataURI},getPNRDataURI:function(){return this.ownerCt.pnrDataURI},getDataBox:function(){return this.items.itemAt(0)},getTimerLabel:function(){return this.getTopToolbar().items.itemAt(17)},getRecheckButton:function(){return this.getTopToolbar().items.itemAt(18)},getQueryData:function(){var f={};var e=this.getTopToolbar();var d=this.getDataBox();e.items.each(function(a){if(a.xtype==="textfield"||a.xtype==="combo"||a.xtype==="omnicrementer"){f[a.name]=a.getValue()}else{if(a.xtype==="datefield"){var b=a.getValue();if(b){f[a.name]=b.format(TDS.env.dateFormat)}}}},this);if(f.rateURI&&f.datePointer&&f.dateDays>=0){return f}return false},getPnrPanel:function(){return this.ownerCt.findParentByType("pnrpanel")},setNumberOfRatePerFieldByRateURI:function(j){var i=this.ownerCt.findParentByType("tabpanel");var h=i.shared.stores.rates;var l=h.getById(j);var g=this.findField("numberOfRatePerType");if(l!=-1&&g){var k=TDS.data.findRecordByResourceDataURI(l.get("ratePerURI"));g.setValue("# of "+k.get("name"))}},expireInterface:function(){this.getTimerLabel().hide();this.getRecheckButton().show();var b=this.getDataBox();b.store.removeAll();b.updateCalendarStatus()},submit:function(){this.dt.cancel();this.dt.delay(this.delay,this.submitQuery,this)},submitQuery:function(){var c=this.getDataBox();var d=this.getQueryData();if(!d){this.dt.cancel();return}c.lm.show();c.store.removeAll();c.updateCalendarStatus();Ext.Ajax.request({method:"GET",url:TDS.env.dataPath+this.getDataURI()+"/reservation",params:d,callback:this.submitResponse,scope:this})},submitResponse:function(i,l,k){if(l){var j=Ext.decode(k.responseText);var d=this.getDataBox();d.store.loadData(j);d.updateCalendarStatus();d.lm.hide();var h=new Date().add(Date.SECOND,240).format(TDS.env.dateFormat);this.getTimerLabel().activate(h)}},tbar:["Rate",{xtype:"combo",name:"rateURI",mode:"local",width:140,triggerAction:"all",editable:false,displayField:"nameString",valueField:"dataURI",listeners:{select:function(){var b=this.ownerCt.ownerCt;b.setNumberOfRatePerFieldByRateURI(this.getValue());b.submit()}}}," ",{xtype:"fieldlabel",hidden:true,name:"numberOfRatePerType",text:"Pax."}," ",{xtype:"omnicrementer",hidden:true,name:"numberToReserve",width:60,value:1,minValue:1,maxValue:7,listeners:{trigger:function(){var d=this.ownerCt.ownerCt;var f=this.findParentByType("tabpanel");var e=f.getTabField("Rate","minimumAvailable");if(e){e.setValue(this.getValue())}d.submit()}}}," ","Available"," ",{xtype:"datefield",name:"datePointer",enableKeyEvents:true,showToday:false,width:80,format:"dMy",minValue:Ext.TimerMgr.getServerCalculatedDate().clearTime(),menuListeners:{select:function(i,l){var k=this.ownerCt.ownerCt;this.setValue(l);var j=this.findParentByType("tabpanel");var c=j.getTabField("Rate","datePointer");if(c){c.setValue(this.getValue())}var h=k.getDataBox();h.setDate(this.getValue());k.submit()}}},"+",{xtype:"omnicrementer",name:"dateDays",width:60,editable:false,listeners:{trigger:function(){var d=this.ownerCt.ownerCt;var f=this.findParentByType("tabpanel");var e=f.getTabField("Rate","dateDays");if(e){e.setValue(this.getValue())}d.submit()}}}," ","Nights"," ","-"," ",{xtype:"timerlabel",text:"",activate:function(d){var f=this.ownerCt.ownerCt;var e=Ext.TimerMgr.start(new Ext.Timer({id:f.getDataURI()+"/availability",useServerTime:false,expireTime:d,interval:1000}));this.setTimer(e)},reset:function(){var b=this.ownerCt.ownerCt;this.cancelTimer();this.setText('<b>Availability:  <font color="#cc0000">Checking...</font></b>',false)},listeners:{timerexpire:function(d){var c=this.ownerCt.ownerCt;c.expireInterface()},timerrefresh:function(d,c){this.setText('<b>Availability: <font color="#cc0000">Valid for '+c+"</font></b>",false)}}},{xtype:"redbutton",text:"Availability: Expired, click to re-check.",hidden:true,handler:function(){var b=this.ownerCt.ownerCt;b.submitQuery();this.hide();b.getTimerLabel().show()}}],items:[{xtype:"databox",id:"avail",listeners:{go:function(p,u,F){var z=this.getRecordByDate(F);var t=this.getDaysFromDate(F);var G=this.ownerCt;var v=G.findParentByType("tabpanel");var D=v.ownerCt.ownerCt.rowRecordData.duration;var w=v.ownerCt.ownerCt.rowRecordData.locationFromString;var x=v.getTabField("Rate","datePointer");var A=v.getTabField("Book","numberToReserve");var y=v.shared.stores.rates;var H=v.getTab("Book");var C=v.getTab("Rate");var B=G.findField("rateURI");var s=B.getValue();var E=y.getById(s);if(E==-1){return}TDS.window.setWindow({title:"Tour Booking Confirmation",interfaceURI:"pnr/offerings/tour/go.js",postDataURI:G.getPNRDataURI()+"/component",mergeData:true,dataURI:{pnr:G.getPNRDataURI(),offering:G.getDataURI()},data:{dateFrom:F.format(TDS.env.dateFormat),offeringURI:v.getDetail("offeringURI"),rateURI:s,departureLocation:w,duration:D,rateMultipleSelectedRateURI:C.getMultipleSelectedRateURI(),priceCurrency:E.get("conversionCurrency")},params:{rateMultipleSelectedRateURI:C.getMultipleSelectedRateURI(),rateName:B.getRawValue(),rateId:B.getValue(),rateBasis:E.get("groupName"),offeringName:v.getDetail("offeringName"),numberToReserveRequested:A.getValue(),priceCurrency:E.get("conversionCurrency"),priceSell:E.get("convertedPricingPriceSell"),rateClassURI:E.get("rateClassURI"),ratePerURI:E.get("ratePerURI"),rateOccupancyURI:E.get("rateOccupancyURI"),daysAvailable:t.availableDays,daysRequestable:t.requestableDays,reservedWaitable:z.data.reservedWaitable,reservedAvailable:z.data.reservedAvailable,rateDatePointerField1:F},callback:{fn:function(e,b,f){if(e){var a=this.ownerCt.getPnrPanel();var c=a.getViewByName("pnr");if(c){var d=c.findByType("awesomegrid")[0];d.submitQuery(true)}if(!b.makeAnotherBooking){a.focusView("pnrView","pnr")}G.expireInterface()}},scope:this}})}}}],listeners:{render:function(){var n=this.ownerCt.findParentByType("tabpanel");this.lm=new Ext.LoadMask(this.bwrap,{msg:""});var q=this.getTopToolbar().items.itemAt(1);q.store=n.shared.stores.rates;var u=n.getTabField("Rate","datePointer");var t=n.getTabField("Rate","dateDays");var m=n.getTabField("Rate","minimumAvailable");var l=this.findField("datePointer");var o=this.findField("dateDays");var p=this.findField("numberToReserve");if(u&&l){l.setValue(u.getValue());this.getDataBox().firstDate=u.getValue()}if(t&&o){o.setValue(t.getValue())}if(m&&p){p.setValue(m.getValue())}var s=n.getTab("Rate");if(s){var r=this.findField("rateURI");var v=s.getSelectedRateURI();if(r&&v){r.setValue(v);this.setNumberOfRatePerFieldByRateURI(v)}}this.submit()}}}