{xtype:"form",border:false,height:350,width:650,markDataDirtyOnLoad:true,beforeSubmit:function(E){;var p=this.ownerCt;var B=p.getParam("priceCurrency");var k=p.getParam("wholefinalDate");var z=this.getPassengerGrid();var l=z.selModel.selections.items;var m=new Array();var n=new Date();for(var y=0;y<=k.length-1;y++){m[y]=k[y]}var o=this.items.itemAt(1).items.itemAt(0).items.itemAt(0).items.itemAt(4).items.itemAt(1);p.clearValidation();var u=this.getDetail("inventoryAmount");var t=this.getDetail("inventoryAmount");var s=0;if(u>t){s=u-t}var d=[];d[0]=E.rateURI;var c=false;var h=false;var r=0;var q=[];for(var y=0;y<d.length;y++){c=false;var f=0;var C={};C.rateURI=d[y];C.noOfPass=this.getDetail("inventoryAmount");q[y]=C;r=this.getDetail("inventoryAmount");for(var v=0;v<l.length;v++){if(d.length==1){l[v].data.rateURI=d[y];f++;c=true}else{if(l[v].data.rateURI===d[y].data.nameString||l[v].data.rateURI===d[y]){l[v].data.rateURI=d[y];f++;c=true}}}if(!c||f!=r){if(f!=r){h=true}break}}try{this.validateBooking(E);var x=[];for(var v=0;v<l.length;v++){var D={};D.rateURI=l[v].data.rateURI;D.passengerURI=l[v].id;x[v]=D}var E={submitDataAsParams:true,paramData:{action:E.action,currency:B},data:{rateURI:E.rateURI,rateMultipleSelectedRateURI:d,offeringURI:E.offeringURI,inventoryAmount:this.getDetail("inventoryAmount"),dateFrom:m[0].format(TDS.env.dateFormat),duration:o.value,noOfPerPerRate:q,noOfPassToWaiting:s,passengerURIs:x,timeheldDate:n,selectedNonMandatoryExtras:TDS.data[p.getParam("rateId")],bookedDate:m,releaseDate:E.action=="request"?E.releaseDate:""}};return E}catch(A){p.showValidation(A);return false}},validateBooking:function(a){var c=this.getPassengerGrid();var d=this.getDetail("numberOfPaxRequired");var b=c.getSelectionModel().getCount();if(b<d){throw"You must select "+(d-b)+" passengers to complete this booking."}if(!a.action){throw"You must select an available booking option to proceed."}},initBooking:function(){var a=this.ownerCt;var d=a.getParam("numberToReserveRequested");var e=a.getParam("priceCurrency");var c=a.getParam("priceSell");var b=c*d;var g=a.getParam("ratePerURI");var f=TDS.data.findRecordByResourceDataURI(g);var h=f.get("name");this.setDetail({inventoryAmount:d,numberOfPaxRequired:1,ratePerType:h,ratePriceUnit:c,ratePriceTotal:b,ratePriceCurrency:e})},initPassengerSelection:function(){var a=this.ownerCt;var b=this.getPassengerGrid();var d=this.getDetail("paxType");var c=this.getDetail("numberOfPaxRequired");b.getStore().on("load",function(){var e=b.preselect(d,c)},this)},getPassengerTab:function(){return this.items.itemAt(1).items.itemAt(1)},getPassengerGrid:function(){return this.getPassengerTab().items.itemAt(1).items.itemAt(0)},shared:{details:{}},setDetail:function(b,c){if(typeof b=="object"){for(var a in b){this.shared.details[a]=b[a]}}else{this.shared.details[b]=c}},getDetail:function(a){return this.shared.details[a]},listeners:{render:function(){var b=this.ownerCt;var c=this.items.itemAt(0);var a=Ext.TimerMgr.lookup(b.getDataURI("offering")+"/availability");if(a){c.setTimer(a)}this.initBooking();this.initRadioButtons();this.initPassengerSelection()}},items:[{xtype:"timerlabel",text:"This availability will expire in...",listeners:{timerexpire:function(a){this.setText("Your availability has expired.")},timerrefresh:function(a,b){this.setText("This availability will expire in... <b>"+b+"</b>.",false)}}},{xtype:"tabpanel",border:false,activeTab:0,layoutOnTabChange:true,deferredRender:false,height:300,defaults:{bodyStyle:"padding: 6px 4px 6px 4px;"},items:[{title:"Details",items:{xtype:"panel",layout:"form",labelWidth:80,border:false,calculateTotalPrice:function(){var b=this.ownerCt.findParentByType("form");var a=this.ownerCt.findParentByType("awesomewindow");var d=a.getParam("numberOfNights");b.setDetail("ratePriceTotal",b.getDetail("inventoryAmount")*b.getDetail("ratePriceUnit"));var c=this.getRatePriceTotalPanel();this.getRatePriceTotalPanel().updateTotal()},getRatePriceTotalPanel:function(){return this.items.itemAt(5).items.itemAt(1)},items:[{xtype:"panel",style:"padding: 0;",border:false,layout:"table",layoutConfig:{columns:2},defaults:{border:false},items:[{html:"Offering:",width:Ext.isIE?88:85},{listeners:{render:function(){var a=this.ownerCt.findParentByType("awesomewindow");this.html=a.getParam("offeringName")}}}]},{xtype:"panel",style:"padding: 0; margin-top: 4px;",border:false,layout:"table",layoutConfig:{columns:2},defaults:{border:false},items:[{html:"Rate:",width:Ext.isIE?88:85},{listeners:{render:function(){var a=this.ownerCt.findParentByType("awesomewindow");this.html=a.getParam("rateName")}}}]},{xtype:"panel",style:"padding: 0; margin-top: 4px;",border:false,layout:"table",layoutConfig:{columns:4},defaults:{border:false},items:[{html:"<b>In:</b>",width:Ext.isIE?88:85},{listeners:{render:function(b){var a=this.ownerCt.findParentByType("awesomewindow");var d=a.getParam("finalDateNew");var c=new Date(d[0]);this.html=c.format(TDS.env.dateFormatDisplay)}}},{html:"&nbsp;&nbsp;<b>Out:</b>",width:Ext.isIE?88:85},{listeners:{render:function(){var b=this.ownerCt.findParentByType("awesomewindow");var a=b.getParam("finalDateNew");if(a[1]=="Invalid Date"){var c=new Date(a[0]);c.setDate(c.getDate()+1);var d=c.format(TDS.env.dateFormatDisplay);this.html=d}else{var c=new Date(a[1]);c.setDate(c.getDate()+1);var d=c.format(TDS.env.dateFormatDisplay);this.html=d}}}}]},{xtype:"panel",style:"padding: 0; margin-top: 4px;",border:false,layout:"table",layoutConfig:{columns:2},defaults:{border:false},items:[{html:"Price:",width:Ext.isIE?88:85},{listeners:{render:function(){var a=this.ownerCt.findParentByType("form");this.html=TDS.util.Price.formatPrice(a.getDetail("ratePriceUnit"),a.getDetail("ratePriceCurrency"))+" per "+a.getDetail("ratePerType")+"."}}}]},{xtype:"panel",style:"padding: 0; margin-top: 4px;",border:false,layout:"table",layoutConfig:{columns:2},defaults:{border:false},items:[{html:"Nights:",width:Ext.isIE?88:85},{xtype:"numberfield",name:"duration",readOnly:true,id:"durationId",width:30,forceSubmit:true,listeners:{render:function(){var b=this.ownerCt.findParentByType("awesomewindow");var a=b.getParam("numberOfNights");Ext.getCmp("durationId").setValue(a)}}}]},{xtype:"panel",style:"padding: 0; margin-top: 4px;",border:false,layout:"table",layoutConfig:{columns:2},defaults:{border:false},items:[{html:"Total:",width:Ext.isIE?88:85},{tpl:"{0} for {1} {2} ",updateTotal:function(){var a=this.ownerCt.findParentByType("awesomewindow");var b=this.ownerCt.findParentByType("form");var c=parseInt(a.getParam("numberOfNights"));this.el.dom.innerHTML=String.format(this.tpl,TDS.util.Price.formatPrice(b.getDetail("ratePriceTotal")*c,b.getDetail("ratePriceCurrency")),a.getParam("numberToReserveRequested"),b.getDetail("ratePerType"),c)},listeners:{render:function(){this.updateTotal()}}}]},{xtype:"panel",style:"padding: 0;",border:false,layout:"table",layoutConfig:{columns:1},defaults:{border:false},items:[{html:"<br><u><b>Booked Rates</b></u>",width:300}]},{xtype:"panel",style:"padding: 0; margin-top: 4px;",border:false,layout:"table",layoutConfig:{columns:2},defaults:{border:false},items:[{xtype:"numberfield",id:"noOfPassengesId",name:"noOfPassenges",hidden:true},{xtype:"textfield",id:"noOfquantityId",name:"noOfquantity",hidden:true},{width:620,listeners:{render:function(){var l='<table class="x-tds-dataview" style="width: 100%;" border=1 cellpadding = 0 cellspacing=0  >';l+='<thead><tr style="background-color: #d0def0;" class="x-tds-dataview-item">';l+='<th style="padding: 2px; width: 35%;">Rate</th>';l+='<th style="padding: 2px; width: 20%;">Room Type</th>';l+='<th style="padding: 2px; width: 10%;">Max in Room</th>';l+='<th style="padding: 2px; width: 5%;">No</th>';l+='<th style="padding: 2px; width: 15%;">Gross Price</th>';var j=this.ownerCt.findParentByType("awesomewindow");var m=j.getParam("numberOfNights");var b=j.getParam("rateName");var h=this.ownerCt.findParentByType("form");var d=TDS.util.Price.formatPrice(h.getDetail("ratePriceUnit"),h.getDetail("ratePriceCurrency"))+" per "+h.getDetail("ratePerType")+".";var e=j.getParam("roomOccupancy");var c=j.getParam("roomTypeURI");var a=TDS.util.Format.displayResourceName(c);var g=j.getParam("priceCurrency");var f=j.getParam("convertedPricingPriceIsNett");var i=f?"Nett":"Gross";var k=j.getParam("numberToReserveRequested");l+="<tr>";l+="<td  >"+b+"</td>",l+="<td ALIGN=CENTER>"+a+"</td>",l+="<td ALIGN=CENTER>"+e+"</td>",l+="<td ALIGN=CENTER>"+k+"</td>",l+="<td ALIGN=RIGHT>"+d+"</td>",l+="</tr>";l+="</table></div>";this.html=l}}}]},{xtype:"fieldset",style:"margin-top: 8px;",layout:"table",layoutConfig:{columns:2},autoHeight:true,defaults:{colspan:2,xtype:"radio",name:"action",forceSubmit:true,hideLabel:true},items:[{boxLabel:"Book available",inputValue:"book",hidden:true,handler:function(c,d){if(d){var e=this.ownerCt.ownerCt;var b=this.ownerCt.findParentByType("form");var a=b.ownerCt;e.calculateTotalPrice()}}},{colspan:1,boxLabel:"Request",inputValue:"request",hidden:true,handler:function(c,d){var f=this.ownerCt.items.itemAt(2);if(d){var e=this.ownerCt.ownerCt;var b=this.ownerCt.findParentByType("form");var a=b.ownerCt;e.calculateTotalPrice();f.enable().focus()}else{f.disable()}}},{colspan:1,xtype:"datefield",name:"releaseDate",hidden:true,disabled:true,showToday:false,width:80,format:TDS.env.dateFormatDisplay,minValue:Ext.TimerMgr.getServerCalculatedDate().clearTime(),listeners:{render:function(){var a=Ext.TimerMgr.getServerCalculatedDate().add(Date.DAY,28);this.setValue(a)}}},{boxLabel:"Quote only",inputValue:"quote"}]},{xtype:"checkbox",name:"makeAnotherBooking",forceSubmit:true,hideLabel:true,checked:false,hidden:true,boxLabel:"Make another booking"}]}},{title:"Passengers",items:[{xtype:"panel",border:false,style:"margin-bottom: 6px;",html:"<p>Please select the passengers for this booking below.</p>",listeners:{beforerender:function(){var a=this.ownerCt.findParentByType("form");var b=a.getDetail("numberOfPaxRequired");if(b>0){this.html="<p>Please select the "+b+" passengers required for this booking below.</p>"}}}},{xtype:"panel",border:false,layout:"fit",items:[{xtype:"editorgrid",height:210,store:new Ext.data.CollectionStore({url:"",identifier:"",fields:["type","code","nameFirst","nameLast","salutation","displayName","dateOfBirth","rateURI","paxAge"]}),viewConfig:{forceFit:true},getData:function(){var b=this.selModel.getSelections();var c=[];for(var a=0;a<b.length;a++){c[a]=b[a].get("dataURI")}return c},preselect:function(c,b){var a=[];this.getStore().each(function(d){if(a.length>=b){return false}if((!c||d.get("type")==c)&&d.get("nameFirst")&&d.get("nameLast")){a[a.length]=d}},this);if(a.length>0){this.getSelectionModel().selectRecords(a)}return a.length},validatePassenger:function(d,a,c,b){if(!b.get("nameFirst")&&!b.get("nameLast")){return false}},sm:new Ext.grid.CheckboxSelectionModel(),columns:[new Ext.grid.CheckboxSelectionModel(),{header:"Type",dataIndex:"type",width:80,fixed:true,editor:new Ext.form.ComboBox({editable:false,forceSelection:true,mode:"local",displayField:"text",valueField:"text",triggerAction:"all",tpl:'<tpl for="."><div class="x-combo-list-item">{text}, <span style="font-style: italic; font-size: 10px; color: #999;">{description}</span></div></tpl>',store:TDS.data.passengerType})},{header:"Last name",dataIndex:"nameLast",editor:new Ext.form.TextField({allowBlank:false}),renderer:function(a,c,b){return a.substr(0,1).toUpperCase()+a.substr(1)}},{header:"First name",dataIndex:"nameFirst",editor:new Ext.form.TextField({allowBlank:false}),renderer:function(a,c,b){return a.substr(0,1).toUpperCase()+a.substr(1)}},{header:"Title",dataIndex:"salutation",width:40,fixed:true,editor:new Ext.form.ComboBox({store:TDS.data.salutations,editable:false,forceSelection:true,mode:"local",triggerAction:"all",displayField:"text",valueField:"text"})},{header:"Code",dataIndex:"code",width:70,fixed:true},{header:"DOB",dataIndex:"dateOfBirth",width:70,fixed:true,editor:new Ext.form.DateField({allowBlank:false}),renderer:function(e,c,b){;if(typeof e!="undefined"){if(typeof e!="string"){var a=new Date();a.setTime(Ext.TimerMgr.getServerCalculatedTime());var d=Math.floor((a.getTime()-e.getTime())/(365.25*24*60*60*1000));b.set("paxAge",((d&&d>0)?d:""));return Ext.util.Format.date(e,TDS.env.dateBirthdayFormatDisplay)}else{if(b.get("paxAge")){var d=TDS.util.Format.age(e);b.set("paxAge",((d&&d>0)?d:""))}return TDS.util.Format.dateSpecial(e,TDS.env.dateBirthdayFormatDisplay)}}return TDS.util.Format.dateSpecial(e,TDS.env.dateBirthdayFormatDisplay)}},{header:"Age",dataIndex:"paxAge",renderer:function(c,b,a){if(c){return c}else{return TDS.util.Format.age(a.get("dateOfBirth"))}}}],bbar:[{xtype:"button",text:"Add",handler:function(){var b=this.ownerCt.items.itemAt(1);var a=this.ownerCt.items.itemAt(2);a.enable();b.enable();this.disable();var d=this.ownerCt.ownerCt;var c=d.getStore();c.add([new c.recordType({type:"AD",nameFirst:"",nameLast:""})]);d.newRecordIndex=c.getCount()-1;d.startEditing(d.newRecordIndex,2)}},{xtype:"button",text:"Cancel",disabled:true,handler:function(){var c=this.ownerCt.items.itemAt(0);var b=this.ownerCt.items.itemAt(2);c.enable();b.disable();var d=this.ownerCt.ownerCt;var a=d.getStore().getAt(d.newRecordIndex);if(a==-1||typeof a.get("dataURI")!="undefined"){return}d.getStore().remove(a);this.disable()}},{xtype:"button",text:"Save",disabled:true,handler:function(){var b=this.ownerCt.findParentByType("awesomewindow");var e=this.ownerCt.ownerCt;var d=this.ownerCt.items.itemAt(0);var c=this.ownerCt.items.itemAt(1);c.disable();this.disable();var a=e.getStore().getAt(e.newRecordIndex);if(a==-1||typeof a.get("dataURI")!="undefined"){return}Ext.Ajax.request({url:TDS.env.dataPath+b.getDataURI("pnr")+"/passengers",jsonData:a.data,method:"POST",callback:function(h,f,g){if(f){e.getStore().load();d.enable()}else{c.enable();this.enable()}},scope:this})}},{xtype:"button",text:"Addional Info",id:"add",handler:function(h){var c=this.ownerCt.findParentByType("awesomewindow");var f=this.ownerCt.ownerCt;var b=f.getStore().getAt(f.newRecordIndex);var a="";var d=this.ownerCt.ownerCt.getSelectionModel().selections;if(d.length==1){a=d.items[0].get("dataURI")}TDS.innerWindow.setWindow({height:300,width:200,autoDestroy:false,title:"Passenger Profile",interfaceURI:"pnr/passenger/passengerDetails.js",sourceDataURI:a,destinationDataURI:a,closeAction:"hide",buttonOK:"Submit",callback:{fn:function(g,i,e){},scope:this}})}}],listeners:{beforeedit:function(a){if(typeof a.record.get("dataURI")!="undefined"){a.cancel=true}},render:function(){var w=this.ownerCt.findParentByType("awesomewindow");this.getSelectionModel().on("beforerowselect",this.validatePassenger,this);with(this.store){reader.meta.identifier=w.getDataURI("pnr")+"/passengers";proxy.conn.url=TDS.env.dataPath+w.getDataURI("pnr")+"/passengers/concise";load()}}}}]}]}]}],initRadioButtons:function(c){var b=this.ownerCt;var d=b.getParam("daysAvailable");var h=b.getParam("daysRequestable");var a=this.items.itemAt(1).items.itemAt(0).items.itemAt(0).findByType("fieldset")[0];var f=a.items.itemAt(0);var e=a.items.itemAt(1);var g=a.items.itemAt(2);if(d>0){f.show()}if(h>0){e.show()}}}