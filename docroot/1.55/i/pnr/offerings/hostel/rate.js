{xtype:"panel",border:false,requireStores:[{dataURI:TDS.env.dataPath+"hostel/roomtypes/collection",identifier:"hostel/roomtypes",fields:["name","dataURI"]},{dataURI:TDS.env.dataPath+"hostel/bedtypes/collection",identifier:"hostel/bedtypes",fields:["name","dataURI"]},{dataURI:TDS.env.dataPath+"rate/pers/collection",identifier:"rate/pers",fields:["name","dataURI"]}],findField:function(b){var a=false;this.getRateToolbar().items.each(function(c){if(c.name==b){a=c;return true}});return a},getRateGrid:function(){return this.items.itemAt(0).items.itemAt(0).items.itemAt(0).items.itemAt(0)},getRateToolbar:function(){return this.items.itemAt(0).items.itemAt(0).items.itemAt(0).getTopToolbar()},getSelectedRateURI:function(){var a=this.getRateGrid().getSelectionModel().getSelected();if(typeof a!="undefined"){return a.get("dataURI")}return false},focusBookTab:function(){var h=this.findParentByType("tabpanel");var d=h.getTabField("Book","datePointer");var g=h.getTabField("Book","dateDays");var b=this.findField("datePointer");var c=this.findField("dateDays");if(d&&b){d.setValue(b.getValue())}if(g&&c){g.setValue(c.getValue())}var e=h.getTabField("Book","rateURI");var a=this.getSelectedRateURI();if(e&&a){e.setValue(a)}var f=h.getTab("Book");if(f){f.setNumberOfRatePerFieldByRateURI(a);f.submit()}h.setActiveTab(2)},items:{xtype:"panel",layout:"column",bodyStyle:"padding: 8px;",border:false,items:[{xtype:"panel",border:false,height:150,width:700,items:[{xtype:"awesomepanel",height:136,layout:"fit",searchURI:"",store:new Ext.data.JsonStore({url:"",id:"dataURI",fields:["dataURI","nameString","agencyURI","roomOccupancy","bedTypeURI","roomTypeURI","ratePerURI","inventoryAvailable","queueRequestable","special","available","conversionCurrency","convertedPricingPriceSell","convertedPricingPriceIsNett","convertedPricingPriceCommission","defaultFee","suppierPricing","homeCurrency"]}),tbar:["Price from ",{xtype:"textfield",name:"amountLower",enableKeyEvents:true,width:60}," ","Room type",{xtype:"combo",name:"roomTypeURI",mode:"local",width:120,triggerAction:"all",editable:false,displayField:"name",valueField:"dataURI",store:TDS.data.getStore({dataURI:TDS.env.dataPath+"hostel/roomtypes/collection",identifier:"hostel/roomtypes",fields:["name","dataURI"]}),appendData:[{name:"Any",dataURI:""}]}," ","No of Pax",{xtype:"omnicrementer",name:"minimumAvailable",width:60,value:1,minValue:1,maxValue:7}," ","Available"," ",{xtype:"datefield",name:"datePointer",enableKeyEvents:true,showToday:false,width:80,format:"dMy",minValue:Ext.TimerMgr.getServerCalculatedDate().clearTime()},"&plusmn;",{xtype:"omnicrementer",name:"dateDays",width:60,editable:false}," ","days"],items:[{xtype:"grid",width:500,border:false,enableColumnHide:false,enableColumnMove:false,enableColumnResize:false,enableHdMenu:false,viewConfig:{forceFit:true},sm:new Ext.grid.RowSelectionModel(),columns:[{header:"Rate",dataIndex:"nameString",width:120,fixed:true,renderer:function(c,b,a){if(a.get("special")){b.attr='style="color: red;"'}else{if(a.get("agencyURI")!=""){b.attr='style="color: blue;"'}}return c}},{header:"Basis",dataIndex:"ratePerURI",width:80,fixed:true,renderer:function(b,c,a){return"per "+TDS.util.Format.displayResourceName(b)}},{header:"Room Type",dataIndex:"roomTypeURI",width:80,fixed:true,renderer:function(b,c,a){return TDS.util.Format.displayResourceName(b)}},{header:"No Bunks",dataIndex:"roomOccupancy",width:80,fixed:true,renderer:function(b,c,a){return b}},{header:"Gross Price",dataIndex:"convertedPricingPriceSell",width:40,renderer:TDS.util.Price.conversionGrossNettPriceRenderer},{header:"Status",dataIndex:"available",width:80,fixed:true,renderer:function(b,c,a){return b}}],listeners:{beforerender:function(){this.store=this.ownerCt.store},render:function(){this.getEl().swallowEvent(["columnmove","columnresize","headerclick","click","mouseout","mouseover","rowclick","rowmousedown","sortchange","mouseup","mousedown"])},rowclick:function(n,k,i){i.stopPropagation();var g=this.getStore().getAt(k);if(g==-1){return}var d={rate:g.data};var c=this.ownerCt.findParentByType("ajaxpanel");var j=this.ownerCt.findParentByType("tabpanel");var h=j.getPNRCurrency();var b=this.ownerCt.ownerCt.ownerCt.items.itemAt(2);b.el.mask("","x-mask-loading");var l=new Ext.data.CollectionStore({autoLoad:true,url:TDS.env.dataPath+c.baseDataURI+"/searchExtras/collection?rateURI="+g.get("dataURI")+"&currency="+h,identifier:c.baseDataURI+"/searchExtras?rateURI="+g.get("dataURI")+"&currency="+h,fields:["dataURI","nameString","termsAndConditions","extraCategoryURI","required","minimumInventoryRequired","conversionCurrency","convertedPricingPriceSell","convertedPricingPriceIsNett","convertedPricingPriceCommission","defaultFee"]});l.on("load",function(y,q){d.extras=[];TDS.data[g.get("dataURI")]=[];var x=g.get("dataURI");for(var u=0;u<q.length;u++){q[u].data.rateURI=x;q[u].data.doWork="if(this.checked){TDS.data['"+x+"'].push(this.value);}else{TDS.data['"+x+"'].pop(this.value);}";d.extras[u]=q[u].data;Ext.apply(d.extras[u],TDS.util.Price.calculateGrossNettPrice(d.extras[u]))}var w=b.items.itemAt(0);var s=b.items.itemAt(1);var v=b.items.itemAt(2);var e=v.items.itemAt(0);var r=v.items.itemAt(1);var p=v.items.itemAt(2);var o=b.items.itemAt(3);w.hide();s.tpl.overwrite(s.body,d.rate);if(d.extras.length>0){o.tpl.overwrite(o.body,d.extras)}e.show();r.show();p.show();b.el.unmask()},this);var a=this.getSelectionModel().selections.items[0].data;var m=this.ownerCt.ownerCt.ownerCt.items.itemAt(1).items.itemAt(0);;var f={};f=a;m.tpl.overwrite(m.body,Ext.apply({convertedPricingPriceSells:TDS.util.Price.formatPrice(f.convertedPricingPriceSell,f.conversionCurrency),defaultFees:TDS.util.Price.formatPrice(f.defaultFee,f.conversionCurrency),totals:TDS.util.Price.formatPrice(f.convertedPricingPriceSell+f.defaultFee,f.conversionCurrency)},f))}}}],listeners:{toolbarinit:function(){var b=this.ownerCt.findParentByType("awesomegrid");var g=this.ownerCt.findParentByType("tabpanel");var d=b.findField("datePointer"),f=b.findField("dateDays");var c=this.getTopToolbar().items.itemAt(11),e=this.getTopToolbar().items.itemAt(13);if(d){c.setValue(d.getValue())}if(f){e.setValue(f.getValue())}this.searchURI=TDS.env.dataPath+g.getDetail("offeringURI")+"/searchRates";this.appendQueryParams.currency=g.getPNRCurrency();var a=g.shared.stores.rates;this.getStore().on("load",function(i,h){a.removeAll();a.add(h)})}}},{border:false,html:'<p style="font-size: 9px; padding-top: 4px;">* Rates that appear highlighted red are <b style="color: red;">special</b> rates.</p>'}]},{xtype:"panel",cls:"x-tds-rate-table",columnWidth:1,layout:"table",layoutConfig:{columns:2},height:150,bodyStyle:"padding-left: 8px;",hideBorders:true,border:false,items:[{html:"<p>Select a rate to view more details and available extras.</p>",colspan:2},{colspan:2,hidden:true,tpl:new Ext.XTemplate(["<p><b>Room type:</b> {[TDS.util.Format.displayResourceName(values.roomTypeURI)]}</p>","<p><b>Bed type:</b> {[TDS.util.Format.displayResourceName(values.bedTypeURI)]}</p>","<p><b>Number of beds in room:</b> {roomOccupancy}</p>"])},{xtype:"panel",layout:"table",colspan:2,width:200,layoutConfig:{columns:3},defaults:{style:"padding-left: 2px;",minWidth:60},items:[{xtype:"button",text:"Terms",hidden:true,handler:function(){var c=this.ownerCt.ownerCt.ownerCt.ownerCt;var a=c.getSelectedRateURI();if(!a){return}var d=this.ownerCt.ownerCt.findParentByType("tabpanel");var b=d.getTabField("Rate","datePointer");TDS.window.setWindow({title:"Terms and Conditions",interfaceURI:"popup/terms.js",sourceDataURI:a,data:{offeringData:d.ownerCt.ownerCt.rowRecordData,departureDate:b.getRawValue()},buttonOK:false,buttonCancel:"Close"})}},{xtype:"button",text:"Facilities",hidden:true,handler:function(){var b=this.ownerCt.ownerCt.ownerCt.ownerCt;var a=b.getSelectedRateURI();if(!a){return}TDS.window.setWindow({title:"Facilities",interfaceURI:"popup/facilities.js",sourceDataURI:a+"/roomfacilities/collection",buttonOK:false,buttonCancel:"Close"})}},{xtype:"formredbutton",text:"Select",hidden:true,handler:function(){var a=this.ownerCt.ownerCt.ownerCt.ownerCt;a.focusBookTab()}}]},{colspan:2,tpl:new Ext.XTemplate(['<div style="height: 80px; overflow-x:hidden; margin-top: 8px;">','<table class="x-tds-dataview" style="width: 100%;">',"<thead>","<tr>",'<th style="width: 20px; padding-bottom: 2px;"></th>','<th style="padding-bottom: 2px;">Extra</th>','<th style="width: 90px; padding-bottom: 2px; texalign:center;">No.</th>','<th style="width: 120px; padding-bottom: 2px;">Pricing</th>',"</tr>","</thead>",'<tpl for=".">','<tr class="x-tds-dataview-extras-item">','<td ><input type="checkbox" id = "{rateURI}{dataURI}" value="{dataURI}" {[values.required ?  "disabled checked" : "" ]} onclick={doWork}></td>','<td style="width: 140px;{[values.required ? " color: gray;" : "" ]}">{nameString}</td>',"<td>{minimumInventoryRequired}</td>","<td>{priceFormatted}</td>","</tr>","</tpl>","</table>","</div>",'<hr style="height: 1px; border: none; border-top: 1px solid #eee;"/>','<p style="font-size: 9px;">* Extras that appear greyed out are <b>mandatory</b> extras on this rate.</p>'])}]}]}}