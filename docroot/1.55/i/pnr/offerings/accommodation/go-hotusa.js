{xtype:"form",border:false,height:450,width:650,markDataDirtyOnLoad:true,requireStores:[{dataURI:TDS.env.dataPath+"accommodation/ratings/collection",identifier:"accommodation/ratings",fields:["name","dataURI"]}],beforeSubmit:function(r){var H=this.ownerCt;var N=this.getPassengerGrid();var v=N.getSelectionModel().getCount();var I=Ext.getCmp("noOfPassengesId").getValue();var f=0;var B=new Date();var p=I;if(I>p){f=I-p}var F=N.selModel.selections.items;var o=H.getParam("wholefinalDate");var G=H.getParam("priceCurrency");var y=H.getParam("conpricingPriceSellHotusa");var E=H.getParam("homeCurrencyh");var x=H.getParam("priceSell");var h=H.getParam("hotusaRoomType");var D=H.getParam("rateName");var J=H.getParam("hotusaNoofRomms");var t=H.getParam("hotusaId");var n=H.getParam("convertedPricingPriceIsNett");var s=H.getParam("pricingPriceIsNett");var m=new Array();for(var M=0;M<=o.length-1;M++){m[M]=o[M]}var C=o.length;H.clearValidation();var u=[];var K=false;var z=false;var k=0;var d=[];for(var M=0;M<r.rateMultipleSelectedRateURI.length;M++){K=false;u[M]=r.rateMultipleSelectedRateURI[M].id;var A=0;var P={};P.rateURI=r.rateMultipleSelectedRateURI[M].id;P.noOfPass=document.getElementById("no"+r.rateMultipleSelectedRateURI[M].data.dataURI).value;d[M]=P;k=r.rateMultipleSelectedRateURI[M].data.maximumOccupancy*document.getElementById("no"+r.rateMultipleSelectedRateURI[M].data.dataURI).value;for(var L=0;L<F.length;L++){if(r.rateMultipleSelectedRateURI.length==1){K=true;F[L].data.rateURI=r.rateMultipleSelectedRateURI[M].id;A++}else{if(F[L].data.rateURI===r.rateMultipleSelectedRateURI[M].data.nameString||F[L].data.rateURI===r.rateMultipleSelectedRateURI[M].id){K=true;F[L].data.rateURI=r.rateMultipleSelectedRateURI[M].id;A++}}}if(!K||A>k){if(A>k){z=true}break}}if(K&&!z){var q=[];for(var L=0;L<F.length;L++){var Q={};Q.rateURI=F[L].data.rateURI;Q.passengerURI=F[L].id;q[L]=Q}this.validateBooking(r);if(I>=v){try{var c={};c.bookDateHotusa=m;c.noOfPersonsHotusa=k;c.covertedCurrencyeh=G;c.convertedprich=y;c.baseCurrencyh=E;c.basepriceh=x;c.hotusaRoomTypeh=h;c.rateName=D;c.hotusaNoofRomms=J;c.hotusaId=t;c.pricingPriceIsNett=s;c.convertedPricingPriceIsNett=n;c.finalSendDateHotusa=o;var r={submitDataAsParams:true,paramData:{action:r.action,currency:G},data:{rateMultipleSelectedRateURI:u,rateURI:r.rateURI,offeringURI:r.offeringURI,inventoryAmount:I,dateFrom:m[0].format(TDS.env.dateFormat),duration:C,bookedDate:m,noOfPassToWaiting:f,passengerURIs:q,selectedNonMandatoryExtras:TDS.data[H.getParam("rateId")],noOfPerPerRate:d,timeheldDate:B,releaseDate:r.action=="request"?r.releaseDate:""}};var l=H.getParam("hotusa");if(H.getParam("hotusa")){r.data.rateDetails=c}return r}catch(O){H.showValidation(O);return false}}else{Ext.Msg.alert("Alert","No.of person and Passenger should be match.")}}else{if(z){Ext.Msg.alert("Alert","select no. of passengers not matching against the rate.")}else{Ext.Msg.alert("Alert","select rate against the passenger")}}},validateBooking:function(a){var c=this.getPassengerGrid();var d=this.getDetail("numberOfPaxRequired");var b=c.getSelectionModel().getCount();if(b<d){throw"You must select "+(d-b)+" passengers to complete this booking."}if(!a.action){throw"You must select an available booking option to proceed."}},initBooking:function(){var a=this.ownerCt;var d=a.getParam("numberToReserveRequested");var e=a.getParam("priceCurrency");var c=a.getParam("priceSell");var b=c*d;this.setDetail({inventoryAmount:d,numberOfPaxRequired:1,ratePriceUnit:c,ratePriceTotal:b,ratePriceCurrency:e})},initPassengerSelection:function(){var a=this.ownerCt;var b=this.getPassengerGrid();var d=this.getDetail("paxType");var c=this.getDetail("numberOfPaxRequired");b.getStore().on("load",function(){var e=b.preselect(d,c)},this)},getPassengerTab:function(){return this.items.itemAt(1).items.itemAt(1)},getPassengerGrid:function(){return this.getPassengerTab().items.itemAt(1).items.itemAt(0)},shared:{details:{}},setDetail:function(b,c){if(typeof b=="object"){for(var a in b){this.shared.details[a]=b[a]}}else{this.shared.details[b]=c}},getDetail:function(a){return this.shared.details[a]},listeners:{render:function(){var b=this.ownerCt;var c=this.items.itemAt(0);var a=Ext.TimerMgr.lookup(b.getDataURI("offering")+"/availability");if(a){c.setTimer(a)}this.initBooking();this.initRadioButtons();this.initPassengerSelection()}},items:[{xtype:"timerlabel",text:"This availability will expire in...",listeners:{timerexpire:function(a){this.el.dom.innerHTML='<b><font color="#cc0000">Your availability has expired.</font></b>'},timerrefresh:function(a,b){this.el.dom.innerHTML='<b><font color="#cc0000">This availability will expire in... '+b+" .</font></b>"}}},{xtype:"tabpanel",border:false,activeTab:0,layoutOnTabChange:true,deferredRender:false,height:450,autoScroll:true,width:650,defaults:{bodyStyle:"padding: 6px 4px 6px 4px;"},items:[{title:"Details",autoScroll:true,items:{xtype:"panel",layout:"form",labelWidth:80,border:false,calculateTotalPrice:function(){var b=this.ownerCt.findParentByType("form");var a=this.ownerCt.findParentByType("awesomewindow");var c=a.getParam("numberOfNights");b.setDetail("ratePriceTotal",b.getDetail("inventoryAmount")*c*b.getDetail("ratePriceUnit"))},getRatePriceTotalPanel:function(){return this.items.itemAt(4).items.itemAt(1)},items:[{xtype:"panel",style:"padding: 0;",border:false,layout:"table",layoutConfig:{columns:6},defaults:{hight:30,border:false},items:[{html:"<b><u>Property:</u></b>",width:Ext.isIE?86:86},{width:Ext.isIE?122:122,listeners:{render:function(){var a=this.ownerCt.findParentByType("awesomewindow");this.html="<b>"+a.getParam("offeringName")}}},{width:Ext.isIE?120:120,listeners:{render:function(){var a=this.ownerCt.findParentByType("awesomewindow");this.html="<b>"+a.getData("locationToString")}}},{html:"<b><u>Star rating:</u></b>",width:Ext.isIE?88:85},{width:30,listeners:{render:function(){var a=this.ownerCt.findParentByType("awesomewindow");var b=a.getParam("ratingURI");this.html="<b>"+TDS.util.Format.displayResourceName(b)}}}]},{xtype:"panel",style:"padding: 0; margin-top: 12px;",border:false,layout:"table",layoutConfig:{columns:8},defaults:{hight:30,border:false},items:[{html:" ",width:Ext.isIE?86:86},{html:"<b><u>In:</u></b>",width:Ext.isIE?35:35},{width:Ext.isIE?86:86,listeners:{render:function(b){var a=this.ownerCt.findParentByType("awesomewindow");var d=a.getParam("finalDateNew");var c=new Date(d[0]);this.html="<b>"+c.format(TDS.env.dateFormatDisplay)}}},{html:"<b><u>Out:</u></b>",width:Ext.isIE?35:35},{width:Ext.isIE?86:86,listeners:{render:function(){var b=this.ownerCt.findParentByType("awesomewindow");var a=b.getParam("finalDateNew");if(a[1]=="Invalid Date"){var c=new Date(a[0]);var e=b.getParam("supplierId");if(e==TDS.util.Defaults.hotusaSupplier){c.setDate(c.getDate())}else{c.setDate(c.getDate()+1)}var d=c.format(TDS.env.dateFormatDisplay);this.html="<b>"+d}else{var c=new Date(a[1]);var e=b.getParam("supplierId");if(e==TDS.util.Defaults.hotusaSupplier){c.setDate(c.getDate())}else{c.setDate(c.getDate()+1)}var d=c.format(TDS.env.dateFormatDisplay);this.html="<b>"+d}}}},{html:"<b><u>Nights:</u></b>",width:Ext.isIE?48:45},{id:"durationId",width:30,listeners:{render:function(){var b=this.ownerCt.findParentByType("awesomewindow");var a=b.getParam("numberOfNights");this.html="<b>"+a}}}]},{xtype:"panel",style:"padding: 0; margin-top: 10px;margin-bottom: 5px;",border:false,layout:"table",layoutConfig:{columns:2},defaults:{border:false},items:[{html:"<b><u>No of Guests:</u></b>",width:Ext.isIE?88:85},{xtype:"label",id:"noOfGuests",width:30}]},{xtype:"panel",style:"padding: 0; margin-top: 4px;",border:false,layout:"table",layoutConfig:{columns:1},defaults:{border:false},items:[{colspan:2,name:"EXTRA_RATE_DISP_AREA",tpl:new Ext.XTemplate(['<br><table class="x-tds-dataview" border=1; style="width: 90%; margin-left: 3px;">',"<thead>",'<tr style="background-color: #d0def0;">','<th style="padding-bottom: 2px; width: 325px;">Extra</th>','<th style="width: 85px; padding-bottom: 2px;">Min. required</th>','<th style="width: 70px; padding-bottom: 2px;">Pricing</th>','<th style="width: 70px; padding-bottom: 2px;">Markup</th>','<th style="width: 35px; padding-bottom: 2px;">Basis</th>','<th style="width: 30px; padding-bottom: 2px;">Comm</th>',"</tr>","</thead>",'<tpl for=".">',"<tr >",'<td style=" {[values.required ? " color: gray;" : "" ]}">&nbsp;{nameString}</td>',"<td ALIGN=CENTER >{minimumInventoryRequired}</td>","<td ALIGN=RIGHT >{priceCurrency} {[values.priceIsNett ? values.priceNett:values.priceGross]}</td>",'<td ALIGN=RIGHT >{[(values.priceIsNett? (values.priceCurrency+" "+values.markUp):"")]}</td>','<td ALIGN=CENTER >{[values.priceIsNett ? "Nett":"Gross"]}</td>','<td ALIGN=CENTER >{priceCommissionPercentage}{[(values.priceCommissionPercentage || values.priceCommissionPercentage == 0 )? "%":""]}</td>',"</tr>","</tpl>","</table>"])}]},{xtype:"panel",style:"padding: 0;",border:false,layout:"table",layoutConfig:{columns:1},defaults:{border:false},items:[{html:"<br><u><b>Booked Rates</b></u>",width:300}]},{xtype:"panel",style:"padding: 0; margin-top: 2px;",border:false,layout:"table",layoutConfig:{columns:2},defaults:{border:false},items:[{xtype:"numberfield",id:"noOfPassengesId",name:"noOfPassenges",hidden:true},{width:620,listeners:{render:function(){;var o='<table class="x-tds-dataview" style="width: 100%;" border=1 cellpadding = 0 cellspacing=0  >';o+='<thead><tr style="background-color: #d0def0;"  >';o+='<th style="padding: 2px; width: 30%;">Rate</th>';o+='<th style="padding: 2px; width: 20%;">Room Type</th>';o+='<th style="padding: 2px; width: 15%;">Max in Room</th>';o+='<th style="padding: 2px; width: 5%;">No</th>';o+='<th style="padding: 2px; width: 15%;">Gross/Net</th>';o+='<th style="padding: 2px; width: 30%;">Price</th>';o+="</tr></thead>";var a="";var q=this.ownerCt.findParentByType("awesomewindow");var l=this.ownerCt.findParentByType("form");var e=q.getParam("rateMultipleSelectedRateURI");var h=q.getParam("noOfNights");var G=q.getParam("plainDate");var k=e.length-1;var z;var g;var f;var E="";var C=0;var j=0;var b="";var v=TDS.data.selectedRates;v.removeAll();v.data.addAll(e);var y=0;for(var A=0;A<e.length;A++){var s=document.getElementById("no"+e[A].data.dataURI).value;var p=q.getParam("hotusaNoofRomms");var n=q.getParam("hotusaRoomType");var m=q.getParam("supplierId");if(m==TDS.util.Defaults.hotusaSupplier){y=e[A].data.selectedTotalGuest;var D=p*y;j=parseInt(j)+D}else{j=parseInt(j)+parseInt(s)}y=e[A].data.selectedTotalGuest;var b=e[A].json.inventoryTypeURI;var u=e[A].json.nameString;var r=e[A].json.groupName;var F="";var u=e[A].json.nameString;var B=e[A].data.conversionCurrency;var d=e[A].data.convertedPricingPriceSell;var c=e[A].data.convertedPricingPriceCommission;var t=e[A].data.convertedPricingPriceIsNett;if(t){z="Nett"}else{z="Gross"}if(typeof d=="undefined"||d==""){d=0}if(B==""){B="AUD"}var x=TDS.util.Price.calculateFixedGrossNettPrice({pricingPriceCurrency:B,pricingPriceSell:d,pricingPriceCommission:c,pricingPriceIsNett:t});if(s!=""&&s!=0){o+="<tr>";o+="<td >"+u+"</td>";if(n!=null&&n!=""){o+="<td >"+n+"</td>"}else{o+="<td >"+TDS.util.Format.displayResourceName(b)+"</td>"}o+="<td ALIGN=CENTER>"+y+"</td>",o+="<td ALIGN=CENTER>"+s+"</td>",o+="<td ALIGN=CENTER>"+z+"</td>",o+="<td ALIGN=RIGHT>"+B+" "+d.toFixed(2)+"</td>",o+="</tr>"}}Ext.getCmp("noOfGuests").setText("<b>"+y+"</b>",false);o+="</table></div>";Ext.getCmp("noOfPassengesId").setValue(j);this.html=o}}}]},{xtype:"panel",style:"padding: 0; margin-top: 4px;",border:false,layout:"table",layoutConfig:{columns:2},defaults:{border:false},items:[{html:"<u><b>Total:</b></u>",width:Ext.isIE?88:40},{xtype:"textfield",readOnly:true,style:"border:#FFFFFF; display:compact; font:Verdana; font-weight: bold; background: none;  text-decoration: none; div {text-align: left; } ",listeners:{render:function(){var o=this.ownerCt.findParentByType("awesomewindow");var m=this.ownerCt.findParentByType("form");var c=o.getParam("rateMultipleSelectedRateURI");var b=parseInt(o.getParam("numberOfNights"));var l=c.length-1;var r;var h;var g=0;var v="";var t=0;var y={};y.extras=[];var f=0;for(var s=0;s<c.length;s++){var p=document.getElementById("no"+c[s].data.dataURI).value;var u=c[s].data.conversionCurrency;if(u==""||u==null){u="AUD"}var d=c[s].data.convertedPricingPriceSell;var e=c[s].data.convertedPricingPriceCommission;var q=c[s].data.convertedPricingPriceIsNett;if(q){r="Nett"}else{r="Gross"}if(typeof g=="undefined"||g==""){g=0}if(typeof d=="undefined"||d==""){d=0}var n=o.getParam("supplierId");if(n==TDS.util.Defaults.hotusaSupplier){t=d}else{t=t+parseInt(p)*parseFloat(d)}var k=new Ext.data.CollectionStore({autoLoad:true,url:TDS.env.dataPath+c[s].data.offeringURI+"/searchExtras/collection?rateURI="+c[s].data.dataURI+"&currency="+u,identifier:c[s].data.offeringURI+"/searchExtras?rateURI="+c[s].data.dataURI+"&currency="+u,fields:["dataURI","nameString","termsAndConditions","extraCategoryURI","required","minimumInventoryRequired","conversionCurrency","convertedPricingPriceSell","convertedPricingPriceIsNett","convertedPricingPriceCommission","rateClassURI","ratePerURI","rateOccupancyURI","shareAvailabilitywith","flagCount","offeringURI","childChbox","markUp"]});var x=this.html;k.on("load",function(w,a){var B=y.extras;var A=y.extras.length;var z=0;for(var i=A;i<(A+a.length);i++){if(!a[(i-A)].data.required){z++;continue}y.extras[(i-z)]=a[(i-A)].data;Ext.apply(y.extras[(i-z)],TDS.util.Price.calculateGrossNettPrice(y.extras[(i-z)]));f+=a[(i-A)].data.priceSell;if(y.extras[(i-z)].priceIsNett){y.extras[(i-z)].priceNett=y.extras[(i-z)].priceSell.toFixed(2);y.extras[(i-z)].markUp=(y.extras[(i-z)].priceSell*TDS.env.user.agencyDefaultComm()/100).toFixed(2);f+=(y.extras[(i-z)].priceSell*TDS.env.user.agencyDefaultComm()/100)}else{y.extras[(i-z)].priceGross=y.extras[(i-z)].priceGross.toFixed(2)}}var C=this.ownerCt.ownerCt.items.itemAt(3).items.itemAt(0);if(y.extras.length>0){C.tpl.overwrite(C.body,y.extras)}var D=" "+u+" "+(((f*parseInt(p))+(t))*b).toFixed(2)+" ";this.setValue(D)},this);if(!c[s].data.convertedPricingPriceIsNett){t+=(d*TDS.env.user.agencyDefaultComm()/100)}var n=o.getParam("supplierId");if(n=TDS.util.Defaults.hotusaSupplier){var j=" "+u+" "+t.toFixed(2)+" ";this.setValue(j)}else{var j=" "+u+" "+(((f*parseInt(p))+(t))*b).toFixed(2)+" ";this.setValue(j)}}}}}]},{xtype:"fieldset",style:"margin-top: 8px;",layout:"table",layoutConfig:{columns:2},autoHeight:true,defaults:{colspan:2,xtype:"radio",name:"action",forceSubmit:true,hideLabel:true},items:[{boxLabel:"Book available",inputValue:"book",hidden:true,handler:function(c,d){if(d){var e=this.ownerCt.ownerCt;var b=this.ownerCt.findParentByType("form");var a=b.ownerCt;e.calculateTotalPrice()}}},{colspan:1,boxLabel:"Request ",inputValue:"request",hidden:true,handler:function(c,d){var f=this.ownerCt.items.itemAt(2);if(d){var e=this.ownerCt.ownerCt;var b=this.ownerCt.findParentByType("form");var a=b.ownerCt;e.calculateTotalPrice();f.enable().focus()}else{f.disable()}}},{colspan:1,xtype:"datefield",name:"releaseDate",hidden:true,disabled:true,showToday:false,width:80,format:TDS.env.dateFormatDisplay,minValue:Ext.TimerMgr.getServerCalculatedDate().clearTime(),listeners:{render:function(){var a=Ext.TimerMgr.getServerCalculatedDate().add(Date.DAY,28);this.setValue(a)}}},{boxLabel:"Quote only",inputValue:"quote"}]},{xtype:"checkbox",name:"makeAnotherBooking",forceSubmit:true,hideLabel:true,checked:false,hidden:true,boxLabel:"Make another booking"}]}},{title:"Passengers",items:[{xtype:"panel",border:false,style:"margin-bottom: 6px;",html:"<p>Please select the passengers for this booking below.</p>",listeners:{beforerender:function(){var a=this.ownerCt.findParentByType("form");var b=a.getDetail("numberOfPaxRequired");if(b>0){this.html="<p>Please select the "+b+" passengers required for this booking below.</p>"}}}},{xtype:"panel",border:false,layout:"fit",items:[{xtype:"editorgrid",height:350,store:new Ext.data.CollectionStore({url:"",identifier:"",fields:["type","code","nameFirst","nameLast","salutation","displayName","dateOfBirth","rateURI"]}),viewConfig:{forceFit:true},getData:function(){var b=this.selModel.getSelections();var c=[];for(var a=0;a<b.length;a++){c[a]=b[a].get("dataURI")}return c},preselect:function(c,b){var a=[];this.getStore().each(function(d){if(a.length>=b){return false}if((!c||d.get("type")==c)&&d.get("nameFirst")&&d.get("nameLast")){a[a.length]=d}},this);if(a.length>0){this.getSelectionModel().selectRecords(a)}return a.length},validatePassenger:function(d,a,c,b){if(!b.get("nameFirst")&&!b.get("nameLast")){return false}},sm:new Ext.grid.CheckboxSelectionModel(),columns:[new Ext.grid.CheckboxSelectionModel(),{header:"Type",dataIndex:"type",width:40,fixed:true,editor:new Ext.form.ComboBox({editable:false,forceSelection:true,mode:"local",displayField:"text",valueField:"text",triggerAction:"all",tpl:'<tpl for="."><div class="x-combo-list-item">{text}, <span style="font-style: italic; font-size: 10px; color: #999;">{description}</span></div></tpl>',store:TDS.data.passengerType})},{header:"Title",dataIndex:"salutation",width:40,fixed:true,editor:new Ext.form.ComboBox({store:TDS.data.salutations,editable:false,forceSelection:true,mode:"local",triggerAction:"all",displayField:"text",valueField:"text"})},{header:"First name",dataIndex:"nameFirst",editor:new Ext.form.TextField({allowBlank:false})},{header:"Last name",dataIndex:"nameLast",editor:new Ext.form.TextField({allowBlank:false})},{header:"Code",dataIndex:"code",width:40,fixed:true},{header:"DOB",dataIndex:"dateOfBirth",width:40,renderer:TDS.util.Format.dateSpecialRenderer(TDS.env.dateBirthdayFormatDisplay),editor:new Ext.form.DateField({showToday:false,format:TDS.env.dateBirthdayFormatDisplay,minValue:"01/01/1901"})},{header:"Rate",dataIndex:"rateURI",fixed:true,editor:new Ext.form.ComboBox({editable:false,forceSelection:true,mode:"local",displayField:"nameString",valueField:"nameString",triggerAction:"all",store:TDS.data.selectedRates})}],bbar:[{xtype:"button",text:"Add",handler:function(){var b=this.ownerCt.items.itemAt(1);var a=this.ownerCt.items.itemAt(2);a.enable();b.enable();this.disable();var d=this.ownerCt.ownerCt;var c=d.getStore();c.add([new c.recordType({type:"AD",nameFirst:"",nameLast:""})]);d.newRecordIndex=c.getCount()-1;d.startEditing(d.newRecordIndex,2)}},{xtype:"button",text:"Cancel",disabled:true,handler:function(){var c=this.ownerCt.items.itemAt(0);var b=this.ownerCt.items.itemAt(2);c.enable();b.disable();var d=this.ownerCt.ownerCt;var a=d.getStore().getAt(d.newRecordIndex);if(a==-1||typeof a.get("dataURI")!="undefined"){return}d.getStore().remove(a);this.disable()}},{xtype:"button",text:"Save",disabled:true,handler:function(){var b=this.ownerCt.findParentByType("awesomewindow");var e=this.ownerCt.ownerCt;var d=this.ownerCt.items.itemAt(0);var c=this.ownerCt.items.itemAt(1);c.disable();this.disable();var a=e.getStore().getAt(e.newRecordIndex);if(a==-1||typeof a.get("dataURI")!="undefined"){return}Ext.Ajax.request({url:TDS.env.dataPath+b.getDataURI("pnr")+"/passengers",jsonData:a.data,method:"POST",callback:function(h,f,g){if(f){e.getStore().load();d.enable()}else{c.enable();this.enable()}},scope:this})}}],listeners:{beforeedit:function(a){},render:function(){var w=this.ownerCt.findParentByType("awesomewindow");this.getSelectionModel().on("beforerowselect",this.validatePassenger,this);with(this.store){reader.meta.identifier=w.getDataURI("pnr")+"/passengers";proxy.conn.url=TDS.env.dataPath+w.getDataURI("pnr")+"/passengers/concise";load()}}}}]}]}]}],initRadioButtons:function(c){var b=this.ownerCt;var d=b.getParam("daysAvailable");var h=b.getParam("daysRequestable");var a=this.items.itemAt(1).items.itemAt(0).items.itemAt(0).findByType("fieldset")[0];var f=a.items.itemAt(0);var e=a.items.itemAt(1);var g=a.items.itemAt(2);if(d>0){f.show()}if(h>0){e.show()}}}