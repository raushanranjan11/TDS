{xtype:"panel",cls:"x-tds-availability",width:750,height:170,dt:new Ext.util.DelayedTask(),delay:400,border:false,hideBorders:true,findField:function(b){var a=false;this.getTopToolbar().items.each(function(c){if(c.name==b){a=c;return true}});return a},getDataURI:function(){return this.ownerCt.baseDataURI},getPNRDataURI:function(){return this.ownerCt.pnrDataURI},getDataBox:function(){return this.items.itemAt(0)},getTimerLabel:function(){return this.getTopToolbar().items.itemAt(21)},getRecheckButton:function(){return this.getTopToolbar().items.itemAt(22)},getQueryData:function(){var c={};var a=this.getTopToolbar();var b=this.getDataBox();a.items.each(function(e){if(e.xtype==="textfield"||e.xtype==="combo"||e.xtype==="omnicrementer"||e.xtype==="numberfield"){c[e.name]=e.getValue()}else{if(e.xtype==="datefield"){var d=e.getValue();if(d){c[e.name]=d.format(TDS.env.dateFormat)}}}},this);if(c.rateURI&&c.datePointer&&c.datePointerOut&&c.dateDays>=0){return c}return false},getPnrPanel:function(){return this.ownerCt.findParentByType("pnrpanel")},expireInterface:function(){this.getTimerLabel().hide();this.getRecheckButton().show();var a=this.getDataBox();a.items.itemAt(0).store.removeAll();a.items.itemAt(0).updateCalendarStatus()},submit:function(){this.dt.cancel();this.dt.delay(this.delay,this.submitQuery,this)},setNumberOfRatePerFieldByRateURI:function(e){var f=this.ownerCt.findParentByType("tabpanel");var a=f.shared.stores.rates;var c=a.getById(e);var b=this.findField("numberOfRatePerType");if(c!=-1&&b){var d=TDS.data.findRecordByResourceDataURI(c.get("ratePerURI"));b.setValue("# of "+d.get("name"))}},submitQuery:function(){var j=this.getDataBox();var b=this.getTopToolbar().items.itemAt(9).getValue();var f=this.getTopToolbar().items.itemAt(13).getValue();var k=this.getTopToolbar().items.itemAt(15);k.setValue((f-b)/86400000);var h=this.ownerCt.findParentByType("tabpanel");var l=h.getTabField("Rate","datePointerIn");var a=h.getTabField("Rate","datePointerOut");var i=h.getTabField("Rate","nightsTemp");var d=h.getTabField("Book","datePointer");var e=h.getTabField("Book","datePointerOut");var c=h.getTabField("Book","dateDays");if(l&&d){l.setValue(d.getValue())}if(a&&e){a.setValue(e.getValue())}if(i&&c){i.setValue(c.getValue())}var g=this.getQueryData();if(!g){this.dt.cancel();return}j.ownerCt.lm.show();j.items.itemAt(0).store.removeAll();j.items.itemAt(0).updateCalendarStatus();Ext.Ajax.request({method:"GET",url:TDS.env.dataPath+this.getDataURI()+"/reservation",params:g,callback:this.submitResponse,scope:this})},submitResponse:function(g,c,e){if(c){var f=Ext.decode(e.responseText);var b=this.getDataBox();b.saveDateParentnew=Array();b.items.itemAt(0).store.loadData(f);b.items.itemAt(0).updateCalendarStatus();b.ownerCt.lm.hide();var a=new Date().add(Date.SECOND,240).format(TDS.env.dateFormat);this.getTimerLabel().activate(a)}},tbar:["Rate",{xtype:"combo",name:"rateURI",mode:"local",width:140,triggerAction:"all",editable:false,displayField:"nameString",valueField:"dataURI",listeners:{select:function(){this.ownerCt.ownerCt.submit()}}}," ","No of rooms"," ",{xtype:"omnicrementer",name:"numberToReserve",width:60,value:1,minValue:1,maxValue:7,listeners:{trigger:function(){this.ownerCt.ownerCt.submit()}}}," ","In"," ",{xtype:"datefield",name:"datePointer",enableKeyEvents:true,showToday:false,width:80,format:"dMy",minValue:Ext.TimerMgr.getServerCalculatedDate().clearTime(),menuListeners:{select:function(i,d){var f=this.ownerCt.ownerCt;this.setValue(d);var h=this.findParentByType("tabpanel");var b=h.getTabField("Rate","datePointerIn");if(b){b.setValue(this.getValue())}var a=f.getDataBox();a.items.itemAt(0).setDate(this.getValue());var g=h.getTabField("Book","datePointerOut");var e=this.getValue();e.setDate(e.getDate()+1);g.setMinValue(e);f.submit()}}}," ","Out"," ",{xtype:"datefield",name:"datePointerOut",enableKeyEvents:true,showToday:false,width:80,format:"dMy",minValue:Ext.TimerMgr.getServerCalculatedDate().clearTime(),menuListeners:{select:function(g,d){var e=this.ownerCt.ownerCt;this.setValue(d);var f=this.findParentByType("tabpanel");var b=f.getTabField("Rate","datePointerOut");if(b){b.setValue(this.getValue())}var a=e.getDataBox();e.submit()}}}," ",{xtype:"omnicrementer",name:"dateDays",width:60,editable:false,listeners:{trigger:function(){var b=this.ownerCt.items.itemAt(9).getValue();var a=this.getValue();this.ownerCt.items.itemAt(13).setValue(new Date(b).add(Date.DAY,a));var d=this.ownerCt.ownerCt;var e=this.findParentByType("tabpanel");var c=e.getTabField("Rate","dateDays");if(c){c.setValue(this.getValue())}d.submit()}}}," ","nights"," ","-"," ",{xtype:"timerlabel",text:".",activate:function(b){var c=this.ownerCt.ownerCt;var a=Ext.TimerMgr.start(new Ext.Timer({id:c.getDataURI()+"/availability",useServerTime:false,expireTime:b,interval:1000}));this.setTimer(a)},reset:function(){var a=this.ownerCt.ownerCt;this.cancelTimer();this.setText('<b>Availability:  <font color="#cc0000">Checking...</font></b>',false)},listeners:{timerexpire:function(a){var b=this.ownerCt.ownerCt;b.expireInterface()},timerrefresh:function(a,b){this.setText('<b>Availability: <font color="#cc0000">Valid for '+b+"</font></b>",false)}}},{xtype:"redbutton",text:"Availability: Expired, click to re-check.",hidden:true,handler:function(){var a=this.ownerCt.ownerCt;a.submitQuery();this.hide();a.getTimerLabel().show()}}],items:[{xtype:"form",layout:"table",border:true,layoutConfig:{columns:2},items:[{xtype:"databox",multidays:true,listeners:{go:function(b,a,c){}}},{xtype:"formredbutton",style:"margin-left:10px;margin-bottom:100px;",text:"Go",minWidth:90,handler:function(v,k,u){var o=this.ownerCt.ownerCt.ownerCt.findParentByType("ajaxpanel");var c=o.rowRecordData.accommodationRatingURI;var m=this.ownerCt.ownerCt.getDataBox();var s=m.items.itemAt(0).saveDateParentnew.sort();var x=m.items.itemAt(0).GetSmallestDate(s);var t=x.split("$");var e=s.length;var f=m.items.itemAt(0).getDaysFromDate(s[0]);var n=this.ownerCt.ownerCt;var a=n.findParentByType("tabpanel");var j=a.ownerCt.ownerCt.rowRecordData.locationToString;var y=n.findField("numberToReserve");var q=a.shared.stores.rates;var i=n.findField("rateURI");var w=i.getValue();var r=q.getById(w);var z=a.getTab("Rate");if(r==-1){return}var h=a.getDetail("termsAndConditions");var b=a.getDetail("addressString");var g=a.getDetail("phoneNumber");var l=a.getDetail("calcRatePerPerson");var d="No property facilities to display.";Ext.Ajax.request({url:TDS.env.dataPath+w+"/roomfacilities/collection",method:"GET",callback:function(F,A,B){if(A){var p=w+"/roomfacilities";var E=Ext.decode(B.responseText);var D=E[p];if(!D){return}var C=TDS.util.collectionToEnglishSentenceList({collection:D,data:E,fieldName:"displayName"});if(C){d=C}TDS.window.setWindow({title:"Accommodation Booking Confirmation",interfaceURI:"pnr/offerings/accommodation/go.js",postDataURI:n.getPNRDataURI()+"/component",mergeData:true,buttonOK:"continue",disableSubmit:true,dataURI:{pnr:n.getPNRDataURI(),offering:n.getDataURI(),priceCurrency:r.get("conversionCurrency")},data:{offeringURI:a.getDetail("offeringURI"),rateURI:w,locationToString:j,rateMultipleSelectedRateURI:z.getMultipleSelectedRateURI()},params:{ratingURI:c,rateName:i.getRawValue(),rateId:i.getValue(),ratePerURI:r.get("ratePerURI"),offeringName:a.getDetail("offeringName"),numberToReserveRequested:y.getValue(),priceCurrency:r.get("conversionCurrency"),priceSell:r.get("convertedPricingPriceSell"),rateMultipleSelectedRateURI:z.getMultipleSelectedRateURI(),finalDateNew:t,daysAvailable:f.availableDays,numberOfNights:e,wholefinalDate:s,daysRequestable:f.requestableDays,termsAndConditions:h,phoneNumber:g,calculatePerPerson:l,roomfacilities:d,hotelAddressString:b},callback:{fn:function(I,L,H){if(I){var G=this.ownerCt;var M=this.ownerCt.ownerCt.getPnrPanel();var K=M.getViewByName("pnr");if(K){var J=K.findByType("awesomegrid")[0];J.submitQuery(true)}if(!L.makeAnotherBooking){M.focusView("pnrView","pnr")}n.expireInterface()}},scope:this}})}},scope:this})}}]}],listeners:{render:function(){var i=this.ownerCt.findParentByType("tabpanel");this.lm=new Ext.LoadMask(this.bwrap,{msg:""});var g=this.getTopToolbar().items.itemAt(1);g.store=i.shared.stores.rates;var j=i.getTabField("Rate","datePointerIn");var b=i.getTabField("Rate","datePointerOut");var c=i.getTabField("Rate","nightsTemp");var d=this.findField("datePointer");var k=this.findField("datePointerOut");var h=this.findField("dateDays");if(j&&d){d.setValue(j.getValue());this.getDataBox().firstDate=j.getValue()}if(b&&k){k.setValue(b.getValue())}if(c&&h){h.setValue(c.getValue())}var e=i.getTab("Rate");if(e){var f=this.findField("rateURI");var a=e.getSelectedRateURI();if(f&&a){f.setValue(a)}}this.submit()}}}