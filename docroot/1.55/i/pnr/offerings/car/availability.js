{xtype:"panel",cls:"x-tds-availability",width:750,height:170,dt:new Ext.util.DelayedTask(),delay:400,border:false,hideBorders:true,findField:function(b){var a=false;this.getTopToolbar().items.each(function(c){if(c.name==b){a=c;return true}});return a},getDataURI:function(){return this.ownerCt.baseDataURI},getPNRDataURI:function(){return this.ownerCt.pnrDataURI},getDataBox:function(){return this.items.itemAt(0)},getTimerLabel:function(){return this.getTopToolbar().items.itemAt(13)},getRecheckButton:function(){return this.getTopToolbar().items.itemAt(14)},getQueryData:function(){var c={};var a=this.getTopToolbar();var b=this.getDataBox();a.items.each(function(e){if(e.xtype==="textfield"||e.xtype==="combo"||e.xtype==="omnicrementer"){c[e.name]=e.getValue()}else{if(e.xtype==="datefield"){var d=e.getValue();if(d){c[e.name]=d.format(TDS.env.dateFormat)}}}},this);if(c.rateURI&&c.datePointer&&c.dateDays>=0){return c}return false},getPnrPanel:function(){return this.ownerCt.findParentByType("pnrpanel")},expireInterface:function(){this.getTimerLabel().hide();this.getRecheckButton().show();var a=this.getDataBox();a.items.itemAt(0).store.removeAll();a.items.itemAt(0).updateCalendarStatus()},submit:function(){this.dt.cancel();this.dt.delay(this.delay,this.submitQuery,this)},submitQuery:function(){var b=this.getDataBox();var a=this.getQueryData();if(!a){this.dt.cancel();return}b.ownerCt.lm.show();b.items.itemAt(0).store.removeAll();b.items.itemAt(0).updateCalendarStatus();Ext.Ajax.request({method:"GET",url:TDS.env.dataPath+this.getDataURI()+"/reservation",params:a,callback:this.submitResponse,scope:this})},submitResponse:function(g,c,e){if(c){var f=Ext.decode(e.responseText);var b=this.getDataBox();b.saveDateParentnew=Array();b.items.itemAt(0).store.loadData(f);b.items.itemAt(0).updateCalendarStatus();b.ownerCt.lm.hide();var a=new Date().add(Date.SECOND,240).format(TDS.env.dateFormat);this.getTimerLabel().activate(a)}},tbar:["Rate",{xtype:"combo",name:"rateURI",mode:"local",width:140,triggerAction:"all",editable:false,displayField:"nameString",valueField:"dataURI",listeners:{select:function(){this.ownerCt.ownerCt.submit()}}}," ","Available"," ",{xtype:"datefield",name:"datePointer",enableKeyEvents:true,showToday:false,width:80,format:"dMy",minValue:Ext.TimerMgr.getServerCalculatedDate().clearTime(),menuListeners:{select:function(g,d){var e=this.ownerCt.ownerCt;this.setValue(d);var f=this.findParentByType("tabpanel");var b=f.getTabField("Rate","datePointer");if(b){b.setValue(this.getValue())}var a=e.getDataBox();a.setDate(this.getValue());e.submit()}}},"+",{xtype:"omnicrementer",name:"dateDays",width:60,editable:false,listeners:{trigger:function(){var b=this.ownerCt.ownerCt;var c=this.findParentByType("tabpanel");var a=c.getTabField("Rate","dateDays");if(a){a.setValue(this.getValue())}b.submit()}}}," ","days"," ","-"," ",{xtype:"timerlabel",text:"",activate:function(b){var c=this.ownerCt.ownerCt;var a=Ext.TimerMgr.start(new Ext.Timer({id:c.getDataURI()+"/availability",useServerTime:false,expireTime:b,interval:1000}));this.setTimer(a)},reset:function(){var a=this.ownerCt.ownerCt;this.cancelTimer();this.setText('<b>Availability:  <font color="#cc0000">Checking...</font></b>',false)},listeners:{timerexpire:function(a){var b=this.ownerCt.ownerCt;b.expireInterface()},timerrefresh:function(a,b){this.setText('<b>Availability: <font color="#cc0000">Valid for '+b+"</font></b>",false)}}},{xtype:"redbutton",text:"Availability: Expired, click to re-check.",hidden:true,handler:function(){var a=this.ownerCt.ownerCt;a.submitQuery();this.hide();a.getTimerLabel().show()}},{xtype:"textfield",value:true,hidden:true,name:"skipminusDays"},{xtype:"numberfield",hidden:true,name:"numberToReserve"}],items:[{xtype:"panel",layout:"table",border:true,layoutConfig:{columns:2},items:[{xtype:"databox",checkBoxNotRequired:true,multidays:true},{xtype:"formredbutton",style:"margin-left:10px;margin-bottom:100px;",text:"Go",minWidth:90,handler:function(C,o,A){;var l=this.ownerCt.ownerCt.ownerCt.findParentByType("awesomegrid");var a=this.ownerCt.ownerCt.ownerCt.findParentByType("tabpanel");var e=l.getSelections();var m=a.getDetail("carTypeURI");var b=TDS.util.Format.displayResourceName(m);var B=a.getDetail("carVehicleSizeURI");var r=TDS.util.Format.displayResourceName(B);var i=l.topToolbar.items.itemAt(5).getRawValue();var j=l.topToolbar.items.itemAt(5).getValue();var n=l.topToolbar.items.itemAt(8).getValue();var q=l.topToolbar.items.itemAt(10).getValue();var H=l.topToolbar.items.itemAt(12).getValue();var d=l.topToolBar2.items.itemAt(3).getRawValue();var v=l.topToolBar2.items.itemAt(3).getValue();var c=l.topToolBar2.items.itemAt(6).getValue();var y=l.topToolBar2.items.itemAt(8).getValue();var h=l.topToolBar2.items.itemAt(10).getValue();if(B==""||B==null){B=l.topToolBar3.items.itemAt(1).getValue();r=l.topToolBar3.items.itemAt(1).getRawValue()}var s=this.ownerCt.ownerCt.getDataBox();var x=s.items.itemAt(0).saveDateParentnew.sort();var F=s.items.itemAt(0).GetSmallestDate(x);var z=F.split("$");var f=x.length;var g=s.items.itemAt(0).getDaysFromDate(x[0]);var t=this.ownerCt.ownerCt;var a=t.findParentByType("tabpanel");var E=t.findField("numberToReserve");var u=a.shared.stores.rates;var k=t.findField("rateURI");var D=k.getValue();var w=u.getById(D);var G=a.getTab("Rate");if(w==-1){return}TDS.window.setWindow({title:"Car Booking Confirmation",interfaceURI:"pnr/offerings/car/go.js",postDataURI:t.getPNRDataURI()+"/component",mergeData:true,dataURI:{pnr:t.getPNRDataURI(),offering:t.getDataURI(),priceCurrency:w.get("conversionCurrency")},data:{offeringURI:a.getDetail("offeringURI"),rateURI:D,fromCityString:i,fromCity:j,fromplaceURI:n,fromDate:q,fromTime:H,toCityString:d,toCity:v,toplaceURI:c,toDate:y,toTime:h,carVehicleType:m,carVehicleTypeString:b,carVehicleSize:B,carVehicleSizeString:r,rateMultipleSelectedRateURI:G.getMultipleSelectedRateURI()},params:{rateName:k.getRawValue(),rateId:k.getValue(),ratePerURI:w.get("ratePerURI"),offeringName:a.getDetail("offeringName"),numberToReserveRequested:E.getValue(),priceCurrency:w.get("conversionCurrency"),priceSell:w.get("convertedPricingPriceSell"),transmission:w.data.transmission,seats:w.data.seats,age:w.data.age,maximumKilometers:w.data.maximumKilometers,rateMultipleSelectedRateURI:G.getMultipleSelectedRateURI(),finalDateNew:z,daysAvailable:g.availableDays,noOfDays:f,wholefinalDate:x,daysRequestable:g.requestableDays},callback:{fn:function(J,M,I){if(J){var p=this.ownerCt;var N=this.ownerCt.ownerCt.getPnrPanel();var L=N.getViewByName("pnr");if(L){var K=L.findByType("awesomegrid")[0];K.submitQuery(true)}if(!M.makeAnotherBooking){N.focusView("pnrView","pnr")}t.expireInterface()}},scope:this}})}}]}],listeners:{render:function(){var i=this.ownerCt.findParentByType("tabpanel");this.lm=new Ext.LoadMask(this.bwrap,{msg:""});var f=this.getTopToolbar().items.itemAt(1);f.store=i.shared.stores.rates;var b=i.getTabField("Rate","datePointer");var c=i.getTabField("Rate","dateDays");var g=i.getTabField("Rate","numberToReserveTemp");var k=this.findField("numberToReserve");var j=this.findField("datePointer");var h=this.findField("dateDays");if(b&&j){j.setValue(b.getValue());this.getDataBox().firstDate=b.getValue()}if(c&&h){h.setValue(c.getValue())}if(g&&k){k.setValue(g.getValue())}var d=i.getTab("Rate");if(d){var e=this.findField("rateURI");var a=d.getSelectedRateURI();if(e&&a){e.setValue(a)}}this.submit()}}}