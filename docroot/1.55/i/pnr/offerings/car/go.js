{xtype:"form",border:false,height:450,width:650,markDataDirtyOnLoad:true,beforeSubmit:function(q){;var s=this.ownerCt;var m=s.getParam("wholefinalDate");var p=new Date();var t=s.getParam("priceCurrency");var g=new Array();for(var k=0;k<=m.length-1;k++){g[k]=m[k]}var f=m.length;s.clearValidation();var l=[];var r=0;for(var k=0;k<q.rateMultipleSelectedRateURI.length;k++){l[k]=q.rateMultipleSelectedRateURI[k].id}try{var d=this.getPassengerGrid().getData();var b=[];for(var h=0;h<d.length;h++){var o={};o.rateURI=l[0];o.driver=d[h].driver;o.passengerURI=d[h].dataURI;b[h]=o}this.validateBooking(q);var c=s.getData("fromCityString");var q={submitDataAsParams:true,paramData:{action:q.action,currency:t},data:{parameters:{fromCityString:s.getData("fromCityString"),fromCity:s.getData("fromCity"),fromplaceURI:s.getData("fromplaceURI"),fromDate:s.getData("fromDate"),fromTime:s.getData("fromTime"),toCityString:s.getData("toCityString"),toCity:s.getData("toCity"),toplaceURI:s.getData("toplaceURI"),toDate:s.getData("toDate"),toTime:s.getData("toTime"),timeheldDate:p,carVehicleSizeString:s.getData("carVehicleSizeString"),carVehicleSize:s.getData("carVehicleSize"),supplierDepotPickupURI:q.supplierDepotPickupURI,supplierDepotDropoffURI:q.supplierDepotDropoffURI,noOfDays:s.getParam("noOfDays")},rateMultipleSelectedRateURI:l,rateURI:q.rateURI,offeringURI:q.offeringURI,inventoryAmount:this.getDetail("inventoryAmount"),dateFrom:g[0].format(TDS.env.dateFormat),duration:f,passengerURIs:b,selectedNonMandatoryExtras:TDS.data[s.getParam("rateId")],bookedDate:g,releaseDate:q.action=="request"?q.releaseDate:""}};return q}catch(n){s.showValidation(n);return false}},validateBooking:function(a){var c=this.getPassengerGrid();var d=this.getDetail("numberOfPaxRequired");var b=c.getSelectionModel().getCount();if(b<d){throw"You must select "+(d-b)+" passengers to complete this booking."}if(!a.action){throw"You must select an available booking option to proceed."}},initBooking:function(){var a=this.ownerCt;var d=a.getParam("numberToReserveRequested");var e=a.getParam("priceCurrency");var c=a.getParam("priceSell");var b=c*d;this.setDetail({inventoryAmount:d,numberOfPaxRequired:1,ratePriceUnit:c,ratePriceTotal:b,ratePriceCurrency:e})},initPassengerSelection:function(){var a=this.ownerCt;var b=this.getPassengerGrid();var d=this.getDetail("paxType");var c=this.getDetail("numberOfPaxRequired");b.getStore().on("load",function(){var e=b.preselect(d,c)},this)},getPassengerTab:function(){return this.items.itemAt(1).items.itemAt(1)},getPassengerGrid:function(){return this.getPassengerTab().items.itemAt(1).items.itemAt(0)},shared:{details:{}},setDetail:function(b,c){if(typeof b=="object"){for(var a in b){this.shared.details[a]=b[a]}}else{this.shared.details[b]=c}},getDetail:function(a){return this.shared.details[a]},listeners:{render:function(){var b=this.ownerCt;var c=this.items.itemAt(0);var a=Ext.TimerMgr.lookup(b.getDataURI("offering")+"/availability");if(a){c.setTimer(a)}this.initBooking();this.initRadioButtons();this.initPassengerSelection()}},items:[{xtype:"timerlabel",text:"This availability will expire in...",listeners:{timerexpire:function(a){this.setText("Your availability has expired.")},timerrefresh:function(a,b){this.setText("This availability will expire in... <b>"+b+"</b>.",false)}}},{xtype:"tabpanel",border:false,activeTab:0,layoutOnTabChange:true,deferredRender:false,height:450,autoScroll:true,width:650,defaults:{bodyStyle:"padding: 6px 4px 6px 4px;"},items:[{title:"Details",autoScroll:true,items:{xtype:"panel",layout:"form",labelWidth:80,border:false,calculateTotalPrice:function(){var b=this.ownerCt.findParentByType("form");var a=this.ownerCt.findParentByType("awesomewindow");var c=a.getParam("noOfDays");b.setDetail("ratePriceTotal",b.getDetail("inventoryAmount")*c*b.getDetail("ratePriceUnit"))},getRatePriceTotalPanel:function(){return this.items.itemAt(4).items.itemAt(1)},items:[{xtype:"panel",style:"padding: 0; margin-top: 15px;",border:false,layout:"table",layoutConfig:{columns:3},defaults:{height:20,border:false},items:[{html:' <b> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="3399FF"><u>Vehicle Type </u></font></b>',width:200},{html:' <b><font color="3399FF"><u>Vehicle Make </u></font></b>',width:200},{html:' <b><font color="3399FF"><u>Size </u></font></b>',width:200}]},{xtype:"panel",style:"padding: 0;",border:false,layout:"table",layoutConfig:{columns:3},defaults:{height:20,border:false},items:[{width:200,listeners:{render:function(){var a=this.ownerCt.findParentByType("awesomewindow");this.html="<b> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"+a.getData("carVehicleTypeString")}}},{width:200,listeners:{render:function(){var a=this.ownerCt.findParentByType("awesomewindow");this.html="<b> "+a.getParam("offeringName")+"&nbsp;&nbsp;&nbsp;&nbsp;(or similar)"}}},{width:200,listeners:{render:function(){var a=this.ownerCt.findParentByType("awesomewindow");this.html="<b> "+a.getData("carVehicleSizeString")}}}]},{xtype:"panel",style:"padding: 0; margin-top: 6px;",border:false,layout:"table",layoutConfig:{columns:3},defaults:{height:20,border:false},items:[{html:' <b> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="3399FF"><u>Transmission  </u></font></b>',width:200},{html:' <b><font color="3399FF"><u>Seats</u></font></b>',width:200},{html:' <b><font color="3399FF"><u>Max Km </u></font></b>',width:200}]},{xtype:"panel",style:"padding: 0;",border:false,layout:"table",layoutConfig:{columns:3},defaults:{height:20,border:false},items:[{width:200,listeners:{render:function(){var a=this.ownerCt.findParentByType("awesomewindow");var c=a.getParam("transmission");var b=c?"Auto":"Manual";this.html="<b> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"+b}}},{width:200,listeners:{render:function(){var a=this.ownerCt.findParentByType("awesomewindow");this.html="<b> "+a.getParam("seats")+"&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"}}},{width:200,listeners:{render:function(){var a=this.ownerCt.findParentByType("awesomewindow");this.html="<b> "+a.getParam("maximumKilometers")}}}]},{xtype:"panel",style:"padding: 0; margin-top: 4px;",border:false,layout:"table",layoutConfig:{columns:1},defaults:{border:false},items:[{colspan:2,name:"EXTRA_RATE_DISP_AREA",tpl:new Ext.XTemplate(["<br>",'<table class="x-tds-dataview" border=1; style="width: 90%; margin-left: 3px;">',"<thead>",'<tr style="background-color: #d0def0;">','<th style="padding-bottom: 2px; width: 325px;">Extra</th>','<th style="width: 85px; padding-bottom: 2px;">Min. required</th>','<th style="width: 70px; padding-bottom: 2px;">Pricing</th>','<th style="width: 35px; padding-bottom: 2px;">Basis</th>','<th style="width: 30px; padding-bottom: 2px;">Comm</th>',"</tr>","</thead>",'<tpl for=".">',"<tr >",'<td style=" {[values.required ? " color: gray;" : "" ]}">&nbsp;{nameString}</td>',"<td ALIGN=CENTER >{minimumInventoryRequired}</td>","<td ALIGN=RIGHT >{priceCurrency} {[values.priceIsNett ? values.priceNett:values.priceGross]}</td>",'<td ALIGN=CENTER >{priceCommissionPercentage}{[(values.priceCommissionPercentage || values.priceCommissionPercentage == 0 )? "%":""]}</td>',"</tr>","</tpl>","</table>"])}]},{xtype:"panel",style:"padding: 0;",border:false,layout:"table",layoutConfig:{columns:1},defaults:{border:false},items:[{html:"<br><b><u>Booked Rates</u>",width:300}]},{xtype:"panel",style:"padding: 0; margin-top: 2px;",border:false,layout:"table",layoutConfig:{columns:2},defaults:{border:false},items:[{xtype:"numberfield",id:"noOfPassengesId",name:"noOfPassenges",hidden:true},{width:620,listeners:{render:function(){;var m='<table class="x-tds-dataview" style="width: 100%;" border=1 cellpadding = 0 cellspacing=0  >';m+='<thead><tr style="background-color: #d0def0;" class="x-tds-dataview-item">';m+='<th style="padding: 2px; width: 30%;">Rate</th>';m+='<th style="padding: 2px; width: 20%;">Driver Age</th>';m+='<th style="padding: 2px; width: 5%;">Days</th>';m+='<th style="padding: 2px; width: 15%;">Gross Price/Day</th>';m+='<th style="padding: 2px; width: 15%;">Total</th>';var a="";var n=this.ownerCt.findParentByType("awesomewindow");var l=this.ownerCt.findParentByType("form");var e=n.getParam("rateMultipleSelectedRateURI");var j=n.getParam("noOfDays");var s=n.getParam("age");var B=n.getParam("plainDate");var k=e.length-1;var u;var g;var f;var z="";var y=0;var h=0;var b="";for(var v=0;v<e.length;v++){var p=document.getElementById("no"+e[v].data.dataURI).value;h=parseInt(h)+parseInt(p);var b=e[v].json.inventoryTypeURI;var r=e[v].json.nameString;var o=e[v].json.groupName;var A="";var r=e[v].json.nameString;var x=e[v].data.conversionCurrency;var d=e[v].data.convertedPricingPriceSell;var c=e[v].data.convertedPricingPriceCommission;var q=e[v].data.convertedPricingPriceIsNett;if(q){u="Nett"}else{u="Gross"}if(typeof d=="undefined"||d==""){d=0}if(x==""){x="AUD"}var t=TDS.util.Price.calculateFixedGrossNettPrice({pricingPriceCurrency:x,pricingPriceSell:d,pricingPriceCommission:c,pricingPriceIsNett:q});if(p!=""&&p!=0){m+="<tr>";m+="<td >&nbsp;"+r+"</td>",m+="<td >&nbsp;"+s+"</td>",m+="<td >&nbsp;"+j+"</td>",m+="<td >&nbsp;"+x+" "+d.toFixed(2)+"</td>",m+="<td >&nbsp;"+x+" "+(d*j).toFixed(2)+"</td>",m+="</tr>"}}m+="</table></div>";this.html=m}}}]},{xtype:"panel",style:"padding: 0; margin-top: 4px;",border:false,layout:"table",layoutConfig:{columns:2},defaults:{border:false},items:[{html:"<u><b>Total:</b></u>",width:Ext.isIE?88:40},{xtype:"textfield",readOnly:true,style:"border:#FFFFFF; display:compact; font:Verdana; font-weight: bold; background: none;  text-decoration: none; div {text-align: left; } ",listeners:{render:function(){;var n=this.ownerCt.findParentByType("awesomewindow");var m=this.ownerCt.findParentByType("form");var c=n.getParam("rateMultipleSelectedRateURI");var b=parseInt(n.getParam("noOfDays"));var l=c.length-1;var q;var h;var g=0;var u="";var s=0;var x={};x.extras=[];var f=0;for(var r=0;r<c.length;r++){var o=1;var t=c[r].data.conversionCurrency;if(t==""||t==null){t="AUD"}var d=c[r].data.convertedPricingPriceSell;var e=c[r].data.convertedPricingPriceCommission;var p=c[r].data.convertedPricingPriceIsNett;if(p){q="Nett"}else{q="Gross"}if(typeof g=="undefined"||g==""){g=0}if(typeof d=="undefined"||d==""){d=0}s=s+parseInt(o)*parseFloat(d);var k=new Ext.data.CollectionStore({autoLoad:true,url:TDS.env.dataPath+n.getData("offeringURI")+"/searchExtras/collection?rateURI="+c[r].data.dataURI+"&currency="+t,identifier:n.getData("offeringURI")+"/searchExtras?rateURI="+c[r].data.dataURI+"&currency="+t,fields:["dataURI","nameString","termsAndConditions","extraCategoryURI","required","minimumInventoryRequired","conversionCurrency","convertedPricingPriceSell","convertedPricingPriceIsNett","convertedPricingPriceCommission","rateClassURI","ratePerURI","rateOccupancyURI","shareAvailabilitywith","flagCount","offeringURI","childChbox","markUp"]});var v=this.html;k.on("load",function(D,w){var A=x.extras;var z=x.extras.length;var C=0;var i=TDS.data[n.getParam("rateId")];for(var y=z;y<(z+w.length);y++){if(w[(y-z)].data.required||i.indexOf(w[(y-z)].data.dataURI)!=-1){x.extras[(y-C)]=w[(y-z)].data;Ext.apply(x.extras[(y-C)],TDS.util.Price.calculateGrossNettPrice(x.extras[(y-C)]));f+=w[(y-z)].data.priceSell;if(x.extras[(y-C)].priceIsNett){x.extras[(y-C)].priceNett=x.extras[(y-C)].priceSell.toFixed(2);x.extras[(y-C)].markUp=(x.extras[(y-C)].priceSell*TDS.env.user.agencyDefaultComm()/100).toFixed(2);f+=(x.extras[(y-C)].priceSell*TDS.env.user.agencyDefaultComm()/100)}else{x.extras[(y-C)].priceGross=x.extras[(y-C)].priceGross.toFixed(2)}}else{C++;continue}}var a=this.ownerCt.ownerCt.items.itemAt(2).items.itemAt(0);if(x.extras.length>0){a.tpl.overwrite(a.body,x.extras)}var B=" "+t+" "+((f*parseInt(o))+(s)).toFixed(2)+" ";this.setValue(B)},this);if(!c[r].data.convertedPricingPriceIsNett){}var j=" "+t+" "+(((f*parseInt(o))+(s))*b).toFixed(2)+" ";this.setValue(j)}}}}]},{xtype:"fieldset",style:"margin-top: 8px;",layout:"table",layoutConfig:{columns:2},autoHeight:true,defaults:{colspan:2,xtype:"radio",name:"action",forceSubmit:true,hideLabel:true},items:[{boxLabel:"Book available",inputValue:"book",hidden:true,handler:function(c,d){if(d){var e=this.ownerCt.ownerCt;var b=this.ownerCt.findParentByType("form");var a=b.ownerCt;e.calculateTotalPrice()}}},{colspan:1,boxLabel:"Request",inputValue:"request",hidden:true,handler:function(c,d){var f=this.ownerCt.items.itemAt(2);if(d){var e=this.ownerCt.ownerCt;var b=this.ownerCt.findParentByType("form");var a=b.ownerCt;e.calculateTotalPrice();f.enable().focus()}else{f.disable()}}},{colspan:1,xtype:"datefield",name:"releaseDate",hidden:true,disabled:true,showToday:false,width:80,format:TDS.env.dateFormatDisplay,minValue:Ext.TimerMgr.getServerCalculatedDate().clearTime(),listeners:{render:function(){var a=Ext.TimerMgr.getServerCalculatedDate().add(Date.DAY,28);this.setValue(a)}}},{boxLabel:"Quote only",inputValue:"quote"}]},{xtype:"checkbox",name:"makeAnotherBooking",forceSubmit:true,hideLabel:true,checked:false,hidden:true,boxLabel:"Make another booking"}],listeners:{beforerender:function(){var a=this.ownerCt.findParentByType("awesomewindow");var b=a.getDataURI("offering");this.depotStore=new Ext.data.CollectionStore({autoLoad:true,identifier:b+"/depots",url:TDS.env.dataPath+b+"/depots/collection",fields:["dataURI","name","addressString"]})}}}},{title:"Passengers",items:[{xtype:"panel",border:false,style:"margin-bottom: 6px;",html:"<p>Please select the passengers for this booking below.</p>",listeners:{beforerender:function(){var a=this.ownerCt.findParentByType("form");var b=a.getDetail("numberOfPaxRequired");if(b>0){this.html="<p>Please select the "+b+" passengers required for this booking below.</p>"}}}},{xtype:"panel",border:false,layout:"fit",items:[{xtype:"editorgrid",height:350,id:"button-grid",store:new Ext.data.CollectionStore({url:"",identifier:"",fields:["type","code","nameFirst","nameLast","salutation","displayName","dateOfBirth","paxAge","driver"]}),viewConfig:{forceFit:true},getData:function(){var b=this.selModel.getSelections();var c=[];for(var a=0;a<b.length;a++){c[a]={};c[a].driver=b[a].get("driver");c[a].dataURI=b[a].get("dataURI")}return c},preselect:function(c,b){var a=[];this.getStore().each(function(d){if(a.length>=b){return false}if((!c||d.get("type")==c)&&d.get("nameFirst")&&d.get("nameLast")){a[a.length]=d}},this);if(a.length>0){this.getSelectionModel().selectRecords(a)}return a.length},validatePassenger:function(d,a,c,b){if(!b.get("nameFirst")&&!b.get("nameLast")){return false}},sm:new Ext.grid.CheckboxSelectionModel(),columns:[new Ext.grid.CheckboxSelectionModel(),{header:"Type",dataIndex:"type",width:80,fixed:true,editor:new Ext.form.ComboBox({editable:false,forceSelection:true,mode:"local",displayField:"text",valueField:"text",triggerAction:"all",tpl:'<tpl for="."><div class="x-combo-list-item">{text}, <span style="font-style: italic; font-size: 10px; color: #999;">{description}</span></div></tpl>',store:TDS.data.passengerType})},{header:"First name",dataIndex:"nameFirst",editor:new Ext.form.TextField({allowBlank:false}),renderer:function(a,c,b){return a.substr(0,1).toUpperCase()+a.substr(1)}},{header:"Last name",dataIndex:"nameLast",editor:new Ext.form.TextField({allowBlank:false}),renderer:function(a,c,b){return a.substr(0,1).toUpperCase()+a.substr(1)}},{header:"DOB",dataIndex:"dateOfBirth",width:70,fixed:true,editor:new Ext.form.DateField({allowBlank:false}),renderer:function(e,c,b){if(typeof e!="undefined"){if(typeof e!="string"){var a=new Date();a.setTime(Ext.TimerMgr.getServerCalculatedTime());var d=Math.floor((a.getTime()-e.getTime())/(365.25*24*60*60*1000));b.set("paxAge",((d&&d>0)?d:""));return Ext.util.Format.date(e,TDS.env.dateBirthdayFormatDisplay)}else{if(b.get("paxAge")){var d=TDS.util.Format.age(e);b.set("paxAge",((d&&d>0)?d:""))}return TDS.util.Format.dateSpecial(e,TDS.env.dateBirthdayFormatDisplay)}}return TDS.util.Format.dateSpecial(e,TDS.env.dateBirthdayFormatDisplay)}},{header:"Age",dataIndex:"paxAge",width:30,fixed:true,editor:new Ext.form.NumberField({allowBlank:false}),renderer:function(e,c,b){if(e){return e}else{if(typeof b.get("dateOfBirth")!="undefined"){if(typeof b.get("dateOfBirth")!="string"){var a=new Date();a.setTime(Ext.TimerMgr.getServerCalculatedTime());var d=Math.floor((a.getTime()-b.get("dateOfBirth").getTime())/(365.25*24*60*60*1000));return((d&&d>0)?d:"")}else{var d=TDS.util.Format.age(b.get("dateOfBirth"));return((d&&d>0)?d:"")}}return""}}},{header:"Driver",dataIndex:"driver",checkOnly:true,width:72,renderer:function(b,c,a){return"<center><input type=\"checkbox\" onclick=\" var s = Ext.getCmp('button-grid').store;for(var t =0;t<s.data.length;t++){ if(s.data.items[t].id == '"+a.id+"'){  s.data.items[t].data.driver =this.checked}}\""}}],bbar:[{xtype:"button",text:"Add",handler:function(){var b=this.ownerCt.items.itemAt(1);var a=this.ownerCt.items.itemAt(2);a.enable();b.enable();this.disable();var d=this.ownerCt.ownerCt;var c=d.getStore();c.add([new c.recordType({type:"AD",nameFirst:"",nameLast:""})]);d.newRecordIndex=c.getCount()-1;d.startEditing(d.newRecordIndex,2)}},{xtype:"button",text:"Cancel",disabled:true,handler:function(){var c=this.ownerCt.items.itemAt(0);var b=this.ownerCt.items.itemAt(2);c.enable();b.disable();var d=this.ownerCt.ownerCt;var a=d.getStore().getAt(d.newRecordIndex);if(a==-1||typeof a.get("dataURI")!="undefined"){return}d.getStore().remove(a);this.disable()}},{xtype:"button",text:"Save",disabled:true,handler:function(){;var b=this.ownerCt.findParentByType("awesomewindow");var e=this.ownerCt.ownerCt;var d=this.ownerCt.items.itemAt(0);var c=this.ownerCt.items.itemAt(1);c.disable();this.disable();var a=e.getStore().getAt(e.newRecordIndex);if(a==-1||typeof a.get("dataURI")!="undefined"){return}Ext.Ajax.request({url:TDS.env.dataPath+b.getDataURI("pnr")+"/passengers",jsonData:a.data,method:"POST",callback:function(h,f,g){if(f){e.getStore().load();d.enable()}else{c.enable();this.enable()}},scope:this})}}],listeners:{beforeedit:function(a){if(typeof a.record.get("dataURI")!="undefined"){a.cancel=true}},render:function(){var w=this.ownerCt.findParentByType("awesomewindow");this.getSelectionModel().on("beforerowselect",this.validatePassenger,this);with(this.store){reader.meta.identifier=w.getDataURI("pnr")+"/passengers";proxy.conn.url=TDS.env.dataPath+w.getDataURI("pnr")+"/passengers/concise";load()}}}}]}]}]}],initRadioButtons:function(c){var b=this.ownerCt;var d=b.getParam("daysAvailable");var h=b.getParam("daysRequestable");var a=this.items.itemAt(1).items.itemAt(0).items.itemAt(0).findByType("fieldset")[0];var f=a.items.itemAt(0);var e=a.items.itemAt(1);var g=a.items.itemAt(2);if(d>0){f.show()}if(h>0){e.show()}}}