{requireStores:[{dataURI:TDS.env.dataPath+"cruise/classes/collection",identifier:"cruise/classes",fields:["name","dataURI"]},{dataURI:TDS.env.dataPath+"cruise/cabintypes/collection",identifier:"cruise/cabintypes",fields:["name","dataURI","displayName"]},{dataURI:TDS.env.dataPath+"cruise/extracategories/collection",identifier:"cruise/extracategories",fields:["name","dataURI"]},{dataURI:TDS.env.dataPath+"rate/classes/collection",identifier:"rate/classes",fields:["name","dataURI"]},{dataURI:TDS.env.dataPath+"rate/pers/collection",identifier:"rate/pers",fields:["name","dataURI"]},{dataURI:TDS.env.dataPath+"rate/occupancies/collection",identifier:"rate/occupancies",fields:["name","dataURI"]}],xtype:"panel",height:300,border:false,layout:"column",getDataURI:function(){return this.ownerCt.getDataURI()},getDetailsPanel:function(){return this.items.itemAt(0)},getPassengersPanel:function(){return this.items.itemAt(1)},hasDetailsInventory:false,hasDetailsOffering:false,isDetailsReady:function(){if(this.hasDetailsInventory&&this.hasDetailsOffering){return true}return false},items:[{tbar:[{xtype:"button",text:"Edit Pay By",handler:function(){var f=this.ownerCt.findParentByType("tabpanel");var e=f.ownerCt;var d=f.getDetail("dataURI");var b=f.getDetail("paybyDate");var c=f.getDetail("depositDescription");TDS.window.setWindow({title:"Description",information:"Please enter description.",interfaceURI:"pnr/components/accommodation/editPayby.js",destinationDataURI:d+"/updatePayBYDates",data:{paybyDate:b,depositDescription:c},callback:{fn:function(g){e.refreshGrid()}}})}},{xtype:"datefield",hidden:true},{xtype:"button",text:"Save",disabled:true,hidden:true},"->",{xtype:"button",text:"Additinonal Info",handler:function(){var c=this.ownerCt.findParentByType("form");var b=c.getDataURI();if(!b){return}TDS.window.setWindow({title:"Attraction PNR",interfaceURI:"pnr/components/generic/additionalInfo.js",sourceDataURI:b+"/additionalInfo",destinationDataURI:b+"/additionalInfo"})}},{xtype:"button",buttonAlign:"left",disabled:true,text:"Download Voucher",handler:function(){var f=this.ownerCt.findParentByType("tabpanel");var e=f.ownerCt;var d="/voucher/";var b=f.getDetail("dataURI");if(!b){return}var c=TDS.env.currentDomain;Ext.Ajax.request({url:TDS.env.dataPath+b+"/voucher",jsonData:{currentDomain:c},method:"PUT",scope:this,callback:function(j,h,i){d=d+i.responseText+".rtf";var g=window.open(d,"Information Priview","height=500,width=800,left=10,top=10,resizable=yes,scrollbars=yes,toolbar=yes,menubar=no,location=no,directories=no,status=yes");g.focus()}})}}],columnWidth:0.6,xtype:"panel",height:220,border:true,tpl:new Ext.XTemplate('<div style="height:150px; overflow-y: scroll;">','<table border="0" width="100%">','<tr><td width="14%"><span style="font-size:12px"><b>RLOC:</b></span></td><td width="20%"><font color="red"><span style="font-size:12px"> <b>{pnrCode}</b><span style="font-size:12px"></font></td>','<td  width="8%"><span style="font-size:12px"><b>Pay By:</b></span></td><td  width="20%"><div id="ttlDate#{divDataUri}"><span style="font-size:12px">{paybyDate}&nbsp;{depositDescription}</span></div></td>',"<td></td>","</tr>","</table>",'<table class="x-tds-dataview" style="width: 100%;" border=1 cellpadding = 1 cellspacing=0  ><tr style="background-color: #d0def0;"><th style="padding: 2px; width: 14%;">Ship</th><th style="padding: 2px; width: 14%;">Departs</th><th style="padding: 2px; width: 14%;">Date/Range</th><th style="padding: 2px; width: 14%;">Arrives</th><th style="padding: 2px; width: 14%;">Duration</th></tr><tr ><td style="padding: 2px; width: 14%;">{shipName}</td><td style="padding: 2px; width: 14%;">{locationFromString}</td><td style="padding: 2px; width: 14%;">{departureDate}</td><td style="padding: 2px; width: 14%;">{arrivalDate}</td><td style="padding: 2px; width: 14%;">{duration}</td></tr></table><table class="x-tds-dataview" style="width: 100%;" border=1 cellpadding = 1 cellspacing=0  ><tr style="background-color: #d0def0;"><th style="padding: 2px; width: 12%;">Category</th><th style="padding: 2px; width: 14%;">Stateroom No</th><th style="padding: 2px; width: 14%;">Position</th><th style="padding: 2px; width: 14%;">Deck</th><th style="padding: 2px; width: 10%;">Status</th></tr>',"{cabinsBody}",'</table> <table class="x-tds-dataview" style="width: 100%;" border=1 cellpadding = 1 cellspacing=0  ><tr style="background-color: #d0def0;"><th style="padding: 2px; width: 14%;">Cruise price</th><th style="padding: 2px; width: 14%;">Package price</th><th style="padding: 2px; width: 14%;"> Extras</th><th style="padding: 2px; width: 24%;">Total Price(Gross)</th><th style="padding: 2px; width: 14%;">Markup Included</th><th style="padding: 2px; width: 14%;">Comm</th></tr><tr><td style="padding: 2px; width: 14%;">{pricingPriceCurrency}&nbsp;{pricingPriceSell}</td><td style="padding: 2px; width: 14%;">{pricingPriceCurrency}&nbsp;{packagepricingPriceSell}</td><td style="padding: 2px; width: 14%;">{pricingPriceCurrency}&nbsp;{extraTotal} {extrsGrossFlag}</td><td style="padding: 2px; width: 24%;">{total}</td><td style="padding: 2px; width: 14%;">{pricingPriceCurrency}&nbsp;{markup}</td><td style="padding: 2px; width: 14%;">{priceCommission}</td></tr></table><br/>','<table border="0" width="100%">',"</table>","</div>",'<div> <table style="width: 100%;"><tr><td>{createdString}</td></tr></table></div>')},{columnWidth:0.4,xtype:"grid",enableRowExpander:false,sessionExpandedRows:false,height:160,autoScroll:true,border:false,enableColumnHide:false,enableColumnMove:false,enableColumnResize:false,enableHdMenu:false,tbar:["->",{xtype:"button",disabled:true,text:"Cancel passenger",handler:function(){pGridPass=this.ownerCt.ownerCt;var c=this.ownerCt.ownerCt.findParentByType("tabpanel");dataURIPass=c.getDetail("dataURI");Ext.Msg.show({title:"Confirmation",msg:"Are you sure, want to cancel passenger?",buttons:Ext.Msg.YESNO,fn:b,animEl:"elId",icon:Ext.MessageBox.QUESTION});function b(k){if(k=="yes"){var f=pGridPass;var h=f.getSelections();var e=dataURIPass;var d={};var g=new Array();for(var j=0;j<h.length;j++){g[j]=h[j].data.dataURI}d.passengerURIs=g;Ext.Ajax.request({url:TDS.env.dataPath+e+"/cancel",method:"PUT",jsonData:d,callback:function(p,i,m){if(i){try{Ext.Msg.alert("Status","Changes saved successfully.");var l=f.ownerCt.findParentByType("awesomegrid");l.submitQuery(true)}catch(n){}}}})}}}}],store:new Ext.data.JsonStore({url:"",id:"dataURI",fields:["dataURI","displayName","code","dateOfBirth","addressString","phoneNumber1","emailAddress","gender","status"]}),sm:new Ext.grid.CheckboxSelectionModel(),columns:[new Ext.grid.CheckboxSelectionModel(),{header:"Passenger",dataIndex:"displayName",width:200,sortable:true,renderer:function(f,e,b,g,d,c){e.attr='ext:qtip= "Click to view details"';return f}},{header:"Type",dataIndex:"code",width:80},{header:"Gender",dataIndex:"gender",renderer:TDS.util.Format.gender,width:100},{header:"DOB",dataIndex:"dateOfBirth",width:100,renderer:TDS.util.Format.dateSpecialRenderer(TDS.env.dateBirthdayFormatDisplay)},{header:"Age",dataIndex:"dateOfBirth",renderer:TDS.util.Format.age,width:80},{header:"Status",dataIndex:"status",width:100}],viewConfig:{forceFit:true},listeners:{rowdblclick:function(d,g,f){var c=d.getStore().getAt(g);var b=c.get("dataURI");TDS.window.setWindow({buttonOK:false,title:"Passenger details",destinationDataURI:b,interfaceURI:"pnr/passenger/viewDetails.js",sourceDataURI:b})},render:function(){var d=this.bottomToolbar;this.getSelectionModel().on("rowselect",function(){if(this.ownerCt.getSelections().length>0){d.items.itemAt(1).setDisabled(false)}},d);this.getSelectionModel().on("rowdeselect",function(){if(this.ownerCt.getSelections().length==0){d.items.itemAt(1).setDisabled(true)}},d);this.getEl().swallowEvent(["columnmove","columnresize","headerclick","click","mouseout","rowclick","rowmousedown","rowblclick","cellblclick","sortchange","mouseup","mousedown"]);var c=this.ownerCt.findParentByType("tabpanel");var b=c.getDetail("dataURI");Ext.Ajax.request({url:TDS.env.dataPath+b+"/passengers/collection/concise",method:"GET",callback:function(h,n,f){if(n){var l=Ext.util.JSON.decode(f.responseText);var k=l[b+"/passengers"];if(typeof k=="undefined"){return}var m=[];for(var j=0;j<k.length;j++){l[k[j]].dataURI=k[j];m.push(l[k[j]])}var g=this;var e=g.store;e.loadData(m);g.getView().refresh()}},scope:this})}}}],listeners:{render:function(){this.initInventory();this.initOffering()}},initInventory:function(){var h=this.ownerCt.findParentByType("tabpanel");var e=h.getDetail("dataURI");var d=h.getDetail("depositDescription");var c=h.getDetail("paybyDate");var b=TDS.util.Format.dateSpecial(c,TDS.env.dateFormatDisplay);var g=e;var f=new Array();f=e.split("/");Ext.Ajax.request({url:TDS.env.dataPath+e+"/inventories/collection",method:"GET",callback:function(P,L,N){if(L){try{var H=Ext.decode(N.responseText)}catch(X){}if(H){var z=0,I,Q=[];var F=0;var V=H["component/inventory/collection"];var n=V[e+"/inventories"];var O=H["component/rate/collection/"];var k=O["component/rate/collection/list"];var v=H["component/selectedCruiseRateCabins"];var A="";if(typeof v!="undefined"&&v!=""&&v.length>0){for(var U=0;U<v.length;U++){var G=v[U];var m=H[G];A+="<tr>";if(typeof m.catName!="undefined"&&m.catName!=""){A+="<td>"+m.catName+"</td>"}else{A+="<td></td>"}if(typeof m.cabinNumber!="undefined"&&m.cabinNumber!=""){A+="<td>"+m.cabinNumber+"</td>"}else{A+="<td></td>"}if(typeof m.position!="undefined"&&m.position!=""){A+="<td>"+m.position+"</td>"}else{A+="<td></td>"}if(typeof m.deck!="undefined"&&m.deck!=""){A+="<td>"+m.deck+"</td>"}else{A+="<td></td>"}if(typeof m.categoryStatus!="undefined"&&m.categoryStatus!=""){A+="<td>"+m.categoryStatus+"</td>"}else{A+="<td></td>"}A+="</tr>"}}h.setDetail("rateList",k);var M=new Array();M=e.split("/");var B="";this.rateData=[];var aa=n.length/k.length;var R=[];var C="";var W=[];var y=0;if(n.length>0){for(var U=0;U<n.length;U++){var Y=V[n[U]];Q[Q.length]=TDS.util.Format.dateSpecial(Y.componentPaybyDate,TDS.env.dateFormatDisplay);C=Y.pricingPriceCurrency;if(W.indexOf(Y.rateId)==-1){W[U]=Y.rateId;R[y]=TDS.util.Price.calculateFixedGrossNettPrice({pricingPriceCurrency:Y.pricingPriceCurrency,pricingPriceSell:Y.pricingPriceSell,pricingPriceCommission:Y.pricingPriceCommission,pricingPriceIsNett:Y.pricingPriceIsNett});R[y].rateId=Y.rateId;R[y].quantity=Y.quantity;y++}}var K="";var E=0;var q="";var T=0;if(k.length>0){for(var U=0;U<k.length;U++){var D=O[k[U]];T=D.extraTotal;B=O[k[U]].tempBookedDate;var J=[];var Z=D.groupName;var p="";var w="";var l=O[k[U]].pricingPriceSell;var t="";O[k[U]].pricingPriceIsNett;if(O[k[U]].pricingPriceIsNett){t="Net"}else{t="Gross"}q=O[k[U]].category;var x=null;for(var S=0;S<R.length;S++){if(R[S].rateId==k[U].substring(k[U].lastIndexOf("/")+1,k[U].length)){x=R[S]}}if(!x.priceIsNett){p=x.priceCommissionPercentage}else{w=x.priceCommission;F+=(x.quantity*x.priceCommission)}E+=(x.quantity*x.priceSell);K+="<tr>";K+="<td  >"+D.nameString+"</td>",K+="<td  ALIGN=CENTER></td>",K+="<td  ALIGN=RIGHT> </td>",K+="<td  ALIGN=RIGHT>"+(x.priceIsNett?(x.priceCurrency+" "+w):"")+"&nbsp;&nbsp;&nbsp;&nbsp;</td>",K+="<td  >"+a[0]+"&nbsp;&nbsp;&nbsp;&nbsp;</td>",K+="<td  ALIGN=CENTER>"+x.quantity+"</td>",K+="<td  ALIGN=CENTER>"+x.flag+"</td>",K+="<td  ALIGN=CENTER>"+p+"</td>",K+="</tr>"}E+=F;E+=T}if(Q.length>0){var u=Q[0]}else{var u=Q}h.setDetail("pricingPriceCurrency",C);this.inventoryData={rateBody:K,cabinsBody:A,dataURI:e,divDataUri:g,numberOfNights:aa,dates:u,depositDescription:d,paybyDate:b,markup:TDS.util.Price.formatPrice(F,C),pnrCode:M[1],bookeddateDis:B,total:TDS.util.Price.formatPrice(E,C),extraTotal:TDS.util.Price.formatPrice(T,C),priceCommission:p,pricingPriceSell:TDS.util.Price.formatPrice(l,C),grossNett:t,category:q,packagepricingPriceSell:TDS.util.Price.formatPrice(this.findParentByType("awesomegrid").getSelectionModel().getSelected().get("packagePrice"),C)};this.hasDetailsInventory=true;if(this.isDetailsReady()){this.displayDetails()}}}}},scope:this})},initOffering:function(){var c=this.ownerCt.findParentByType("tabpanel");var b=c.getDetail("offeringURI");Ext.Ajax.request({url:TDS.env.dataPath+b,method:"GET",callback:function(i,d,g){if(d){try{var f=Ext.decode(g.responseText)}catch(h){}if(f){this.offeringData={website:f.primaryHref,addressString:f.addressString,shipName:f.cruiseShipName,locationFromString:f.locationFromString,locationToString:f.locationToString,duration:f.duration,departureDate:TDS.util.Format.dateSpecial(f.departureDate,TDS.env.dateFormatDisplay),arrivalDate:TDS.util.Format.dateSpecial(f.arrivalDate,TDS.env.dateFormatDisplay)};this.hasDetailsOffering=true;if(this.isDetailsReady()){this.displayDetails()}}}},scope:this})},displayDetails:function(){var e=this.ownerCt.findParentByType("tabpanel");var h=Date.parseDate(e.getDetail("createdDate"),TDS.env.dateFormat);var j=Date.parseDate(e.getDetail("updatedDate"),TDS.env.dateFormat);var b=this.findParentByType("awesomegrid").findParentByType("pnrpanel").ownerCt.ownerCt.dataObj.pnrFrom;var i=!Ext.isEmpty(b)?"Created by Mobile on ":"Created on ";var c=i+h.format(TDS.env.dateTimeFormatDisplay)+" by "+e.getDetail("createdByUserFullNameString")+", modified on "+j.format(TDS.env.dateTimeFormatDisplay)+(e.getDetail("createdByUserFullNameString")==e.getDetail("updatedByUserFullNameString")?"":" by "+e.getDetail("updatedByUserFullNameString"))+".";var f=TDS.util.Price.calculateFixedGrossNettPrice({pricingPriceCurrency:e.getDetail("pricingPriceCurrency"),pricingPriceSell:e.getDetail("pricingPriceSell"),pricingPriceCommission:e.getDetail("pricingPriceCommission"),pricingPriceIsNett:e.getDetail("pricingPriceIsNett")});var g=this.inventoryData.Ggrosstemp;if(f.priceSell==""||f.priceSell==null||f.priceSell=="undefined"){f.priceSell=0}var d=f.priceSell*parseInt(this.inventoryData.quantity);this.getDetailsPanel().tpl.overwrite(this.getDetailsPanel().body,Ext.apply({createdString:c},this.inventoryData,this.offeringData))}}