{requireStores:[{dataURI:TDS.env.dataPath+"tour/types/collection",identifier:"tour/types",fields:["name","dataURI"]},{dataURI:TDS.env.dataPath+"tour/classes/collection",identifier:"tour/classes",fields:["name","dataURI"]},{dataURI:TDS.env.dataPath+"tour/extracategories/collection",identifier:"tour/extracategories",fields:["name","dataURI"]},{dataURI:TDS.env.dataPath+"rate/classes/collection",identifier:"rate/classes",fields:["name","dataURI"]},{dataURI:TDS.env.dataPath+"rate/pers/collection",identifier:"rate/pers",fields:["name","dataURI"]},{dataURI:TDS.env.dataPath+"rate/occupancies/collection",identifier:"rate/occupancies",fields:["name","dataURI"]}],xtype:"panel",height:300,border:false,frame:false,layout:"column",getDetailsPanel:function(){return this.items.itemAt(0)},getPassengersPanel:function(){return this.items.itemAt(1)},hasDetailsInventory:false,hasDetailsOffering:false,isDetailsReady:function(){if(this.hasDetailsInventory&&this.hasDetailsOffering){return true}return false},items:[{tbar:[{xtype:"button",text:"Edit Pay By",handler:function(){var e=this.ownerCt.findParentByType("tabpanel");var d=e.ownerCt;var c=e.getDetail("dataURI");var a=e.getDetail("paybyDate");var b=e.getDetail("depositDescription");TDS.window.setWindow({title:"Description",information:"Please enter description.",interfaceURI:"pnr/components/accommodation/editPayby.js",destinationDataURI:c+"/updatePayBYDates",data:{paybyDate:a,depositDescription:b},callback:{fn:function(f){d.refreshGrid()}}})}},{xtype:"datefield",hidden:true},{xtype:"button",text:"Save",disabled:true,hidden:true},"->",{xtype:"button",buttonAlign:"right",text:"Additional Info",handler:function(){var c=this.ownerCt.findParentByType("tabpanel");var b=c.ownerCt;var a=c.getDetail("dataURI");if(!a){return}TDS.window.setWindow({title:"Tour PNR",interfaceURI:"pnr/components/generic/additionalInfo.js",sourceDataURI:a+"/additionalInfo",destinationDataURI:a+"/additionalInfo"})}}],columnWidth:0.6,xtype:"panel",height:225,border:true,tpl:new Ext.XTemplate('<div style="height:180px; overflow-y: scroll;">','<table border="0" width="100%">','<tr><td width="14%"><span style="font-size:12px"><b>RLOC:</b></span></td><td width="20%"><font color="red"><span style="font-size:12px"> <b>{pnrCode}</b><span style="font-size:12px"></font></td>','<td  width="17%"><span style="font-size:12px"><b>Pay By:</b></span></td><td  width="20%"><div id="ttlDate#{divDataUri}"><span style="font-size:12px">{paybyDate}&nbsp;{depositDescription}</span></div></td>',"<td></td>","<td width='20%'></td>","</tr>","</table>",'<table class="x-tds-dataview" style="width: 100%;" border=1 cellpadding = 1 cellspacing=0  >','<tr style="background-color: #d0def0;" >','<th style="padding: 2px; width: 38%;">Pax Type</th>','<th style="padding: 2px; width: 4%;">No</th>','<th style="padding: 2px; width: 16%;">Net</th>','<th style="padding: 2px; width: 12%;">Markup</th>','<th style="padding: 2px; width: 12%;">Gross</th>','<th style="padding: 2px; width: 7%;">Comm</th>',"</tr>","{rateBody}","</table>","<br/>",'<table border= 0 width="100%">','<tr><td width="17%"><b>Markup:</b></td><td width="86%" colspan = 8> {priceCurrency}&nbsp;{markup}</td></tr>','<tr><td width="17%"><b>Extras:</b></td><td width="86%" colspan = 8>{priceCurrency}&nbsp;{extraTotal} {extrsGrossFlag}</td></tr>','<tr><td width="17%"><b>Total:</b></td><td width="86%" colspan = 8> {priceCurrency}&nbsp;{total} </td></tr>','<tr><td width="100%" colspan=9><hr></td></tr>','<tr><td width="17%"><b>Pass Category:</b></td><td width="86%" colspan = 8> {railPassMainCategoryName}</td></tr>',"<tr>",'<td width="17%"><b>Pass Sub Category: </b></td><td width="46%" colspan = 4> {railPassSubCategoryName}</td>','<td width="5%" valign="top"><b>Countries:</b></td><td width="46%" colspan = 4> <p>{countries}</p></td>',"</tr>","<tr>",'<td width="17%" valign="top"><b>Pass Name:</b></td><td width="46%" colspan = 4> <p>{rateName}</p></td>','<td width="5%" valign="top"><b>Period:</b></td><td width="46%" colspan = 4> <p>{validity}</p></td>',"</tr>","</table>","</div>",'<div> <table style="width: 100%;"><tr><td>{createdString}</td></tr></table></div>')},{columnWidth:0.4,xtype:"grid",enableRowExpander:false,sessionExpandedRows:false,height:160,autoScroll:true,border:false,enableColumnHide:false,enableColumnMove:false,enableColumnResize:false,enableHdMenu:false,bbar:["->",{xtype:"button",disabled:true,text:"Cancel passenger",handler:function(){pGridPass=this.ownerCt.ownerCt;var b=this.ownerCt.ownerCt.findParentByType("tabpanel");dataURIPass=b.getDetail("dataURI");Ext.Msg.show({title:"Confirmation",msg:"Are you sure, want to cancel passenger?",buttons:Ext.Msg.YESNO,fn:a,animEl:"elId",icon:Ext.MessageBox.QUESTION});function a(j){if(j=="yes"){var e=pGridPass;var g=e.getSelections();var d=dataURIPass;var c={};var f=new Array();for(var h=0;h<g.length;h++){f[h]=g[h].data.dataURI}c.passengerURIs=f;Ext.Ajax.request({url:TDS.env.dataPath+d+"/cancel",method:"PUT",jsonData:c,callback:function(n,i,l){if(i){try{Ext.Msg.alert("Status","Changes saved successfully.");var k=e.ownerCt.findParentByType("awesomegrid");k.submitQuery(true)}catch(m){}}}})}}}}],store:new Ext.data.JsonStore({url:"",id:"dataURI",fields:["dataURI","displayName","code","dateOfBirth","addressString","phoneNumber1","emailAddress","gender","status"]}),sm:new Ext.grid.CheckboxSelectionModel(),columns:[new Ext.grid.CheckboxSelectionModel(),{header:"Passenger",dataIndex:"displayName",width:200,sortable:true,renderer:function(e,d,a,f,c,b){d.attr='ext:qtip= "Click to view details"';return e}},{header:"Type",dataIndex:"code",width:80},{header:"Gender",dataIndex:"gender",renderer:TDS.util.Format.gender,width:100},{header:"DOB",dataIndex:"dateOfBirth",width:100,renderer:TDS.util.Format.dateSpecialRenderer(TDS.env.dateBirthdayFormatDisplay)},{header:"Age",dataIndex:"dateOfBirth",renderer:TDS.util.Format.age,width:80},{header:"Status",dataIndex:"status",width:100}],viewConfig:{forceFit:true},listeners:{rowdblclick:function(c,f,d){var b=c.getStore().getAt(f);var a=b.get("dataURI");TDS.window.setWindow({buttonOK:false,title:"Passenger details",destinationDataURI:a,interfaceURI:"pnr/passenger/viewDetails.js",sourceDataURI:a});if(c.getSelections().length>0){this.bottomToolbar.items.itemAt(1).enable(true)}else{this.bottomToolbar.items.itemAt(1).disable(true)}},render:function(){this.getEl().swallowEvent(["columnmove","columnresize","headerclick","click","mouseout","rowclick","rowmousedown","rowblclick","cellblclick","sortchange","mouseup","mousedown"]);var b=this.ownerCt.findParentByType("tabpanel");var a=b.getDetail("dataURI");Ext.Ajax.request({url:TDS.env.dataPath+a+"/passengers/collection/concise",method:"GET",callback:function(f,l,d){if(l){var j=Ext.util.JSON.decode(d.responseText);var h=j[a+"/passengers"];if(typeof h=="undefined"){return}var k=[];for(var g=0;g<h.length;g++){j[h[g]].dataURI=h[g];k.push(j[h[g]])}var e=this;var c=e.store;c.loadData(k);e.getView().refresh()}},scope:this})}}}],listeners:{render:function(){this.initInventory();this.initOffering()}},initInventory:function(){;var h=this.ownerCt.findParentByType("tabpanel");var d=h.getDetail("dataURI");var c=h.getDetail("depositDescription");var b=h.getDetail("paybyDate");var a=TDS.util.Format.dateSpecial(b,TDS.env.dateFormatDisplay);var g=d;var f=new Array();var e=0;f=d.split("/");Ext.Ajax.request({url:TDS.env.dataPath+d+"/inventories/collection",method:"GET",callback:function(M,I,K){var Y=this.ownerCt.findParentByType("tabpanel");if(I){try{var E=Ext.decode(K.responseText)}catch(V){}if(E){var x=0,F,N=[];var D=0;var T=E["component/inventory/collection"];var l=T[d+"/inventories"];var L=E["component/rate/collection/"];var k=L["component/rate/collection/list"];var v=L.TOUR_TYPR_STRING;Y.setDetail("rateList",k);var J=new Array();J=d.split("/");var y="";this.rateData=[];var ab=l.length/k.length;var P=[];var A="";var U=[];var w=0;if(l.length>0){for(var S=0;S<l.length;S++){var X=T[l[S]];N[N.length]=TDS.util.Format.dateSpecial(X.componentPaybyDate,TDS.env.dateFormatDisplay);A=X.pricingPriceCurrency;if(U.indexOf(X.rateId)==-1){U[S]=X.rateId;P[w]=TDS.util.Price.calculateFixedGrossNettPrice({pricingPriceCurrency:X.pricingPriceCurrency,pricingPriceSell:X.pricingPriceSell,pricingPriceCommission:X.pricingPriceCommission,pricingPriceIsNett:X.pricingPriceIsNett});P[w].rateId=X.rateId;P[w].quantity=X.quantity;w++}}var H="";var z="";var p="";var q="";var C=0;var R=0;if(k.length>0){for(var S=0;S<k.length;S++){var B=L[k[S]];y=L[k[S]].tempBookedDate;var G=[];var aa=B.groupName;var m="";var t="";G=aa.split(",");var Z=[];var O=G[0];Z=O.split(" ");var u=null;for(var Q=0;Q<P.length;Q++){if(P[Q].rateId==k[S].substring(k[S].lastIndexOf("/")+1,k[S].length)){u=P[Q]}}if(!u.priceIsNett){m=u.priceCommissionPercentage}else{t=u.priceCommission;D+=(u.quantity*u.priceCommission)}if(u.quantity>0){R=B.extraTotal}z=B.nameString;q=B.railPassSelectedCountries;var Z=B.validityDays+" Days in "+B.validityMonths+" Months";var W=B.days+" Days  "+B.months+" Months";if(B.validityDays!=0&&B.validityMonths!=0){p=Z}else{if(B.months!=0&&B.days!=0){p=W}}C+=(u.quantity*u.priceSell);H+="<tr>";H+="<td  >"+B.passType+"</td>",H+="<td  ALIGN=CENTER>"+u.quantity+"</td>",H+="<td  ALIGN=RIGHT>"+u.priceCurrency+" "+u.priceSell.toFixed(2)+"&nbsp;&nbsp;&nbsp;&nbsp;</td>",H+="<td  ALIGN=RIGHT>"+(u.priceIsNett?(u.priceCurrency+" "+t):"")+"&nbsp;&nbsp;&nbsp;&nbsp;</td>",H+="<td  ALIGN=RIGHT>"+u.priceCurrency+" "+u.priceSell.toFixed(2)+"&nbsp;&nbsp;&nbsp;&nbsp;</td>",H+="<td  ALIGN=CENTER>"+m+"</td>",H+="</tr>"}}C+=D;C+=R;if(N.length>0){var n=N[0]}else{var n=N}Y.setDetail("pricingPriceCurrency",A);this.inventoryData={fn:this.updatePayByDate,dataURI:d,divDataUri:g,rateName:z,validity:p,countries:q,rateBody:H,numberOfNights:ab,dates:n,depositDescription:c,paybyDate:a,markup:D.toFixed(2),pnrCode:J[1],bookeddateDis:y,total:C.toFixed(2),extraTotal:R.toFixed(2),tourType:v,priceCurrency:A};this.hasDetailsInventory=true;if(this.isDetailsReady()){this.displayDetails()}}}}},scope:this})},initOffering:function(){var c=this.ownerCt.findParentByType("tabpanel");var b=c.getDetail("offeringURI");var a;Ext.Ajax.request({url:TDS.env.dataPath+b,method:"GET",callback:function(i,d,g){if(d){try{var f=Ext.decode(g.responseText)}catch(h){}if(f){this.offeringData={railPassMainCategoryName:f.railPassMainCategoryName,railPassSubCategoryName:f.railPassSubCategoryName};this.hasDetailsOffering=true;if(this.isDetailsReady()){this.displayDetails()}}}},scope:this})},displayDetails:function(){var d=this.ownerCt.findParentByType("tabpanel");var h=Date.parseDate(d.getDetail("createdDate"),TDS.env.dateFormat);var j=Date.parseDate(d.getDetail("updatedDate"),TDS.env.dateFormat);var a=this.findParentByType("awesomegrid").findParentByType("pnrpanel").ownerCt.ownerCt.dataObj.pnrFrom;var i=!Ext.isEmpty(a)?"Created by Mobile on ":"Created on ";var b=i+h.format(TDS.env.dateTimeFormatDisplay)+" by "+d.getDetail("createdByUserFullNameString")+", modified on "+j.format(TDS.env.dateTimeFormatDisplay)+(d.getDetail("createdByUserFullNameString")==d.getDetail("updatedByUserFullNameString")?"":" by "+d.getDetail("updatedByUserFullNameString"))+".";var e=TDS.util.Price.calculateFixedGrossNettPrice({pricingPriceCurrency:d.getDetail("pricingPriceCurrency"),pricingPriceSell:d.getDetail("pricingPriceSell"),pricingPriceCommission:d.getDetail("pricingPriceCommission"),pricingPriceIsNett:d.getDetail("pricingPriceIsNett")});var f=(e.priceSell+e.priceCommission);var g=this.inventoryData.Ggrosstemp;if(e.priceSell==""||e.priceSell==null||e.priceSell=="undefined"){e.priceSell=0}var c=e.priceSell*parseInt(this.inventoryData.quantity);this.getDetailsPanel().tpl.overwrite(this.getDetailsPanel().body,Ext.apply({price:e.priceSell.toFixed(2),createdString:b,pricenet:e.priceIsNett,flag:e.flag,priceCommissionPercentage:e.priceCommissionPercentage,extragross:e.extragross,quaPrice:c.toFixed(2)},this.inventoryData,this.offeringData))}}