{requireStores:[{dataURI:TDS.env.dataPath+"tour/types/collection",identifier:"tour/types",fields:["name","dataURI"]},{dataURI:TDS.env.dataPath+"tour/classes/collection",identifier:"tour/classes",fields:["name","dataURI"]},{dataURI:TDS.env.dataPath+"tour/extracategories/collection",identifier:"tour/extracategories",fields:["name","dataURI"]},{dataURI:TDS.env.dataPath+"rate/classes/collection",identifier:"rate/classes",fields:["name","dataURI"]},{dataURI:TDS.env.dataPath+"rate/pers/collection",identifier:"rate/pers",fields:["name","dataURI"]},{dataURI:TDS.env.dataPath+"rate/occupancies/collection",identifier:"rate/occupancies",fields:["name","dataURI"]}],xtype:"panel",height:320,border:true,frame:false,layout:"column",getDetailsPanel:function(){return this.items.itemAt(0)},getPassengersPanel:function(){return this.items.itemAt(1)},hasDetailsInventory:false,hasDetailsOffering:false,isDetailsReady:function(){if(this.hasDetailsInventory&&this.hasDetailsOffering){return true}return false},items:[{tbar:[{xtype:"button",text:"Edit Pay By",handler:function(){var f=this.ownerCt.findParentByType("tabpanel");var e=f.ownerCt;var d=f.getDetail("dataURI");var b=f.getDetail("paybyDate");var c=f.getDetail("depositDescription");TDS.window.setWindow({title:"Description",information:"Please enter description.",interfaceURI:"pnr/components/accommodation/editPayby.js",destinationDataURI:d+"/updatePayBYDates",data:{paybyDate:b,depositDescription:c},callback:{fn:function(g){e.refreshGrid()}}})}},{xtype:"datefield",hidden:true},{xtype:"button",text:"Save",disabled:true,hidden:true},"->",{xtype:"button",buttonAlign:"right",text:"Additional Info",handler:function(){var d=this.ownerCt.findParentByType("tabpanel");var c=d.ownerCt;var b=d.getDetail("dataURI");if(!b){return}TDS.window.setWindow({title:"Tour PNR",interfaceURI:"pnr/components/generic/additionalInfo.js",sourceDataURI:b+"/additionalInfo",destinationDataURI:b+"/additionalInfo"})}},{xtype:"button",buttonAlign:"left",text:"Download Voucher",handler:function(){var f=this.ownerCt.findParentByType("tabpanel");var e=f.ownerCt;var d="/GraphicsImg/voucher/";var b=f.getDetail("dataURI");if(!b){return}var c=TDS.env.currentDomain;Ext.Ajax.request({url:TDS.env.dataPath+b+"/voucher",jsonData:{currentDomain:c},method:"PUT",scope:this,callback:function(j,h,i){d=d+i.responseText+".rtf";var g=window.open(d,"Information Priview","height=500,width=800,left=10,top=10,resizable=yes,scrollbars=yes,toolbar=yes,menubar=no,location=no,directories=no,status=yes");g.focus()}})}}],columnWidth:0.6,xtype:"panel",height:275,border:true,tpl:new Ext.XTemplate('<div style="height:150px; overflow-y: scroll;">','<table border="0" width="100%">','<tr><td width="14%"><span style="font-size:12px"><b>RLOC:</b></span></td><td width="20%"><font color="red"><span style="font-size:12px"> <b>{pnrCode}</b><span style="font-size:12px"></font></td>','<td  width="15%"><span style="font-size:12px"><b>Pay By:</b></span></td><td  width="20%"><div id="ttlDate#{divDataUri}"><span style="font-size:12px">{paybyDate}&nbsp;{depositDescription}</span></div></td>',"<td></td>","<td width='20%'></td>","</tr>","</table>",'<table class="x-tds-dataview" style="width: 100%;" border=1 cellpadding = 1 cellspacing=0  >','<tr style="background-color: #d0def0;" >','<th style="padding: 2px; width: 35%;">Tour Name</th>','<th style="padding: 2px; width: 25%;">City</th>','<th style="padding: 2px; width: 25%;">Dep Date</th>','<th style="padding: 2px; width: 15%;">Time</th>','<th style="padding: 2px; width: 15%;">Duration</th>',"</tr>","<tr>","<td>{name}</td>","<td>{locationToString}</td>","<td>{depDate}</td>","<td>{time}</td>","<td>{duration}</td>","</tr>","</table>",'<table class="x-tds-dataview" style="width: 100%;" border=1 cellpadding = 1 cellspacing=0  >','<tr style="background-color: #d0def0;" >','<th style="padding: 2px; width: 25%;">Rate</th>','<th style="padding: 2px; width: 15%;">Passenger Type</th>','<th style="padding: 2px; width: 5%;">No.</th>','<tpl if="isCruisePackage">','<th style="padding: 2px; width: 20%;">Price Per Person</th>',"</tpl>",'<th style="padding: 2px; width: 10%;">Status</th>',"</tr>","{rateBody}","</table>",'<tpl if="isCruisePackage">','<table class="x-tds-dataview" style="width: 100%;" border=1 cellpadding = 1 cellspacing=0  >','<tr style="background-color: #C0D9D9;">','<th style="padding: 2px; width: 14%;">Tour Price</th>','<th style="padding: 2px; width: 14%;">Extras</th>','<th style="padding: 2px; width: 20%;">Total Price (Gross)</th>','<th style="padding: 2px; width: 10%;">Markup Included</th>','<th style="padding: 2px; width: 7%;">Comm%</th>',"</tr>","<tr>","<td>{totprice}</td>","<td>{priceCurrency}&nbsp;{extraTotal} {extrsGrossFlag}</td>","<td>{priceCurrency}&nbsp;{total}</td>","<td><b>{priceCurrency}&nbsp;{markup}</td>","<td>{priceCommission}</td>","</tr>","</table>","</tpl>","</div>",'<div> <table style="width: 100%;"><tr><td>{createdString}</td></tr></table></div>')},{height:270,columnWidth:0.4,layout:"fit",border:false,items:[{columnWidth:1,xtype:"grid",enableRowExpander:false,sessionExpandedRows:false,height:130,autoScroll:true,border:false,enableColumnHide:false,enableColumnMove:false,enableColumnResize:false,enableHdMenu:false,tbar:["->",{xtype:"button",disabled:true,text:"Cancel passenger",handler:function(){pGridPass=this.ownerCt.ownerCt;var c=this.ownerCt.ownerCt.findParentByType("tabpanel");dataURIPass=c.getDetail("dataURI");Ext.Msg.show({title:"Confirmation",msg:"Are you sure, want to cancel passenger?",buttons:Ext.Msg.YESNO,fn:b,animEl:"elId",icon:Ext.MessageBox.QUESTION});function b(k){if(k=="yes"){var f=pGridPass;var h=f.getSelections();var e=dataURIPass;var d={};var g=new Array();for(var j=0;j<h.length;j++){g[j]=h[j].data.dataURI}d.passengerURIs=g;Ext.Ajax.request({url:TDS.env.dataPath+e+"/cancel",method:"PUT",jsonData:d,callback:function(p,i,m){if(i){try{Ext.Msg.alert("Status","Changes saved successfully.");var l=f.ownerCt.findParentByType("awesomegrid");l.submitQuery(true)}catch(n){}}}})}}}}],store:new Ext.data.JsonStore({url:"",id:"dataURI",fields:["dataURI","displayName","roomType","code","dateOfBirth","addressString","phoneNumber1","emailAddress","gender","priceSell","status","paxAge"]}),sm:new Ext.grid.CheckboxSelectionModel(),columns:[new Ext.grid.CheckboxSelectionModel(true),{header:"Passenger",dataIndex:"displayName",width:200,sortable:true,renderer:function(f,e,b,g,d,c){e.attr='ext:qtip= "Click to view details"';return f}},{header:"Type",dataIndex:"code",width:80},{header:"Gender",dataIndex:"gender",renderer:TDS.util.Format.gender,width:100},{header:"DOB",dataIndex:"dateOfBirth",width:70,fixed:true,renderer:TDS.util.Format.dateSpecialRenderer(TDS.env.dateBirthdayFormatDisplay)},{header:"Age",dataIndex:"paxAge",width:40,fixed:true,renderer:function(e,c,b){if(e){return e}else{var d=TDS.util.Format.age(b.get("dateOfBirth"));return((d&&d>0)?d:"")}}},{header:"Price",dataIndex:"priceSell",width:100,renderer:TDS.util.Price.conversionPriceRenderer},{header:"Status",dataIndex:"status",width:100}],viewConfig:{forceFit:true},listeners:{rowdblclick:function(d,g,f){var c=d.getStore().getAt(g);var b=c.get("dataURI");TDS.window.setWindow({title:"Passenger details",destinationDataURI:b,interfaceURI:"pnr/passenger/viewDetails.js",sourceDataURI:b})},render:function(){var d=this.topToolbar;this.getSelectionModel().on("rowselect",function(){if(this.ownerCt.getSelections().length>0){d.items.itemAt(1).setDisabled(false)}},d);this.getSelectionModel().on("rowdeselect",function(){if(this.ownerCt.getSelections().length==0){d.items.itemAt(1).setDisabled(true)}},d);this.getEl().swallowEvent(["columnmove","columnresize","headerclick","click","mouseout","rowclick","rowmousedown","rowblclick","cellblclick","sortchange","mouseup","mousedown"]);var c=this.ownerCt.findParentByType("tabpanel");var b=c.getDetail("dataURI");Ext.Ajax.request({url:TDS.env.dataPath+b+"/passengers/collection/concise",method:"GET",callback:function(h,n,f){if(n){var l=Ext.util.JSON.decode(f.responseText);var k=l[b+"/passengers"];if(typeof k=="undefined"){return}var m=[];for(var j=0;j<k.length;j++){l[k[j]].dataURI=k[j];m.push(l[k[j]])}var g=this;var e=g.store;e.loadData(m);g.getView().refresh()}},scope:this})}}}]}],listeners:{render:function(){this.initInventory();this.initOffering()}},initInventory:function(){var i=this.ownerCt.findParentByType("tabpanel");var e=i.getDetail("dataURI");var d=i.getDetail("depositDescription");var c=i.getDetail("paybyDate");var b=TDS.util.Format.dateSpecial(c,TDS.env.dateFormatDisplay);var h=e;var g=new Array();var f=0;g=e.split("/");Ext.Ajax.request({url:TDS.env.dataPath+e+"/inventories/collection",method:"GET",callback:function(S,O,Q){var ad=this.ownerCt.findParentByType("tabpanel");if(O){try{var K=Ext.decode(Q.responseText)}catch(ab){}if(K){var B=0,L,U=[];var J=0;var Z=K["component/inventory/collection"];var n=Z[e+"/inventories"];var R=K["component/rate/collection/"];var l=R["component/rate/collection/list"];var y=R.TOUR_TYPR_STRING;ad.setDetail("rateList",l);var P=new Array();P=e.split("/");var D="";this.rateData=[];var af=n.length/l.length;var V=[];var F="";var aa=[];var A=0;if(n.length>0){for(var Y=0;Y<n.length;Y++){var ac=Z[n[Y]];U[U.length]=TDS.util.Format.dateSpecial(ac.componentPaybyDate,TDS.env.dateFormatDisplay);F=ac.pricingPriceCurrency;if(aa.indexOf(ac.rateId)==-1){aa[Y]=ac.rateId;V[A]=TDS.util.Price.calculateFixedGrossNettPrice({pricingPriceCurrency:ac.pricingPriceCurrency,pricingPriceSell:ac.pricingPriceSell,pricingPriceCommission:ac.pricingPriceCommission,pricingPriceIsNett:ac.pricingPriceIsNett});V[A].rateId=ac.rateId;V[A].quantity=ac.quantity;A++}}var N="";var q="";var I=0;var X=0;if(l.length>0){for(var Y=0;Y<l.length;Y++){var G=R[l[Y]];D=R[l[Y]].tempBookedDate;var M=[];var ae=G.groupName;var p="";var x="";var m="";var z=null;for(var W=0;W<V.length;W++){if(V[W].rateId==l[Y].substring(l[Y].lastIndexOf("/")+1,l[Y].length)){z=V[W]}}var t=this.ownerCt.ownerCt.findParentByType("ajaxpanel");var C=TDS.util.Format.dateSpecial(t.rowRecordData.dateFrom,TDS.env.dateFormatDisplay);var v=t.rowRecordData.description;var H=t.rowRecordData.status;var w=t.rowRecordData.bookingReferenceNumber;if(typeof w!="undefined"&&w!=""){P[1]=w}if(!z.priceIsNett){p=z.priceCommissionPercentage;if(typeof p=="undefined"){p="0%"}}else{x=z.priceCommission;J+=z.priceCommission}if(z.quantity>0){X=G.extraTotal}var E=x/z.quantity;I+=z.priceSell;var k=this.findParentByType("tabpanel").findParentByType("awesomegrid").lastExpandedRowIdx;if(!(this.findParentByType("tabpanel").findParentByType("awesomegrid").getStore().getAt(k).data.cruisePackage!=0)){N+="<tr>";N+="<td>"+G.nameString+"</td>",N+="<td>"+a[0]+"</td>",N+="<td>"+z.quantity+"</td>",N+="<td>"+TDS.util.Price.formatPrice((z.priceSell/z.quantity+E),z.priceCurrency)+"</td>",N+="<td>"+H+"</td>",N+="</tr>"}else{N+="<tr>";N+="<td>"+G.nameString+"</td>",N+="<td>"+a[0]+"</td>",N+="<td>"+z.quantity+"</td>",N+="<td>"+H+"</td>",N+="</tr>"}var p=p;m=(z.priceIsNett?"Nett":"Gross");if(!m){J=""}}}I+=J;var T=I;I+=X;if(U.length>0){var u=U[0]}else{var u=U}ad.setDetail("pricingPriceCurrency",F);this.inventoryData={fn:this.updatePayByDate,dataURI:e,divDataUri:h,rateBody:N,numberOfNights:af,dates:u,depositDescription:d,paybyDate:b,markup:J.toFixed(2),pnrCode:P[1],bookeddateDis:D,total:I.toFixed(2),depDate:C,status:H,description:v,netorgross:m,priceCommission:p,totprice:TDS.util.Price.formatPrice(T,F),extraTotal:X.toFixed(2),tourType:y,priceCurrency:F,isCruisePackage:!(this.findParentByType("tabpanel").findParentByType("awesomegrid").getStore().getAt(k).data.cruisePackage)};this.hasDetailsInventory=true;if(this.isDetailsReady()){this.displayDetails()}}}}},scope:this})},initOffering:function(){var d=this.ownerCt.findParentByType("tabpanel");var c=d.getDetail("offeringURI");var b;Ext.Ajax.request({url:TDS.env.dataPath+c,method:"GET",callback:function(j,f,h){if(f){try{var g=Ext.decode(h.responseText)}catch(i){}if(g){this.offeringData={locationToString:g.locationToString,locationsString:g.locationsString,duration:g.duration,name:g.name,website:g.primaryHref,addressString:g.addressString,tourClass:TDS.util.Format.displayResourceName(g.tourClassURI)};this.hasDetailsOffering=true;if(this.isDetailsReady()){this.displayDetails()}}}},scope:this})},displayDetails:function(){var f=this.ownerCt.findParentByType("tabpanel");var e=this.ownerCt.ownerCt.findParentByType("ajaxpanel");if(f.getDetail("voucher")&&e.rowRecordData.status=="Confirmed"){this.getDetailsPanel().topToolbar.items.itemAt(5).enable(true)}else{this.getDetailsPanel().topToolbar.items.itemAt(5).disable(true)}var j=Date.parseDate(f.getDetail("createdDate"),TDS.env.dateFormat);var l=Date.parseDate(f.getDetail("updatedDate"),TDS.env.dateFormat);var b=this.findParentByType("awesomegrid").findParentByType("pnrpanel").ownerCt.ownerCt.dataObj.pnrFrom;var k=!Ext.isEmpty(b)?"Created by Mobile on ":"Created on ";var c=k+j.format(TDS.env.dateTimeFormatDisplay)+" by "+f.getDetail("createdByUserFullNameString")+", modified on "+l.format(TDS.env.dateTimeFormatDisplay)+(f.getDetail("createdByUserFullNameString")==f.getDetail("updatedByUserFullNameString")?"":" by "+f.getDetail("updatedByUserFullNameString"))+".";var g=TDS.util.Price.calculateFixedGrossNettPrice({pricingPriceCurrency:f.getDetail("pricingPriceCurrency"),pricingPriceSell:f.getDetail("pricingPriceSell"),pricingPriceCommission:f.getDetail("pricingPriceCommission"),pricingPriceIsNett:f.getDetail("pricingPriceIsNett")});var h=(g.priceSell+g.priceCommission);var i=this.inventoryData.Ggrosstemp;if(g.priceSell==""||g.priceSell==null||g.priceSell=="undefined"){g.priceSell=0}var d=g.priceSell*parseInt(this.inventoryData.quantity);this.getDetailsPanel().tpl.overwrite(this.getDetailsPanel().body,Ext.apply({price:g.priceSell.toFixed(2),createdString:c,pricenet:g.priceIsNett,flag:g.flag,priceCommissionPercentage:g.priceCommissionPercentage,extragross:g.extragross,quaPrice:d.toFixed(2)},this.inventoryData,this.offeringData))}}