{xtype:"panel",autoScroll:true,border:true,updateLedgerscreen:function(o,p,l,q,r,k){var n=this.findParentByType("ajaxpanel");var j=n.baseDataURI;var m={grossTotal:r,recievedTotal:q,owingAmount:o,paidTotal:l,marginTotal:p,percentageCommision:k};Ext.Ajax.request({url:TDS.env.dataPath+j+"/updateLedger",method:"POST",jsonData:m,scope:this})},items:[{xtype:"panel",border:true,layout:"fit",items:[{xtype:"panel",height:300,autoScroll:true,border:true,layout:"fit",items:[{border:true,xtype:"awesomegrid",cls:"custom-dirty",searchURI:"",pinnable:false,enableRowExpander:false,iconCls:"icon-grid",firstLoad:0,height:200,tbar:['<font color="#3333ff"><b>Trip Cost</font>',"&nbsp;","->",{xtype:"redbutton",text:"To Pay",disabled:true,handler:function(){var z=this.ownerCt.ownerCt;var u=this.ownerCt.findParentByType("ajaxpanel");var q=z.selModel.getSelected();var v=q.get("dataURI");var j=z.getStore();var w=q.store.data.length;q.data.componentArray=[];q.data.payAmount=parseFloat(document.getElementById("pay"+v).value);q.data.amount=parseFloat(document.getElementById("pay"+v).value);q.data.type="";q.data.amount=0;var t=0;var p=true;var r="";for(var s=0;s<w;s++){var y=j.getAt(s);var i=y.get("dataURI");if(document.getElementById("ch"+i).checked){if(r==""){r=y.get("supplierName")}else{if(r!=y.get("supplierName")){p=false;break}}r=y.get("supplierName");q.data.grossAmount=q.data.grossAmount+y.data.grossAmount;q.data.nettAmount=q.data.nettAmount+y.data.nettAmount;q.data.componentArray[t]={rowNo:(s+1),supplierURI:y.get("supplierURI"),dataURI:i,amountPayed:parseFloat(document.getElementById("pay"+i).value)};q.data.amount=q.data.amount+parseFloat(document.getElementById("pay"+i).value);t++}}if(!p){Ext.Msg.alert("Alert","Select single supplier to Proceed payment.");return}q.data.amount=q.data.amount.toFixed(2);q.data.payAmountTemp=q.data.payAmount.toFixed(2);var x=this.ownerCt.findParentByType("pnrpanel");TDS.window.setWindow({title:"Create transaction",information:"Please enter details of the transaction.",buttonOK:"Pay",data:q.data,postDataURI:u.baseDataURI+"/transactions",interfaceURI:"pnr/ledger/singlePayment.js",dataURI:{agency:x.getPNRAgencyURI()},callback:{fn:function(a){if(a){z.submitQuery(true);this.ownerCt.ownerCt.ownerCt.items.itemAt(1).items.itemAt(0).items.itemAt(0).submitQuery(true)}},scope:this.ownerCt.ownerCt}})}}],cm:new Ext.grid.ColumnModel([{header:"",fixed:true,width:25,editable:false,renderer:function(k,n,h,l,j,m){var i=h.get("dataURI");return' <input type="checkbox" value="true" id="ch'+i+'"/> '}},{header:"",fixed:true,width:20,editable:false,renderer:function(j,g,h,k,i,l){return k+1}},{header:"Supplier",width:110,flex:2,fixed:true,dataIndex:"supplierName",sortable:true,renderer:function(j,k,h,i,l,g){k.attr='ext:qtip="'+h.get("supplierContactDet")+'"';return j}},{header:"Component",width:150,flex:1,fixed:true,sortable:true,dataIndex:"type",renderer:function(f,d,e){if(f===TDS.data.componentType.TYPE_OWN){return"OA"}else{if(f===TDS.data.componentType.TYPE_MANUAL){return"Manual entry"}else{if(f===TDS.data.componentType.TYPE_SIGHTSEEING){return"Day Tours"}else{if(f===TDS.data.componentType.TYPE_ATTRACTION&&e.get("status")){return"Services"}}}}return f.substring(0,1).toUpperCase()+f.substring(1).toLowerCase()}},{header:"Description",width:210,fixed:true,sortable:true,dataIndex:"name"},{header:"Nights",width:60,fixed:true,sortable:true,dataIndex:"nights"},{header:"Status",width:90,fixed:true,sortable:true,dataIndex:"status"},{header:"Gross",width:110,fixed:true,sortable:true,dataIndex:"grossAmount",summaryType:"sum",renderer:TDS.util.Price.amountRenderer},{header:"%",width:55,fixed:true,sortable:true,dataIndex:"commissionPercentage",renderer:function(d,f,e){if(d){return parseFloat(d).toFixed(2)}else{return d}}},{header:"Comm/Markup",width:110,fixed:true,sortable:true,dataIndex:"commissionAmount",summaryType:"sum",renderer:TDS.util.Price.amountRenderer},{header:"Net",width:100,fixed:true,sortable:true,dataIndex:"nettAmount",summaryType:"sum",renderer:TDS.util.Price.amountRenderer},{header:"To Pay",dataIndex:"",width:100,fixed:true,renderer:function(m,t,o,s,q,l){var r=o.get("dataURI");var p=o.get("nettAmount");var n=o.get("currency");var k=o.get("transactionBalance");if(k<=0){p=0;return TDS.util.Price.formatCurrency(n)+'<input type="text"  size="7" id="pay'+r+'"  value='+parseFloat(p).toFixed(2)+" readOnly><table><tr><td></td></tr></table>"}else{if(k>0){p=k;return TDS.util.Price.formatCurrency(n)+'<input type="text"  size="7" id="pay'+r+'"  value='+parseFloat(p).toFixed(2)+"><table><tr><td></td></tr></table>"}}}},{header:"Balance",width:120,fixed:true,sortable:true,dataIndex:"transactionBalance",summaryType:"sum",renderer:TDS.util.Price.amountRenderer},{header:"Credit Card",width:80,fixed:true,sortable:true,dataIndex:"creditCardPaymentAllowed",renderer:function(d,f,e){if(d){return"Accepted"}else{return""}}},{header:"priceIsNetFlag1",fixed:true,hidden:true,sortable:true,dataIndex:"priceIsNetFlag"},{header:"priceIsCancelFlag",fixed:true,hidden:true,sortable:true,dataIndex:"priceIsCancelFlag"}]),store:new Ext.data.JsonStore({id:"dataURI",fields:["dataURI","supplierURI","nights","creditCardPaymentAllowed","amount","name","type","offeringURI","currency","grossAmount","nettAmount","commissionAmount","commissionPercentage","passengersTotal","gst","status","description","supplierName","priceIsNetFlag","supplierContactDet","paymentGatewayAllowed","transactionBalance"]}),summaryCurrency:undefined,processCollectionData:function(m){var b=this.ownerCt.findParentByType("pnrpanel");this.pnrCurrency=b.getPNRCurrency();var p=0;var f=0;var k=m[this.getCollectionIdentifier()];;if(typeof k!="undefined"){for(var g=0;g<k.length;g++){var j=m[k[g]].currency;var h=m[k[g]].grossAmount;var d=m[k[g]].commissionAmount;console.log(d);if(d==""||isNaN(d)){d=0}if(typeof this.summaryCurrency=="undefined"){this.summaryCurrency=j}if(this.summaryCurrency!=j){this.summaryCurrency=false}p+=h;f+=d}}var l=this.ownerCt.ownerCt.ownerCt.items.itemAt(1).items.itemAt(1).items.itemAt(0).items;l.itemAt(12).setValue(p);l.itemAt(1).setValue(TDS.util.Price.formatCurrency(this.pnrCurrency)+" "+p.toFixed(2));var a=l.itemAt(12).getValue();var c=l.itemAt(13).getValue();var o=l.itemAt(14).getValue();var e=a-c;if(e=="NaN"||e==NaN||isNaN(e)){e=0}l.itemAt(5).setValue(TDS.util.Price.formatCurrency(this.pnrCurrency)+" "+(e.toFixed(2)));var f=c-o;l.itemAt(9).setValue(TDS.util.Price.formatCurrency(this.pnrCurrency)+" "+(f).toFixed(2));l.itemAt(15).setValue(f);var n=(f/a)*100;if(n!=0&&n!="NaN"&&!isNaN(n)){l.itemAt(11).setValue(n.toFixed(2)+" %")}else{l.itemAt(11).setValue(0+" %")}this.ownerCt.ownerCt.ownerCt.updateLedgerscreen(e,f,o,c,a,n);return m},sm:new Ext.grid.CheckboxSelectionModel(),plugins:new Ext.ux.grid.GridSummary({processSummaryData:function(b){if(this.grid.summaryCurrency){b.data.currency=this.grid.summaryCurrency;return b}return{data:{}}}}),viewConfig:{getRowClass:function(d,c){if(d.get("priceIsNetFlag")&&d.get("status")=="Confirmed"){return"price-is-green-net"}else{if(d.get("priceIsNetFlag")==false&&d.get("status")=="Confirmed"){return"price-is-blue-net"}}}},getRowInterface:function(){return"pnr/components/financial/layout.js"},listeners:{rowclick:function(){var r=this;var n=this.topToolbar.items.itemAt(3);var p=r.store.data.length;var l=r.getStore();var o=false;for(var m=0;m<p;m++){var q=r.store.data.items[m];var k=q.data.dataURI;var i=document.getElementById("ch"+k).checked;if(i){o=true}}if(o){n.enable(true)}else{n.disable(true)}},cellclick:function(P,F,i,j){var E=this.ownerCt.ownerCt.ownerCt.items.itemAt(1).items.itemAt(0).items.itemAt(0);var L=P.getStore().getAt(F);var I=L.get("dataURI");var G=L.get("supplierName");var e=document.getElementById("ch"+I).value;var J=E.getStore();if(false){var D=this.ownerCt.findParentByType("ajaxpanel");var a=L.get("creditCardPaymentAllowed");if(a){var J=this.getStore();var N=L.store.data.length;L.data.componentArray=[];L.data.componentArray[0]={dataURI:I,amountPayed:parseFloat(document.getElementById("pay"+I).value)};L.data.payAmount=parseFloat(document.getElementById("pay"+I).value);var A=1;for(var z=0;z<N;z++){var K=J.getAt(z);var M=K.get("dataURI");if(document.getElementById("ch"+M).checked&&M!=I){L.data.grossAmount=L.data.grossAmount+K.data.grossAmount;L.data.nettAmount=L.data.nettAmount+K.data.nettAmount;L.data.componentArray[A]={dataURI:M,amountPayed:parseFloat(document.getElementById("pay"+M).value)};L.data.payAmount=L.data.payAmount+parseFloat(document.getElementById("pay"+M).value);A++}}L.data.payAmountTemp=L.data.payAmount.toFixed(2);var B=this.ownerCt.findParentByType("pnrpanel");TDS.window.setWindow({title:"Payment Gateway",buttonOK:"Pay",data:L.data,sourceDataURI:L.data.supplierURI,postDataURI:D.baseDataURI+"/transactions",interfaceURI:"pnr/ledger/creditCardPayment.js",dataURI:{agency:B.getPNRAgencyURI()},callback:{fn:function(b){if(b){P.submitQuery(true);E.submitQuery(true)}},scope:this.ownerCt.ownerCt}})}}else{if(false&&i==11&&document.getElementById("ch"+I).checked){var D=this.ownerCt.findParentByType("ajaxpanel");var J=this.getStore();var N=L.store.data.length;L.data.componentArray=[];L.data.payAmount=parseFloat(document.getElementById("pay"+I).value);L.data.amount=parseFloat(document.getElementById("pay"+I).value);L.data.type="";L.data.amount=0;var A=0;var C=true;var O="";for(var z=0;z<N;z++){var K=J.getAt(z);var M=K.get("dataURI");if(document.getElementById("ch"+M).checked){if(O==""){O=K.get("supplierName")}else{if(O!=K.get("supplierName")){C=false;break}}O=K.get("supplierName");L.data.grossAmount=L.data.grossAmount+K.data.grossAmount;L.data.nettAmount=L.data.nettAmount+K.data.nettAmount;L.data.componentArray[A]={rowNo:(z+1),supplierURI:K.get("supplierURI"),dataURI:M,amountPayed:parseFloat(document.getElementById("pay"+M).value)};L.data.amount=L.data.amount+parseFloat(document.getElementById("pay"+M).value);A++}}if(!C){Ext.Msg.alert("Alert","Select single supplier to Proceed payment.");return}L.data.amount=L.data.amount.toFixed(2);L.data.payAmountTemp=L.data.payAmount.toFixed(2);var B=this.ownerCt.findParentByType("pnrpanel");TDS.window.setWindow({title:"Create transaction",information:"Please enter details of the transaction.",buttonOK:"Pay",data:L.data,postDataURI:D.baseDataURI+"/transactions",interfaceURI:"pnr/ledger/singlePayment.js",dataURI:{agency:B.getPNRAgencyURI()},callback:{fn:function(b){if(b){P.submitQuery(true);E.submitQuery(true)}},scope:this.ownerCt.ownerCt}})}else{if(i==0){var J=this.getStore();var N=L.store.data.length;var H=0;for(var z=0;z<N;z++){var K=J.getAt(z);var M=K.get("dataURI");if(document.getElementById("ch"+M).checked){H++;break}}if(H>0){for(var z=0;z<N;z++){var K=J.getAt(z);var M=K.get("dataURI");if(G!=K.get("supplierName")&&(document.getElementById("ch"+I).checked||!document.getElementById("ch"+M).checked)){document.getElementById("ch"+M).checked=false;document.getElementById("ch"+M).disabled=true}else{document.getElementById("ch"+M).disabled=false}}}else{for(var z=0;z<N;z++){var K=J.getAt(z);var M=K.get("dataURI");document.getElementById("ch"+M).checked=false;document.getElementById("ch"+M).disabled=false}}}}}},sessioninit:function(){var b=this.ownerCt.findParentByType("ajaxpanel");if(!b){return}this.searchURI=TDS.env.dataPath+b.baseDataURI+"/financials";this.overrideCollectionIdentifier=b.baseDataURI+"/financials"}}}]}]},{xtype:"panel",height:300,border:true,layout:"table",layoutConfig:{columns:2},items:[{xtype:"panel",height:300,width:1050,border:false,layout:"auto",autoScroll:true,items:[{border:true,cellpadding:false,cellspacing:false,xtype:"awesomegrid",searchURI:"",width:1020,pinnable:false,iconCls:"icon-grid",style:"margin:0 auto;margin-top;",autoScroll:true,enableRowExpander:true,alwaysUseCollection:true,tbar:['<font color="#3333ff"><b>Receipts & Non Credit Card Payments</font>',"->",{xtype:"button",text:"External Payments",information:"Please enter details of the Payment.",handler:function(){var b=this.ownerCt.findParentByType("ajaxpanel");if(!b){return}TDS.window.setWindow({title:"Payments Details",interfaceURI:"pnr/components/payment.js",postDataURI:b.baseDataURI+"/ownPayments",dataURI:b.baseDataURI,buttonOK:"Submit",autoScroll:true})}},{xtype:"redbutton",text:"Create",handler:function(){var c=this.ownerCt.findParentByType("ajaxpanel");var e=this.ownerCt.findParentByType("pnrpanel");if(!c&&!e){return}var d=this.ownerCt.ownerCt.findParentByType("pnrpanel");TDS.window.setWindow({title:"Create transaction",information:"Please enter details of the transaction.",interfaceURI:"pnr/ledger/create.js",postDataURI:c.baseDataURI+"/transactions",dataURI:{agency:e.getPNRAgencyURI()},callback:{fn:function(a){if(a){this.submitQuery(true)}},scope:this.ownerCt.ownerCt}})}},{xtype:"button",text:"Export",handler:function(){}}],processCollectionData:function(h){var j=this.ownerCt.ownerCt.items.itemAt(1).items.itemAt(0).items;var l=this;var k=0;var r=0;var m=0;var g=h[l.getCollectionIdentifier()];for(var f=(g.length-1);f>=0;f--){var e=h[g[f]];e.currency=this.pnrCurrency;if(e.amount=="NaN"||typeof e.amount=="undefined"){e.amount=0}if(e.credit){e.amountCredit=e.amount;k+=e.amount;m+=e.amount}else{e.amountDebit=e.amount;k-=e.amount;r+=e.amount}e.amountBalance=k}j.itemAt(13).setValue(m);j.itemAt(14).setValue(r);j.itemAt(3).setValue(TDS.util.Price.formatCurrency(this.pnrCurrency)+" "+m.toFixed(2));var b=j.itemAt(12).getValue();var c=j.itemAt(13).getValue();var p=j.itemAt(14).getValue();var q=c-p;console.log(c);var d=b-c;if(d=="NaN"||d==NaN||isNaN(d)){d=0}j.itemAt(5).setValue(TDS.util.Price.formatCurrency(this.pnrCurrency)+" "+d.toFixed(2));j.itemAt(7).setValue(TDS.util.Price.formatCurrency(this.pnrCurrency)+" "+p.toFixed(2));var o=q.toFixed(2);j.itemAt(9).setValue(TDS.util.Price.formatCurrency(this.pnrCurrency)+" "+q.toFixed(2));j.itemAt(15).setValue(q);var n=(q/c)*100;if(n==0||n=="NaN"||isNaN(n)){j.itemAt(11).setValue("0.00 %")}else{j.itemAt(11).setValue(n.toFixed(2)+" %")}l.ownerCt.ownerCt.ownerCt.updateLedgerscreen(d,o,p,c,b,n);return h},store:new Ext.data.JsonStore({id:"dataURI",fields:["dataURI","dateCreated","componentPaymentDetails","paymentType","agencyTransactionTypeName","passengerNameRecordComponentURI","description","notes","amount","credit","amountCredit","supplierURI","supplierNameString","amountDebit","amountBalance","currency","type","passengerNameRecordTransactionMethodName"],sortInfo:{field:"dateCreated",direction:"DESC"}}),sm:new Ext.grid.RowSelectionModel(),cm:new Ext.grid.ColumnModel([{header:"Date/Time",dataIndex:"dateCreated",width:150,fixed:true,renderer:TDS.util.Format.dateSpecialRenderer(TDS.env.dateTimeFormatDisplay)},{header:"Supplier",dataIndex:"supplierNameString",width:140,fixed:true},{header:"Type",width:120,dataIndex:"agencyTransactionTypeName",fixed:true,renderer:function(f,d,e){if(typeof e.get("paymentType")!="undefined"&&e.get("paymentType")!=null&&e.get("paymentType")!=""){return e.get("paymentType")}else{return f}}},{header:"Details",width:250,dataIndex:"description",renderer:function(f,d,e){return e.get("passengerNameRecordComponentURI")?"<b>"+f+"</b>":f}},{header:"Method",dataIndex:"passengerNameRecordTransactionMethodName",width:120,fixed:true},{hidden:true,summaryType:"sum"},{hidden:true,summaryType:"sum"},{header:"Received",dataIndex:"amountCredit",width:100,fixed:true,summaryType:"sum",renderer:TDS.util.Price.amountRenderer},{header:"Paid",dataIndex:"amountDebit",width:100,fixed:true,summaryType:"sum",renderer:TDS.util.Price.amountRenderer},{header:"",editable:false,dataIndex:"",fixed:true,width:15,renderer:function(f,d,e){if(typeof e.get("notes")!="undefined"&&e.get("notes")!=""){return'<input type="password" name="" style="border:#FFFFFF; display:compact; font:Verdana; font-weight: bold; background: none; div {text-align: lert; }; color:#ff0000" disabled value = "a">'}}}]),plugins:new Ext.ux.grid.GridSummary({processSummaryData:function(b){if(this.grid.pnrCurrency){b.data.currency=this.grid.pnrCurrency;return b}return{data:{}}}}),viewConfig:{html:"&nbsp;",height:200},updateAmountCache:function(f,j,h){console.log(h);var i=Ext.DomQuery.selectNode("div.x-grid3-col-5",this.view.summary.dom);Ext.fly(i).update(TDS.util.Price.formatPrice(this.totalPaid,h.fixedCurrency));var g=Ext.DomQuery.selectNode("div.x-grid3-col-4",this.view.summary.dom);Ext.fly(g).update(TDS.util.Price.formatPrice(this.totalRec,h.fixedCurrency))},listeners:{sessioninit:function(){var f=this.ownerCt.ownerCt.ownerCt.findParentByType("ajaxpanel");var d=this.ownerCt.ownerCt.ownerCt.findParentByType("pnrpanel");if(!f||!d){return}this.searchURI=TDS.env.dataPath+f.baseDataURI+"/transactions";this.overrideCollectionIdentifier=f.baseDataURI+"/transactions";this.pnrCurrency=d.getPNRCurrency();var e=d.findParentByType("ajaxpanel");console.log(d);console.log(d.getPNRAgencyURI());e.on("reloaddata",this.updateAmountCache,this)}},getRowInterface:function(b){return"pnr/ledger/layout.js"}}]},{xtype:"panel",style:"padding-left:20px;",border:false,height:280,items:[{xtype:"panel",border:false,layout:"table",layoutConfig:{columns:2},defaults:{width:100},items:[{border:false,cellpadding:false,cellspacing:false,width:130,height:30,html:"<b>Total Gross Amount : </b>"},{border:false,cellpadding:false,cellspacing:false,width:130,style:" margin-bottom: 15px; font-weight: bold; ",height:20,readOnly:true,xtype:"textfield",value:0,name:"totalGrossAmount"},{border:false,cellpadding:false,cellspacing:false,width:130,height:30,html:"<b>Total Recived : </b>"},{border:false,cellpadding:false,cellspacing:false,width:130,style:" margin-bottom: 15px; font-weight: bold; ",height:20,readOnly:true,xtype:"textfield",value:0,name:"totalRecived"},{border:false,cellpadding:false,cellspacing:false,width:130,height:30,html:"<b>Amount Owing : </b>"},{border:false,cellpadding:false,cellspacing:false,width:130,style:" margin-bottom: 15px; font-weight: bold; ",height:20,readOnly:true,xtype:"textfield",value:0,name:"amount"},{border:false,cellpadding:false,cellspacing:false,width:130,height:30,html:"<b>Total Paid : </b>"},{border:false,cellpadding:false,cellspacing:false,width:130,style:" margin-bottom: 15px; font-weight: bold; ",height:20,readOnly:true,xtype:"textfield",value:0,name:"totalPaid"},{border:false,cellpadding:false,cellspacing:false,width:130,height:30,html:"<b>Margin : </b>"},{border:false,cellpadding:false,cellspacing:false,width:130,style:" margin-bottom: 15px;   font-weight: bold; ",height:20,readOnly:true,xtype:"textfield",value:0,name:"margin"},{border:false,cellpadding:false,cellspacing:false,width:130,height:30,html:"<b>Percentage : </b>"},{border:false,cellpadding:false,cellspacing:false,width:130,readOnly:true,height:20,style:" margin-bottom: 15px;  font-weight: bold;  ",xtype:"textfield",value:0,name:"percentage"},{xtype:"numberfield",hidden:true,width:130,value:0,name:"grossHiddenTotalId"},{xtype:"numberfield",hidden:true,width:130,value:0,name:"receiveHiddenTotalIdNew"},{xtype:"numberfield",hidden:true,width:130,value:0,name:"paidHiddenTotalIdNew"},{xtype:"numberfield",hidden:true,width:130,value:0,name:"marginHiddenTotalIdNew"}]}]}]}]}