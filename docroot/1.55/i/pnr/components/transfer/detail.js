{requireStores:[{dataURI:TDS.env.dataPath+"accommodation/ratings/collection",identifier:"accommodation/ratings",fields:["name","dataURI"]},{dataURI:TDS.env.dataPath+"accommodation/propertyclasstypes/collection",identifier:"accommodation/propertyclasstypes",fields:["name","displayName","dataURI"]},{dataURI:TDS.env.dataPath+"accommodation/groups/collection",identifier:"accommodation/groups",fields:["name","dataURI"]},{dataURI:TDS.env.dataPath+"accommodation/inventorytypes/collection",identifier:"accommodation/inventorytypes",fields:["name","displayName","dataURI"]},{dataURI:TDS.env.dataPath+"accommodation/roomviews/collection",identifier:"accommodation/roomviews",fields:["name","displayName","dataURI"]},{dataURI:TDS.env.dataPath+"accommodation/extracategories/collection",identifier:"accommodation/extracategories",fields:["name","dataURI"]},{dataURI:TDS.env.dataPath+"accommodation/rateType/collection",identifier:"accommodation/rateType",fields:["name","displayName","dataURI"]}],xtype:"panel",height:320,border:true,layout:"column",getDetailsTopPanel:function(){return this.items.itemAt(0).items.itemAt(0)},getDetailsRatePanel:function(){return this.items.itemAt(0).items.itemAt(1)},getDetailsPanel:function(){return this.items.itemAt(0)},getPassengersPanel:function(){return this.items.itemAt(1)},hasDetailsInventory:false,hasDetailsOffering:false,isDetailsReady:function(){if(this.hasDetailsInventory&&this.hasDetailsOffering){return true}return false},items:[{tbar:[{xtype:"button",text:"Edit Pay By",handler:function(){var e=this.ownerCt.findParentByType("tabpanel");var d=e.ownerCt;var c=e.getDetail("dataURI");var a=e.getDetail("paybyDate");var b=e.getDetail("depositDescription");TDS.window.setWindow({title:"Description",information:"Please enter description.",interfaceURI:"pnr/components/accommodation/editPayby.js",destinationDataURI:c+"/updatePayBYDates",data:{paybyDate:a,depositDescription:b},callback:{fn:function(f){d.refreshGrid()}}})}},{xtype:"datefield",hidden:true},{xtype:"button",text:"Save",disabled:true,hidden:true},"->",{xtype:"button",buttonAlign:"right",text:"Additional Info",handler:function(){var c=this.ownerCt.findParentByType("tabpanel");var b=c.ownerCt;var a=c.getDetail("dataURI");if(!a){return}TDS.window.setWindow({title:"Accommodation PNR",interfaceURI:"pnr/components/generic/additionalInfo.js",sourceDataURI:a+"/additionalInfo",destinationDataURI:a+"/additionalInfo"})}},{xtype:"button",buttonAlign:"left",text:"Download Voucher",handler:function(){var e=this.ownerCt.findParentByType("tabpanel");var d=e.ownerCt;var c="/GraphicsImg/voucher/";var a=e.getDetail("dataURI");if(!a){return}var b=TDS.env.currentDomain;Ext.Ajax.request({url:TDS.env.dataPath+a+"/voucher",jsonData:{currentDomain:b},method:"PUT",scope:this,callback:function(i,g,h){c=c+h.responseText+".rtf";var f=window.open(c,"Information Priview","height=500,width=800,left=10,top=10,resizable=yes,scrollbars=yes,toolbar=yes,menubar=no,location=no,directories=no,status=yes");f.focus()}})}}],columnWidth:0.6,xtype:"panel",height:275,border:false,tpl:new Ext.XTemplate('<div style="height:150px; overflow-y: scroll;">','<table border="0" width="100%">','<tr> <td width="6%"><span style="font-size:12px"><b>RLOC:</b></span></td><td width="15%"><font color="red"><span style="font-size:12px"> <b>{pnrCode}&nbsp;&nbsp;</span></font></td><td width="11%" ><span  style="font-size:12px"><font color="black"> <b>{externalPNRCodeName}</b></span></font></td><td ><font color="red"><span style="font-size:12px;align:right"> <b>{externalPNRCode}</b></span></td>','<td  width="8%"><span style="font-size:12px"><b>Pay By:</b></span></td><td  width="28%"><div id="ttlDate#{divDataUri}"><span style="font-size:12px">{paybyDate}&nbsp;{depositDescription}</span></div></td>',"<td></td>","</tr>","</table>",'<table class="x-tds-dataview" style="width: 100%;" border=1 cellpadding = 1 cellspacing=0  >','<tr style="background-color: #d0def0;" >','<th style="padding: 2px; width: 25%;">Property Name</th>','<th style="padding: 2px; width: 16%;">Rating</th>','<th style="padding: 2px; width: 18%;">In</th>','<th style="padding: 2px; width: 15%;">out</th>','<th style="padding: 2px; width: 18%;">Nights</th>',"</tr>","<tr>","<td>{name}</td>","<td>{accommodationRatingURI}</td>","<td>{indate}</td>","<td>{outdate}</td>","<td>{numberOfNights}</td>","</tr>","</table>",'<table class="x-tds-dataview" style="width: 100%;" border=1 cellpadding = 1 cellspacing=0  >','<tr style="background-color: #d0def0;" >','<th style="padding: 2px; width: 25%;">Room Type</th>','<th style="padding: 2px; width: 25%;">Rate</th>','<th style="padding: 2px; width: 5%;">Rooms</th>','<th style="padding: 2px; width: 15%;">Status</th>',"</tr>","{rateBody}","</table>","</tpl>","</div>",'<div><table style="width: 100%;"><tr><td>{createdString}</td></tr></table></div>')},{xtype:"panel",height:270,columnWidth:0.4,layout:"fit",border:false,items:[{columnWidth:1,xtype:"grid",enableRowExpander:false,sessionExpandedRows:false,height:130,autoScroll:true,border:false,enableColumnHide:false,enableColumnMove:false,enableColumnResize:false,enableHdMenu:false,tbar:["->",{xtype:"button",disabled:true,text:"Cancel Guests",handler:function(){pGridPass=this.ownerCt.ownerCt;var b=this.ownerCt.ownerCt.findParentByType("tabpanel");dataURIPass=b.getDetail("dataURI");Ext.Msg.show({title:"Confirmation",msg:"Are you sure, want to cancel Guests?",buttons:Ext.Msg.YESNO,fn:a,animEl:"elId",icon:Ext.MessageBox.QUESTION});function a(j){if(j=="yes"){var e=pGridPass;var g=e.getSelections();var d=dataURIPass;var c={};var f=new Array();for(var h=0;h<g.length;h++){f[h]=g[h].data.dataURI}c.passengerURIs=f;Ext.Ajax.request({url:TDS.env.dataPath+d+"/cancel",method:"PUT",jsonData:c,callback:function(n,i,l){if(i){try{Ext.Msg.alert("Status","Changes saved successfully.");var k=e.ownerCt.findParentByType("awesomegrid");k.submitQuery(true)}catch(m){}}}})}}}}],store:new Ext.data.JsonStore({url:"",id:"dataURI",fields:["dataURI","displayName","code","dateOfBirth","addressString","phoneNumber1","emailAddress","gender","status","paxAge","roomTypeName"]}),sm:new Ext.grid.CheckboxSelectionModel(),columns:[new Ext.grid.CheckboxSelectionModel(),{header:"Guests",dataIndex:"displayName",width:200,sortable:true,renderer:function(e,d,a,f,c,b){d.attr='ext:qtip= "Click to view details"';return e}},{header:"Type",dataIndex:"code",width:80},{header:"Gender",dataIndex:"gender",renderer:TDS.util.Format.gender,width:100},{header:"DOB",dataIndex:"dateOfBirth",width:70,fixed:true,renderer:TDS.util.Format.dateSpecialRenderer(TDS.env.dateBirthdayFormatDisplay)},{header:"Age",dataIndex:"paxAge",width:40,fixed:true,renderer:function(d,b,a){if(d){return d}else{var c=TDS.util.Format.age(a.get("dateOfBirth"));return((c&&c>0)?c:"")}}},{header:"Room Type",dataIndex:"roomTypeName",width:150,editor:new Ext.form.ComboBox({editable:false,forceSelection:true,mode:"local",triggerAction:"all",displayField:"name",valueField:"dataURI",emptyText:"Type",store:TDS.data.getStore({dataURI:TDS.env.dataPath+"accommodation/propertyclasstypes/collection",identifier:"accommodation/propertyclasstypes",fields:["name","displayName","dataURI"]})})},{header:"Seat/Cabin",hidden:true,dataIndex:"roomType",width:150},{header:"Price",dataIndex:"price",width:80},{header:"Status",dataIndex:"status",width:100}],viewConfig:{forceFit:true},listeners:{rowdblclick:function(c,f,d){var b=c.getStore().getAt(f);var a=b.get("dataURI");TDS.window.setWindow({buttonOK:false,title:"Guest details",destinationDataURI:a,interfaceURI:"pnr/passenger/viewDetails.js",sourceDataURI:a})},render:function(){var c=this.topToolbar;this.getSelectionModel().on("rowselect",function(){if(this.ownerCt.getSelections().length>0){c.items.itemAt(1).setDisabled(false)}},c);this.getSelectionModel().on("rowdeselect",function(){if(this.ownerCt.getSelections().length==0){c.items.itemAt(1).setDisabled(true)}},c);this.getEl().swallowEvent(["columnmove","columnresize","headerclick","click","mouseout","rowclick","rowmousedown","rowblclick","cellblclick","sortchange","mouseup","mousedown"]);var b=this.ownerCt.findParentByType("tabpanel");var a=b.getDetail("dataURI");Ext.Ajax.request({url:TDS.env.dataPath+a+"/passengers/collection/concise",method:"GET",callback:function(g,m,e){if(m){var k=Ext.util.JSON.decode(e.responseText);var j=k[a+"/passengers"];if(typeof j=="undefined"){return}var l=[];for(var h=0;h<j.length;h++){k[j[h]].dataURI=j[h];l.push(k[j[h]])}var f=this;var d=f.store;d.loadData(l);f.getView().refresh()}},scope:this})}}}]}],listeners:{render:function(){this.initInventory();this.initOffering()}},initInventory:function(){var f=this.ownerCt.findParentByType("tabpanel");var d=f.getDetail("dataURI");var c=f.getDetail("depositDescription");var b=f.getDetail("paybyDate");var a=TDS.util.Format.dateSpecial(b,TDS.env.dateFormatDisplay);var e=d;Ext.Ajax.request({url:TDS.env.dataPath+d+"/inventories/collection",method:"GET",callback:function(ac,X,Z){;if(X){try{var S=Ext.decode(Z.responseText)}catch(ap){}if(S){var ar=this.ownerCt.findParentByType("tabpanel");var G=0,T,af=[];var R=0;var W=0;var al=S["component/inventory/collection"];var n=al[d+"/inventories"];var ab=S["component/rate/collection/"];var h=ab["component/rate/collection/list"];ar.setDetail("rateList",h);var Y=new Array();Y=d.split("/");var J="";this.rateData=[];var E="";var u="";var au=n.length/h.length;var ag=[];var L="";var am=[];var F=0;if(n.length>0){for(var aj=0;aj<n.length;aj++){var aq=al[n[aj]];var an=aq.componentPaybyDate;af[af.length]=TDS.util.Format.dateSpecial(aq.componentPaybyDate,TDS.env.dateFormatDisplay);L=aq.pricingPriceCurrency;if(am.indexOf(aq.rateId)==-1){am[aj]=aq.rateId;ag[F]=TDS.util.Price.calculateFixedGrossNettPrice({pricingPriceCurrency:aq.pricingPriceCurrency,pricingPriceSell:aq.pricingPriceSell,pricingPriceCommission:aq.pricingPriceCommission,pricingPriceIsNett:aq.pricingPriceIsNett});ag[F].rateId=aq.rateId;ag[F].quantity=aq.quantity;F++}}var V="";var P=0;var ai=0;var q=0;var x=0;var B=0;var k=0;var l="";if(h.length>0){var O=0;var v=aq.quantity;for(var aj=0;aj<h.length;aj++){;var M=ab[h[aj]];var H=M.rateTypeURI;H=TDS.util.Format.displayResourceName(H);ai=M.extraTotal;J=ab[h[aj]].tempBookedDate;var C="";var D=null;var m="";for(var ah=0;ah<ag.length;ah++){if(ag[ah].rateId==h[aj].substring(h[aj].lastIndexOf("/")+1,h[aj].length)){D=ag[ah]}var t=this.ownerCt.ownerCt.findParentByType("ajaxpanel");var at=TDS.util.Format.dateSpecial(t.rowRecordData.dateFrom,TDS.env.dateFormatDisplay);var aa=TDS.util.Format.dateSpecial(t.rowRecordData.dateTo,TDS.env.dateFormatDisplay);var N=t.rowRecordData.status;var z=t.rowRecordData.description;var y=t.rowRecordData.supplierURI;if(y==TDS.util.Defaults.hotusaSupplier){D=ag[ah];Y[1]=t.rowRecordData.bookingReferenceNumber;E=t.rowRecordData.externalPNRCode;u="Confirm No:"}}if(!D.priceIsNett){m=D.priceCommissionPercentage}else{C=D.priceCommission;R+=(n.length*D.priceCommission)}var I=((n.length/am.length)*D.priceSell);P+=((n.length/am.length)*D.priceSell);var ao=D.priceSell;ao=ao+C;q+=ao;var K=C/D.quantity;if(y==TDS.util.Defaults.hotusaSupplier){P=D.priceSell;q=P;R=C;if(D.priceIsNett){m=D.priceCommissionPercentage}}var g=this.findParentByType("tabpanel").findParentByType("awesomegrid").lastExpandedRowIdx;if(!(this.findParentByType("tabpanel").findParentByType("awesomegrid").getStore().getAt(g).data.cruisePackage!=0)){V+="<tr>";if(y==TDS.util.Defaults.hotusaSupplier){V+="<td >"+M.hotusaRoomType+"</td>"}else{V+="<td >"+TDS.util.Format.displayResourceName(M.inventoryTypeURI)+"</td>"}V+="<td>"+M.nameString+"</td>";V+="<td>"+D.quantity+"</td>",V+="<td>"+TDS.util.Price.formatPrice(D.priceSell+K,D.priceCurrency)+"</td>",V+="<td>"+N+"</td>",V+="</tr>"}else{V+="<tr>";if(y==TDS.util.Defaults.hotusaSupplier){V+="<td >"+M.hotusaRoomType+"</td>"}else{V+="<td >"+TDS.util.Format.displayResourceName(M.inventoryTypeURI)+"</td>"}V+="<td>"+M.nameString+"</td>";V+="<td>"+D.quantity+"</td>",V+="<td>"+N+"</td>",V+="</tr>"}V+="<tr>";if(y==TDS.util.Defaults.hotusaSupplier){V+="<td >"+M.hotusaRoomType+"</td>"}else{V+="<td >"+TDS.util.Format.displayResourceName(M.inventoryTypeURI)+"</td>"}V+="<td>"+M.nameString+"</td>";V+="<td>"+D.quantity+"</td>",V+="<td>"+N+"</td>",V+="</tr>";l=(t.rowRecordData.pricingPriceIsNett?"Nett":"Gross")}q=q*au;P+=R;P+=ai}if(af.length>0){var w=af[0]}else{var w=af}if(y==TDS.util.Defaults.hotusaSupplier){var Q=new Date();Q.setDate(Q.getDate()+14);var A=Ext.util.Format.date(Q,TDS.env.dateFormat);var ae=new Date(A);var ad=new Date(aq.componentPaybyDate);if(ae<ad){var ak=ad.setDate(ad.getDate()-14);var U=new Date(ak);var p=Ext.util.Format.date(U,TDS.env.dateFormatDisplay);w=p}else{var ak=new Date();var p=Ext.util.Format.date(ak,TDS.env.dateFormatDisplay);w=p}}ar.setDetail("pricingPriceCurrency",L);this.inventoryData={rateBody:V,stayPrice:q.toFixed(2),priceCommission:m,netorgross:l,indate:at,outdate:aa,status:N,description:z,dataURI:d,divDataUri:e,numberOfNights:au,dates:w,depositDescription:c,paybyDate:a,markup:R.toFixed(2),pnrCode:Y[1],externalPNRCode:E,externalPNRCodeName:u,bookeddateDis:J,total:P.toFixed(2),extraTotal:ai.toFixed(2),priceCurrency:L,isCruisePackage:!(this.findParentByType("tabpanel").findParentByType("awesomegrid").getStore().getAt(g).data.cruisePackage)};this.hasDetailsInventory=true;if(this.isDetailsReady()){this.displayDetails()}}}}},scope:this})},initOffering:function(){var b=this.ownerCt.findParentByType("tabpanel");var a=b.getDetail("offeringURI");Ext.Ajax.request({url:TDS.env.dataPath+a,method:"GET",callback:function(h,c,f){if(c){try{;var d=Ext.decode(f.responseText)}catch(g){}if(d){this.offeringData={addressString:d.addressString,name:d.name,propertyType:TDS.util.Format.displayResourceName(d.accommodationPropertyClassTypeURI),accommodationRatingURI:TDS.util.Format.displayResourceName(d.accommodationRatingURI),accommodationGroup:TDS.util.Format.displayResourceName(d.accommodationGroupURI)};this.hasDetailsOffering=true;if(this.isDetailsReady()){this.displayDetails()}}}},scope:this})},displayDetails:function(){var g=this.ownerCt.findParentByType("tabpanel");var e=this.ownerCt.ownerCt.findParentByType("ajaxpanel");if(g.getDetail("voucher")&&e.rowRecordData.status=="Confirmed"){this.getDetailsPanel().topToolbar.items.itemAt(5).enable(true)}else{this.getDetailsPanel().topToolbar.items.itemAt(5).disable(true)}var d=g.getDetail("tempBookedDate");var j=Date.parseDate(g.getDetail("createdDate"),TDS.env.dateFormat);var l=Date.parseDate(g.getDetail("updatedDate"),TDS.env.dateFormat);var a=this.findParentByType("awesomegrid").findParentByType("pnrpanel").ownerCt.ownerCt.dataObj.pnrFrom;var k=!Ext.isEmpty(a)?"Created by Mobile on ":"Created on ";var b=k+j.format(TDS.env.dateTimeFormatDisplay)+" by "+g.getDetail("createdByUserFullNameString")+", modified on "+l.format(TDS.env.dateTimeFormatDisplay)+(g.getDetail("createdByUserFullNameString")==g.getDetail("updatedByUserFullNameString")?"":" by "+g.getDetail("updatedByUserFullNameString"))+".";var f=TDS.util.Price.calculateFixedGrossNettPrice({pricingPriceCurrency:g.getDetail("pricingPriceCurrency"),pricingPriceSell:g.getDetail("pricingPriceSell"),pricingPriceCommission:g.getDetail("pricingPriceCommission"),pricingPriceIsNett:g.getDetail("pricingPriceIsNett")});var h=(f.priceSell+f.priceCommission);var i=this.inventoryData.Ggrosstemp;if(f.priceSell==""||f.priceSell==null||f.priceSell=="undefined"){f.priceSell=0}var c=f.priceSell*parseInt(this.inventoryData.quantity);this.getDetailsPanel().tpl.overwrite(this.getDetailsPanel().body,Ext.apply({price:f.priceSell.toFixed(2),createdString:b,pricenet:f.priceIsNett,flag:f.flag,priceCommissionPercentage:f.priceCommissionPercentage,extragross:f.extragross,quaPrice:c.toFixed(2)},this.inventoryData,this.offeringData))},displayRates:function(){this.getDetailsRatePanel().tpl.overwrite(this.getDetailsRatePanel().body,this.rateData)}}