{requireStores:[{dataURI:TDS.env.dataPath+"tour/types/collection",identifier:"tour/types",fields:["name","dataURI"]},{dataURI:TDS.env.dataPath+"tour/classes/collection",identifier:"tour/classes",fields:["name","dataURI"]},{dataURI:TDS.env.dataPath+"tour/extracategories/collection",identifier:"tour/extracategories",fields:["name","dataURI"]},{dataURI:TDS.env.dataPath+"rate/classes/collection",identifier:"rate/classes",fields:["name","dataURI"]},{dataURI:TDS.env.dataPath+"rate/pers/collection",identifier:"rate/pers",fields:["name","dataURI"]},{dataURI:TDS.env.dataPath+"rate/occupancies/collection",identifier:"rate/occupancies",fields:["name","dataURI"]}],xtype:"panel",height:320,border:true,frame:false,layout:"column",getDetailsPanel:function(){return this.items.itemAt(0)},getPassengersPanel:function(){return this.items.itemAt(1)},hasDetailsInventory:false,hasDetailsOffering:false,isDetailsReady:function(){if(this.hasDetailsInventory&&this.hasDetailsOffering){return true}return false},items:[{tbar:[{xtype:"button",text:"Edit Pay By",handler:function(){var e=this.ownerCt.findParentByType("tabpanel");var d=e.ownerCt;var c=e.getDetail("dataURI");var a=e.getDetail("paybyDate");var b=e.getDetail("depositDescription");TDS.window.setWindow({title:"Description",information:"Please enter description.",interfaceURI:"pnr/components/accommodation/editPayby.js",destinationDataURI:c+"/updatePayBYDates",data:{paybyDate:a,depositDescription:b},callback:{fn:function(f){d.refreshGrid()}}})}},{xtype:"datefield",hidden:true},{xtype:"button",text:"Save",disabled:true,hidden:true},"->",{xtype:"button",buttonAlign:"right",text:"Additional Info",handler:function(){var c=this.ownerCt.findParentByType("tabpanel");var b=c.ownerCt;var a=c.getDetail("dataURI");if(!a){return}TDS.window.setWindow({title:"Tour PNR",interfaceURI:"pnr/components/generic/additionalInfo.js",sourceDataURI:a+"/additionalInfo",destinationDataURI:a+"/additionalInfo"})}},{xtype:"button",buttonAlign:"left",text:"Download Voucher",handler:function(){var e=this.ownerCt.findParentByType("tabpanel");var d=e.ownerCt;var c="/GraphicsImg/voucher/";var a=e.getDetail("dataURI");if(!a){return}var b=TDS.env.currentDomain;Ext.Ajax.request({url:TDS.env.dataPath+a+"/voucher",jsonData:{currentDomain:b},method:"PUT",scope:this,callback:function(i,g,h){c=c+h.responseText+".rtf";var f=window.open(c,"Information Priview","height=500,width=800,left=10,top=10,resizable=yes,scrollbars=yes,toolbar=yes,menubar=no,location=no,directories=no,status=yes");f.focus()}})}}],columnWidth:0.6,xtype:"panel",height:275,border:true,tpl:new Ext.XTemplate('<div style="height:150px; overflow-y: scroll;">','<table border="0" width="100%">','<tr><td width="14%"><span style="font-size:12px"><b>RLOC:</b></span></td><td width="20%"><font color="red"><span style="font-size:12px"> <b>{pnrCode}</b><span style="font-size:12px"></font></td>','<td  width="15%"><span style="font-size:12px"><b>Pay By:</b></span></td><td  width="20%"><div id="ttlDate#{divDataUri}"><span style="font-size:12px">{paybyDate}&nbsp;{depositDescription}</span></div></td>',"<td></td>","<td width='20%'></td>","</tr>","</table>",'<table class="x-tds-dataview" style="width: 100%;" border=1 cellpadding = 1 cellspacing=0  >','<tr style="background-color: #d0def0;" >','<th style="padding: 2px; width: 35%;">Tour Name</th>','<th style="padding: 2px; width: 25%;">City</th>','<th style="padding: 2px; width: 25%;">Dep Date</th>','<th style="padding: 2px; width: 15%;">Time</th>','<th style="padding: 2px; width: 15%;">Duration</th>',"</tr>","<tr>","<td>{name}</td>","<td>{locationToString}</td>","<td>{depDate}</td>","<td>{time}</td>","<td>{duration}</td>","</tr>","</table>",'<table class="x-tds-dataview" style="width: 100%;" border=1 cellpadding = 1 cellspacing=0  >','<tr style="background-color: #d0def0;" >','<th style="padding: 2px; width: 25%;">Rate</th>','<th style="padding: 2px; width: 15%;">Passenger Type</th>','<th style="padding: 2px; width: 5%;">No.</th>','<th style="padding: 2px; width: 20%;"> Gross Price Per Person</th>','<th style="padding: 2px; width: 10%;">Status</th>',"</tr>","{rateBody}","</table>",'<table class="x-tds-dataview" style="width: 100%;" border=1 cellpadding = 1 cellspacing=0  >','<tr style="background-color: #C0D9D9;">','<th style="padding: 2px; width: 14%;">Tour Price</th>','<th style="padding: 2px; width: 14%;">Extras</th>','<th style="padding: 2px; width: 20%;">Total Price (Gross)</th>','<th style="padding: 2px; width: 10%;">Markup Included</th>','<th style="padding: 2px; width: 7%;">Comm%</th>',"</tr>","<tr>","<td>{totprice}</td>","<td>{priceCurrency}&nbsp;{extraTotal} {extrsGrossFlag}</td>","<td><b>{priceCurrency}&nbsp;{total}</td>","<td>{priceCurrency}&nbsp;{markup}</td>","<td>{priceCommission}</td>","</tr>","</table>","</div>",'<div> <table style="width: 100%;"><tr><td>{createdString}</td></tr></table></div>')},{height:270,columnWidth:0.4,layout:"fit",border:false,items:[{columnWidth:1,xtype:"grid",enableRowExpander:false,sessionExpandedRows:false,height:130,autoScroll:true,border:false,enableColumnHide:false,enableColumnMove:false,enableColumnResize:false,enableHdMenu:false,tbar:["->",{xtype:"button",disabled:true,text:"Cancel passenger",handler:function(){pGridPass=this.ownerCt.ownerCt;var b=this.ownerCt.ownerCt.findParentByType("tabpanel");dataURIPass=b.getDetail("dataURI");Ext.Msg.show({title:"Confirmation",msg:"Are you sure, want to cancel passenger?",buttons:Ext.Msg.YESNO,fn:a,animEl:"elId",icon:Ext.MessageBox.QUESTION});function a(j){if(j=="yes"){var e=pGridPass;var g=e.getSelections();var d=dataURIPass;var c={};var f=new Array();for(var h=0;h<g.length;h++){f[h]=g[h].data.dataURI}c.passengerURIs=f;Ext.Ajax.request({url:TDS.env.dataPath+d+"/cancel",method:"PUT",jsonData:c,callback:function(n,i,l){if(i){try{Ext.Msg.alert("Status","Changes saved successfully.");var k=e.ownerCt.findParentByType("awesomegrid");k.submitQuery(true)}catch(m){}}}})}}}}],store:new Ext.data.JsonStore({url:"",id:"dataURI",fields:["dataURI","displayName","roomType","code","dateOfBirth","addressString","phoneNumber1","emailAddress","gender","priceSell","status","paxAge"]}),sm:new Ext.grid.CheckboxSelectionModel(),columns:[new Ext.grid.CheckboxSelectionModel(true),{header:"Passenger",dataIndex:"displayName",width:200,sortable:true,renderer:function(e,d,a,f,c,b){d.attr='ext:qtip= "Click to view details"';return e}},{header:"Type",dataIndex:"code",width:80},{header:"Gender",dataIndex:"gender",renderer:TDS.util.Format.gender,width:100},{header:"DOB",dataIndex:"dateOfBirth",width:70,fixed:true,renderer:TDS.util.Format.dateSpecialRenderer(TDS.env.dateBirthdayFormatDisplay)},{header:"Age",dataIndex:"paxAge",width:40,fixed:true,renderer:function(d,b,a){if(d){return d}else{var c=TDS.util.Format.age(a.get("dateOfBirth"));return((c&&c>0)?c:"")}}},{header:"Price",dataIndex:"priceSell",width:100,renderer:TDS.util.Price.conversionPriceRenderer},{header:"Status",dataIndex:"status",width:100}],viewConfig:{forceFit:true},listeners:{celldblclick:function(c,g,d,f){var b=c.getStore().getAt(g);var a=b.get("dataURI");TDS.window.setWindow({title:"Passenger details",destinationDataURI:a,interfaceURI:"pnr/passenger/viewDetails.js",sourceDataURI:a});return false},render:function(){var c=this.topToolbar;this.getSelectionModel().on("rowselect",function(){if(this.ownerCt.getSelections().length>0){c.items.itemAt(1).setDisabled(false)}},c);this.getSelectionModel().on("rowdeselect",function(){if(this.ownerCt.getSelections().length==0){c.items.itemAt(1).setDisabled(true)}},c);this.getEl().swallowEvent(["columnmove","columnresize","headerclick","click","mouseout","rowclick","rowmousedown","rowblclick","cellblclick","sortchange","mouseup","mousedown"]);var b=this.ownerCt.findParentByType("tabpanel");var a=b.getDetail("dataURI");Ext.Ajax.request({url:TDS.env.dataPath+a+"/passengers/collection/concise",method:"GET",callback:function(g,m,e){if(m){var k=Ext.util.JSON.decode(e.responseText);var j=k[a+"/passengers"];if(typeof j=="undefined"){return}var l=[];for(var h=0;h<j.length;h++){k[j[h]].dataURI=j[h];l.push(k[j[h]])}var f=this;var d=f.store;d.loadData(l);f.getView().refresh()}},scope:this})}}}]}],listeners:{render:function(){this.initInventory();this.initOffering()}},initInventory:function(){var h=this.ownerCt.findParentByType("tabpanel");var d=h.getDetail("dataURI");var c=h.getDetail("depositDescription");var b=h.getDetail("paybyDate");var a=TDS.util.Format.dateSpecial(b,TDS.env.dateFormatDisplay);var g=d;var f=new Array();var e=0;f=d.split("/");Ext.Ajax.request({url:TDS.env.dataPath+d+"/inventories/collection",method:"GET",callback:function(R,N,P){var af=this.ownerCt.findParentByType("tabpanel");if(N){try{var J=Ext.decode(P.responseText)}catch(ac){}if(J){var B=0,K,T=[];var I=0;var aa=J["component/inventory/collection"];var m=aa[d+"/inventories"];var Q=J["component/rate/collection/"];var k=Q["component/rate/collection/list"];var z=Q.TOUR_TYPR_STRING;af.setDetail("rateList",k);var O=new Array();O=d.split("/");var D="";this.rateData=[];var ai=m.length/k.length;var V=[];var E="";var ab=[];var A=0;if(m.length>0){for(var Y=0;Y<m.length;Y++){var ae=aa[m[Y]];T[T.length]=TDS.util.Format.dateSpecial(ae.componentPaybyDate,TDS.env.dateFormatDisplay);E=ae.pricingPriceCurrency;if(ab.indexOf(ae.rateId)==-1){ab[Y]=ae.rateId;V[A]=TDS.util.Price.calculateFixedGrossNettPrice({pricingPriceCurrency:ae.pricingPriceCurrency,pricingPriceSell:ae.pricingPriceSell,pricingPriceCommission:ae.pricingPriceCommission,pricingPriceIsNett:ae.pricingPriceIsNett});V[A].rateId=ae.rateId;V[A].quantity=ae.quantity;A++}}var M="";var p="";var H=0;var X=0;if(k.length>0){;for(var Y=0;Y<k.length;Y++){var F=Q[k[Y]];D=Q[k[Y]].tempBookedDate;var L=[];var ah=F.groupName;var n="";var x="";L=typeof ah!="undefined"?ah.split(","):"";var ag=[],U="";var l="";var y=null;for(var W=0;W<V.length;W++){if(V[W].rateId==k[Y].substring(k[Y].lastIndexOf("/")+1,k[Y].length)){y=V[W]}}var q=this.ownerCt.ownerCt.findParentByType("ajaxpanel");var C=TDS.util.Format.dateSpecial(q.rowRecordData.dateFrom,TDS.env.dateFormatDisplay);var v=q.rowRecordData.description;var G=q.rowRecordData.status;var w=q.rowRecordData.bookingReferenceNumber;if(typeof w!="undefined"&&w!=""){O[1]=w}var t=0;var Z=0;if(!y.priceIsNett){n=y.priceCommissionPercentage;if(typeof n=="undefined"){n="0%"}H+=(y.priceSell);t=y.priceSell/y.quantity}else{x=y.priceCommission;I+=y.priceCommission;t=(y.priceSell)/y.quantity+(x)/y.quantity;H+=(y.priceSell+x)}if(y.quantity>0){X=F.extraTotal}var ad="&nbsp;0";M+="<tr>";M+="<td>"+F.nameString+"</td>",M+="<td>"+ag[0]+"</td>",M+="<td>"+y.quantity+"</td>",M+="<td>"+TDS.util.Price.formatPrice(t,y.priceCurrency)+"</td>",M+="<td>"+G+"</td>",M+="</tr>";var n=n;l=(y.priceIsNett?"Nett":"Gross");if(!l){I=""}}}var S=H;H+=X;if(T.length>0){var u=T[0]}else{var u=T}af.setDetail("pricingPriceCurrency",E);this.inventoryData={fn:this.updatePayByDate,dataURI:d,divDataUri:g,rateBody:M,numberOfNights:ai,dates:u,depositDescription:c,paybyDate:a,markup:I.toFixed(2),pnrCode:O[1],bookeddateDis:D,total:H.toFixed(2),depDate:C,status:G,description:v,netorgross:l,priceCommission:n,totprice:TDS.util.Price.formatPrice(S,E),extraTotal:X.toFixed(2),tourType:z,priceCurrency:E};this.hasDetailsInventory=true;if(this.isDetailsReady()){this.displayDetails()}}}}},scope:this})},initOffering:function(){var c=this.ownerCt.findParentByType("tabpanel");var b=c.getDetail("offeringURI");var a;Ext.Ajax.request({url:TDS.env.dataPath+b,method:"GET",callback:function(i,d,g){if(d){try{var f=Ext.decode(g.responseText)}catch(h){}if(f){this.offeringData={locationToString:f.locationToString,locationsString:f.locationsString,duration:f.duration,name:f.name,website:f.primaryHref,addressString:f.addressString,tourClass:TDS.util.Format.displayResourceName(f.tourClassURI)};this.hasDetailsOffering=true;if(this.isDetailsReady()){this.displayDetails()}}}},scope:this})},displayDetails:function(){var e=this.ownerCt.findParentByType("tabpanel");var d=this.ownerCt.ownerCt.findParentByType("ajaxpanel");if(e.getDetail("voucher")&&d.rowRecordData.status=="Confirmed"){this.getDetailsPanel().topToolbar.items.itemAt(5).enable(true)}else{this.getDetailsPanel().topToolbar.items.itemAt(5).disable(true)}var i=Date.parseDate(e.getDetail("createdDate"),TDS.env.dateFormat);var k=Date.parseDate(e.getDetail("updatedDate"),TDS.env.dateFormat);var a=this.findParentByType("awesomegrid").findParentByType("pnrpanel").ownerCt.ownerCt.dataObj.pnrFrom;var j=!Ext.isEmpty(a)?"Created by Mobile on ":"Created on ";var b=j+i.format(TDS.env.dateTimeFormatDisplay)+" by "+e.getDetail("createdByUserFullNameString")+", modified on "+k.format(TDS.env.dateTimeFormatDisplay)+(e.getDetail("createdByUserFullNameString")==e.getDetail("updatedByUserFullNameString")?"":" by "+e.getDetail("updatedByUserFullNameString"))+".";var f=TDS.util.Price.calculateFixedGrossNettPrice({pricingPriceCurrency:e.getDetail("pricingPriceCurrency"),pricingPriceSell:e.getDetail("pricingPriceSell"),pricingPriceCommission:e.getDetail("pricingPriceCommission"),pricingPriceIsNett:e.getDetail("pricingPriceIsNett")});var g=(f.priceSell+f.priceCommission);var h=this.inventoryData.Ggrosstemp;if(f.priceSell==""||f.priceSell==null||f.priceSell=="undefined"){f.priceSell=0}var c=f.priceSell*parseInt(this.inventoryData.quantity);this.getDetailsPanel().tpl.overwrite(this.getDetailsPanel().body,Ext.apply({price:f.priceSell.toFixed(2),createdString:b,pricenet:f.priceIsNett,flag:f.flag,priceCommissionPercentage:f.priceCommissionPercentage,extragross:f.extragross,quaPrice:c.toFixed(2)},this.inventoryData,this.offeringData))}}