{requireStores:[{dataURI:TDS.env.dataPath+"car/types/collection",identifier:"car/types",fields:["name","dataURI"]},{dataURI:TDS.env.dataPath+"car/vehicleSizes/collection",identifier:"car/vehicleSizes",fields:["name","dataURI"]},{dataURI:TDS.env.dataPath+"car/extracategories/collection",identifier:"car/extracategories",fields:["name","dataURI"]}],xtype:"panel",height:350,border:true,layout:"column",getDetailsPanel:function(){return this.items.itemAt(0)},getPassengersPanel:function(){return this.items.itemAt(1)},hasDetailsInventory:false,hasDetailsOffering:false,hasDetailsDepot:true,isDetailsReady:function(){if(this.hasDetailsInventory&&this.hasDetailsOffering&&this.hasDetailsDepot){return true}return false},items:[{tbar:[{xtype:"button",text:"Edit Pay By",handler:function(){var e=this.ownerCt.findParentByType("tabpanel");var d=e.ownerCt;var c=e.getDetail("dataURI");var a=e.getDetail("paybyDate");var b=e.getDetail("depositDescription");TDS.window.setWindow({title:"Description",information:"Please enter description.",interfaceURI:"pnr/components/accommodation/editPayby.js",destinationDataURI:c+"/updatePayBYDates",data:{paybyDate:a,depositDescription:b},callback:{fn:function(f){d.refreshGrid()}}})}},{xtype:"datefield",hidden:true},{xtype:"button",text:"Save",disabled:true,hidden:true},"->",{xtype:"button",buttonAlign:"right",text:"Additional Info",handler:function(){var c=this.ownerCt.findParentByType("tabpanel");var b=c.ownerCt;var a=c.getDetail("dataURI");if(!a){return}TDS.window.setWindow({title:"Car rental PNR",interfaceURI:"pnr/components/generic/additionalInfo.js",sourceDataURI:a+"/additionalInfo",destinationDataURI:a+"/additionalInfo"})}},{xtype:"button",buttonAlign:"left",text:"Download Voucher",handler:function(){var e=this.ownerCt.findParentByType("tabpanel");var d=e.ownerCt;var c="/GraphicsImg/voucher/";var a=e.getDetail("dataURI");if(!a){return}var b=TDS.env.currentDomain;Ext.Ajax.request({url:TDS.env.dataPath+a+"/voucher",jsonData:{currentDomain:b},method:"PUT",scope:this,callback:function(i,g,h){c=c+h.responseText+".rtf";var f=window.open(c,"Information Priview","height=500,width=800,left=10,top=10,resizable=yes,scrollbars=yes,toolbar=yes,menubar=no,location=no,directories=no,status=yes");f.focus()}})}}],columnWidth:0.6,xtype:"panel",height:275,border:true,tpl:new Ext.XTemplate('<div style="height:175px; overflow-y: scroll;">','<table border="0" width="100%">','<tr><td width="14%"><span style="font-size:12px"><b>RLOC:</b></span></td><td width="20%"><font color="red"><span style="font-size:12px"> <b>{pnrCode}</b><span style="font-size:12px"></font></td>','<td  width="8%"><span style="font-size:12px"><b>Pay By:</b></span></td><td  width="20%"><div id="ttlDate#{divDataUri}"><span style="font-size:12px">{paybyDate}&nbsp;{depositDescription}</span></div></td>',"<td></td>","</tr>","</table>",'<table class="x-tds-dataview" style="width: 100%;" border=1 cellpadding = 1 cellspacing=0  >','<tr style="background-color: #d0def0;" >','<th style="padding: 2px; width: 22%;">Vehicle Type</th>','<th style="padding: 2px; width: 22%;">Category</th>','<th style="padding: 2px; width: 20%;">Transmission</th>','<th style="padding: 2px; width: 16%;">Seats</th>','<th style="padding: 2px; width: 18%;">Kilometers</th>','<th style="padding: 2px; width: 14%;">Status</th>',"</tr>","<tr>","<td>{carType}</td>","<td>{carVehicleSizeURI}</td>","<td>{automaticTransmission}</td>","<td>{capacityPeople}</td>","<td>{maximumKilometers}</td>","<td>{status}</td>","</tr>","</tr>","</table>",'<table class="x-tds-dataview" style="width: 100%;" border=1 cellpadding = 1 cellspacing=0  >','<tr style="background-color: #C0D9D9;">','<th style="padding: 2px; width: 20%;">Rate</th>','<th style="padding: 2px; width: 12%;">Gross Price P/D</th>','<th style="padding: 2px; width: 10%;">Days</th>','<th style="padding: 2px; width: 12%;">Extras</th>','<th style="padding: 2px; width: 15%;">Total Price (Gross)</th>','<th style="padding: 2px; width: 8%;">Comm%</th>',"</tr>","{rateBody}","</table>",'<table class="x-tds-dataview" style="width: 100%;" border=1 cellpadding = 1 cellspacing=0  >','<tr style="background-color: #d0def0;">','<th style="padding: 2px; width: 14%;">From</th>','<th style="padding: 2px; width: 14%;">Pick-Up</th>','<th style="padding: 2px; width: 14%;" >Date</th>','<th style="padding: 2px; width: 14%;" >Time</th>',"</tr>","<tr>","<td >{fromCityString}</td>","<td >{depotPickupAddress}</td>","<td >{fromDate}</td>","<td >{fromTime}</td>","</tr>","</table>",' <table class="x-tds-dataview" style="width: 100%;" border=1 cellpadding = 1 cellspacing=0  >','<tr style="background-color: #d0def0;">','<th style="padding: 2px; width: 14%;">Return</th>','<th style="padding: 2px; width: 14%;">Drop-Off</th>','<th style="padding: 2px; width: 14%;">Date</th>','<th style="padding: 2px; width: 14%;">Time</th>',"</tr>","<tr>","<td >{toCityString}</td>","<td >{depotDropoffName}</td>","<td >{toDate}</td>","<td >{toTime}</td>","</tr>","</table>","</div>",'<div> <table style="width: 100%;"><tr><td>{createdString}</td></tr></table></div>')},{height:270,columnWidth:0.4,layout:"fit",border:false,items:[{columnWidth:1,xtype:"grid",enableRowExpander:false,sessionExpandedRows:false,height:160,autoScroll:true,border:false,enableColumnHide:false,enableColumnMove:false,enableColumnResize:false,enableHdMenu:false,tbar:["->",{xtype:"button",disabled:true,text:"Cancel passenger",handler:function(){pGridPass=this.ownerCt.ownerCt;var b=this.ownerCt.ownerCt.findParentByType("tabpanel");dataURIPass=b.getDetail("dataURI");Ext.Msg.show({title:"Confirmation",msg:"Are you sure, want to cancel passenger?",buttons:Ext.Msg.YESNO,fn:a,animEl:"elId",icon:Ext.MessageBox.QUESTION});function a(j){if(j=="yes"){var e=pGridPass;var g=e.getSelections();var d=dataURIPass;var c={};var f=new Array();for(var h=0;h<g.length;h++){f[h]=g[h].data.dataURI}c.passengerURIs=f;Ext.Ajax.request({url:TDS.env.dataPath+d+"/cancel",method:"PUT",jsonData:c,callback:function(n,i,l){if(i){try{Ext.Msg.alert("Status","Changes saved successfully.");var k=e.ownerCt.findParentByType("awesomegrid");k.submitQuery(true)}catch(m){}}}})}}}}],store:new Ext.data.JsonStore({url:"",id:"dataURI",fields:["dataURI","displayName","roomType","code","dateOfBirth","addressString","driver","phoneNumber1","emailAddress","gender","status"]}),sm:new Ext.grid.CheckboxSelectionModel(),columns:[new Ext.grid.CheckboxSelectionModel(),{header:"Passenger",dataIndex:"displayName",width:200,sortable:true,renderer:function(e,d,a,f,c,b){d.attr='ext:qtip= "Click to view details"';return e}},{header:"Type",dataIndex:"code",width:40,fixed:true},{header:"Gender",dataIndex:"gender",renderer:TDS.util.Format.gender,width:50,fixed:true},{header:"DOB",dataIndex:"dateOfBirth",width:70,fixed:true,renderer:TDS.util.Format.dateSpecialRenderer(TDS.env.dateBirthdayFormatDisplay)},{header:"Age",dataIndex:"paxAge",width:30,fixed:true,renderer:function(d,b,a){if(d){return d}else{var c=TDS.util.Format.age(a.get("dateOfBirth"));return((c&&c>0)?c:"")}}},{header:"Driver",dataIndex:"driver",checkOnly:true,width:72,renderer:function(c,d,a){var b="";if(c){b="checked=checked"}return'<center><input type="checkbox" '+b+" onclick=\" var s = Ext.getCmp('button-grid').store;for(var t =0;t<s.data.length;t++){ if(s.data.items[t].id == '"+a.id+"'){  s.data.items[t].data.driver =(this.value=='on')?true:false;}}\""}},{header:"Price",dataIndex:"price",width:40,fixed:true},{header:"Status",dataIndex:"status",width:50,fixed:true}],viewConfig:{forceFit:true},listeners:{rowdblclick:function(c,f,d){var b=c.getStore().getAt(f);var a=b.get("dataURI");TDS.window.setWindow({buttonOK:false,title:"Passenger details",destinationDataURI:a,interfaceURI:"pnr/passenger/viewDetails.js",sourceDataURI:a})},render:function(){var c=this.topToolbar;this.getSelectionModel().on("rowselect",function(){if(this.ownerCt.getSelections().length>0){c.items.itemAt(1).setDisabled(false)}},c);this.getSelectionModel().on("rowdeselect",function(){if(this.ownerCt.getSelections().length==0){c.items.itemAt(1).setDisabled(true)}},c);this.getEl().swallowEvent(["columnmove","columnresize","headerclick","click","mouseout","rowclick","rowmousedown","rowblclick","cellblclick","sortchange","mouseup","mousedown"]);var b=this.ownerCt.findParentByType("tabpanel");var a=b.getDetail("dataURI");Ext.Ajax.request({url:TDS.env.dataPath+a+"/passengers/collection/concise",method:"GET",callback:function(g,m,e){if(m){var k=Ext.util.JSON.decode(e.responseText);var j=k[a+"/passengers"];if(typeof j=="undefined"){return}var l=[];for(var h=0;h<j.length;h++){k[j[h]].dataURI=j[h];l.push(k[j[h]])}var f=this;var d=f.store;d.loadData(l);f.getView().refresh()}},scope:this})}}}]}],listeners:{render:function(){this.initInventory();this.initOffering();this.initDepots()}},initInventory:function(){var f=this.ownerCt.findParentByType("tabpanel");var d=f.getDetail("dataURI");var e=d;var c=f.getDetail("depositDescription");var b=f.getDetail("paybyDate");var a=TDS.util.Format.dateSpecial(b,TDS.env.dateFormatDisplay);Ext.Ajax.request({url:TDS.env.dataPath+d+"/inventories/collection",method:"GET",callback:function(P,L,N){if(L){try{var F=Ext.decode(N.responseText)}catch(aa){}if(F){var ac=this.ownerCt.findParentByType("tabpanel");var x=1,H,T=[];var E=0;var J=0;var Y=F["component/inventory/collection"];var k=Y[d+"/inventories"];var O=F["component/rate/collection/"];var g=O["component/rate/collection/list"];ac.setDetail("rateList",g);var M=new Array();M=d.split("/");var y="";this.rateData=[];var ad=k.length/g.length;var U=[];var z="";var Z=[];var w=0;if(k.length>0){for(var X=0;X<k.length;X++){var ab=Y[k[X]];T[T.length]=TDS.util.Format.dateSpecial(ab.componentPaybyDate,TDS.env.dateFormatDisplay);z=ab.pricingPriceCurrency;if(Z.indexOf(ab.rateId)==-1){Z[X]=ab.rateId;U[w]=TDS.util.Price.calculateFixedGrossNettPrice({pricingPriceCurrency:ab.pricingPriceCurrency,pricingPriceSell:ab.pricingPriceSell,pricingPriceCommission:ab.pricingPriceCommission,pricingPriceIsNett:ab.pricingPriceIsNett});U[w].rateId=ab.rateId;w++}}var p=0;var D=0;var I="";var C=0;var W=0;if(g.length>0){for(var X=0;X<g.length;X++){var A=O[g[X]];A.maximumOccupancy=k.length;W=A.extraTotal*A.maximumOccupancy;var q=A.extraTotal*A.maximumOccupancy;y=O[g[X]].tempBookedDate;var t="";var h="";var v=null;var l="";for(var V=0;V<U.length;V++){if(U[V].rateId==g[X].substring(g[X].lastIndexOf("/")+1,g[X].length)){v=U[V]}}var m=this.ownerCt.ownerCt.findParentByType("ajaxpanel");var B=m.rowRecordData.status;if(!v.priceIsNett){l=v.priceCommissionPercentage}else{t=v.priceCommission;E+=(A.maximumOccupancy*v.priceCommission)}C+=(A.maximumOccupancy*v.priceSell);I+="<tr>";I+="<td >"+A.nameString+"</td>";I+="<td >"+TDS.util.Price.formatPrice((v.priceSell)+t,v.priceCurrency)+"</td>";I+="<td >"+A.maximumOccupancy+"</td>";I+="<td >"+TDS.util.Price.formatPrice(q,v.priceCurrency)+"</td>";I+="<td >"+TDS.util.Price.formatPrice(((v.priceSell*A.maximumOccupancy)+q),v.priceCurrency)+"</td>";I+="<td >"+(v.priceIsNett?"":l)+"</td>";I+="</tr>";h=(v.priceIsNett?"Nett":"Gross");p=A.maximumKilometers;D=A.excessPerKilometers}C+=E;var R=C;C+=W}var G=F["component/collection"];var u=G[d];var K=Ext.util.JSON.decode(u.parameters);var S=new Date();var Q=new Date();if(typeof K!="undefined"){this.pickUpAndDropOff=K;S=new Date(K.fromDate);Q=new Date(K.toDate)}else{K=[]}if(T.length>0){var n=T[0]}else{var n=T}ac.setDetail("pricingPriceCurrency",z);this.inventoryData={rateBody:I,dataURI:d,divDataUri:e,numberOfNights:ad,dates:n,depositDescription:c,paybyDate:a,markup:E.toFixed(2),pnrCode:M[1],bookeddateDis:y,total:C.toFixed(2),extraTotal:W.toFixed(2),fromCityString:K.fromCityString,fromTime:K.fromTime,fromDate:S.format(TDS.env.dateFormatDisplay),status:B,netorgross:h,totprice:R,toCityString:K.toCityString,toDate:Q.format(TDS.env.dateFormatDisplay),toTime:K.toTime,noOfDays:K.noOfDays,maximumKilometers1:(p&&p>0)?"Max. Kilometers":"Unlimited",maximumKilometers:(p&&p>0)?p:"",excessPerKilometers:(D&&D>0)?(z+" "+D):"",priceCurrency:z};this.hasDetailsInventory=true;if(this.isDetailsReady()){this.displayDetails()}}}}},scope:this})},initOffering:function(){var b=this.ownerCt.findParentByType("tabpanel");var a=b.getDetail("offeringURI");Ext.Ajax.request({url:TDS.env.dataPath+a,method:"GET",callback:function(h,c,f){if(c){try{var d=Ext.decode(f.responseText)}catch(g){}if(d){this.offeringData={offeringName:d.name,automaticTransmission:d.automaticTransmission?"Auto":"Manual",capacityPeople:d.capacityPeople,minimumAgeRequired:d.minimumAgeRequired,carVehicleSizeURI:TDS.util.Format.displayResourceName(d.carVehicleSizeURI),carType:TDS.util.Format.displayResourceName(d.carTypeURI)};this.hasDetailsOffering=true;if(this.isDetailsReady()){this.displayDetails()}}}},scope:this})},depotData:{},initDepots:function(){var b=this.ownerCt.findParentByType("tabpanel");var a=b.getDetail("dataURI");Ext.Ajax.request({url:TDS.env.dataPath+a+"/parameters/collection",method:"GET",callback:function(k,d,h){if(d){try{var g=Ext.decode(h.responseText)}catch(j){}if(g){var f=g[a+"/parameters"];if(f.length>0){for(var c=0;c<f.length;c++){var l=g[f[c]];if(l.name=="supplierDepotPickupURI"){this.getDepot(l.value,"pickup")}if(l.name=="supplierDepotDropoffURI"){this.getDepot(l.value,"dropoff")}}}else{this.depotData={};this.hasDetailsDepot=true;if(this.isDetailsReady()){this.displayDetails()}}}}},scope:this})},depots:{},isDepotReady:function(){if(typeof this.depots.pickup!="undefined"&&typeof this.depots.dropoff!="undefined"){return true}return false},getDepot:function(a,b){Ext.Ajax.request({url:TDS.env.dataPath+a,method:"GET",callback:function(h,c,f){try{;var d=Ext.decode(f.responseText);this.depots[b]=d}catch(g){}if(this.isDepotReady()){this.depotData=this.depots;delete this.depots;this.hasDetailsDepot=true;if(this.isDetailsReady()){this.displayDetails()}}},scope:this})},displayDetails:function(){var g=this.ownerCt.findParentByType("tabpanel");var b=Date.parseDate(g.getDetail("createdDate"),TDS.env.dateFormat);var e=Date.parseDate(g.getDetail("updatedDate"),TDS.env.dateFormat);var d=this.findParentByType("awesomegrid").findParentByType("pnrpanel").ownerCt.ownerCt.dataObj.pnrFrom;var f=!Ext.isEmpty(d)?"Created by Mobile on ":"Created on ";var a=f+b.format(TDS.env.dateTimeFormatDisplay)+" by "+g.getDetail("createdByUserFullNameString")+", modified on "+e.format(TDS.env.dateTimeFormatDisplay)+(g.getDetail("createdByUserFullNameString")==g.getDetail("updatedByUserFullNameString")?"":" by "+g.getDetail("updatedByUserFullNameString"))+".";var c=TDS.util.Price.calculateFixedGrossNettPrice({pricingPriceCurrency:g.getDetail("pricingPriceCurrency"),pricingPriceSell:g.getDetail("pricingPriceSell"),pricingPriceCommission:g.getDetail("pricingPriceCommission"),pricingPriceIsNett:g.getDetail("pricingPriceIsNett")});this.getDetailsPanel().tpl.overwrite(this.getDetailsPanel().body,Ext.apply({depotPickupName:this.depotData.pickup?this.depotData.pickup.name:"",depotPickupAddress:this.depotData.pickup?this.depotData.pickup.addressString:"",depotDropoffName:this.depotData.dropoff?this.depotData.dropoff.name:"",depotDropoffAddress:this.depotData.dropoff?this.depotData.dropoff.addressString:"",createdString:a},this.inventoryData,this.offeringData))}}