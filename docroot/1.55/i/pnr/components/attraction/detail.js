{requireStores:[{dataURI:TDS.env.dataPath+"attraction/types/collection",identifier:"attraction/types",fields:["name","dataURI"]},{dataURI:TDS.env.dataPath+"attraction/extracategories/collection",identifier:"attraction/extracategories",fields:["name","dataURI"]},{dataURI:TDS.env.dataPath+"rate/classes/collection",identifier:"rate/classes",fields:["name","dataURI"]},{dataURI:TDS.env.dataPath+"rate/pers/collection",identifier:"rate/pers",fields:["name","dataURI"]},{dataURI:TDS.env.dataPath+"rate/occupancies/collection",identifier:"rate/occupancies",fields:["name","dataURI"]}],xtype:"panel",height:140,border:false,layout:"column",getDetailsPanel:function(){return this.items.itemAt(0)},getPassengersPanel:function(){return this.items.itemAt(1)},hasDetailsInventory:false,hasDetailsOffering:false,isDetailsReady:function(){if(this.hasDetailsInventory&&this.hasDetailsOffering){return true}return false},items:[{tbar:[{xtype:"button",text:"Edit Pay By",handler:function(){var f=this.ownerCt.findParentByType("tabpanel");var e=f.ownerCt;var d=f.getDetail("dataURI");var b=f.getDetail("paybyDate");var c=f.getDetail("depositDescription");TDS.window.setWindow({title:"Description",information:"Please enter description.",interfaceURI:"pnr/components/accommodation/editPayby.js",destinationDataURI:d+"/updatePayBYDates",data:{paybyDate:b,depositDescription:c},callback:{fn:function(g){e.refreshGrid()}}})}},{xtype:"datefield",hidden:true},{xtype:"button",text:"Save",disabled:true,hidden:true},"->",{xtype:"button",buttonAlign:"right",text:"Additinonal Info",handler:function(){var d=this.ownerCt.findParentByType("tabpanel");var c=d.ownerCt;var b=d.getDetail("dataURI");if(!b){return}TDS.window.setWindow({title:"Services PNR",interfaceURI:"pnr/components/generic/additionalInfo.js",sourceDataURI:b+"/additionalInfo",destinationDataURI:b+"/additionalInfo"})}},{xtype:"button",buttonAlign:"left",text:"Download Voucher",handler:function(){var f=this.ownerCt.findParentByType("tabpanel");var e=f.ownerCt;var d="/GraphicsImg/voucher/";var b=f.getDetail("dataURI");if(!b){return}var c=TDS.env.currentDomain;Ext.Ajax.request({url:TDS.env.dataPath+b+"/voucher",jsonData:{currentDomain:c},method:"PUT",scope:this,callback:function(j,h,i){d=d+i.responseText+".rtf";var g=window.open(d,"Information Priview","height=500,width=800,left=10,top=10,resizable=yes,scrollbars=yes,toolbar=yes,menubar=no,location=no,directories=no,status=yes");g.focus()}})}}],columnWidth:0.6,xtype:"panel",height:275,border:true,tpl:new Ext.XTemplate('<div style="height:150px; overflow-y: scroll;">','<table border="0" width="100%">','<tr><td width="14%"><span style="font-size:12px"><b>RLOC:</b></span></td><td width="20%"><font color="red"><span style="font-size:12px"> <b>{pnrCode}</b><span style="font-size:12px"></font></td>','<td  width="8%"><span style="font-size:12px"><b>Pay By:</b></span></td><td  width="30%"><div id="ttlDate#{divDataUri}"><span style="font-size:12px">{paybyDate}&nbsp;{depositDescription}</span></div></td>',"<td></td>","</tr>","</table>",'<table class="x-tds-dataview" style="width: 100%;" border=1 cellpadding = 1 cellspacing=0  >','<tr style="background-color: #d0def0;" >','<th style="padding: 2px; width: 35%;">Service</th>','<th style="padding: 2px; width: 25%;">City</th>','<th style="padding: 2px; width: 25%;">Date</th>','<th style="padding: 2px; width: 15%;">Time</th>','<th style="padding: 2px; width: 15%;">Duration</th>',"</tr>","<tr>","<td>{nameString}</td>","<td>{locationToString}</td>","<td>{dates}</td>","<td>{time}</td>","<td>{duration}</td>","</tr>","</table>",'<table class="x-tds-dataview" style="width: 100%;" border=1 cellpadding = 1 cellspacing=0  >','<tr style="background-color: #d0def0;" >','<th style="padding: 2px; width: 25%;">Rate</th>','<th style="padding: 2px; width: 15%;">Passenger Type</th>','<th style="padding: 2px; width: 5%;">No.</th>','<tpl if="isCruisePackage">','<th style="padding: 2px; width: 20%;">Gross Price Per Person</th>',"</tpl>",'<th style="padding: 2px; width: 10%;">Status</th>',"</tr>","{rateBody}","</table>",'<tpl if="isCruisePackage">','<table class="x-tds-dataview" style="width: 100%;" border=1 cellpadding = 1 cellspacing=0  >','<tr style="background-color: #C0D9D9;">','<th style="padding: 2px; width: 22%;">Tour Price</th>','<th style="padding: 2px; width: 14%;">Extras</th>','<th style="padding: 2px; width: 20%;">Total Price (Gross)</th>','<th style="padding: 2px; width: 10%;">Markup Included</th>','<th style="padding: 2px; width: 7%;">Comm%</th>',"</tr>","<tr>","<td>{priceCurrency}&nbsp;{totalPrice}</td>","<td>{priceCurrency}&nbsp;{extraTotal} {extrsGrossFlag}</td>","<td>{priceCurrency}&nbsp;{total}</td>","<td><b>{priceCurrency}&nbsp;{markup}</td>","<td>{priceCommission}</td>","</tr>","</table>","</tpl>","</div>",'<table style="width: 100%;"><tr><td>{createdString}</td></tr></table>')},{height:270,columnWidth:0.4,layout:"fit",border:false,items:[{columnWidth:1,xtype:"grid",enableRowExpander:false,sessionExpandedRows:false,height:160,autoScroll:true,border:false,enableColumnHide:false,enableColumnMove:false,enableColumnResize:false,enableHdMenu:false,tbar:["->",{xtype:"button",disabled:true,text:"Cancel passenger",handler:function(){pGridPass=this.ownerCt.ownerCt;var c=this.ownerCt.ownerCt.findParentByType("tabpanel");dataURIPass=c.getDetail("dataURI");Ext.Msg.show({title:"Confirmation",msg:"Are you sure, want to cancel passenger?",buttons:Ext.Msg.YESNO,fn:b,animEl:"elId",icon:Ext.MessageBox.QUESTION});function b(k){if(k=="yes"){var f=pGridPass;var h=f.getSelections();var e=dataURIPass;var d={};var g=new Array();for(var j=0;j<h.length;j++){g[j]=h[j].data.dataURI}d.passengerURIs=g;Ext.Ajax.request({url:TDS.env.dataPath+e+"/cancel",method:"PUT",jsonData:d,callback:function(p,i,m){if(i){try{Ext.Msg.alert("Status","Changes saved successfully.");var l=f.ownerCt.findParentByType("awesomegrid");l.submitQuery(true)}catch(n){}}}})}}}}],store:new Ext.data.JsonStore({url:"",id:"dataURI",fields:["dataURI","displayName","roomType","code","dateOfBirth","addressString","phoneNumber1","emailAddress","gender","status"]}),sm:new Ext.grid.CheckboxSelectionModel(),columns:[new Ext.grid.CheckboxSelectionModel(),{header:"Passenger",dataIndex:"displayName",width:200,sortable:true,renderer:function(f,e,b,g,d,c){e.attr='ext:qtip= "Click to view details"';return f}},{header:"Type",dataIndex:"code",width:80},{header:"Gender",dataIndex:"gender",renderer:TDS.util.Format.gender,width:100},{header:"DOB",dataIndex:"dateOfBirth",width:100,renderer:TDS.util.Format.dateSpecialRenderer(TDS.env.dateBirthdayFormatDisplay)},{header:"Age",dataIndex:"dateOfBirth",renderer:TDS.util.Format.age,width:80},{header:"Status",dataIndex:"status",width:100}],viewConfig:{forceFit:true},listeners:{rowdblclick:function(d,g,f){var c=d.getStore().getAt(g);var b=c.get("dataURI");TDS.window.setWindow({buttonOK:false,title:"Passenger details",destinationDataURI:b,interfaceURI:"pnr/passenger/viewDetails.js",sourceDataURI:b})},render:function(){var d=this.topToolbar;this.getSelectionModel().on("rowselect",function(){if(this.ownerCt.getSelections().length>0){d.items.itemAt(1).setDisabled(false)}},d);this.getSelectionModel().on("rowdeselect",function(){if(this.ownerCt.getSelections().length==0){d.items.itemAt(1).setDisabled(true)}},d);this.getEl().swallowEvent(["columnmove","columnresize","headerclick","click","mouseout","rowclick","rowmousedown","rowblclick","cellblclick","sortchange","mouseup","mousedown"]);var c=this.ownerCt.findParentByType("tabpanel");var b=c.getDetail("dataURI");Ext.Ajax.request({url:TDS.env.dataPath+b+"/passengers/collection/concise",method:"GET",callback:function(h,n,f){if(n){var l=Ext.util.JSON.decode(f.responseText);var k=l[b+"/passengers"];if(typeof k=="undefined"){return}var m=[];for(var j=0;j<k.length;j++){l[k[j]].dataURI=k[j];m.push(l[k[j]])}var g=this;var e=g.store;e.loadData(m);g.getView().refresh()}},scope:this})}}}]}],listeners:{render:function(){this.initInventory();this.initOffering()}},initInventory:function(){var h=this.ownerCt.findParentByType("tabpanel");var e=h.getDetail("dataURI");var d=h.getDetail("depositDescription");var c=h.getDetail("paybyDate");var b=TDS.util.Format.dateSpecial(c,TDS.env.dateFormatDisplay);var g=e;var f=new Array();f=e.split("/");Ext.Ajax.request({url:TDS.env.dataPath+e+"/inventories/collection",method:"GET",callback:function(O,J,L){if(J){try{var F=Ext.decode(L.responseText)}catch(W){}if(F){var x=0,G,P=[];var E=0;var U=F["component/inventory/collection"];var n=U[e+"/inventories"];var N=F["component/rate/collection/"];var l=N["component/rate/collection/list"];h.setDetail("rateList",l);var K=new Array();K=e.split("/");var y="";this.rateData=[];var Z=n.length/l.length;var Q=[];var A="";var V=[];var w=0;if(n.length>0){for(var T=0;T<n.length;T++){var X=U[n[T]];P[P.length]=TDS.util.Format.dateSpecial(X.componentPaybyDate,TDS.env.dateFormatDisplay);A=X.pricingPriceCurrency;if(V.indexOf(X.rateId)==-1){V[T]=X.rateId;Q[w]=TDS.util.Price.calculateFixedGrossNettPrice({pricingPriceCurrency:X.pricingPriceCurrency,pricingPriceSell:X.pricingPriceSell,pricingPriceCommission:X.pricingPriceCommission,pricingPriceIsNett:X.pricingPriceIsNett});Q[w].rateId=X.rateId;Q[w].quantity=X.quantity;w++}}var I="";var D=0;var S=0;if(l.length>0){for(var T=0;T<l.length;T++){var B=N[l[T]];S=B.extraTotal;y=N[l[T]].tempBookedDate;var H=[];var Y=B.groupName;var p=0;var u=0;var v=null;for(var R=0;R<Q.length;R++){if(Q[R].rateId==l[T].substring(l[T].lastIndexOf("/")+1,l[T].length)){v=Q[R]}}var v=null;for(var R=0;R<Q.length;R++){if(Q[R].rateId==l[T].substring(l[T].lastIndexOf("/")+1,l[T].length)){v=Q[R]}}if(!v.priceIsNett){p=v.priceCommissionPercentage}else{u=v.priceCommission;E+=v.priceCommission}var z=u/v.quantity;D+=v.priceSell;var q=this.ownerCt.ownerCt.findParentByType("ajaxpanel");var m=(q.rowRecordData.pricingPriceIsNett?"Nett":"Gross");var C=q.rowRecordData.status;var M=D+E;var k=this.findParentByType("tabpanel").findParentByType("awesomegrid").lastExpandedRowIdx;if(!(this.findParentByType("tabpanel").findParentByType("awesomegrid").getStore().getAt(k).data.cruisePackage!=0)){I+="<tr>";I+="<td> "+B.nameString+"</td>",I+="<td> "+a[0]+" </td>",I+="<td>"+v.quantity+"</td>",I+="<td>"+TDS.util.Price.formatPrice((D/v.quantity+z),v.priceCurrency)+"</td>",I+="<td>"+C+"</td>",I+="</tr>"}else{I+="<tr>";I+="<td> "+B.nameString+"</td>",I+="<td> "+a[0]+" </td>",I+="<td>"+v.quantity+"</td>",I+="<td>"+C+"</td>",I+="</tr>"}}D+=E;D+=S}if(P.length>0){var t=P[0]}else{var t=P}h.setDetail("pricingPriceCurrency",A);this.inventoryData={rateBody:I,totalPrice:M,dataURI:e,netorgross:m,divDataUri:g,numberOfNights:Z,dates:t,depositDescription:d,paybyDate:b,markup:E.toFixed(2),pnrCode:K[1],bookeddateDis:y,total:D.toFixed(2),extraTotal:S.toFixed(2),priceCurrency:A,priceCommission:p,isCruisePackage:!(this.findParentByType("tabpanel").findParentByType("awesomegrid").getStore().getAt(k).data.cruisePackage)};this.hasDetailsInventory=true;if(this.isDetailsReady()){this.displayDetails()}}}}},scope:this})},initOffering:function(){var c=this.ownerCt.findParentByType("tabpanel");var b=c.getDetail("offeringURI");Ext.Ajax.request({url:TDS.env.dataPath+b,method:"GET",callback:function(i,d,g){if(d){try{var f=Ext.decode(g.responseText)}catch(h){}if(f){this.offeringData={locationToString:f.locationToString,nameString:f.nameString,addressString:f.addressString,attractionType:TDS.util.Format.displayResourceName(f.attractionTypeURI)};this.hasDetailsOffering=true;if(this.isDetailsReady()){this.displayDetails()}}}},scope:this})},displayDetails:function(){var h=this.ownerCt.findParentByType("tabpanel");var e=this.ownerCt.ownerCt.findParentByType("ajaxpanel");if(h.getDetail("voucher")&&e.rowRecordData.status=="Confirmed"){this.getDetailsPanel().topToolbar.items.itemAt(5).enable(true)}else{this.getDetailsPanel().topToolbar.items.itemAt(5).disable(true)}var c=Date.parseDate(h.getDetail("createdDate"),TDS.env.dateFormat);var f=Date.parseDate(h.getDetail("updatedDate"),TDS.env.dateFormat);var d=this.findParentByType("awesomegrid").findParentByType("pnrpanel").ownerCt.ownerCt.dataObj.pnrFrom;var g=!Ext.isEmpty(d)?"Created by Mobile on ":"Created on ";var b=g+c.format(TDS.env.dateTimeFormatDisplay)+" by "+h.getDetail("createdByUserFullNameString")+", modified on "+f.format(TDS.env.dateTimeFormatDisplay)+(h.getDetail("createdByUserFullNameString")==h.getDetail("updatedByUserFullNameString")?"":" by "+h.getDetail("updatedByUserFullNameString"))+".";this.getDetailsPanel().tpl.overwrite(this.getDetailsPanel().body,Ext.apply({createdString:b},this.inventoryData,this.offeringData))}}