{requireStores:[{dataURI:TDS.env.dataPath+"rail/extracategories/collection",identifier:"rail/extracategories",fields:["name","dataURI"]},{dataURI:TDS.env.dataPath+"rate/classes/collection",identifier:"rate/classes",fields:["name","dataURI"]},{dataURI:TDS.env.dataPath+"rate/pers/collection",identifier:"rate/pers",fields:["name","dataURI"]},{dataURI:TDS.env.dataPath+"rate/occupancies/collection",identifier:"rate/occupancies",fields:["name","dataURI"]}],xtype:"panel",height:320,border:true,layout:"column",getDetailsPanel:function(){return this.items.itemAt(0)},getPassengersPanel:function(){return this.items.itemAt(1)},hasDetailsInventory:false,hasDetailsOffering:false,isDetailsReady:function(){if(this.hasDetailsInventory&&this.hasDetailsOffering){return true}return false},items:[{tbar:[{xtype:"button",text:"Edit Pay By",handler:function(){var e=this.ownerCt.findParentByType("tabpanel");var d=e.ownerCt;var c=e.getDetail("dataURI");var a=e.getDetail("paybyDate");var b=e.getDetail("depositDescription");TDS.window.setWindow({title:"Description",information:"Please enter description.",interfaceURI:"pnr/components/accommodation/editPayby.js",destinationDataURI:c+"/updatePayBYDates",data:{paybyDate:a,depositDescription:b},callback:{fn:function(f){d.refreshGrid()}}})}},{xtype:"button",text:"Save",disabled:true,hidden:true},"->",{xtype:"button",buttonAlign:"right",text:"Additinonal Info",handler:function(){TDS.window.setWindow({title:"Rail PNR",interfaceURI:"pnr/components/generic/additionalInfo.js",sourceDataURI:dataURI+"/additionalInfo",destinationDataURI:dataURI+"/additionalInfo"})}}],columnWidth:0.6,xtype:"panel",height:260,border:true,tpl:new Ext.XTemplate('<div style="height:160px; overflow-y: scroll; overflow-x: hidden;">','<table border="0" width="100%">','<tr><td width="14%"><span style="font-size:12px"><b>RLOC:</b></span></td><td width="20%"><font color="red"><span style="font-size:12px"> <b>{pnrCode}</b><span style="font-size:12px"></font></td>','<td  width="8%"><span style="font-size:12px"><b>Pay By:</b></span></td><td  width="20%"><div id="ttlDate#{divDataUri}"><span style="font-size:12px">{paybyDate}&nbsp;{depositDescription}</span></div></td>',"</table>",'<table class="x-tds-dataview" style="width: 100%;" border=1 cellpadding = 1 cellspacing=0  >','<tr style="background-color: #d0def0;" >','<th style="padding: 2px; width: 35%;">Service</th>','<th style="padding: 2px; width: 25%;">Departs</th>','<th style="padding: 2px; width: 25%;">Date</th>','<th style="padding: 2px; width: 15%;">Time</th>','<th style="padding: 2px; width: 15%;">Arrive</th>','<th style="padding: 2px; width: 15%;">Time</th>','<th style="padding: 2px; width: 15%;">Trip Time</th>',"</tr>","<tr>","<td>{name}</td>","<td>{locationFromString}</td>","<td>{inDate}</td>","<td>{departureTime}</td>","<td>{locationToString}</td>","<td>{arrivalTime}</td>","<td>{duration}</td>","</tr>","</table>",'<table class="x-tds-dataview" style="width: 100%;" border=1 cellpadding = 1 cellspacing=0  >','<tr style="background-color: #d0def0;" >','<th style="padding: 2px; width: 15%;">Rate</th>','<th style="padding: 2px; width: 10%;">Cabin/Seat</th>','<th style="padding: 2px; width: 10%;">Car No</th>','<th style="padding: 2px; width: 10%;">Class</th>','<th style="padding: 2px; width: 10%;">Pax Type</th>','<th style="padding: 2px; width: 5%;">No</th>','<th style="padding: 2px; width: 10%;"> Gross Price P/P</th>','<th style="padding: 2px; width: 5%;">Status</th>',"</tr>","{rateBody}","</table>",'<table class="x-tds-dataview" style="width: 100%;" border=1 cellpadding = 1 cellspacing=0  >','<tr style="background-color: #C0D9D9;">','<th style="padding: 2px; width: 14%;">Price</th>','<th style="padding: 2px; width: 14%;">Extras</th>','<th style="padding: 2px; width: 20%;">Total Price (Gross)</th>','<th style="padding: 2px; width: 10%;">Markup Included</th>','<th style="padding: 2px; width: 7%;">Comm%</th>',"</tr>","<tr>","<td>{pricesCurrency}&nbsp;{price}</td>","<td>{pricesCurrency}&nbsp;{Ggrosstemp}</td>","<td>{pricesCurrency} &nbsp;{total}</td>","<td><b>{pricesCurrency}&nbsp;{markup}</td>","<td>{priceCommissionPercentage_new}</td>","</tr>","</table>","</div>",'<div> <table style="width: 100%;"><tr><td>{createdString}</td></tr></table></div>')},{height:270,columnWidth:0.4,layout:"fit",border:false,items:[{columnWidth:1,xtype:"grid",enableRowExpander:false,sessionExpandedRows:false,height:160,autoScroll:true,border:false,enableColumnHide:false,enableColumnMove:false,enableColumnResize:false,enableHdMenu:false,tbar:["->",{xtype:"button",disabled:true,text:"Cancel passenger",handler:function(){pGridPass=this.ownerCt.ownerCt;var b=this.ownerCt.ownerCt.findParentByType("tabpanel");dataURIPass=b.getDetail("dataURI");Ext.Msg.show({title:"Confirmation",msg:"Are you sure, want to cancel passenger?",buttons:Ext.Msg.YESNO,fn:a,animEl:"elId",icon:Ext.MessageBox.QUESTION});function a(j){if(j=="yes"){var e=pGridPass;var g=e.getSelections();var d=dataURIPass;var c={};var f=new Array();for(var h=0;h<g.length;h++){f[h]=g[h].data.dataURI}c.passengerURIs=f;Ext.Ajax.request({url:TDS.env.dataPath+d+"/cancel",method:"PUT",jsonData:c,callback:function(n,i,l){if(i){try{Ext.Msg.alert("Status","Changes saved successfully.");var k=e.ownerCt.findParentByType("awesomegrid");k.submitQuery(true)}catch(m){}}}})}}}}],store:new Ext.data.JsonStore({url:"",id:"dataURI",fields:["dataURI","displayName","roomType","code","dateOfBirth","addressString","phoneNumber1","emailAddress","gender","status","paxAge"]}),sm:new Ext.grid.CheckboxSelectionModel(),columns:[new Ext.grid.CheckboxSelectionModel(),{header:"Passenger",dataIndex:"displayName",width:200,sortable:true,renderer:function(e,d,a,f,c,b){d.attr='ext:qtip= "Click to view details"';return e}},{header:"Type",dataIndex:"code",width:80},{header:"Gender",dataIndex:"gender",renderer:TDS.util.Format.gender,width:100},{header:"DOB",dataIndex:"dateOfBirth",width:70,fixed:true,renderer:TDS.util.Format.dateSpecialRenderer(TDS.env.dateBirthdayFormatDisplay)},{header:"Age",dataIndex:"paxAge",width:40,fixed:true,renderer:function(d,b,a){if(d){return d}else{var c=TDS.util.Format.age(a.get("dateOfBirth"));return((c&&c>0)?c:"")}}},{header:"Seat/Cabin",hidden:true,dataIndex:"roomType",width:150,editor:new Ext.form.ComboBox({editable:false,forceSelection:true,mode:"local",triggerAction:"all",displayField:"name",valueField:"dataURI",emptyText:"Type",store:[]})},{header:"Price",dataIndex:"price",width:80,editor:new Ext.form.NumberField({})},{header:"Status",dataIndex:"status",width:100}],viewConfig:{forceFit:true},listeners:{rowdblclick:function(c,f,d){var b=c.getStore().getAt(f);var a=b.get("dataURI");TDS.window.setWindow({buttonOK:false,title:"Passenger details",destinationDataURI:a,interfaceURI:"pnr/passenger/viewDetails.js",sourceDataURI:a})},render:function(){var c=this.topToolbar;this.getSelectionModel().on("rowselect",function(){if(this.ownerCt.getSelections().length>0){c.items.itemAt(1).setDisabled(false)}},c);this.getSelectionModel().on("rowdeselect",function(){if(this.ownerCt.getSelections().length==0){c.items.itemAt(1).setDisabled(true)}},c);this.getEl().swallowEvent(["columnmove","columnresize","headerclick","click","mouseout","rowclick","rowmousedown","rowblclick","cellblclick","sortchange","mouseup","mousedown"]);var b=this.ownerCt.findParentByType("tabpanel");var a=b.getDetail("dataURI");Ext.Ajax.request({url:TDS.env.dataPath+a+"/passengers/collection/concise",method:"GET",callback:function(g,m,e){if(m){var k=Ext.util.JSON.decode(e.responseText);var j=k[a+"/passengers"];if(typeof j=="undefined"){return}var l=[];for(var h=0;h<j.length;h++){k[j[h]].dataURI=j[h];l.push(k[j[h]])}var f=this;var d=f.store;d.loadData(l);f.getView().refresh()}},scope:this})}}}]}],listeners:{render:function(){this.initInventory();this.initOffering();this.initPassengers()}},initInventory:function(){var g=this.ownerCt.findParentByType("tabpanel");var d=g.getDetail("dataURI");var c=g.getDetail("depositDescription");var b=g.getDetail("paybyDate");var a=TDS.util.Format.dateSpecial(b,TDS.env.dateFormatDisplay);var f=d;var e=new Array();e=d.split("/");Ext.Ajax.request({url:TDS.env.dataPath+d+"/inventories/collection",method:"GET",callback:function(aa,X,Y){if(X){try{var P=Ext.decode(Y.responseText)}catch(am){}if(P){var E=0,U,ac=[];var ak=P["component/inventory/collection"];var p=ak[d+"/inventories"];var Z=P["component/rate/collection/"];var h=Z["component/rate/collection/list"];var W=0;var ae=[];var I="";var al=[];var C=0;var aj;if(p.length>0){for(var ai=0;ai<p.length;ai++){var an=ak[p[ai]];if(!U){U=an.rateURI}E+=an.quantity;ac[ac.length]=TDS.util.Format.dateSpecial(an.date,TDS.env.dateFormatDisplay);W=W+an.pricingPriceCommission;aj=an.pricingPriceCurrency;var an=ak[p[ai]];ac[ac.length]=TDS.util.Format.dateSpecial(an.componentPaybyDate,TDS.env.dateFormatDisplay);I=an.pricingPriceCurrency;if(al.indexOf(an.rateId)==-1){al[ai]=an.rateId;ae[C]=TDS.util.Price.calculateFixedGrossNettPrice({pricingPriceCurrency:an.pricingPriceCurrency,pricingPriceSell:an.pricingPriceSell,pricingPriceCommission:an.pricingPriceCommission,pricingPriceIsNett:an.pricingPriceIsNett});ae[C].rateId=an.rateId;ae[C].quantity=an.quantity;C++}}var Q=Z[h[0]];g.setDetail("rate",Q);var v=Q.railClass;var z=Q.railSeat;var af=Q.extraTotal;var O=Q.convertedPricingPriceSell;var D=Q.pricingPriceCommission;var q=(O+parseFloat(af));q=parseFloat(q);var t;var K;var G=0;var m=Q.maximumOccupancy;var u=this.ownerCt.ownerCt.findParentByType("ajaxpanel");var ab=TDS.util.Format.dateSpecial(u.rowRecordData.dateFrom,TDS.env.dateFormatDisplay);var R=TDS.util.Format.dateSpecial(u.rowRecordData.dateTo,TDS.env.dateFormatDisplay);var H=u.rowRecordData.passengersTotal;var T=H;var y=u.rowRecordData.description;var M=u.rowRecordData.status;if(Q.pricingPriceIsNett){t="Nett";q=q+W}else{t="Gross";W=0;var F=Q.pricingPriceCommission;var k=Q.pricingPriceSell;G=Math.round((Q.pricingPriceCommission*100)/Q.pricingPriceSell);if(!isNaN(G)){K=G+"%"}}var V="";var l="";var x=false;var L=0;var w=0;var ah=0;var N=0;if(h.length>0){for(var ai=0;ai<h.length;ai++){var J=Z[h[ai]];ah=J.extraTotal;tempBookedDate=Z[h[ai]].tempBookedDate;var S=[];var ap=J.groupName;var n="";var A="";S=ap.split(",");var ao=[];var ad=S[0];ao=ad.split(" ");var B=null;for(var ag=0;ag<ae.length;ag++){if(ae[ag].rateId==h[ai].substring(h[ai].lastIndexOf("/")+1,h[ai].length)){B=ae[ag]}}x=B.priceIsNett;if(!B.priceIsNett){n=B.priceCommissionPercentage}else{A=B.priceCommission;N+=(B.quantity*B.priceCommission)}L+=(B.quantity*B.priceSell);w+=(B.quantity*B.priceSell);V+="<tr>";V+="<td>"+J.nameString+"</td>",V+="<td>"+(h[ai].railSeat?"Cabin Type("+h[ai].railSeat+")":"Seat")+"</td>",V+="<td> </td>";V+="<td>"+(h[ai].railClass?h[ai].railClass:"")+"</td>",V+="<td>"+ao[0]+"</td>",V+="<td>"+B.quantity+"</td>",V+="<td>"+TDS.util.Price.formatPrice(B.priceSell,B.priceCurrency)+"</td>",V+="<td>"+M+"</td>";V+="</tr>"}L+=N;L+=ah}this.inventoryData={rateBody:V,quantity:E,rateURI:U,rateName:Q.name,rateCode:Q.code,groupName:Q.groupName,dates:ac,depositDescription:c,paybyDate:a,rateConditions:Q.restrictions,price:O.toFixed(2),nameString:Q.nameString,pricesCurrency:aj,passengers:m,status:M,passengersTotal:H,seats:T,description:y,inDate:ab,railClass:v,railSeat:z,outDate:R,priceCommissionPercentage_new:K,flag_new:t,total:q.toFixed(2),Ggrosstemp:af.toFixed(2),markup:W.toFixed(2),pnrCode:e[1],divDataUri:f};this.hasDetailsInventory=true;if(this.isDetailsReady()){this.displayDetails()}}}}},scope:this})},initOffering:function(){var b=this.ownerCt.findParentByType("tabpanel");var a=b.getDetail("offeringURI");Ext.Ajax.request({url:TDS.env.dataPath+a,method:"GET",callback:function(h,c,f){if(c){try{var d=Ext.decode(f.responseText)}catch(g){}if(d){this.offeringData={locationFromString:d.locationFromString,name:d.name,departureTime:d.departureTime,locationToString:d.locationToString,arrivalTime:d.arrivalTime,duration:d.duration,website:d.primaryHref,addressString:d.addressString};this.hasDetailsOffering=true;if(this.isDetailsReady()){this.displayDetails()}}}},scope:this})},initPassengers:function(){var d=this.ownerCt.findParentByType("tabpanel");var b=d.getDetail("dataURI");var c=0;var a=d.getDetail("status");Ext.Ajax.request({url:TDS.env.dataPath+b+"/passengers/collection/concise",method:"GET",callback:function(g,p,f){if(p){try{var j=Ext.decode(f.responseText)}catch(k){}if(j){this.passengerData=[];var l=j[b+"/passengers"];for(var h=0;h<l.length;h++){var m="enabled";if(l.length>=2){m="enabled"}else{m="disabled"}var n=l[h].split("/");passengerId=n[3];j[l[h]].countryURI=passengerId;j[l[h]].dataURI=b;j[l[h]].chkboxCount=h;j[l[h]].pncid=l[h];j[l[h]].chkrequired=m;j[l[h]].status=a;this.passengerData[h]=j[l[h]]}this.displayPassengers()}}},scope:this})},displayPassengers:function(){},getPassengersPanel:function(){return this.items.itemAt(1)},displayDetails:function(){;var d=this.ownerCt.findParentByType("tabpanel");var g=Date.parseDate(d.getDetail("createdDate"),TDS.env.dateFormat);var i=Date.parseDate(d.getDetail("updatedDate"),TDS.env.dateFormat);var a=this.findParentByType("awesomegrid").findParentByType("pnrpanel").ownerCt.ownerCt.dataObj.pnrFrom;var h=!Ext.isEmpty(a)?"Created by Mobile on ":"Created on ";var b=h+g.format(TDS.env.dateTimeFormatDisplay)+" by "+d.getDetail("createdByUserFullNameString")+", modified on "+i.format(TDS.env.dateTimeFormatDisplay)+(d.getDetail("createdByUserFullNameString")==d.getDetail("updatedByUserFullNameString")?"":" by "+d.getDetail("updatedByUserFullNameString"))+".";var e=TDS.util.Price.calculateFixedGrossNettPrice({pricingPriceCurrency:d.getDetail("pricingPriceCurrency"),pricingPriceSell:d.getDetail("pricingPriceSell"),pricingPriceCommission:d.getDetail("pricingPriceCommission"),pricingPriceIsNett:d.getDetail("pricingPriceIsNett")});var f=this.inventoryData.Ggrosstemp;if(e.priceSell==""||e.priceSell==null||e.priceSell=="undefined"){e.priceSell=0}var c=e.priceSell*parseInt(this.inventoryData.quantity);this.getDetailsPanel().tpl.overwrite(this.getDetailsPanel().body,Ext.apply({createdString:b,quaPrice:c.toFixed(2)},this.inventoryData,this.offeringData))}}